<!doctype html><html lang=zh-CN><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>glibc源码分析 - J-shiro's Blog</title><meta name=Description content="Hugo theme - LoveIt"><meta property="og:url" content="https://j-shiro.github.io/source_analyze/">
<meta property="og:site_name" content="J-shiro's Blog"><meta property="og:title" content="glibc源码分析"><meta property="og:description" content="Heap 结构 malloc_par malloc.c中，记录堆管理器的相关参数
struct malloc_par { unsigned long trim_threshold; // 收缩阈值 默认128KB /* 用于控制main_arena中保留的内存量 当释放的chunk为mmap获得的，同时大小大于mmap_threshold，更新mmap_threshold同时将trim_threshold乘2; 当释放的chunk大小在 fast bin 范围内，合并完 size 大于 FASTBIN_CONSOLIDATION_THRESHOLD:0x10000，根据该字段缩小 top chunk */ INTERNAL_SIZE_T top_pad;	// 初始化或扩展堆时申请内存是否添加额外pad，默认为0 // 调用sbrk函数时在原有请求大小上添加的一个值，是一个填充 INTERNAL_SIZE_T mmap_threshold;	// mmap分配阈值 /* 决定sysmalloc用mmap还是sbrk分配内存界限, >则mmap, <则sbrk, 若释放的内存通过mmap得到的, 则mmap_threshold与该内存大小取max, 且该值最大不超过DEFAULT_MMAP_THRESHOLD_MAX:0x2000000 */ INTERNAL_SIZE_T arena_test; // 最小分配区 INTERNAL_SIZE_T arena_max; // 最大分配区 int n_mmaps;	// mmap分配的内存数量, mmap一次+1, munmap一次-1 int n_mmaps_max;	// 最多能mmap的内存数量 int max_n_mmaps;	// n_mmaps达到过的最大值 int no_dyn_threshold;	// 是否开启mmap分配阈值动态调整，默认为0开启 INTERNAL_SIZE_T mmapped_mem;	// 当前 mmap 分配的内存大小总和 /*INTERNAL_SIZE_T sbrked_mem;*/ /*INTERNAL_SIZE_T max_sbrked_mem;*/ INTERNAL_SIZE_T max_mmapped_mem;	// mmap 的内存大小总和达到过的最大值 INTERNAL_SIZE_T max_total_mem; // 单线程情况下统计进程分配的内存总数 char *sbrk_base; // brk系统调用申请的heap区域的起始地址 }; 该结构体类型实例mp_来记录ptmalloc参数"><meta property="og:locale" content="zh_CN"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-11-19T00:00:00+00:00"><meta property="article:modified_time" content="2025-05-24T19:40:01+08:00"><meta property="article:tag" content="Pwn"><meta property="og:image" content="https://j-shiro.github.io/logo.png"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://j-shiro.github.io/logo.png"><meta name=twitter:title content="glibc源码分析"><meta name=twitter:description content="Heap 结构 malloc_par malloc.c中，记录堆管理器的相关参数
struct malloc_par { unsigned long trim_threshold; // 收缩阈值 默认128KB /* 用于控制main_arena中保留的内存量 当释放的chunk为mmap获得的，同时大小大于mmap_threshold，更新mmap_threshold同时将trim_threshold乘2; 当释放的chunk大小在 fast bin 范围内，合并完 size 大于 FASTBIN_CONSOLIDATION_THRESHOLD:0x10000，根据该字段缩小 top chunk */ INTERNAL_SIZE_T top_pad;	// 初始化或扩展堆时申请内存是否添加额外pad，默认为0 // 调用sbrk函数时在原有请求大小上添加的一个值，是一个填充 INTERNAL_SIZE_T mmap_threshold;	// mmap分配阈值 /* 决定sysmalloc用mmap还是sbrk分配内存界限, >则mmap, <则sbrk, 若释放的内存通过mmap得到的, 则mmap_threshold与该内存大小取max, 且该值最大不超过DEFAULT_MMAP_THRESHOLD_MAX:0x2000000 */ INTERNAL_SIZE_T arena_test; // 最小分配区 INTERNAL_SIZE_T arena_max; // 最大分配区 int n_mmaps;	// mmap分配的内存数量, mmap一次+1, munmap一次-1 int n_mmaps_max;	// 最多能mmap的内存数量 int max_n_mmaps;	// n_mmaps达到过的最大值 int no_dyn_threshold;	// 是否开启mmap分配阈值动态调整，默认为0开启 INTERNAL_SIZE_T mmapped_mem;	// 当前 mmap 分配的内存大小总和 /*INTERNAL_SIZE_T sbrked_mem;*/ /*INTERNAL_SIZE_T max_sbrked_mem;*/ INTERNAL_SIZE_T max_mmapped_mem;	// mmap 的内存大小总和达到过的最大值 INTERNAL_SIZE_T max_total_mem; // 单线程情况下统计进程分配的内存总数 char *sbrk_base; // brk系统调用申请的heap区域的起始地址 }; 该结构体类型实例mp_来记录ptmalloc参数"><meta name=application-name content="LoveIt"><meta name=apple-mobile-web-app-title content="LoveIt"><meta name=referrer content="no-referrer"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://j-shiro.github.io/source_analyze/><link rel=prev href=https://j-shiro.github.io/langchain_note/><link rel=next href=https://j-shiro.github.io/git/><link rel=stylesheet href=/css/style.min.css><link rel=preload href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.7.2/css/all.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.7.2/css/all.min.css></noscript><link rel=preload href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css></noscript><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"glibc源码分析","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/j-shiro.github.io\/source_analyze\/"},"image":["https:\/\/j-shiro.github.io\/images\/Apple-Devices-Preview.png"],"genre":"posts","keywords":"pwn","wordcount":28949,"url":"https:\/\/j-shiro.github.io\/source_analyze\/","datePublished":"2024-11-19T00:00:00+00:00","dateModified":"2025-05-24T19:40:01+08:00","license":"This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","publisher":{"@type":"Organization","name":"xxxx","logo":{"@type":"ImageObject","url":"https:\/\/j-shiro.github.io\/images\/avatar.png","width":800,"height":800}},"author":{"@type":"Person","name":"jshiro"},"description":""}</script></head><body data-header-desktop=fixed data-header-mobile=auto><script>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"auto"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"auto"==="dark")&&document.body.setAttribute("theme","dark")</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title="J-shiro's Blog"><span class=header-title-pre><i class='far fa-kiss-wink-heart fa-fw' aria-hidden=true></i></span>LoveIt</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/>所有文章 </a><a class=menu-item href=/tags/>标签 </a><a class=menu-item href=/categories/>分类 </a><a class=menu-item href=/categories/documentation/>文档 </a><a class=menu-item href=/about/>关于 </a><a class=menu-item href=https://github.com/dillonzq/LoveIt title=GitHub rel="noopener noreffer" target=_blank><i class='fab fa-github fa-fw' aria-hidden=true></i> </a><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop>
<input type=text placeholder=搜索文章标题或内容... id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=搜索><i class="fas fa-search fa-fw" aria-hidden=true></i>
</a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=清空><i class="fas fa-times-circle fa-fw" aria-hidden=true></i>
</a><span class="search-button search-loading" id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i>
</span></span><a href=javascript:void(0); class="menu-item theme-switch" title=切换主题><i class="fas fa-adjust fa-fw" aria-hidden=true></i>
</a><a href=javascript:void(0); class="menu-item language" title=选择语言><i class="fa fa-globe fa-fw" aria-hidden=true></i>
<select class=language-select id=language-select-desktop onchange="location=this.value"><option value=/source_analyze/ selected>简体中文</option></select></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="J-shiro's Blog"><span class=header-title-pre><i class='far fa-kiss-wink-heart fa-fw' aria-hidden=true></i></span>LoveIt</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder=搜索文章标题或内容... id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=搜索><i class="fas fa-search fa-fw" aria-hidden=true></i>
</a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=清空><i class="fas fa-times-circle fa-fw" aria-hidden=true></i>
</a><span class="search-button search-loading" id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>取消</a></div><a class=menu-item href=/posts/ title>所有文章</a><a class=menu-item href=/tags/ title>标签</a><a class=menu-item href=/categories/ title>分类</a><a class=menu-item href=/categories/documentation/ title>文档</a><a class=menu-item href=/about/ title>关于</a><a class=menu-item href=https://github.com/dillonzq/LoveIt title=GitHub rel="noopener noreffer" target=_blank><i class='fab fa-github fa-fw' aria-hidden=true></i></a><a href=javascript:void(0); class="menu-item theme-switch" title=切换主题>
<i class="fas fa-adjust fa-fw" aria-hidden=true></i>
</a><a href=javascript:void(0); class=menu-item title=选择语言><i class="fa fa-globe fa-fw" aria-hidden=true></i>
<select class=language-select onchange="location=this.value"><option value=/source_analyze/ selected>简体中文</option></select></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>目录</h2><div class=toc-content id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">glibc源码分析</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=/ title=Author rel=author class=author><i class="fas fa-user-circle fa-fw" aria-hidden=true></i>jshiro</a></span>&nbsp;<span class=post-category>收录于 <a href=/categories/notes/><i class="far fa-folder fa-fw" aria-hidden=true></i>Notes</a>&nbsp;<a href=/categories/ctf/><i class="far fa-folder fa-fw" aria-hidden=true></i>CTF</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw" aria-hidden=true></i>&nbsp;<time datetime=2024-11-19>2024-11-19</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden=true></i>&nbsp;约 28949 字&nbsp;
<i class="far fa-clock fa-fw" aria-hidden=true></i>&nbsp;预计阅读 58 分钟&nbsp;<span id=/source_analyze/ class=leancloud_visitors data-flag-title=glibc源码分析>
<i class="far fa-eye fa-fw" aria-hidden=true></i>&nbsp;<span class=leancloud-visitors-count></span>&nbsp;次阅读
</span>&nbsp;</div></div><div class="details toc" id=toc-static data-kept><div class="details-summary toc-title"><span>目录</span>
<span><i class="details-icon fas fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#heap>Heap</a><ul><li><a href=#结构>结构</a><ul><li><a href=#malloc_par>malloc_par</a></li><li><a href=#heap_info>heap_info</a></li></ul></li><li><a href=#malloc>malloc</a><ul><li><a href=#223>2.23</a><ul><li><a href=#宏>宏</a></li><li><a href=#__libc_malloc>__libc_malloc</a></li><li><a href=#_int_malloc>_int_malloc</a></li><li><a href=#checked_request2size>checked_request2size</a></li><li><a href=#get_max_fast>get_max_fast</a></li><li><a href=#fastbin_index>fastbin_index</a></li><li><a href=#chunk_size>chunk_size</a></li><li><a href=#chunk2mem>chunk2mem</a></li><li><a href=#in_smallbin_range>in_smallbin_range</a></li><li><a href=#malloc_consolidate>malloc_consolidate</a></li><li><a href=#malloc_init_state>malloc_init_state</a></li><li><a href=#unlink>unlink</a></li><li><a href=#alloc_perturb>alloc_perturb</a></li></ul></li><li><a href=#227>2.27</a><ul><li><a href=#__libc_malloc-1>__libc_malloc</a></li><li><a href=#_int_malloc-1>_int_malloc</a></li><li><a href=#remove_fb>REMOVE_FB</a></li><li><a href=#tcache_init>tcache_init</a></li><li><a href=#tcache_get>tcache_get</a></li><li><a href=#tcache_put>tcache_put</a></li><li><a href=#unlink-1>unlink</a></li></ul></li></ul></li><li><a href=#sysmalloc>sysmalloc</a><ul><li><a href=#223-1>2.23</a><ul><li><a href=#sysmalloc-1>sysmalloc</a></li><li><a href=#mmap>MMAP</a></li><li><a href=#initial_top>initial_top</a></li><li><a href=#heap_for_ptr>heap_for_ptr</a></li><li><a href=#grow_heap>grow_heap</a></li><li><a href=#new_heap>new_heap</a></li><li><a href=#morecore>MORECORE</a></li></ul></li></ul></li><li><a href=#free>free</a><ul><li><a href=#223-2>2.23</a><ul><li><a href=#__libc_free>__libc_free</a></li><li><a href=#_int_free>_int_free</a></li><li><a href=#munmap_chunk>munmap_chunk</a></li><li><a href=#arena_for_chunk>arena_for_chunk</a></li><li><a href=#systrim>systrim</a></li><li><a href=#heap_trim>heap_trim</a></li><li><a href=#shrink_heap>shrink_heap</a></li></ul></li><li><a href=#227-1>2.27</a><ul><li><a href=#__libc_free-1>__libc_free</a></li><li><a href=#maybe_init_tcache>MAYBE_INIT_TCACHE</a></li><li><a href=#_int_free-1>_int_free</a></li><li><a href=#tcache_put-1>tcache_put</a></li></ul></li><li><a href=#231>2.31</a><ul><li><a href=#_int_free-2>_int_free</a></li></ul></li></ul></li><li><a href=#calloc>calloc</a><ul><li><a href=#223-3>2.23</a><ul><li><a href=#__libc_calloc>__libc_calloc</a></li></ul></li></ul></li><li><a href=#realloc>realloc</a><ul><li><a href=#223-4>2.23</a><ul><li><a href=#__libc_realloc>__libc_realloc</a></li><li><a href=#int_realloc>int_realloc</a></li><li><a href=#mremap_chunk>mremap_chunk</a></li></ul></li></ul></li></ul></li><li><a href=#io_file>IO_FILE</a><ul><li><a href=#结构-1>结构</a><ul><li><a href=#_io_list_all>_IO_list_all</a></li><li><a href=#_io_file_plus>_IO_FILE_plus</a></li><li><a href=#_io_file>_IO_FILE</a></li><li><a href=#_io_file_complete>_IO_FILE_complete</a></li><li><a href=#_io_codecvt>_IO_codecvt</a></li><li><a href=#_io_iconv_t>_IO_iconv_t</a></li><li><a href=#__gconv_step>__gconv_step</a></li><li><a href=#_io_wstrnfile>_IO_wstrnfile</a></li><li><a href=#_io_strnfile>_IO_strnfile</a></li><li><a href=#_io_strfile>_IO_strfile</a></li><li><a href=#_io_streambuf>_IO_streambuf</a></li><li><a href=#_io_str_fields>_IO_str_fields</a></li><li><a href=#_io_wide_data>_IO_wide_data</a></li><li><a href=#_io_jump_t>_IO_jump_t</a></li><li><a href=#std>STD</a></li><li><a href=#def_stdfile>DEF_STDFILE</a></li><li><a href=#_io_link_in>_IO_link_in</a></li><li><a href=#_io_cookie_file>_IO_cookie_file</a></li><li><a href=#_io_cookie_io_functions_t>_IO_cookie_io_functions_t</a></li></ul></li><li><a href=#fopen>fopen</a><ul><li><a href=#fopen-1>fopen</a></li><li><a href=#_io_new_fopen>_IO_new_fopen</a></li><li><a href=#__fopen_internal>__fopen_internal</a></li><li><a href=#_io_no_init>_IO_no_init</a></li><li><a href=#_io_old_init>_IO_old_init</a></li><li><a href=#_io_new_file_init_internal>_IO_new_file_init_internal</a></li><li><a href=#_io_new_file_fopen>_IO_new_file_fopen</a></li><li><a href=#_io_file_open>_IO_file_open</a></li></ul></li><li><a href=#fread>fread</a><ul><li><a href=#fread-1>fread</a></li><li><a href=#_io_fread>_IO_fread</a></li><li><a href=#_io_sgetn>_IO_sgetn</a></li><li><a href=#_io_file_xsgetn>_IO_file_xsgetn</a></li><li><a href=#_io_doallocbuf>_IO_doallocbuf</a></li><li><a href=#_io_new_file_underflow>_IO_new_file_underflow</a></li></ul></li><li><a href=#fwrite>fwrite</a><ul><li><a href=#fwrite-1>fwrite</a></li><li><a href=#_io_fwrite>_IO_fwrite</a></li><li><a href=#_io_new_file_xsputn>_IO_new_file_xsputn</a></li><li><a href=#_io_new_file_overflow>_IO_new_file_overflow</a></li><li><a href=#new_do_write>new_do_write</a></li></ul></li><li><a href=#fclose>fclose</a><ul><li><a href=#fclose-1>fclose</a></li><li><a href=#_io_new_fclose>_IO_new_fclose</a></li><li><a href=#_io_un_link>_IO_un_link</a></li><li><a href=#_io_new_file_close_it>_IO_new_file_close_it</a></li></ul></li><li><a href=#puts>puts</a><ul><li><a href=#_io_puts>_IO_puts</a></li><li><a href=#_io_sputn>_IO_sputn</a></li><li><a href=#io_validate_vtable>IO_validate_vtable</a></li><li><a href=#_io_vtable_check>_IO_vtable_check</a></li><li><a href=#rtld_active>rtld_active</a></li><li><a href=#_dl_addr>_dl_addr</a></li></ul></li><li><a href=#flush>flush</a><ul><li><a href=#_io_flush_all_lockp>_IO_flush_all_lockp</a></li><li><a href=#_io_str_overflow>_IO_str_overflow</a></li><li><a href=#_io_fflush>_IO_fflush</a></li></ul></li><li><a href=#printf>printf</a><ul><li><a href=#__fxprintf>__fxprintf</a></li><li><a href=#__vfxprintf>__vfxprintf</a></li><li><a href=#locked_vfxprintf>locked_vfxprintf</a></li><li><a href=#__printf>__printf</a></li><li><a href=#__register_printf_function>__register_printf_function</a></li><li><a href=#__register_printf_specifier>__register_printf_specifier</a></li></ul></li><li><a href=#assert>assert</a><ul><li><a href=#__malloc_assert>__malloc_assert</a></li></ul></li><li><a href=#cookie>cookie</a><ul><li><a href=#_io_cookie_read>_IO_cookie_read</a></li><li><a href=#_io_cookie_write>_IO_cookie_write</a></li><li><a href=#_io_cookie_close>_IO_cookie_close</a></li><li><a href=#_io_cookie_seek>_IO_cookie_seek</a></li></ul></li><li><a href=#house-of-apple>house of apple</a><ul><li><a href=#_io_wstrn_overflow>_IO_wstrn_overflow</a></li><li><a href=#_io_wsetb>_IO_wsetb</a></li><li><a href=#__libio_codecvt_in>__libio_codecvt_in</a></li></ul></li></ul></li><li><a href=#ldso>ld.so</a><ul><li><a href=#结构-2>结构</a><ul><li><a href=#rtld_global>rtld_global</a></li><li><a href=#_rtld_global>_rtld_global</a></li><li><a href=#_dl_ns>_dl_ns</a></li><li><a href=#_dl_nns>_dl_nns</a></li><li><a href=#link_map>link_map</a></li></ul></li><li><a href=#238>2.38</a><ul><li><a href=#_dl_fini>_dl_fini</a></li><li><a href=#_dl_call_fini>_dl_call_fini</a></li></ul></li></ul></li><li><a href=#tls>TLS</a><ul><li><a href=#结构-3>结构</a><ul><li><a href=#tcbhead_t>tcbhead_t</a></li></ul></li></ul></li></ul></nav></div></div><div class=content id=content><h2 id=heap>Heap</h2><h3 id=结构>结构</h3><h4 id=malloc_par>malloc_par</h4><p><code>malloc.c</code>中，记录堆管理器的相关参数</p><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-c"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=复制到剪贴板><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>struct</span> <span class=n>malloc_par</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kt>unsigned</span> <span class=kt>long</span> <span class=n>trim_threshold</span><span class=p>;</span> <span class=c1>// 收缩阈值 默认128KB
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm>  	用于控制main_arena中保留的内存量
</span></span></span><span class=line><span class=cl><span class=cm>  	当释放的chunk为mmap获得的，同时大小大于mmap_threshold，更新mmap_threshold同时将trim_threshold乘2;
</span></span></span><span class=line><span class=cl><span class=cm>  	当释放的chunk大小在 fast bin 范围内，合并完 size 大于 FASTBIN_CONSOLIDATION_THRESHOLD:0x10000，根据该字段缩小 top chunk
</span></span></span><span class=line><span class=cl><span class=cm>  */</span>
</span></span><span class=line><span class=cl>  <span class=n>INTERNAL_SIZE_T</span> <span class=n>top_pad</span><span class=p>;</span>			<span class=c1>// 初始化或扩展堆时申请内存是否添加额外pad，默认为0
</span></span></span><span class=line><span class=cl><span class=c1></span>    								<span class=c1>// 调用sbrk函数时在原有请求大小上添加的一个值，是一个填充
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>INTERNAL_SIZE_T</span> <span class=n>mmap_threshold</span><span class=p>;</span>	<span class=c1>// mmap分配阈值
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=cm>/* 
</span></span></span><span class=line><span class=cl><span class=cm>  	决定sysmalloc用mmap还是sbrk分配内存界限, &gt;则mmap, &lt;则sbrk,
</span></span></span><span class=line><span class=cl><span class=cm>  	若释放的内存通过mmap得到的, 则mmap_threshold与该内存大小取max, 且该值最大不超过DEFAULT_MMAP_THRESHOLD_MAX:0x2000000
</span></span></span><span class=line><span class=cl><span class=cm>  */</span>
</span></span><span class=line><span class=cl>  <span class=n>INTERNAL_SIZE_T</span> <span class=n>arena_test</span><span class=p>;</span> <span class=c1>// 最小分配区
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>INTERNAL_SIZE_T</span> <span class=n>arena_max</span><span class=p>;</span>  <span class=c1>// 最大分配区
</span></span></span><span class=line><span class=cl><span class=c1></span> 
</span></span><span class=line><span class=cl>  <span class=kt>int</span> <span class=n>n_mmaps</span><span class=p>;</span>			<span class=c1>// mmap分配的内存数量, mmap一次+1, munmap一次-1
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kt>int</span> <span class=n>n_mmaps_max</span><span class=p>;</span>		<span class=c1>// 最多能mmap的内存数量
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kt>int</span> <span class=n>max_n_mmaps</span><span class=p>;</span>		<span class=c1>// n_mmaps达到过的最大值
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=kt>int</span> <span class=n>no_dyn_threshold</span><span class=p>;</span>	<span class=c1>// 是否开启mmap分配阈值动态调整，默认为0开启
</span></span></span><span class=line><span class=cl><span class=c1></span> 
</span></span><span class=line><span class=cl>  <span class=n>INTERNAL_SIZE_T</span> <span class=n>mmapped_mem</span><span class=p>;</span>		<span class=c1>// 当前 mmap 分配的内存大小总和
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=cm>/*INTERNAL_SIZE_T  sbrked_mem;*/</span>
</span></span><span class=line><span class=cl>  <span class=cm>/*INTERNAL_SIZE_T  max_sbrked_mem;*/</span>
</span></span><span class=line><span class=cl>  <span class=n>INTERNAL_SIZE_T</span> <span class=n>max_mmapped_mem</span><span class=p>;</span>	<span class=c1>// mmap 的内存大小总和达到过的最大值
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>INTERNAL_SIZE_T</span> <span class=n>max_total_mem</span><span class=p>;</span>  <span class=c1>// 单线程情况下统计进程分配的内存总数
</span></span></span><span class=line><span class=cl><span class=c1></span> 
</span></span><span class=line><span class=cl>  <span class=kt>char</span> <span class=o>*</span><span class=n>sbrk_base</span><span class=p>;</span> <span class=c1>// brk系统调用申请的heap区域的起始地址
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>};</span></span></span></code></pre></div></div><p>该结构体类型实例<code>mp_</code>来记录ptmalloc参数</p><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-c"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=复制到剪贴板><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#define DEFAULT_TOP_PAD 131072 </span><span class=c1>// 0x20000
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=cp>#define DEFAULT_MMAP_MAX       (65536) </span><span class=c1>// 0x10000
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=cp>#define DEFAULT_MMAP_THRESHOLD_MIN (128 * 1024)
</span></span></span><span class=line><span class=cl><span class=cp>#define DEFAULT_MMAP_THRESHOLD DEFAULT_MMAP_THRESHOLD_MIN </span><span class=c1>// 0x20000
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=cp>#define DEFAULT_TRIM_THRESHOLD (128 * 1024) </span><span class=c1>// 0x20000
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=k>struct</span> <span class=n>malloc_par</span> <span class=n>mp_</span> <span class=o>=</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=p>.</span><span class=n>top_pad</span> <span class=o>=</span> <span class=n>DEFAULT_TOP_PAD</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=p>.</span><span class=n>n_mmaps_max</span> <span class=o>=</span> <span class=n>DEFAULT_MMAP_MAX</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=p>.</span><span class=n>mmap_threshold</span> <span class=o>=</span> <span class=n>DEFAULT_MMAP_THRESHOLD</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=p>.</span><span class=n>trim_threshold</span> <span class=o>=</span> <span class=n>DEFAULT_TRIM_THRESHOLD</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=cp>#define NARENAS_FROM_NCORES(n) ((n) * (sizeof (long) == 4 ? 2 : 8))
</span></span></span><span class=line><span class=cl><span class=cp></span>  <span class=p>.</span><span class=n>arena_test</span> <span class=o>=</span> <span class=nf>NARENAS_FROM_NCORES</span> <span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>};</span></span></span></code></pre></div></div><h4 id=heap_info>heap_info</h4><ul><li><strong>位于堆块的开头</strong>，记录通过mmap从Memory Mapping Segment处申请到的内存块信息，<code>arena.c</code>中</li><li>为<strong>非主线程</strong>分配内存使用，因为主分配区可以直接使用sbrk扩展，只有一个堆，非主线程的堆是提前分配好的，当该资源用完时需要重新申请内存空间，不连续所以需要记录不同的堆的链接结构</li></ul><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-c"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=复制到剪贴板><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>typedef</span> <span class=k>struct</span> <span class=n>_heap_info</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>mstate</span> <span class=n>ar_ptr</span><span class=p>;</span> <span class=cm>/* 指向管理该堆块的arena分配区 */</span>
</span></span><span class=line><span class=cl>  <span class=k>struct</span> <span class=n>_heap_info</span> <span class=o>*</span><span class=n>prev</span><span class=p>;</span> <span class=cm>/* 上一个heap_info，单链表形式记录一个线程所有堆结构 */</span>
</span></span><span class=line><span class=cl>  <span class=kt>size_t</span> <span class=n>size</span><span class=p>;</span>   <span class=cm>/* 该堆块大小 */</span>
</span></span><span class=line><span class=cl>  <span class=kt>size_t</span> <span class=n>mprotect_size</span><span class=p>;</span> <span class=cm>/* 记录该堆块被mprotected保护的大小*/</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kt>char</span> <span class=n>pad</span><span class=p>[</span><span class=o>-</span><span class=mi>6</span> <span class=o>*</span> <span class=n>SIZE_SZ</span> <span class=o>&amp;</span> <span class=n>MALLOC_ALIGN_MASK</span><span class=p>];</span> <span class=c1>// 在SIZE_SZ不正常时填充来对其, 正常pad占用0字节
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span> <span class=n>heap_info</span><span class=p>;</span></span></span></code></pre></div></div><h3 id=malloc>malloc</h3><h4 id=223>2.23</h4><h5 id=宏>宏</h5><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-c"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=复制到剪贴板><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=n>SIZE_SZ</span>				<span class=c1>// sizeof( size_t ) 1字节大小
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>MALLOC_ALIGN_MASK</span>	<span class=c1>// ( 2 * SIZE_SZ ) - 1 = 2 * 8 - 1 = 0x10 - 1
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>MINSIZE</span> 			<span class=c1>// ( MIN_CHUNK_SIZE + MALLOC_ALIGN_MASK ) &amp; ~MALLOC_ALIGN_MASK 向下取整
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>MIN_CHUNK_SIZE</span> 		<span class=c1>// offsetof( struct malloc_chunk, fd_nextsize ) 0x20字节
</span></span></span></code></pre></div></div><h5 id=__libc_malloc>__libc_malloc</h5><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-c"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=复制到剪贴板><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=kt>void</span> <span class=o>*</span><span class=nf>__libc_malloc</span> <span class=p>(</span><span class=kt>size_t</span> <span class=n>bytes</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>mstate</span> <span class=n>ar_ptr</span><span class=p>;</span> <span class=c1>// 保存指向分配区main_arena的指针
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kt>void</span> <span class=o>*</span><span class=n>victim</span><span class=p>;</span> <span class=c1>// 保存获得的堆块内存指针: chunk_addr + 0x10
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=c1>// 获取 __malloc_hook
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kt>void</span> <span class=o>*</span><span class=p>(</span><span class=o>*</span><span class=n>hook</span><span class=p>)</span> <span class=p>(</span><span class=kt>size_t</span><span class=p>,</span> <span class=k>const</span> <span class=kt>void</span> <span class=o>*</span><span class=p>)</span> <span class=o>=</span> <span class=nf>atomic_forced_read</span> <span class=p>(</span><span class=n>__malloc_hook</span><span class=p>);</span> 
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nf>__builtin_expect</span> <span class=p>(</span><span class=n>hook</span> <span class=o>!=</span> <span class=nb>NULL</span><span class=p>,</span> <span class=mi>0</span><span class=p>))</span> <span class=c1>// 检查__malloc_hook值是否被设置
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=k>return</span> <span class=p>(</span><span class=o>*</span><span class=n>hook</span><span class=p>)(</span><span class=n>bytes</span><span class=p>,</span> <span class=nf>RETURN_ADDRESS</span> <span class=p>(</span><span class=mi>0</span><span class=p>));</span> <span class=c1>// 若被设置则调用其指向的函数, 参数为申请的内存大小
</span></span></span><span class=line><span class=cl><span class=c1></span>  
</span></span><span class=line><span class=cl>  <span class=nf>arena_get</span> <span class=p>(</span><span class=n>ar_ptr</span><span class=p>,</span> <span class=n>bytes</span><span class=p>);</span> <span class=c1>// 若未被设置则获取本线程一个可用分配区thread_arena
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>victim</span> <span class=o>=</span> <span class=nf>_int_malloc</span> <span class=p>(</span><span class=n>ar_ptr</span><span class=p>,</span> <span class=n>bytes</span><span class=p>);</span> <span class=c1>// 申请内存并返回
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>victim</span> <span class=o>&amp;&amp;</span> <span class=n>ar_ptr</span> <span class=o>!=</span> <span class=nb>NULL</span><span class=p>)</span> <span class=c1>// 堆块未申请成功且arena的指针不为空
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nf>LIBC_PROBE</span> <span class=p>(</span><span class=n>memory_malloc_retry</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=n>bytes</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=n>ar_ptr</span> <span class=o>=</span> <span class=nf>arena_get_retry</span> <span class=p>(</span><span class=n>ar_ptr</span><span class=p>,</span> <span class=n>bytes</span><span class=p>);</span> <span class=c1>// 获取下一个分配区
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=n>victim</span> <span class=o>=</span> <span class=nf>_int_malloc</span> <span class=p>(</span><span class=n>ar_ptr</span><span class=p>,</span> <span class=n>bytes</span><span class=p>);</span> <span class=c1>// 再次申请分配
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>ar_ptr</span> <span class=o>!=</span> <span class=nb>NULL</span><span class=p>)</span> 
</span></span><span class=line><span class=cl>      <span class=p>(</span><span class=kt>void</span><span class=p>)</span> <span class=nf>mutex_unlock</span> <span class=p>(</span><span class=o>&amp;</span><span class=n>ar_ptr</span><span class=o>-&gt;</span><span class=n>mutex</span><span class=p>);</span> <span class=c1>// 操作完成, 解锁分配区使其他线程能够访问
</span></span></span><span class=line><span class=cl><span class=c1></span>	
</span></span><span class=line><span class=cl>    <span class=c1>// 只有3种情况
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nf>assert</span> <span class=p>(</span><span class=o>!</span><span class=n>victim</span> <span class=o>||</span> <span class=c1>// 未申请到内存
</span></span></span><span class=line><span class=cl><span class=c1></span>          <span class=nf>chunk_is_mmapped</span> <span class=p>(</span><span class=nf>mem2chunk</span> <span class=p>(</span><span class=n>victim</span><span class=p>))</span> <span class=o>||</span> <span class=c1>// mmap获取的内存
</span></span></span><span class=line><span class=cl><span class=c1></span>          <span class=n>ar_ptr</span> <span class=o>==</span> <span class=nf>arena_for_chunk</span> <span class=p>(</span><span class=nf>mem2chunk</span> <span class=p>(</span><span class=n>victim</span><span class=p>)));</span> <span class=c1>// 内存从当前线程对应的thread_arena管理的内存中获取
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>return</span> <span class=n>victim</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div><h5 id=_int_malloc>_int_malloc</h5><p><strong>CAS</strong>：从内存位置读取值与期望值比较，相等则更新，不相等则失败重新尝试</p><p><strong>ABA</strong>：一个值在经过多次修改后又回到原始值</p><div class="code-block code-line-numbers" style="counter-reset:code-block 0"><div class="code-header language-c"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=复制到剪贴板><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>static</span> <span class=kt>void</span> <span class=o>*</span><span class=nf>_int_malloc</span> <span class=p>(</span><span class=n>mstate</span> <span class=n>av</span><span class=p>,</span> <span class=kt>size_t</span> <span class=n>bytes</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>INTERNAL_SIZE_T</span> <span class=n>nb</span><span class=p>;</span>               <span class=cm>/* 请求的chunk_size */</span>
</span></span><span class=line><span class=cl>  <span class=kt>unsigned</span> <span class=kt>int</span> <span class=n>idx</span><span class=p>;</span>                 <span class=cm>/* 对应bin数组中的index索引 */</span>
</span></span><span class=line><span class=cl>  <span class=n>mbinptr</span> <span class=n>bin</span><span class=p>;</span>                      <span class=cm>/* 指向对应bin的指针 */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>mchunkptr</span> <span class=n>victim</span><span class=p>;</span>                 <span class=cm>/* 指向分配的chunk */</span>
</span></span><span class=line><span class=cl>  <span class=n>INTERNAL_SIZE_T</span> <span class=n>size</span><span class=p>;</span>             <span class=cm>/* 分配的chunk的size */</span>
</span></span><span class=line><span class=cl>  <span class=kt>int</span> <span class=n>victim_index</span><span class=p>;</span>                 <span class=cm>/* 分配的chunk的bin的index */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>mchunkptr</span> <span class=n>remainder</span><span class=p>;</span>              <span class=cm>/* 指向分割后剩下的那块chunk */</span>
</span></span><span class=line><span class=cl>  <span class=kt>unsigned</span> <span class=kt>long</span> <span class=n>remainder_size</span><span class=p>;</span>     <span class=cm>/* 分割后剩下那块chunk的size */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kt>unsigned</span> <span class=kt>int</span> <span class=n>block</span><span class=p>;</span>               <span class=cm>/* bit map traverser */</span>
</span></span><span class=line><span class=cl>  <span class=kt>unsigned</span> <span class=kt>int</span> <span class=n>bit</span><span class=p>;</span>                 <span class=cm>/* bit map traverser */</span>
</span></span><span class=line><span class=cl>  <span class=kt>unsigned</span> <span class=kt>int</span> <span class=n>map</span><span class=p>;</span>                 <span class=cm>/* current word of binmap */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>mchunkptr</span> <span class=n>fwd</span><span class=p>;</span>                    <span class=cm>/* 链表操作 */</span>
</span></span><span class=line><span class=cl>  <span class=n>mchunkptr</span> <span class=n>bck</span><span class=p>;</span>                    <span class=cm>/* 链表操作 */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=n>errstr</span> <span class=o>=</span> <span class=nb>NULL</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nf>checked_request2size</span> <span class=p>(</span><span class=n>bytes</span><span class=p>,</span> <span class=n>nb</span><span class=p>);</span> <span class=c1>// 检查并将申请内存转换为适合内存分配的块大小
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nf>__glibc_unlikely</span> <span class=p>(</span><span class=n>av</span> <span class=o>==</span> <span class=nb>NULL</span><span class=p>))</span> <span class=c1>// 没有可用arena即arena未初始化
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>void</span> <span class=o>*</span><span class=n>p</span> <span class=o>=</span> <span class=nf>sysmalloc</span> <span class=p>(</span><span class=n>nb</span><span class=p>,</span> <span class=n>av</span><span class=p>);</span> <span class=c1>// 通过sysmalloc系统调用从mmap获取堆块
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=n>p</span> <span class=o>!=</span> <span class=nb>NULL</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=nf>alloc_perturb</span> <span class=p>(</span><span class=n>p</span><span class=p>,</span> <span class=n>bytes</span><span class=p>);</span> <span class=c1>// 用memset清理空间数据
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>return</span> <span class=n>p</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// 在fastbin大小内
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=p>((</span><span class=kt>unsigned</span> <span class=kt>long</span><span class=p>)(</span><span class=n>nb</span><span class=p>)</span> <span class=o>&lt;=</span> <span class=p>(</span><span class=kt>unsigned</span> <span class=kt>long</span><span class=p>)(</span><span class=nf>get_max_fast</span><span class=p>()))</span> <span class=c1>// global_max_fast:0x80
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>idx</span> <span class=o>=</span> <span class=nf>fastbin_index</span><span class=p>(</span><span class=n>nb</span><span class=p>);</span> <span class=c1>// 获取fastbin中的索引，无任何检查，改global_max_fast可使idx极大
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>mfastbinptr</span> <span class=o>*</span><span class=n>fb</span> <span class=o>=</span> <span class=o>&amp;</span><span class=nf>fastbin</span><span class=p>(</span><span class=n>av</span><span class=p>,</span> <span class=n>idx</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=c1>// #define fastbin(ar_ptr, idx) ((ar_ptr)-&gt;fastbinsY[idx]) 即fb指向fastbin中对应的bin的地址
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>mchunkptr</span> <span class=n>pp</span> <span class=o>=</span> <span class=o>*</span><span class=n>fb</span><span class=p>;</span> <span class=c1>// pp指向该对应fastbin中第一个chunk
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>do</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>victim</span> <span class=o>=</span> <span class=n>pp</span><span class=p>;</span> <span class=c1>// 取出第一个空闲chunk来分配 【victim】
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=k>if</span> <span class=p>(</span><span class=n>victim</span> <span class=o>==</span> <span class=nb>NULL</span><span class=p>)</span> <span class=c1>// fastbin中无chunk，跳出，去申请相应大小的smallbin
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        	<span class=c1>// 等价于*fb = victim-&gt;fd, 链表头指向该空闲chunk的下一个chunk
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>}</span> <span class=k>while</span> <span class=p>((</span><span class=n>pp</span> <span class=o>=</span> <span class=nf>catomic_compare_and_exchange_val_acq</span><span class=p>(</span><span class=n>fb</span><span class=p>,</span> <span class=n>victim</span><span class=o>-&gt;</span><span class=n>fd</span><span class=p>,</span> <span class=n>victim</span><span class=p>))</span> <span class=o>!=</span> <span class=n>victim</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=c1>// # define catomic_compare_and_exchange_val_acq(mem, newval, oldval) 
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=c1>// CAS(Compareand-Swap)原子操作, 避免多线程的ABA问题
</span></span></span><span class=line><span class=cl><span class=c1></span>      
</span></span><span class=line><span class=cl>    <span class=c1>// 存在可使用的chunk
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=n>victim</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=nf>__builtin_expect</span><span class=p>(</span><span class=nf>fastbin_index</span><span class=p>(</span><span class=nf>chunksize</span><span class=p>(</span><span class=n>victim</span><span class=p>))</span> <span class=o>!=</span> <span class=n>idx</span><span class=p>,</span> <span class=mi>0</span><span class=p>))</span>
</span></span><span class=line><span class=cl>          <span class=c1>// 检测该chunk的size是否符合该bin的index
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>errstr</span> <span class=o>=</span> <span class=s>&#34;malloc(): memory corruption (fast)&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=nl>errout</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nf>malloc_printerr</span><span class=p>(</span><span class=n>check_action</span><span class=p>,</span> <span class=n>errstr</span><span class=p>,</span> <span class=nf>chunk2mem</span><span class=p>(</span><span class=n>victim</span><span class=p>),</span> <span class=n>av</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nb>NULL</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=nf>check_remalloced_chunk</span><span class=p>(</span><span class=n>av</span><span class=p>,</span> <span class=n>victim</span><span class=p>,</span> <span class=n>nb</span><span class=p>);</span> <span class=c1>// 对chunk标志位检查、是否是malloc_state所表示的分配区中的
</span></span></span><span class=line><span class=cl><span class=c1></span>        									  <span class=c1>// 检查是否已分配，是否重复分配和大小检查
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=kt>void</span> <span class=o>*</span><span class=n>p</span> <span class=o>=</span> <span class=nf>chunk2mem</span><span class=p>(</span><span class=n>victim</span><span class=p>);</span> <span class=c1>// p 指向 chunk 的 fd 字段地址即data区域
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nf>alloc_perturb</span><span class=p>(</span><span class=n>p</span><span class=p>,</span> <span class=n>bytes</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=n>p</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// 在 small bin 大小范围内
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=p>(</span><span class=nf>in_smallbin_range</span><span class=p>(</span><span class=n>nb</span><span class=p>))</span> 
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>idx</span> <span class=o>=</span> <span class=nf>smallbin_index</span><span class=p>(</span><span class=n>nb</span><span class=p>);</span> <span class=c1>// 获取smallbin的下标索引
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>bin</span> <span class=o>=</span> <span class=nf>bin_at</span><span class=p>(</span><span class=n>av</span><span class=p>,</span> <span class=n>idx</span><span class=p>);</span>	<span class=c1>// 取出对应的bin
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>((</span><span class=n>victim</span> <span class=o>=</span> <span class=nf>last</span><span class=p>(</span><span class=n>bin</span><span class=p>))</span> <span class=o>!=</span> <span class=n>bin</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=c1>// #define last(b) ((b)-&gt;bk) 即 bin-&gt;bk != bin说明small bin非空
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// 【victim为取出的表尾第一个chunk】
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=n>victim</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=cm>/* main_arena未初始化时victim为0，表示smallbin还未初始化为双向循环链表 */</span>
</span></span><span class=line><span class=cl>        <span class=nf>malloc_consolidate</span><span class=p>(</span><span class=n>av</span><span class=p>);</span> <span class=c1>// 初始化
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=k>else</span>
</span></span><span class=line><span class=cl>      <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>bck</span> <span class=o>=</span> <span class=n>victim</span><span class=o>-&gt;</span><span class=n>bk</span><span class=p>;</span> <span class=c1>// 取出victim之后的一个chunk检查
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>if</span> <span class=p>(</span><span class=nf>__glibc_unlikely</span><span class=p>(</span><span class=n>bck</span><span class=o>-&gt;</span><span class=n>fd</span> <span class=o>!=</span> <span class=n>victim</span><span class=p>))</span> <span class=c1>// 安全检查: 该chunk的fd应指回victim
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=n>errstr</span> <span class=o>=</span> <span class=s>&#34;malloc(): smallbin double linked list corrupted&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>          <span class=k>goto</span> <span class=n>errout</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=nf>set_inuse_bit_at_offset</span><span class=p>(</span><span class=n>victim</span><span class=p>,</span> <span class=n>nb</span><span class=p>);</span> <span class=c1>// 设置物理相邻的下一个chunk inuse位, 表示victim被使用
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// 使链表头 bin 与 bck 的bk与fd相互连接, 将 victim 脱离双向循环链表
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>bin</span><span class=o>-&gt;</span><span class=n>bk</span> <span class=o>=</span> <span class=n>bck</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>bck</span><span class=o>-&gt;</span><span class=n>fd</span> <span class=o>=</span> <span class=n>bin</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>av</span> <span class=o>!=</span> <span class=o>&amp;</span><span class=n>main_arena</span><span class=p>)</span> <span class=c1>// 若是非住分配区将标志位清零
</span></span></span><span class=line><span class=cl><span class=c1></span>          <span class=n>victim</span><span class=o>-&gt;</span><span class=n>size</span> <span class=o>|=</span> <span class=n>NON_MAIN_ARENA</span><span class=p>;</span> <span class=c1>// 只有申请出的chunk才会置该位, bin中chunk不置位 0x4
</span></span></span><span class=line><span class=cl><span class=c1></span>          
</span></span><span class=line><span class=cl>        <span class=nf>check_malloced_chunk</span><span class=p>(</span><span class=n>av</span><span class=p>,</span> <span class=n>victim</span><span class=p>,</span> <span class=n>nb</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=kt>void</span> <span class=o>*</span><span class=n>p</span> <span class=o>=</span> <span class=nf>chunk2mem</span><span class=p>(</span><span class=n>victim</span><span class=p>);</span> <span class=c1>// p 指向 chunk 的 fd 字段地址
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nf>alloc_perturb</span><span class=p>(</span><span class=n>p</span><span class=p>,</span> <span class=n>bytes</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>p</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 否则在 large bin 范围中，先不查找而是对fastbin进行处理
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>else</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>idx</span> <span class=o>=</span> <span class=nf>largebin_index</span><span class=p>(</span><span class=n>nb</span><span class=p>);</span> <span class=c1>// 获取largebin中索引
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=nf>have_fastchunks</span><span class=p>(</span><span class=n>av</span><span class=p>))</span> <span class=c1>// ((M)-&gt;flags &amp; FASTCHUNKS_BIT) == 0 即是否已初始化main_arena
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nf>malloc_consolidate</span><span class=p>(</span><span class=n>av</span><span class=p>);</span> <span class=c1>// 对fastbin中所有chunk进行遍历、合并，将空闲chunk放入unsorted bin
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 在 unsorted bin中找，并将相应的bin按照大小放入small bin和large bin中
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>for</span> <span class=p>(;;)</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>iters</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 取unsorted bin中最后一个chunk victim, 反向遍历unsorted bin直到unsorted bin为空
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>while</span> <span class=p>((</span><span class=n>victim</span> <span class=o>=</span> <span class=nf>unsorted_chunks</span><span class=p>(</span><span class=n>av</span><span class=p>)</span><span class=o>-&gt;</span><span class=n>bk</span><span class=p>)</span> <span class=o>!=</span> <span class=nf>unsorted_chunks</span><span class=p>(</span><span class=n>av</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>bck</span> <span class=o>=</span> <span class=n>victim</span><span class=o>-&gt;</span><span class=n>bk</span><span class=p>;</span> <span class=c1>// victim的前一个chunk
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=k>if</span> <span class=p>(</span><span class=nf>__builtin_expect</span><span class=p>(</span><span class=n>victim</span><span class=o>-&gt;</span><span class=n>size</span> <span class=o>&lt;=</span> <span class=mi>2</span> <span class=o>*</span> <span class=n>SIZE_SZ</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span> <span class=o>||</span> 
</span></span><span class=line><span class=cl>          <span class=nf>__builtin_expect</span><span class=p>(</span><span class=n>victim</span><span class=o>-&gt;</span><span class=n>size</span> <span class=o>&gt;</span> <span class=n>av</span><span class=o>-&gt;</span><span class=n>system_mem</span><span class=p>,</span> <span class=mi>0</span><span class=p>))</span>
</span></span><span class=line><span class=cl>          <span class=c1>// 若小于0x10或大于arena管理的最大内存，报错
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nf>malloc_printerr</span><span class=p>(</span><span class=n>check_action</span><span class=p>,</span> <span class=s>&#34;malloc(): memory corruption&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                        <span class=nf>chunk2mem</span><span class=p>(</span><span class=n>victim</span><span class=p>),</span> <span class=n>av</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=n>size</span> <span class=o>=</span> <span class=nf>chunksize</span><span class=p>(</span><span class=n>victim</span><span class=p>);</span> <span class=c1>// 获取chunk大小
</span></span></span><span class=line><span class=cl><span class=c1></span>	  
</span></span><span class=line><span class=cl>      <span class=c1>// 需要切割情况
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=k>if</span> <span class=p>(</span><span class=nf>in_smallbin_range</span><span class=p>(</span><span class=n>nb</span><span class=p>)</span> <span class=o>&amp;&amp;</span>	<span class=c1>// 申请大小在small bin范围
</span></span></span><span class=line><span class=cl><span class=c1></span>          <span class=n>bck</span> <span class=o>==</span> <span class=nf>unsorted_chunks</span><span class=p>(</span><span class=n>av</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=c1>// unsorted bin中只有一个chunk victim
</span></span></span><span class=line><span class=cl><span class=c1></span>          <span class=n>victim</span> <span class=o>==</span> <span class=n>av</span><span class=o>-&gt;</span><span class=n>last_remainder</span> <span class=o>&amp;&amp;</span> <span class=c1>// victim刚好是last_remainder
</span></span></span><span class=line><span class=cl><span class=c1></span>          <span class=p>(</span><span class=kt>unsigned</span> <span class=kt>long</span><span class=p>)(</span><span class=n>size</span><span class=p>)</span> <span class=o>&gt;</span> <span class=p>(</span><span class=kt>unsigned</span> <span class=kt>long</span><span class=p>)(</span><span class=n>nb</span> <span class=o>+</span> <span class=n>MINSIZE</span><span class=p>))</span> <span class=c1>// victim大小 &gt; 申请大小 + 0x20
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>remainder_size</span> <span class=o>=</span> <span class=n>size</span> <span class=o>-</span> <span class=n>nb</span><span class=p>;</span> 
</span></span><span class=line><span class=cl>        <span class=n>remainder</span> <span class=o>=</span> <span class=nf>chunk_at_offset</span><span class=p>(</span><span class=n>victim</span><span class=p>,</span> <span class=n>nb</span><span class=p>);</span> <span class=c1>// 切出一个remainder_size的chunk
</span></span></span><span class=line><span class=cl><span class=c1></span>          
</span></span><span class=line><span class=cl>        <span class=nf>unsorted_chunks</span><span class=p>(</span><span class=n>av</span><span class=p>)</span><span class=o>-&gt;</span><span class=n>bk</span> <span class=o>=</span> <span class=nf>unsorted_chunks</span><span class=p>(</span><span class=n>av</span><span class=p>)</span><span class=o>-&gt;</span><span class=n>fd</span> <span class=o>=</span> <span class=n>remainder</span><span class=p>;</span> <span class=c1>// 切出的chunk放入unsorted bin
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>av</span><span class=o>-&gt;</span><span class=n>last_remainder</span> <span class=o>=</span> <span class=n>remainder</span><span class=p>;</span> <span class=c1>// 设置新的remainder
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>remainder</span><span class=o>-&gt;</span><span class=n>bk</span> <span class=o>=</span> <span class=n>remainder</span><span class=o>-&gt;</span><span class=n>fd</span> <span class=o>=</span> <span class=nf>unsorted_chunks</span><span class=p>(</span><span class=n>av</span><span class=p>);</span> <span class=c1>// 维护双向链表
</span></span></span><span class=line><span class=cl><span class=c1></span>          
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nf>in_smallbin_range</span><span class=p>(</span><span class=n>remainder_size</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span> <span class=c1>// 若是large bin则设置两个nextsize
</span></span></span><span class=line><span class=cl><span class=c1></span>          <span class=n>remainder</span><span class=o>-&gt;</span><span class=n>fd_nextsize</span> <span class=o>=</span> <span class=nb>NULL</span><span class=p>;</span>
</span></span><span class=line><span class=cl>          <span class=n>remainder</span><span class=o>-&gt;</span><span class=n>bk_nextsize</span> <span class=o>=</span> <span class=nb>NULL</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nf>set_head</span><span class=p>(</span><span class=n>victim</span><span class=p>,</span> <span class=n>nb</span> <span class=o>|</span> <span class=n>PREV_INUSE</span> <span class=o>|</span> <span class=p>(</span><span class=n>av</span> <span class=o>!=</span> <span class=o>&amp;</span><span class=n>main_arena</span> <span class=o>?</span> <span class=nl>NON_MAIN_ARENA</span> <span class=p>:</span> <span class=mi>0</span><span class=p>));</span>
</span></span><span class=line><span class=cl>        <span class=nf>set_head</span><span class=p>(</span><span class=n>remainder</span><span class=p>,</span> <span class=n>remainder_size</span> <span class=o>|</span> <span class=n>PREV_INUSE</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nf>set_foot</span><span class=p>(</span><span class=n>remainder</span><span class=p>,</span> <span class=n>remainder_size</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nf>check_malloced_chunk</span><span class=p>(</span><span class=n>av</span><span class=p>,</span> <span class=n>victim</span><span class=p>,</span> <span class=n>nb</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=kt>void</span> <span class=o>*</span><span class=n>p</span> <span class=o>=</span> <span class=nf>chunk2mem</span><span class=p>(</span><span class=n>victim</span><span class=p>);</span> <span class=c1>// 转换为内存指针返回
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nf>alloc_perturb</span><span class=p>(</span><span class=n>p</span><span class=p>,</span> <span class=n>bytes</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>p</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=cm>/* 不满足切割的条件，将 victim 从 unsorted bin 中取出 */</span>
</span></span><span class=line><span class=cl>      <span class=nf>unsorted_chunks</span><span class=p>(</span><span class=n>av</span><span class=p>)</span><span class=o>-&gt;</span><span class=n>bk</span> <span class=o>=</span> <span class=n>bck</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=n>bck</span><span class=o>-&gt;</span><span class=n>fd</span> <span class=o>=</span> <span class=nf>unsorted_chunks</span><span class=p>(</span><span class=n>av</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=n>size</span> <span class=o>==</span> <span class=n>nb</span><span class=p>)</span> <span class=c1>// 若victim大小刚好为用户申请的大小, 直接取出
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>set_inuse_bit_at_offset</span><span class=p>(</span><span class=n>victim</span><span class=p>,</span> <span class=n>size</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>av</span> <span class=o>!=</span> <span class=o>&amp;</span><span class=n>main_arena</span><span class=p>)</span>
</span></span><span class=line><span class=cl>          <span class=n>victim</span><span class=o>-&gt;</span><span class=n>size</span> <span class=o>|=</span> <span class=n>NON_MAIN_ARENA</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=nf>check_malloced_chunk</span><span class=p>(</span><span class=n>av</span><span class=p>,</span> <span class=n>victim</span><span class=p>,</span> <span class=n>nb</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=kt>void</span> <span class=o>*</span><span class=n>p</span> <span class=o>=</span> <span class=nf>chunk2mem</span><span class=p>(</span><span class=n>victim</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nf>alloc_perturb</span><span class=p>(</span><span class=n>p</span><span class=p>,</span> <span class=n>bytes</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>p</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=c1>// 到这说明该victim会被放入对应大小的bin链表中，分别获得bck和fwd用于插入
</span></span></span><span class=line><span class=cl><span class=c1></span>	  <span class=c1>// 若 victim 大小属于 small bin
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=k>if</span> <span class=p>(</span><span class=nf>in_smallbin_range</span><span class=p>(</span><span class=n>size</span><span class=p>))</span>
</span></span><span class=line><span class=cl>      <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>victim_index</span> <span class=o>=</span> <span class=nf>smallbin_index</span><span class=p>(</span><span class=n>size</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>bck</span> <span class=o>=</span> <span class=nf>bin_at</span><span class=p>(</span><span class=n>av</span><span class=p>,</span> <span class=n>victim_index</span><span class=p>);</span> <span class=c1>// bck赋值为smallbin的链表表头
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>fwd</span> <span class=o>=</span> <span class=n>bck</span><span class=o>-&gt;</span><span class=n>fd</span><span class=p>;</span>	<span class=c1>// fwd指向small bin第一个chunk，victim将插入到bck和fwd中作为第一个chunk
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=c1>// 若 victim 大小属于 large bin
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=k>else</span>
</span></span><span class=line><span class=cl>      <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>victim_index</span> <span class=o>=</span> <span class=nf>largebin_index</span><span class=p>(</span><span class=n>size</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>bck</span> <span class=o>=</span> <span class=nf>bin_at</span><span class=p>(</span><span class=n>av</span><span class=p>,</span> <span class=n>victim_index</span><span class=p>);</span> <span class=c1>// bck赋值为largebin的链表表头
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>fwd</span> <span class=o>=</span> <span class=n>bck</span><span class=o>-&gt;</span><span class=n>fd</span><span class=p>;</span>	<span class=c1>// fwd指向large bin第一个chunk
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>fwd</span> <span class=o>!=</span> <span class=n>bck</span><span class=p>)</span> <span class=c1>// large bin中非空，即其中有空闲chunk存在
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=n>size</span> <span class=o>|=</span> <span class=n>PREV_INUSE</span><span class=p>;</span> <span class=c1>// 当前chunk的size的inuse置位，便于加快chunk大小比较
</span></span></span><span class=line><span class=cl><span class=c1></span>          <span class=nf>assert</span><span class=p>((</span><span class=n>bck</span><span class=o>-&gt;</span><span class=n>bk</span><span class=o>-&gt;</span><span class=n>size</span> <span class=o>&amp;</span> <span class=n>NON_MAIN_ARENA</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span><span class=p>);</span> <span class=c1>// 多次判断确保NON_MAIN_ARENA为0，主线程
</span></span></span><span class=line><span class=cl><span class=c1></span>          <span class=k>if</span> <span class=p>((</span><span class=kt>unsigned</span> <span class=kt>long</span><span class=p>)(</span><span class=n>size</span><span class=p>)</span> <span class=o>&lt;</span> <span class=p>(</span><span class=kt>unsigned</span> <span class=kt>long</span><span class=p>)(</span><span class=n>bck</span><span class=o>-&gt;</span><span class=n>bk</span><span class=o>-&gt;</span><span class=n>size</span><span class=p>))</span>
</span></span><span class=line><span class=cl>              <span class=c1>// fd一般指向比自己小的，bck的bk指向的是最小的size，此时victim为最小size
</span></span></span><span class=line><span class=cl><span class=c1></span>          <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 交换
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>fwd</span> <span class=o>=</span> <span class=n>bck</span><span class=p>;</span> <span class=c1>// fwd 指向 largebin 链表表头
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>bck</span> <span class=o>=</span> <span class=n>bck</span><span class=o>-&gt;</span><span class=n>bk</span><span class=p>;</span> <span class=c1>// bck 指向largebin中最小size的chunk
</span></span></span><span class=line><span class=cl><span class=c1></span>			
</span></span><span class=line><span class=cl>            <span class=c1>// 更新victim的2个nextsize，使得victim插入largebin的末尾
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=c1>// fd_nextsize指向最大的chunk
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>victim</span><span class=o>-&gt;</span><span class=n>fd_nextsize</span> <span class=o>=</span> <span class=n>fwd</span><span class=o>-&gt;</span><span class=n>fd</span><span class=p>;</span> 
</span></span><span class=line><span class=cl>            <span class=c1>// bk_nextsize指向最大chunk的bk_nextsize, 即最小size的第一个chunk(因为最小chunk可能多个)
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>victim</span><span class=o>-&gt;</span><span class=n>bk_nextsize</span> <span class=o>=</span> <span class=n>fwd</span><span class=o>-&gt;</span><span class=n>fd</span><span class=o>-&gt;</span><span class=n>bk_nextsize</span><span class=p>;</span> 
</span></span><span class=line><span class=cl>            <span class=n>fwd</span><span class=o>-&gt;</span><span class=n>fd</span><span class=o>-&gt;</span><span class=n>bk_nextsize</span> <span class=o>=</span> <span class=n>victim</span><span class=o>-&gt;</span><span class=n>bk_nextsize</span><span class=o>-&gt;</span><span class=n>fd_nextsize</span> <span class=o>=</span> <span class=n>victim</span><span class=p>;</span> <span class=c1>// 对应反向指
</span></span></span><span class=line><span class=cl><span class=c1></span>          <span class=p>}</span>
</span></span><span class=line><span class=cl>          <span class=k>else</span> <span class=c1>// victim不为最小size
</span></span></span><span class=line><span class=cl><span class=c1></span>          <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nf>assert</span><span class=p>((</span><span class=n>fwd</span><span class=o>-&gt;</span><span class=n>size</span> <span class=o>&amp;</span> <span class=n>NON_MAIN_ARENA</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 遍历找到第一个小于等于victim size的chunk
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=k>while</span> <span class=p>((</span><span class=kt>unsigned</span> <span class=kt>long</span><span class=p>)</span><span class=n>size</span> <span class=o>&lt;</span> <span class=n>fwd</span><span class=o>-&gt;</span><span class=n>size</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=p>{</span>
</span></span><span class=line><span class=cl>              <span class=n>fwd</span> <span class=o>=</span> <span class=n>fwd</span><span class=o>-&gt;</span><span class=n>fd_nextsize</span><span class=p>;</span> <span class=c1>// 不断遍历使得fwd-&gt;size非严格递减
</span></span></span><span class=line><span class=cl><span class=c1></span>              <span class=nf>assert</span><span class=p>((</span><span class=n>fwd</span><span class=o>-&gt;</span><span class=n>size</span> <span class=o>&amp;</span> <span class=n>NON_MAIN_ARENA</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>((</span><span class=kt>unsigned</span> <span class=kt>long</span><span class=p>)</span><span class=n>size</span> <span class=o>==</span> <span class=p>(</span><span class=kt>unsigned</span> <span class=kt>long</span><span class=p>)</span><span class=n>fwd</span><span class=o>-&gt;</span><span class=n>size</span><span class=p>)</span>
</span></span><span class=line><span class=cl>              <span class=n>fwd</span> <span class=o>=</span> <span class=n>fwd</span><span class=o>-&gt;</span><span class=n>fd</span><span class=p>;</span> <span class=c1>// 插入第二个位置，则不需要更新fd_nextsize和bk_nextsize
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=k>else</span>
</span></span><span class=line><span class=cl>            <span class=p>{</span> <span class=c1>// 此时victim &gt; fwd(同样大小第一个)，更新将victim插入fwd前
</span></span></span><span class=line><span class=cl><span class=c1></span>              <span class=n>victim</span><span class=o>-&gt;</span><span class=n>fd_nextsize</span> <span class=o>=</span> <span class=n>fwd</span><span class=p>;</span>
</span></span><span class=line><span class=cl>              <span class=n>victim</span><span class=o>-&gt;</span><span class=n>bk_nextsize</span> <span class=o>=</span> <span class=n>fwd</span><span class=o>-&gt;</span><span class=n>bk_nextsize</span><span class=p>;</span>
</span></span><span class=line><span class=cl>              <span class=n>fwd</span><span class=o>-&gt;</span><span class=n>bk_nextsize</span> <span class=o>=</span> <span class=n>victim</span><span class=p>;</span>
</span></span><span class=line><span class=cl>              <span class=n>victim</span><span class=o>-&gt;</span><span class=n>bk_nextsize</span><span class=o>-&gt;</span><span class=n>fd_nextsize</span> <span class=o>=</span> <span class=n>victim</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=n>bck</span> <span class=o>=</span> <span class=n>fwd</span><span class=o>-&gt;</span><span class=n>bk</span><span class=p>;</span> <span class=c1>// bck 更新为找到的fwd的上一个chunk
</span></span></span><span class=line><span class=cl><span class=c1></span>          <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span> <span class=c1>// largebin 为空直接插入更新nextsize
</span></span></span><span class=line><span class=cl><span class=c1></span>          <span class=n>victim</span><span class=o>-&gt;</span><span class=n>fd_nextsize</span> <span class=o>=</span> <span class=n>victim</span><span class=o>-&gt;</span><span class=n>bk_nextsize</span> <span class=o>=</span> <span class=n>victim</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>	  <span class=c1>// 统一维护fd和bk指针将victim插入bck和fwd中间
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nf>mark_bin</span><span class=p>(</span><span class=n>av</span><span class=p>,</span> <span class=n>victim_index</span><span class=p>);</span> 
</span></span><span class=line><span class=cl>        <span class=cm>/* 
</span></span></span><span class=line><span class=cl><span class=cm>       		#define mark_bin(m, i) ((m)-&gt;binmap[idx2block(i)] |= idx2bit(i))
</span></span></span><span class=line><span class=cl><span class=cm>        	将对应map里该index对应的标志位置1 
</span></span></span><span class=line><span class=cl><span class=cm>      	*/</span>
</span></span><span class=line><span class=cl>      <span class=n>victim</span><span class=o>-&gt;</span><span class=n>bk</span> <span class=o>=</span> <span class=n>bck</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=n>victim</span><span class=o>-&gt;</span><span class=n>fd</span> <span class=o>=</span> <span class=n>fwd</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=n>fwd</span><span class=o>-&gt;</span><span class=n>bk</span> <span class=o>=</span> <span class=n>victim</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=n>bck</span><span class=o>-&gt;</span><span class=n>fd</span> <span class=o>=</span> <span class=n>victim</span><span class=p>;</span> <span class=c1>// 将当前chunk插入到对应bin中
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=cp>#define MAX_ITERS 10000
</span></span></span><span class=line><span class=cl><span class=cp></span>      <span class=k>if</span> <span class=p>(</span><span class=o>++</span><span class=n>iters</span> <span class=o>&gt;=</span> <span class=n>MAX_ITERS</span><span class=p>)</span> <span class=c1>// 循环10000次处理unsorted bin中的chunk
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 此时unsorted bin 链表已经处理完成，在 large bin 中查找
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nf>in_smallbin_range</span><span class=p>(</span><span class=n>nb</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>bin</span> <span class=o>=</span> <span class=nf>bin_at</span><span class=p>(</span><span class=n>av</span><span class=p>,</span> <span class=n>idx</span><span class=p>);</span> <span class=c1>// 对应large bin
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>((</span><span class=n>victim</span> <span class=o>=</span> <span class=nf>first</span><span class=p>(</span><span class=n>bin</span><span class=p>))</span> <span class=o>!=</span> <span class=n>bin</span> <span class=o>&amp;&amp;</span> <span class=c1>// large bin不为空，victim设为largebin最大cunk
</span></span></span><span class=line><span class=cl><span class=c1></span>          <span class=p>(</span><span class=kt>unsigned</span> <span class=kt>long</span><span class=p>)(</span><span class=n>victim</span><span class=o>-&gt;</span><span class=n>size</span><span class=p>)</span> <span class=o>&gt;=</span> <span class=p>(</span><span class=kt>unsigned</span> <span class=kt>long</span><span class=p>)(</span><span class=n>nb</span><span class=p>))</span> <span class=c1>// 申请大小小于最大chunk
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>victim</span> <span class=o>=</span> <span class=n>victim</span><span class=o>-&gt;</span><span class=n>bk_nextsize</span><span class=p>;</span> <span class=c1>// 最大chunk的bk_nextsize指向最小chunk, 此时victim最小
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// 遍历找到比申请的nb大小小的最近的
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>while</span> <span class=p>(((</span><span class=kt>unsigned</span> <span class=kt>long</span><span class=p>)(</span><span class=n>size</span> <span class=o>=</span> <span class=nf>chunksize</span><span class=p>(</span><span class=n>victim</span><span class=p>))</span> <span class=o>&lt;</span> <span class=p>(</span><span class=kt>unsigned</span> <span class=kt>long</span><span class=p>)(</span><span class=n>nb</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>          <span class=n>victim</span> <span class=o>=</span> <span class=n>victim</span><span class=o>-&gt;</span><span class=n>bk_nextsize</span><span class=p>;</span> <span class=c1>// 最小chunk的bk_nextsize的chunk size 不断变大
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=c1>// victim有效 且 有至少两个size相同的chunk
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>if</span> <span class=p>(</span><span class=n>victim</span> <span class=o>!=</span> <span class=nf>last</span><span class=p>(</span><span class=n>bin</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=n>victim</span><span class=o>-&gt;</span><span class=n>size</span> <span class=o>==</span> <span class=n>victim</span><span class=o>-&gt;</span><span class=n>fd</span><span class=o>-&gt;</span><span class=n>size</span><span class=p>)</span>
</span></span><span class=line><span class=cl>          <span class=n>victim</span> <span class=o>=</span> <span class=n>victim</span><span class=o>-&gt;</span><span class=n>fd</span><span class=p>;</span> <span class=c1>// 再往下跳一步避免维护两个nextsize指针
</span></span></span><span class=line><span class=cl><span class=c1></span>          
</span></span><span class=line><span class=cl>		<span class=c1>// 分割
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>remainder_size</span> <span class=o>=</span> <span class=n>size</span> <span class=o>-</span> <span class=n>nb</span><span class=p>;</span> <span class=c1>// 不一定完全合适，计算remainder_size
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nf>unlink</span><span class=p>(</span><span class=n>av</span><span class=p>,</span> <span class=n>victim</span><span class=p>,</span> <span class=n>bck</span><span class=p>,</span> <span class=n>fwd</span><span class=p>);</span> <span class=c1>// 将找到的victim 脱链
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>        <span class=c1>// 比MINSIZE还小则不能切割，将整个victim返回，实际分配的chunk比所需chunk大一些
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>if</span> <span class=p>(</span><span class=n>remainder_size</span> <span class=o>&lt;</span> <span class=n>MINSIZE</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=nf>set_inuse_bit_at_offset</span><span class=p>(</span><span class=n>victim</span><span class=p>,</span> <span class=n>size</span><span class=p>);</span> <span class=c1>// 设置下一个chunk的prev_inuse
</span></span></span><span class=line><span class=cl><span class=c1></span>          <span class=k>if</span> <span class=p>(</span><span class=n>av</span> <span class=o>!=</span> <span class=o>&amp;</span><span class=n>main_arena</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>victim</span><span class=o>-&gt;</span><span class=n>size</span> <span class=o>|=</span> <span class=n>NON_MAIN_ARENA</span><span class=p>;</span> <span class=c1>// 非主线程设置non_main_arena位
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=c1>// 否则需要切割
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>else</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span> <span class=c1>// 从victim中切分出所需的chunk，剩余部分作为新chunk加入unsorted bin中
</span></span></span><span class=line><span class=cl><span class=c1></span>          <span class=n>remainder</span> <span class=o>=</span> <span class=nf>chunk_at_offset</span><span class=p>(</span><span class=n>victim</span><span class=p>,</span> <span class=n>nb</span><span class=p>);</span> <span class=c1>// 剩余chunk
</span></span></span><span class=line><span class=cl><span class=c1></span>          <span class=n>bck</span> <span class=o>=</span> <span class=nf>unsorted_chunks</span><span class=p>(</span><span class=n>av</span><span class=p>);</span> <span class=c1>// 获取unsorted bin
</span></span></span><span class=line><span class=cl><span class=c1></span>          <span class=n>fwd</span> <span class=o>=</span> <span class=n>bck</span><span class=o>-&gt;</span><span class=n>fd</span><span class=p>;</span> <span class=c1>// 指向 unsorted bin 第一个 chunk
</span></span></span><span class=line><span class=cl><span class=c1></span>          <span class=k>if</span> <span class=p>(</span><span class=nf>__glibc_unlikely</span><span class=p>(</span><span class=n>fwd</span><span class=o>-&gt;</span><span class=n>bk</span> <span class=o>!=</span> <span class=n>bck</span><span class=p>))</span> <span class=c1>// 检测是否指针相互指向
</span></span></span><span class=line><span class=cl><span class=c1></span>          <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>errstr</span> <span class=o>=</span> <span class=s>&#34;malloc(): corrupted unsorted chunks&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=k>goto</span> <span class=n>errout</span><span class=p>;</span>
</span></span><span class=line><span class=cl>          <span class=p>}</span>
</span></span><span class=line><span class=cl>          <span class=c1>// 将remainder其放入unsorted bin中
</span></span></span><span class=line><span class=cl><span class=c1></span>          <span class=n>remainder</span><span class=o>-&gt;</span><span class=n>bk</span> <span class=o>=</span> <span class=n>bck</span><span class=p>;</span>
</span></span><span class=line><span class=cl>          <span class=n>remainder</span><span class=o>-&gt;</span><span class=n>fd</span> <span class=o>=</span> <span class=n>fwd</span><span class=p>;</span>
</span></span><span class=line><span class=cl>          <span class=n>bck</span><span class=o>-&gt;</span><span class=n>fd</span> <span class=o>=</span> <span class=n>remainder</span><span class=p>;</span>
</span></span><span class=line><span class=cl>          <span class=n>fwd</span><span class=o>-&gt;</span><span class=n>bk</span> <span class=o>=</span> <span class=n>remainder</span><span class=p>;</span>
</span></span><span class=line><span class=cl>          <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nf>in_smallbin_range</span><span class=p>(</span><span class=n>remainder_size</span><span class=p>))</span>
</span></span><span class=line><span class=cl>          <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>remainder</span><span class=o>-&gt;</span><span class=n>fd_nextsize</span> <span class=o>=</span> <span class=nb>NULL</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=n>remainder</span><span class=o>-&gt;</span><span class=n>bk_nextsize</span> <span class=o>=</span> <span class=nb>NULL</span><span class=p>;</span>
</span></span><span class=line><span class=cl>          <span class=p>}</span>
</span></span><span class=line><span class=cl>          <span class=c1>// 设置victim标志
</span></span></span><span class=line><span class=cl><span class=c1></span>          <span class=nf>set_head</span><span class=p>(</span><span class=n>victim</span><span class=p>,</span> <span class=n>nb</span> <span class=o>|</span> <span class=n>PREV_INUSE</span> <span class=o>|</span>
</span></span><span class=line><span class=cl>                               <span class=p>(</span><span class=n>av</span> <span class=o>!=</span> <span class=o>&amp;</span><span class=n>main_arena</span> <span class=o>?</span> <span class=nl>NON_MAIN_ARENA</span> <span class=p>:</span> <span class=mi>0</span><span class=p>));</span>
</span></span><span class=line><span class=cl>          <span class=nf>set_head</span><span class=p>(</span><span class=n>remainder</span><span class=p>,</span> <span class=n>remainder_size</span> <span class=o>|</span> <span class=n>PREV_INUSE</span><span class=p>);</span>
</span></span><span class=line><span class=cl>          <span class=nf>set_foot</span><span class=p>(</span><span class=n>remainder</span><span class=p>,</span> <span class=n>remainder_size</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=nf>check_malloced_chunk</span><span class=p>(</span><span class=n>av</span><span class=p>,</span> <span class=n>victim</span><span class=p>,</span> <span class=n>nb</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=kt>void</span> <span class=o>*</span><span class=n>p</span> <span class=o>=</span> <span class=nf>chunk2mem</span><span class=p>(</span><span class=n>victim</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nf>alloc_perturb</span><span class=p>(</span><span class=n>p</span><span class=p>,</span> <span class=n>bytes</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>p</span><span class=p>;</span> <span class=c1>// 从largebin中取出victim返回
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=o>++</span><span class=n>idx</span><span class=p>;</span> <span class=c1>// 正确的idx找不到chunk，加一看下一个索引:比当前binindex大的small/large bin 是否能找到chunk
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>bin</span> <span class=o>=</span> <span class=nf>bin_at</span><span class=p>(</span><span class=n>av</span><span class=p>,</span> <span class=n>idx</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>block</span> <span class=o>=</span> <span class=nf>idx2block</span><span class=p>(</span><span class=n>idx</span><span class=p>);</span> <span class=c1>// 将idx/32转移到binmap中的block, 32位一组block
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// #define idx2block(i) ((i) &gt;&gt; BINMAPSHIFT)
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// #define BINMAPSHIFT 5
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>map</span> <span class=o>=</span> <span class=n>av</span><span class=o>-&gt;</span><span class=n>binmap</span><span class=p>[</span><span class=n>block</span><span class=p>];</span> <span class=c1>// binmap用于加速查找bin是否包含空闲chunk
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>bit</span> <span class=o>=</span> <span class=nf>idx2bit</span><span class=p>(</span><span class=n>idx</span><span class=p>);</span> <span class=c1>// 将idx指定的位置1，其他位清零
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// #define idx2bit(i) ((1U &lt;&lt; ((i) &amp; ((1U &lt;&lt; BINMAPSHIFT) - 1))))
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(;;)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// 大于等于该bit位的位都未置1，表示该block没有可用的空闲chunk，需要搜索下一个block
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=k>if</span> <span class=p>(</span><span class=n>bit</span> <span class=o>&gt;</span> <span class=n>map</span> <span class=o>||</span> <span class=n>bit</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>do</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>     <span class=c1>// 加一换到下一组block
</span></span></span><span class=line><span class=cl><span class=c1></span>          <span class=k>if</span> <span class=p>(</span><span class=o>++</span><span class=n>block</span> <span class=o>&gt;=</span> <span class=n>BINMAPSIZE</span><span class=p>)</span> <span class=c1>// 检查是否超过范围
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=k>goto</span> <span class=n>use_top</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span> <span class=k>while</span> <span class=p>((</span><span class=n>map</span> <span class=o>=</span> <span class=n>av</span><span class=o>-&gt;</span><span class=n>binmap</span><span class=p>[</span><span class=n>block</span><span class=p>])</span> <span class=o>==</span> <span class=mi>0</span><span class=p>);</span> <span class=c1>// 直到找到一个不为0的block
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>        <span class=n>bin</span> <span class=o>=</span> <span class=nf>bin_at</span><span class=p>(</span><span class=n>av</span><span class=p>,</span> <span class=p>(</span><span class=n>block</span> <span class=o>&lt;&lt;</span> <span class=n>BINMAPSHIFT</span><span class=p>));</span> <span class=c1>// block*32转换为bin的位置
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>bit</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span> <span class=c1>// 可以确定有可用的chunk
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>      <span class=k>while</span> <span class=p>((</span><span class=n>bit</span> <span class=o>&amp;</span> <span class=n>map</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=c1>// 与后为0则表明没有可用chunk
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=p>{</span> <span class=c1>// 在一个block中遍历对应的bin直到找到一个bit不为0，退出遍历
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>bin</span> <span class=o>=</span> <span class=nf>next_bin</span><span class=p>(</span><span class=n>bin</span><span class=p>);</span> <span class=c1>// 找下一个bin
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>bit</span> <span class=o>&lt;&lt;=</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=nf>assert</span><span class=p>(</span><span class=n>bit</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>	  <span class=c1>// 获取bin中的最后一个chunk victim
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=n>victim</span> <span class=o>=</span> <span class=nf>last</span><span class=p>(</span><span class=n>bin</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=n>victim</span> <span class=o>==</span> <span class=n>bin</span><span class=p>)</span> <span class=c1>// victim与bin链表头相同则说明bin中无空闲chunk，binmap设置有误
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>av</span><span class=o>-&gt;</span><span class=n>binmap</span><span class=p>[</span><span class=n>block</span><span class=p>]</span> <span class=o>=</span> <span class=n>map</span> <span class=o>&amp;=</span> <span class=o>~</span><span class=n>bit</span><span class=p>;</span> <span class=c1>// 将binmap的相应bit位清零
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>bin</span> <span class=o>=</span> <span class=nf>next_bin</span><span class=p>(</span><span class=n>bin</span><span class=p>);</span> <span class=c1>// 获取下一个bin
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>bit</span> <span class=o>&lt;&lt;=</span> <span class=mi>1</span><span class=p>;</span> <span class=c1>// 将bit移到下一个bit位，即乘以2
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=k>else</span> <span class=c1>// bin中有空闲chunk，不为空，基本操作同之前
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>size</span> <span class=o>=</span> <span class=nf>chunksize</span><span class=p>(</span><span class=n>victim</span><span class=p>);</span> <span class=c1>// 获取大小
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>        <span class=cm>/*  We know the first chunk in this bin is big enough to use. */</span>
</span></span><span class=line><span class=cl>        <span class=nf>assert</span><span class=p>((</span><span class=kt>unsigned</span> <span class=kt>long</span><span class=p>)(</span><span class=n>size</span><span class=p>)</span> <span class=o>&gt;=</span> <span class=p>(</span><span class=kt>unsigned</span> <span class=kt>long</span><span class=p>)(</span><span class=n>nb</span><span class=p>));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>remainder_size</span> <span class=o>=</span> <span class=n>size</span> <span class=o>-</span> <span class=n>nb</span><span class=p>;</span> <span class=c1>// 计算切分出所需chunk后剩余部分大小
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nf>unlink</span><span class=p>(</span><span class=n>av</span><span class=p>,</span> <span class=n>victim</span><span class=p>,</span> <span class=n>bck</span><span class=p>,</span> <span class=n>fwd</span><span class=p>);</span> <span class=c1>// 从链表取出victim
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>        <span class=c1>// 无法切割
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>if</span> <span class=p>(</span><span class=n>remainder_size</span> <span class=o>&lt;</span> <span class=n>MINSIZE</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=nf>set_inuse_bit_at_offset</span><span class=p>(</span><span class=n>victim</span><span class=p>,</span> <span class=n>size</span><span class=p>);</span>
</span></span><span class=line><span class=cl>          <span class=k>if</span> <span class=p>(</span><span class=n>av</span> <span class=o>!=</span> <span class=o>&amp;</span><span class=n>main_arena</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>victim</span><span class=o>-&gt;</span><span class=n>size</span> <span class=o>|=</span> <span class=n>NON_MAIN_ARENA</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span> <span class=c1>// 可以切割，将切割出的remainder放入unsored bin
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=n>remainder</span> <span class=o>=</span> <span class=nf>chunk_at_offset</span><span class=p>(</span><span class=n>victim</span><span class=p>,</span> <span class=n>nb</span><span class=p>);</span>
</span></span><span class=line><span class=cl>          <span class=n>bck</span> <span class=o>=</span> <span class=nf>unsorted_chunks</span><span class=p>(</span><span class=n>av</span><span class=p>);</span>
</span></span><span class=line><span class=cl>          <span class=n>fwd</span> <span class=o>=</span> <span class=n>bck</span><span class=o>-&gt;</span><span class=n>fd</span><span class=p>;</span>
</span></span><span class=line><span class=cl>          <span class=k>if</span> <span class=p>(</span><span class=nf>__glibc_unlikely</span><span class=p>(</span><span class=n>fwd</span><span class=o>-&gt;</span><span class=n>bk</span> <span class=o>!=</span> <span class=n>bck</span><span class=p>))</span>
</span></span><span class=line><span class=cl>          <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>errstr</span> <span class=o>=</span> <span class=s>&#34;malloc(): corrupted unsorted chunks 2&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=k>goto</span> <span class=n>errout</span><span class=p>;</span>
</span></span><span class=line><span class=cl>          <span class=p>}</span>
</span></span><span class=line><span class=cl>          <span class=n>remainder</span><span class=o>-&gt;</span><span class=n>bk</span> <span class=o>=</span> <span class=n>bck</span><span class=p>;</span>
</span></span><span class=line><span class=cl>          <span class=n>remainder</span><span class=o>-&gt;</span><span class=n>fd</span> <span class=o>=</span> <span class=n>fwd</span><span class=p>;</span>
</span></span><span class=line><span class=cl>          <span class=n>bck</span><span class=o>-&gt;</span><span class=n>fd</span> <span class=o>=</span> <span class=n>remainder</span><span class=p>;</span>
</span></span><span class=line><span class=cl>          <span class=n>fwd</span><span class=o>-&gt;</span><span class=n>bk</span> <span class=o>=</span> <span class=n>remainder</span><span class=p>;</span>
</span></span><span class=line><span class=cl>          <span class=c1>// 若剩余部分chunk属于smallbin，将分配区的last_remainder chunk设置为remainder
</span></span></span><span class=line><span class=cl><span class=c1></span>          <span class=k>if</span> <span class=p>(</span><span class=nf>in_smallbin_range</span><span class=p>(</span><span class=n>nb</span><span class=p>))</span>
</span></span><span class=line><span class=cl>            <span class=n>av</span><span class=o>-&gt;</span><span class=n>last_remainder</span> <span class=o>=</span> <span class=n>remainder</span><span class=p>;</span>
</span></span><span class=line><span class=cl>          <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nf>in_smallbin_range</span><span class=p>(</span><span class=n>remainder_size</span><span class=p>))</span>
</span></span><span class=line><span class=cl>          <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>remainder</span><span class=o>-&gt;</span><span class=n>fd_nextsize</span> <span class=o>=</span> <span class=nb>NULL</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=n>remainder</span><span class=o>-&gt;</span><span class=n>bk_nextsize</span> <span class=o>=</span> <span class=nb>NULL</span><span class=p>;</span>
</span></span><span class=line><span class=cl>          <span class=p>}</span>
</span></span><span class=line><span class=cl>          <span class=nf>set_head</span><span class=p>(</span><span class=n>victim</span><span class=p>,</span> <span class=n>nb</span> <span class=o>|</span> <span class=n>PREV_INUSE</span> <span class=o>|</span>
</span></span><span class=line><span class=cl>                               <span class=p>(</span><span class=n>av</span> <span class=o>!=</span> <span class=o>&amp;</span><span class=n>main_arena</span> <span class=o>?</span> <span class=nl>NON_MAIN_ARENA</span> <span class=p>:</span> <span class=mi>0</span><span class=p>));</span>
</span></span><span class=line><span class=cl>          <span class=nf>set_head</span><span class=p>(</span><span class=n>remainder</span><span class=p>,</span> <span class=n>remainder_size</span> <span class=o>|</span> <span class=n>PREV_INUSE</span><span class=p>);</span>
</span></span><span class=line><span class=cl>          <span class=nf>set_foot</span><span class=p>(</span><span class=n>remainder</span><span class=p>,</span> <span class=n>remainder_size</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=nf>check_malloced_chunk</span><span class=p>(</span><span class=n>av</span><span class=p>,</span> <span class=n>victim</span><span class=p>,</span> <span class=n>nb</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=kt>void</span> <span class=o>*</span><span class=n>p</span> <span class=o>=</span> <span class=nf>chunk2mem</span><span class=p>(</span><span class=n>victim</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nf>alloc_perturb</span><span class=p>(</span><span class=n>p</span><span class=p>,</span> <span class=n>bytes</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>p</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// 均找不到可用chunk, 则切top chunk
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nl>use_top</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>victim</span> <span class=o>=</span> <span class=n>av</span><span class=o>-&gt;</span><span class=n>top</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>size</span> <span class=o>=</span> <span class=nf>chunksize</span><span class=p>(</span><span class=n>victim</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>((</span><span class=kt>unsigned</span> <span class=kt>long</span><span class=p>)(</span><span class=n>size</span><span class=p>)</span> <span class=o>&gt;=</span> <span class=p>(</span><span class=kt>unsigned</span> <span class=kt>long</span><span class=p>)(</span><span class=n>nb</span> <span class=o>+</span> <span class=n>MINSIZE</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>remainder_size</span> <span class=o>=</span> <span class=n>size</span> <span class=o>-</span> <span class=n>nb</span><span class=p>;</span> <span class=c1>// 切割出remainder
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=n>remainder</span> <span class=o>=</span> <span class=nf>chunk_at_offset</span><span class=p>(</span><span class=n>victim</span><span class=p>,</span> <span class=n>nb</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=n>av</span><span class=o>-&gt;</span><span class=n>top</span> <span class=o>=</span> <span class=n>remainder</span><span class=p>;</span> <span class=c1>// remainder成为新的top chunk
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=c1>// 设置标志位
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nf>set_head</span><span class=p>(</span><span class=n>victim</span><span class=p>,</span> <span class=n>nb</span> <span class=o>|</span> <span class=n>PREV_INUSE</span> <span class=o>|</span> <span class=p>(</span><span class=n>av</span> <span class=o>!=</span> <span class=o>&amp;</span><span class=n>main_arena</span> <span class=o>?</span> <span class=nl>NON_MAIN_ARENA</span> <span class=p>:</span> <span class=mi>0</span><span class=p>));</span>
</span></span><span class=line><span class=cl>      <span class=nf>set_head</span><span class=p>(</span><span class=n>remainder</span><span class=p>,</span> <span class=n>remainder_size</span> <span class=o>|</span> <span class=n>PREV_INUSE</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=nf>check_malloced_chunk</span><span class=p>(</span><span class=n>av</span><span class=p>,</span> <span class=n>victim</span><span class=p>,</span> <span class=n>nb</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=kt>void</span> <span class=o>*</span><span class=n>p</span> <span class=o>=</span> <span class=nf>chunk2mem</span><span class=p>(</span><span class=n>victim</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=nf>alloc_perturb</span><span class=p>(</span><span class=n>p</span><span class=p>,</span> <span class=n>bytes</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=n>p</span><span class=p>;</span> <span class=c1>// 返回top chunk切割出的victim
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=nf>have_fastchunks</span><span class=p>(</span><span class=n>av</span><span class=p>))</span> <span class=c1>// 看是否有fastchunk
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nf>malloc_consolidate</span><span class=p>(</span><span class=n>av</span><span class=p>);</span> <span class=c1>// 进一步处理fastchunk放入unsorted bin
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=k>if</span> <span class=p>(</span><span class=nf>in_smallbin_range</span><span class=p>(</span><span class=n>nb</span><span class=p>))</span> <span class=c1>// 再重新赋值idx找
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>idx</span> <span class=o>=</span> <span class=nf>smallbin_index</span><span class=p>(</span><span class=n>nb</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=k>else</span>
</span></span><span class=line><span class=cl>        <span class=n>idx</span> <span class=o>=</span> <span class=nf>largebin_index</span><span class=p>(</span><span class=n>nb</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=kt>void</span> <span class=o>*</span><span class=n>p</span> <span class=o>=</span> <span class=nf>sysmalloc</span><span class=p>(</span><span class=n>nb</span><span class=p>,</span> <span class=n>av</span><span class=p>);</span> <span class=c1>// 系统调用sysmalloc向操作系统申请内存返回堆块
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=k>if</span> <span class=p>(</span><span class=n>p</span> <span class=o>!=</span> <span class=nb>NULL</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nf>alloc_perturb</span><span class=p>(</span><span class=n>p</span><span class=p>,</span> <span class=n>bytes</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=n>p</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=c1>// 分配不到则死循环，在其他线程中找，要么报错要么找到并返回
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span> 
</span></span></code></pre></div></div><h5 id=checked_request2size>checked_request2size</h5><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-c"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=复制到剪贴板><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=c1>// 可用于prev_size复用
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=cp>#define checked_request2size(req, sz)
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=k>if</span> <span class=p>(</span><span class=nf>REQUEST_OUT_OF_RANGE</span> <span class=p>(</span><span class=n>req</span><span class=p>))</span> <span class=p>{</span> <span class=c1>// 看是否超过范围
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nf>__set_errno</span> <span class=p>(</span><span class=n>ENOMEM</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>(</span><span class=n>sz</span><span class=p>)</span> <span class=o>=</span> <span class=nf>request2size</span> <span class=p>(</span><span class=n>req</span><span class=p>);</span> <span class=c1>// 将申请内存转换为适合内存分配的块大小
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=cp>#define request2size(req) (((req) + SIZE_SZ + MALLOC_ALIGN_MASK &lt; MINSIZE)  ?
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=nl>MINSIZE</span> <span class=p>:</span> <span class=p>((</span><span class=n>req</span><span class=p>)</span> <span class=o>+</span> <span class=n>SIZE_SZ</span> <span class=o>+</span> <span class=n>MALLOC_ALIGN_MASK</span><span class=p>)</span> <span class=o>&amp;</span> <span class=o>~</span><span class=n>MALLOC_ALIGN_MASK</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=c1>// = bytes + sizeof(size_t)*2 + sizeof(size_t) - 1 关于 0x10 向下取整
</span></span></span></code></pre></div></div><ul><li><code>bytes</code>变化堆块大小使得与下一个堆块的<code>prev_size</code>重合，则8+7向下取整0，最终只申请<code>prev_size+size+bytes</code></li><li>若超过下一个堆块的<code>prev_size</code>，则9+7向下取整0x10，最终申请<code>prev_size+size+bytes+prev_size+size</code></li></ul><img src=/img/source_analyze.zh-cn.assets/image-20241119131202911.png alt=图片无法加载><h5 id=get_max_fast>get_max_fast</h5><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-c"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=复制到剪贴板><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#define get_max_fast() global_max_fast
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=cp>#define set_max_fast(s) 
</span></span></span><span class=line><span class=cl><span class=cp></span>	<span class=n>global_max_fast</span> <span class=o>=</span> <span class=p>(((</span><span class=n>s</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=o>?</span> <span class=nl>SMALLBIN_WIDTH</span> <span class=p>:</span> <span class=p>((</span><span class=n>s</span> <span class=o>+</span> <span class=n>SIZE_SZ</span><span class=p>)</span> <span class=o>&amp;</span> <span class=o>~</span><span class=n>MALLOC_ALIGN_MASK</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>set_max_fast</span><span class=p>(</span><span class=n>DEFAULT_MXFAST</span><span class=p>);</span> <span class=c1>// malloc_init_state函数中
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=cp>#define DEFAULT_MXFAST (64 * SIZE_SZ / 4) </span><span class=c1>// 64*8/4=128=0x80
</span></span></span></code></pre></div></div><h5 id=fastbin_index>fastbin_index</h5><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-c"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=复制到剪贴板><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#define fastbin_index(sz) ((((unsigned int)(sz)) &gt;&gt; (SIZE_SZ == 8 ? 4 : 3)) - 2)
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=c1>// 64位下 申请size右移4位再减2，最小的size为0x20，则0x20/16-2=0索引
</span></span></span></code></pre></div></div><h5 id=chunk_size>chunk_size</h5><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-c"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=复制到剪贴板><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#define chunksize(p) ((p)-&gt;size &amp; ~(SIZE_BITS)) </span><span class=c1>// 去除3个标志位后得到chunk的size
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=cp>#define SIZE_BITS (PREV_INUSE | IS_MMAPPED | NON_MAIN_ARENA)</span></span></span></code></pre></div></div><h5 id=chunk2mem>chunk2mem</h5><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-c"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=复制到剪贴板><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#define chunk2mem(p) ((void *)((char *)(p) + 2 * SIZE_SZ))
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=c1>// 将指向 prev_size 的指针偏移2个机器字长后指向 fd
</span></span></span></code></pre></div></div><h5 id=in_smallbin_range>in_smallbin_range</h5><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-c"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=复制到剪贴板><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#define in_smallbin_range(sz) ((unsigned long)(sz) &lt; (unsigned long)MIN_LARGE_SIZE)
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=c1>// 小于 largebin 最小的 size 
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=cp>#define MIN_LARGE_SIZE ((NSMALLBINS - SMALLBIN_CORRECTION) * SMALLBIN_WIDTH)
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=c1>// (64 - 0)*(2 * 8) = 0x400 = 1024
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=cp>#define NSMALLBINS 64
</span></span></span><span class=line><span class=cl><span class=cp>#define SMALLBIN_CORRECTION (MALLOC_ALIGNMENT &gt; 2 * SIZE_SZ)
</span></span></span><span class=line><span class=cl><span class=cp>#define SMALLBIN_WIDTH MALLOC_ALIGNMENT
</span></span></span><span class=line><span class=cl><span class=cp>#define MALLOC_ALIGNMENT (2 * SIZE_SZ)</span></span></span></code></pre></div></div><h5 id=malloc_consolidate>malloc_consolidate</h5><p>遍历fastbin，合并并放入unsorted bin中</p><div class="code-block code-line-numbers" style="counter-reset:code-block 0"><div class="code-header language-c"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=复制到剪贴板><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>static</span> <span class=kt>void</span> <span class=nf>malloc_consolidate</span><span class=p>(</span><span class=n>mstate</span> <span class=n>av</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>mfastbinptr</span> <span class=o>*</span><span class=n>fb</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>mfastbinptr</span> <span class=o>*</span><span class=n>maxfb</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>mchunkptr</span> <span class=n>p</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>mchunkptr</span> <span class=n>nextp</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>mchunkptr</span> <span class=n>unsorted_bin</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>mchunkptr</span> <span class=n>first_unsorted</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>  <span class=n>mchunkptr</span> <span class=n>nextchunk</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>INTERNAL_SIZE_T</span> <span class=n>size</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>INTERNAL_SIZE_T</span> <span class=n>nextsize</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>INTERNAL_SIZE_T</span> <span class=n>prevsize</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>int</span> <span class=n>nextinuse</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>mchunkptr</span> <span class=n>bck</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>mchunkptr</span> <span class=n>fwd</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nf>get_max_fast</span><span class=p>()</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>)</span> <span class=c1>// 已初始化
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nf>clear_fastchunks</span><span class=p>(</span><span class=n>av</span><span class=p>);</span> <span class=c1>// 清除fastchunk的标志位
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=n>unsorted_bin</span> <span class=o>=</span> <span class=nf>unsorted_chunks</span><span class=p>(</span><span class=n>av</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=c1>// #define unsorted_chunks(M) (bin_at(M, 1)) 获取unsorted_bin
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=n>maxfb</span> <span class=o>=</span> <span class=o>&amp;</span><span class=nf>fastbin</span><span class=p>(</span><span class=n>av</span><span class=p>,</span> <span class=n>NFASTBINS</span> <span class=o>-</span> <span class=mi>1</span><span class=p>);</span> <span class=c1>// 指向最大size的fastbin地址
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=c1>// #define NFASTBINS (fastbin_index(request2size(MAX_FAST_SIZE)) + 1)
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>fb</span> <span class=o>=</span> <span class=o>&amp;</span><span class=nf>fastbin</span><span class=p>(</span><span class=n>av</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span> <span class=c1>// 指向最小size的fastbin地址
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>do</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>p</span> <span class=o>=</span> <span class=nf>atomic_exchange_acq</span><span class=p>(</span><span class=n>fb</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span> <span class=c1>// 将fastbin置为0，而p指向fastbin第一个chunk
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=k>if</span> <span class=p>(</span><span class=n>p</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>do</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=nf>check_inuse_chunk</span><span class=p>(</span><span class=n>av</span><span class=p>,</span> <span class=n>p</span><span class=p>);</span> <span class=c1>// 具体是检查下一个相邻chunk的prev_size位
</span></span></span><span class=line><span class=cl><span class=c1></span>          <span class=n>nextp</span> <span class=o>=</span> <span class=n>p</span><span class=o>-&gt;</span><span class=n>fd</span><span class=p>;</span> <span class=c1>// p的下一个chunk
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>          <span class=n>size</span> <span class=o>=</span> <span class=n>p</span><span class=o>-&gt;</span><span class=n>size</span> <span class=o>&amp;</span> <span class=o>~</span><span class=p>(</span><span class=n>PREV_INUSE</span> <span class=o>|</span> <span class=n>NON_MAIN_ARENA</span><span class=p>);</span> <span class=c1>// p指向chunk的size
</span></span></span><span class=line><span class=cl><span class=c1></span>          <span class=n>nextchunk</span> <span class=o>=</span> <span class=nf>chunk_at_offset</span><span class=p>(</span><span class=n>p</span><span class=p>,</span> <span class=n>size</span><span class=p>);</span> <span class=c1>// 下一个chunk
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=c1>// #define chunk_at_offset(p, s) ((mchunkptr)(((char *)(p)) + (s)))
</span></span></span><span class=line><span class=cl><span class=c1></span>          <span class=n>nextsize</span> <span class=o>=</span> <span class=nf>chunksize</span><span class=p>(</span><span class=n>nextchunk</span><span class=p>);</span> <span class=c1>// 下一个chunk的size
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>          <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nf>prev_inuse</span><span class=p>(</span><span class=n>p</span><span class=p>))</span> <span class=c1>// 即p相邻上一个chunk空闲: 在small/large/unsorted bin中
</span></span></span><span class=line><span class=cl><span class=c1></span>          <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 前向合并
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>prevsize</span> <span class=o>=</span> <span class=n>p</span><span class=o>-&gt;</span><span class=n>prev_size</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=n>size</span> <span class=o>+=</span> <span class=n>prevsize</span><span class=p>;</span>	<span class=c1>// size变为前一个chunk大小加上当前size大小
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>p</span> <span class=o>=</span> <span class=nf>chunk_at_offset</span><span class=p>(</span><span class=n>p</span><span class=p>,</span> <span class=o>-</span><span class=p>((</span><span class=kt>long</span><span class=p>)</span><span class=n>prevsize</span><span class=p>));</span> <span class=c1>// p此时指向相邻上一个chunk
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=nf>unlink</span><span class=p>(</span><span class=n>av</span><span class=p>,</span> <span class=n>p</span><span class=p>,</span> <span class=n>bck</span><span class=p>,</span> <span class=n>fwd</span><span class=p>);</span> <span class=c1>// 将p从双向链表中取出
</span></span></span><span class=line><span class=cl><span class=c1></span>          <span class=p>}</span>
</span></span><span class=line><span class=cl>		  <span class=c1>// 下一个 chunk 不是 top chunk
</span></span></span><span class=line><span class=cl><span class=c1></span>          <span class=k>if</span> <span class=p>(</span><span class=n>nextchunk</span> <span class=o>!=</span> <span class=n>av</span><span class=o>-&gt;</span><span class=n>top</span><span class=p>)</span> 
</span></span><span class=line><span class=cl>          <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>nextinuse</span> <span class=o>=</span> <span class=nf>inuse_bit_at_offset</span><span class=p>(</span><span class=n>nextchunk</span><span class=p>,</span> <span class=n>nextsize</span><span class=p>);</span> 
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>nextinuse</span><span class=p>)</span><span class=c1>// 下一个chunk+nextsize偏移的prev_inuse为0，表示下一个chunk空闲
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=p>{</span>
</span></span><span class=line><span class=cl>              <span class=c1>// 后向合并
</span></span></span><span class=line><span class=cl><span class=c1></span>              <span class=n>size</span> <span class=o>+=</span> <span class=n>nextsize</span><span class=p>;</span>
</span></span><span class=line><span class=cl>              <span class=nf>unlink</span><span class=p>(</span><span class=n>av</span><span class=p>,</span> <span class=n>nextchunk</span><span class=p>,</span> <span class=n>bck</span><span class=p>,</span> <span class=n>fwd</span><span class=p>);</span> <span class=c1>// 将下一个chunk也脱链
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=k>else</span>
</span></span><span class=line><span class=cl>              <span class=nf>clear_inuse_bit_at_offset</span><span class=p>(</span><span class=n>nextchunk</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span> <span class=c1>// 下一个chunk的prev_inuse设为0，即当前chunk此时空闲
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>            <span class=n>first_unsorted</span> <span class=o>=</span> <span class=n>unsorted_bin</span><span class=o>-&gt;</span><span class=n>fd</span><span class=p>;</span> <span class=c1>// 第一个unsorted bin
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>unsorted_bin</span><span class=o>-&gt;</span><span class=n>fd</span> <span class=o>=</span> <span class=n>p</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=n>first_unsorted</span><span class=o>-&gt;</span><span class=n>bk</span> <span class=o>=</span> <span class=n>p</span><span class=p>;</span> <span class=c1>// 在unsorted bin链表头加入p，此处改unsorted bin原先chunk的指针
</span></span></span><span class=line><span class=cl><span class=c1></span>			
</span></span><span class=line><span class=cl>            <span class=c1>// 在 large bin 中将两个nextsize指针置空
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nf>in_smallbin_range</span><span class=p>(</span><span class=n>size</span><span class=p>))</span>
</span></span><span class=line><span class=cl>            <span class=p>{</span>
</span></span><span class=line><span class=cl>              <span class=n>p</span><span class=o>-&gt;</span><span class=n>fd_nextsize</span> <span class=o>=</span> <span class=nb>NULL</span><span class=p>;</span>
</span></span><span class=line><span class=cl>              <span class=n>p</span><span class=o>-&gt;</span><span class=n>bk_nextsize</span> <span class=o>=</span> <span class=nb>NULL</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=nf>set_head</span><span class=p>(</span><span class=n>p</span><span class=p>,</span> <span class=n>size</span> <span class=o>|</span> <span class=n>PREV_INUSE</span><span class=p>);</span> <span class=c1>// 设置p的size
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>p</span><span class=o>-&gt;</span><span class=n>bk</span> <span class=o>=</span> <span class=n>unsorted_bin</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=n>p</span><span class=o>-&gt;</span><span class=n>fd</span> <span class=o>=</span> <span class=n>first_unsorted</span><span class=p>;</span> <span class=c1>// 此处将p的bk和fd指针更改
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=nf>set_foot</span><span class=p>(</span><span class=n>p</span><span class=p>,</span> <span class=n>size</span><span class=p>);</span> <span class=c1>// 设置下一个chunk的prev_size为size
</span></span></span><span class=line><span class=cl><span class=c1></span>          <span class=p>}</span>
</span></span><span class=line><span class=cl>          <span class=k>else</span>
</span></span><span class=line><span class=cl>          <span class=p>{</span> <span class=c1>// 下一个chunk是top chunk，则将当前chunk合并入top chunk
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>size</span> <span class=o>+=</span> <span class=n>nextsize</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=nf>set_head</span><span class=p>(</span><span class=n>p</span><span class=p>,</span> <span class=n>size</span> <span class=o>|</span> <span class=n>PREV_INUSE</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=n>av</span><span class=o>-&gt;</span><span class=n>top</span> <span class=o>=</span> <span class=n>p</span><span class=p>;</span>
</span></span><span class=line><span class=cl>          <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=p>}</span> <span class=k>while</span> <span class=p>((</span><span class=n>p</span> <span class=o>=</span> <span class=n>nextp</span><span class=p>)</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>);</span> <span class=c1>// 内部循环某个fastbin的链表中的chunk，合并+放入unsorted bin中
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>while</span> <span class=p>(</span><span class=n>fb</span><span class=o>++</span> <span class=o>!=</span> <span class=n>maxfb</span><span class=p>);</span> <span class=c1>// 循环整个fastbin 
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>else</span> <span class=c1>// global_max_fast为0则初始化
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nf>malloc_init_state</span><span class=p>(</span><span class=n>av</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>check_malloc_state</span><span class=p>(</span><span class=n>av</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div><h5 id=malloc_init_state>malloc_init_state</h5><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-c"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=复制到剪贴板><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>static</span> <span class=kt>void</span> <span class=nf>malloc_init_state</span><span class=p>(</span><span class=n>mstate</span> <span class=n>av</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kt>int</span> <span class=n>i</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>mbinptr</span> <span class=n>bin</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>  <span class=k>for</span> <span class=p>(</span><span class=n>i</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>NBINS</span><span class=p>;</span> <span class=o>++</span><span class=n>i</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>bin</span> <span class=o>=</span> <span class=nf>bin_at</span><span class=p>(</span><span class=n>av</span><span class=p>,</span> <span class=n>i</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>bin</span><span class=o>-&gt;</span><span class=n>fd</span> <span class=o>=</span> <span class=n>bin</span><span class=o>-&gt;</span><span class=n>bk</span> <span class=o>=</span> <span class=n>bin</span><span class=p>;</span> <span class=c1>// 初始化创建循环链表
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cp>#if MORECORE_CONTIGUOUS
</span></span></span><span class=line><span class=cl><span class=cp></span>  <span class=k>if</span> <span class=p>(</span><span class=n>av</span> <span class=o>!=</span> <span class=o>&amp;</span><span class=n>main_arena</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=cp>#endif
</span></span></span><span class=line><span class=cl><span class=cp></span>    <span class=nf>set_noncontiguous</span><span class=p>(</span><span class=n>av</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>av</span> <span class=o>==</span> <span class=o>&amp;</span><span class=n>main_arena</span><span class=p>)</span> <span class=c1>// 若为主线程
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nf>set_max_fast</span><span class=p>(</span><span class=n>DEFAULT_MXFAST</span><span class=p>);</span> <span class=c1>// 设置global_max_fast为0x80，即fastbin最大size
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>av</span><span class=o>-&gt;</span><span class=n>flags</span> <span class=o>|=</span> <span class=n>FASTCHUNKS_BIT</span><span class=p>;</span> <span class=c1>// FASTCHUNKS_BIT = 1U 设置标志位
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=n>av</span><span class=o>-&gt;</span><span class=n>top</span> <span class=o>=</span> <span class=nf>initial_top</span><span class=p>(</span><span class=n>av</span><span class=p>);</span> <span class=c1>// 初始化分配区的top chunk
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span></span></span></code></pre></div></div><h5 id=unlink>unlink</h5><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-c"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=复制到剪贴板><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#define unlink(AV, P, BK, FD)
</span></span></span><span class=line><span class=cl><span class=cp></span>  <span class=p>{</span>                                                                                                     
</span></span><span class=line><span class=cl>    <span class=n>FD</span> <span class=o>=</span> <span class=n>P</span><span class=o>-&gt;</span><span class=n>fd</span><span class=p>;</span> <span class=c1>// p在bin中下一个chunk
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>BK</span> <span class=o>=</span> <span class=n>P</span><span class=o>-&gt;</span><span class=n>bk</span><span class=p>;</span> <span class=c1>// p在bin中上一个chunk
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=nf>__builtin_expect</span><span class=p>(</span><span class=n>FD</span><span class=o>-&gt;</span><span class=n>bk</span> <span class=o>!=</span> <span class=n>P</span> <span class=o>||</span> <span class=n>BK</span><span class=o>-&gt;</span><span class=n>fd</span> <span class=o>!=</span> <span class=n>P</span><span class=p>,</span> <span class=mi>0</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 检查fd和bk应该对应相互指向对方
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nf>malloc_printerr</span><span class=p>(</span><span class=n>check_action</span><span class=p>,</span> <span class=s>&#34;corrupted double-linked list&#34;</span><span class=p>,</span> <span class=n>P</span><span class=p>,</span> <span class=n>AV</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>FD</span><span class=o>-&gt;</span><span class=n>bk</span> <span class=o>=</span> <span class=n>BK</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=n>BK</span><span class=o>-&gt;</span><span class=n>fd</span> <span class=o>=</span> <span class=n>FD</span><span class=p>;</span> <span class=c1>// 将中间的p chunk脱离
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nf>in_smallbin_range</span><span class=p>(</span><span class=n>P</span><span class=o>-&gt;</span><span class=n>size</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=nf>__builtin_expect</span><span class=p>(</span><span class=n>P</span><span class=o>-&gt;</span><span class=n>fd_nextsize</span> <span class=o>!=</span> <span class=nb>NULL</span><span class=p>,</span> <span class=mi>0</span><span class=p>))</span>
</span></span><span class=line><span class=cl>      <span class=p>{</span> <span class=c1>// 若 P 属于 large bin 且 fd-&gt;nextsize 不为空
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>if</span> <span class=p>(</span><span class=nf>__builtin_expect</span><span class=p>(</span><span class=n>P</span><span class=o>-&gt;</span><span class=n>fd_nextsize</span><span class=o>-&gt;</span><span class=n>bk_nextsize</span> <span class=o>!=</span> <span class=n>P</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span> <span class=o>||</span> 
</span></span><span class=line><span class=cl>            <span class=nf>__builtin_expect</span><span class=p>(</span><span class=n>P</span><span class=o>-&gt;</span><span class=n>bk_nextsize</span><span class=o>-&gt;</span><span class=n>fd_nextsize</span> <span class=o>!=</span> <span class=n>P</span><span class=p>,</span> <span class=mi>0</span><span class=p>))</span>
</span></span><span class=line><span class=cl>          <span class=c1>// 判断 fd_nextsize 和 bk_nextsize 是否合法: 相互对应指向对方
</span></span></span><span class=line><span class=cl><span class=c1></span>          <span class=nf>malloc_printerr</span><span class=p>(</span><span class=n>check_action</span><span class=p>,</span><span class=s>&#34;corrupted double-linked list (not small)&#34;</span><span class=p>,</span> <span class=n>P</span><span class=p>,</span> <span class=n>AV</span><span class=p>);</span>
</span></span><span class=line><span class=cl>          
</span></span><span class=line><span class=cl>        <span class=c1>// 下一个chunk的fd_nextsize为空
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>if</span> <span class=p>(</span><span class=n>FD</span><span class=o>-&gt;</span><span class=n>fd_nextsize</span> <span class=o>==</span> <span class=nb>NULL</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=k>if</span> <span class=p>(</span><span class=n>P</span><span class=o>-&gt;</span><span class=n>fd_nextsize</span> <span class=o>==</span> <span class=n>P</span><span class=p>)</span> <span class=c1>// p的fd_nextsize指向自己: p和FD size相等
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>FD</span><span class=o>-&gt;</span><span class=n>fd_nextsize</span> <span class=o>=</span> <span class=n>FD</span><span class=o>-&gt;</span><span class=n>bk_nextsize</span> <span class=o>=</span> <span class=n>FD</span><span class=p>;</span> <span class=c1>// 此时FD替代p将两个nextsize指针指向自己
</span></span></span><span class=line><span class=cl><span class=c1></span>          <span class=k>else</span> <span class=c1>// p的fd_nextsize不指向自己: p和FD size相等
</span></span></span><span class=line><span class=cl><span class=c1></span>          <span class=p>{</span> <span class=c1>// 此时FD替代p将两个nextsize指针指向p原本指向的chunk
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>FD</span><span class=o>-&gt;</span><span class=n>fd_nextsize</span> <span class=o>=</span> <span class=n>P</span><span class=o>-&gt;</span><span class=n>fd_nextsize</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=n>FD</span><span class=o>-&gt;</span><span class=n>bk_nextsize</span> <span class=o>=</span> <span class=n>P</span><span class=o>-&gt;</span><span class=n>bk_nextsize</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=n>P</span><span class=o>-&gt;</span><span class=n>fd_nextsize</span><span class=o>-&gt;</span><span class=n>bk_nextsize</span> <span class=o>=</span> <span class=n>FD</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=n>P</span><span class=o>-&gt;</span><span class=n>bk_nextsize</span><span class=o>-&gt;</span><span class=n>fd_nextsize</span> <span class=o>=</span> <span class=n>FD</span><span class=p>;</span> <span class=c1>// 相互指
</span></span></span><span class=line><span class=cl><span class=c1></span>          <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 下一个chunk的fd_nextsize不为空: p和FD size不相等
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>else</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=n>P</span><span class=o>-&gt;</span><span class=n>fd_nextsize</span><span class=o>-&gt;</span><span class=n>bk_nextsize</span> <span class=o>=</span> <span class=n>P</span><span class=o>-&gt;</span><span class=n>bk_nextsize</span><span class=p>;</span>
</span></span><span class=line><span class=cl>          <span class=n>P</span><span class=o>-&gt;</span><span class=n>bk_nextsize</span><span class=o>-&gt;</span><span class=n>fd_nextsize</span> <span class=o>=</span> <span class=n>P</span><span class=o>-&gt;</span><span class=n>fd_nextsize</span><span class=p>;</span> 
</span></span><span class=line><span class=cl>          <span class=c1>// FD的两个nextsize替换为p的两个nextsize
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span></span></span></code></pre></div></div><h5 id=alloc_perturb>alloc_perturb</h5><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-c"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=复制到剪贴板><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>static</span> <span class=kt>void</span> <span class=nf>alloc_perturb</span><span class=p>(</span><span class=kt>char</span> <span class=o>*</span><span class=n>p</span><span class=p>,</span> <span class=kt>size_t</span> <span class=n>n</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nf>__glibc_unlikely</span><span class=p>(</span><span class=n>perturb_byte</span><span class=p>))</span> <span class=c1>// 若perturb_byte不为0
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nf>memset</span><span class=p>(</span><span class=n>p</span><span class=p>,</span> <span class=n>perturb_byte</span> <span class=o>^</span> <span class=mh>0xff</span><span class=p>,</span> <span class=n>n</span><span class=p>);</span> <span class=c1>// 设置内存为该值的最低1字节，可能导致程序崩溃
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span></span></span></code></pre></div></div><h4 id=227>2.27</h4><h5 id=__libc_malloc-1>__libc_malloc</h5><p>主要讲解变化</p><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-c"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=复制到剪贴板><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=kt>void</span> <span class=o>*</span><span class=nf>__libc_malloc</span><span class=p>(</span><span class=kt>size_t</span> <span class=n>bytes</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 增加
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=cp>#if USE_TCACHE
</span></span></span><span class=line><span class=cl><span class=cp></span>  <span class=kt>size_t</span> <span class=n>tbytes</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nf>checked_request2size</span><span class=p>(</span><span class=n>bytes</span><span class=p>,</span> <span class=n>tbytes</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=kt>size_t</span> <span class=n>tc_idx</span> <span class=o>=</span> <span class=nf>csize2tidx</span><span class=p>(</span><span class=n>tbytes</span><span class=p>);</span> <span class=c1>// 获取tcache的索引
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=nf>MAYBE_INIT_TCACHE</span><span class=p>();</span> <span class=c1>// tcache初始化
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm>  	#define MAYBE_INIT_TCACHE()
</span></span></span><span class=line><span class=cl><span class=cm>  		if (__glibc_unlikely(tcache == NULL))
</span></span></span><span class=line><span class=cl><span class=cm>    		tcache_init();
</span></span></span><span class=line><span class=cl><span class=cm>  */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>DIAG_PUSH_NEEDS_COMMENT</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=c1>// mp_.tcache_bins = TCACHE_MAX_BINS = 64
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=p>(</span><span class=n>tc_idx</span> <span class=o>&lt;</span> <span class=n>mp_</span><span class=p>.</span><span class=n>tcache_bins</span> <span class=o>&amp;&amp;</span> <span class=n>tcache</span> <span class=o>&amp;&amp;</span> <span class=n>tcache</span><span class=o>-&gt;</span><span class=n>entries</span><span class=p>[</span><span class=n>tc_idx</span><span class=p>]</span> <span class=o>!=</span> <span class=nb>NULL</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span> <span class=c1>// 在tcache范围内，且entries指向不为空
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>return</span> <span class=nf>tcache_get</span><span class=p>(</span><span class=n>tc_idx</span><span class=p>);</span> <span class=c1>// 获取tcache并返回
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=n>DIAG_POP_NEEDS_COMMENT</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=cp>#endif
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>SINGLE_THREAD_P</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>victim</span> <span class=o>=</span> <span class=nf>_int_malloc</span><span class=p>(</span><span class=o>&amp;</span><span class=n>main_arena</span><span class=p>,</span> <span class=n>bytes</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>assert</span><span class=p>(</span><span class=o>!</span><span class=n>victim</span> <span class=o>||</span> <span class=nf>chunk_is_mmapped</span><span class=p>(</span><span class=nf>mem2chunk</span><span class=p>(</span><span class=n>victim</span><span class=p>))</span> <span class=o>||</span>
</span></span><span class=line><span class=cl>           <span class=o>&amp;</span><span class=n>main_arena</span> <span class=o>==</span> <span class=nf>arena_for_chunk</span><span class=p>(</span><span class=nf>mem2chunk</span><span class=p>(</span><span class=n>victim</span><span class=p>)));</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>victim</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 变化
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm>  if (ar_ptr != NULL) 
</span></span></span><span class=line><span class=cl><span class=cm>    (void) mutex_unlock (&amp;ar_ptr-&gt;mutex)
</span></span></span><span class=line><span class=cl><span class=cm>*/</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>ar_ptr</span> <span class=o>!=</span> <span class=nb>NULL</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nf>__libc_lock_unlock</span><span class=p>(</span><span class=n>ar_ptr</span><span class=o>-&gt;</span><span class=n>mutex</span><span class=p>);</span> 
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div><h5 id=_int_malloc-1>_int_malloc</h5><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-c"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=复制到剪贴板><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=c1>// 增加 fastbin中
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=cp>#if USE_TCACHE
</span></span></span><span class=line><span class=cl><span class=cp></span>        <span class=kt>size_t</span> <span class=n>tc_idx</span> <span class=o>=</span> <span class=nf>csize2tidx</span><span class=p>(</span><span class=n>nb</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>tcache</span> <span class=o>&amp;&amp;</span> <span class=n>tc_idx</span> <span class=o>&lt;</span> <span class=n>mp_</span><span class=p>.</span><span class=n>tcache_bins</span><span class=p>)</span> <span class=c1>// 若在tcache范围内
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=n>mchunkptr</span> <span class=n>tc_victim</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>          <span class=k>while</span> <span class=p>(</span><span class=n>tcache</span><span class=o>-&gt;</span><span class=n>counts</span><span class=p>[</span><span class=n>tc_idx</span><span class=p>]</span> <span class=o>&lt;</span> <span class=n>mp_</span><span class=p>.</span><span class=n>tcache_count</span> <span class=o>&amp;&amp;</span> <span class=p>(</span><span class=n>tc_victim</span> <span class=o>=</span> <span class=o>*</span><span class=n>fb</span><span class=p>)</span> <span class=o>!=</span> <span class=nb>NULL</span><span class=p>)</span>
</span></span><span class=line><span class=cl>          <span class=p>{</span> <span class=c1>// 小于mp_.tcache_count=7即tcache没装满：遍历将fastbin中chunk加到tcache中直到满7个或fastbin为空
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=k>if</span> <span class=p>(</span><span class=n>SINGLE_THREAD_P</span><span class=p>)</span> <span class=c1>// 单线程
</span></span></span><span class=line><span class=cl><span class=c1></span>              <span class=o>*</span><span class=n>fb</span> <span class=o>=</span> <span class=n>tc_victim</span><span class=o>-&gt;</span><span class=n>fd</span><span class=p>;</span> <span class=c1>// 取出一个空闲chunk
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=k>else</span>
</span></span><span class=line><span class=cl>            <span class=p>{</span>
</span></span><span class=line><span class=cl>              <span class=nf>REMOVE_FB</span><span class=p>(</span><span class=n>fb</span><span class=p>,</span> <span class=n>pp</span><span class=p>,</span> <span class=n>tc_victim</span><span class=p>);</span> <span class=c1>// 取出一个空闲chunk
</span></span></span><span class=line><span class=cl><span class=c1></span>              <span class=k>if</span> <span class=p>(</span><span class=nf>__glibc_unlikely</span><span class=p>(</span><span class=n>tc_victim</span> <span class=o>==</span> <span class=nb>NULL</span><span class=p>))</span>
</span></span><span class=line><span class=cl>                <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=nf>tcache_put</span><span class=p>(</span><span class=n>tc_victim</span><span class=p>,</span> <span class=n>tc_idx</span><span class=p>);</span> <span class=c1>// 把fastbin中拿出的chunk加入到tcache链表中
</span></span></span><span class=line><span class=cl><span class=c1></span>          <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=cp>#endif
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=c1>// 增加 small bin中
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=cp>#if USE_TCACHE
</span></span></span><span class=line><span class=cl><span class=cp></span>      <span class=kt>size_t</span> <span class=n>tc_idx</span> <span class=o>=</span> <span class=nf>csize2tidx</span><span class=p>(</span><span class=n>nb</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=n>tcache</span> <span class=o>&amp;&amp;</span> <span class=n>tc_idx</span> <span class=o>&lt;</span> <span class=n>mp_</span><span class=p>.</span><span class=n>tcache_bins</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>mchunkptr</span> <span class=n>tc_victim</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>while</span> <span class=p>(</span><span class=n>tcache</span><span class=o>-&gt;</span><span class=n>counts</span><span class=p>[</span><span class=n>tc_idx</span><span class=p>]</span> <span class=o>&lt;</span> <span class=n>mp_</span><span class=p>.</span><span class=n>tcache_count</span> <span class=o>&amp;&amp;</span> <span class=p>(</span><span class=n>tc_victim</span> <span class=o>=</span> <span class=nf>last</span><span class=p>(</span><span class=n>bin</span><span class=p>))</span> <span class=o>!=</span> <span class=n>bin</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=k>if</span> <span class=p>(</span><span class=n>tc_victim</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>          <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>bck</span> <span class=o>=</span> <span class=n>tc_victim</span><span class=o>-&gt;</span><span class=n>bk</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=nf>set_inuse_bit_at_offset</span><span class=p>(</span><span class=n>tc_victim</span><span class=p>,</span> <span class=n>nb</span><span class=p>);</span> <span class=c1>// 设置tc_victim物理相邻的下一个chunk的prev_inuse位
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=k>if</span> <span class=p>(</span><span class=n>av</span> <span class=o>!=</span> <span class=o>&amp;</span><span class=n>main_arena</span><span class=p>)</span>
</span></span><span class=line><span class=cl>              <span class=nf>set_non_main_arena</span><span class=p>(</span><span class=n>tc_victim</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=n>bin</span><span class=o>-&gt;</span><span class=n>bk</span> <span class=o>=</span> <span class=n>bck</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=n>bck</span><span class=o>-&gt;</span><span class=n>fd</span> <span class=o>=</span> <span class=n>bin</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=nf>tcache_put</span><span class=p>(</span><span class=n>tc_victim</span><span class=p>,</span> <span class=n>tc_idx</span><span class=p>);</span><span class=c1>// 把small bin中拿出的chunk加入到tcache中
</span></span></span><span class=line><span class=cl><span class=c1></span>          <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=cp>#endif</span></span></span></code></pre></div></div><h5 id=remove_fb>REMOVE_FB</h5><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-c"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=复制到剪贴板><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#define REMOVE_FB(fb, victim, pp) </span><span class=c1>// 封装成一个宏,CAS操作
</span></span></span><span class=line><span class=cl><span class=c1>// 从刚刚得到的空闲chunk链表指针中取出第一个空闲的chunk(victim)
</span></span></span><span class=line><span class=cl><span class=c1>// 并将链表头设置为该空闲chunk的下一个chunk(victim-&gt;fd)
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>do</span>                              
</span></span><span class=line><span class=cl>  <span class=p>{</span>                               
</span></span><span class=line><span class=cl>    <span class=n>victim</span> <span class=o>=</span> <span class=n>pp</span><span class=p>;</span>                  
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>victim</span> <span class=o>==</span> <span class=nb>NULL</span><span class=p>)</span>           
</span></span><span class=line><span class=cl>      <span class=k>break</span><span class=p>;</span>                      
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=k>while</span> <span class=p>((</span><span class=n>pp</span> <span class=o>=</span> <span class=nf>catomic_compare_and_exchange_val_acq</span><span class=p>(</span><span class=n>fb</span><span class=p>,</span> <span class=n>victim</span><span class=o>-&gt;</span><span class=n>fd</span><span class=p>,</span> <span class=n>victim</span><span class=p>))</span> <span class=o>!=</span> <span class=n>victim</span><span class=p>);</span></span></span></code></pre></div></div><h5 id=tcache_init>tcache_init</h5><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-c"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=复制到剪贴板><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>static</span> <span class=kt>void</span> <span class=nf>tcache_init</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>mstate</span> <span class=n>ar_ptr</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>void</span> <span class=o>*</span><span class=n>victim</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>const</span> <span class=kt>size_t</span> <span class=n>bytes</span> <span class=o>=</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>tcache_perthread_struct</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>tcache_shutting_down</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nf>arena_get</span><span class=p>(</span><span class=n>ar_ptr</span><span class=p>,</span> <span class=n>bytes</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=n>victim</span> <span class=o>=</span> <span class=nf>_int_malloc</span><span class=p>(</span><span class=n>ar_ptr</span><span class=p>,</span> <span class=n>bytes</span><span class=p>);</span> <span class=c1>// 通过_int_malloc获取内存chunk
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>victim</span> <span class=o>&amp;&amp;</span> <span class=n>ar_ptr</span> <span class=o>!=</span> <span class=nb>NULL</span><span class=p>)</span> 
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>ar_ptr</span> <span class=o>=</span> <span class=nf>arena_get_retry</span><span class=p>(</span><span class=n>ar_ptr</span><span class=p>,</span> <span class=n>bytes</span><span class=p>);</span> <span class=c1>// 获取下一个分配区
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>victim</span> <span class=o>=</span> <span class=nf>_int_malloc</span><span class=p>(</span><span class=n>ar_ptr</span><span class=p>,</span> <span class=n>bytes</span><span class=p>);</span> <span class=c1>// 再次malloc
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>ar_ptr</span> <span class=o>!=</span> <span class=nb>NULL</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nf>__libc_lock_unlock</span><span class=p>(</span><span class=n>ar_ptr</span><span class=o>-&gt;</span><span class=n>mutex</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 申请成功
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=p>(</span><span class=n>victim</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>tcache</span> <span class=o>=</span> <span class=p>(</span><span class=n>tcache_perthread_struct</span> <span class=o>*</span><span class=p>)</span><span class=n>victim</span><span class=p>;</span> <span class=c1>// 将victim给tcache，每个线程都有一个tcache缓解竞争
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nf>memset</span><span class=p>(</span><span class=n>tcache</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>tcache_perthread_struct</span><span class=p>));</span> <span class=c1>// 清空数据
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div><h5 id=tcache_get>tcache_get</h5><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-c"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=复制到剪贴板><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>static</span> <span class=n>__always_inline</span> <span class=kt>void</span> <span class=o>*</span><span class=nf>tcache_get</span><span class=p>(</span><span class=kt>size_t</span> <span class=n>tc_idx</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>tcache_entry</span> <span class=o>*</span><span class=n>e</span> <span class=o>=</span> <span class=n>tcache</span><span class=o>-&gt;</span><span class=n>entries</span><span class=p>[</span><span class=n>tc_idx</span><span class=p>];</span> <span class=c1>// 从entries中取出入口指针
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nf>assert</span><span class=p>(</span><span class=n>tc_idx</span> <span class=o>&lt;</span> <span class=n>TCACHE_MAX_BINS</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=nf>assert</span><span class=p>(</span><span class=n>tcache</span><span class=o>-&gt;</span><span class=n>entries</span><span class=p>[</span><span class=n>tc_idx</span><span class=p>]</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=n>tcache</span><span class=o>-&gt;</span><span class=n>entries</span><span class=p>[</span><span class=n>tc_idx</span><span class=p>]</span> <span class=o>=</span> <span class=n>e</span><span class=o>-&gt;</span><span class=n>next</span><span class=p>;</span> <span class=c1>// 更新entries，指向其下一个chunk
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=o>--</span><span class=p>(</span><span class=n>tcache</span><span class=o>-&gt;</span><span class=n>counts</span><span class=p>[</span><span class=n>tc_idx</span><span class=p>]);</span> <span class=c1>// counts减少一个
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>return</span> <span class=p>(</span><span class=kt>void</span> <span class=o>*</span><span class=p>)</span><span class=n>e</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div><h5 id=tcache_put>tcache_put</h5><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-c"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=复制到剪贴板><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>static</span> <span class=n>__always_inline</span> <span class=kt>void</span> <span class=nf>tcache_put</span><span class=p>(</span><span class=n>mchunkptr</span> <span class=n>chunk</span><span class=p>,</span> <span class=kt>size_t</span> <span class=n>tc_idx</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span> <span class=c1>// 将其放入tcache中
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>tcache_entry</span> <span class=o>*</span><span class=n>e</span> <span class=o>=</span> <span class=p>(</span><span class=n>tcache_entry</span> <span class=o>*</span><span class=p>)</span><span class=nf>chunk2mem</span><span class=p>(</span><span class=n>chunk</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=nf>assert</span><span class=p>(</span><span class=n>tc_idx</span> <span class=o>&lt;</span> <span class=n>TCACHE_MAX_BINS</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=n>e</span><span class=o>-&gt;</span><span class=n>next</span> <span class=o>=</span> <span class=n>tcache</span><span class=o>-&gt;</span><span class=n>entries</span><span class=p>[</span><span class=n>tc_idx</span><span class=p>];</span>
</span></span><span class=line><span class=cl>  <span class=n>tcache</span><span class=o>-&gt;</span><span class=n>entries</span><span class=p>[</span><span class=n>tc_idx</span><span class=p>]</span> <span class=o>=</span> <span class=n>e</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=o>++</span><span class=p>(</span><span class=n>tcache</span><span class=o>-&gt;</span><span class=n>counts</span><span class=p>[</span><span class=n>tc_idx</span><span class=p>]);</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div><h5 id=unlink-1>unlink</h5><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-c"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=复制到剪贴板><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#define unlink(AV, P, BK, FD) {
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=c1>// 增加 开头加了一个判断：P的 chunk 大小需要等于下一个 chunk 的 prev_size
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=nf>__builtin_expect</span> <span class=p>(</span><span class=nf>chunksize</span><span class=p>(</span><span class=n>P</span><span class=p>)</span> <span class=o>!=</span> <span class=nf>prev_size</span> <span class=p>(</span><span class=nf>next_chunk</span><span class=p>(</span><span class=n>P</span><span class=p>)),</span> <span class=mi>0</span><span class=p>))</span>
</span></span><span class=line><span class=cl>      <span class=nf>malloc_printerr</span> <span class=p>(</span><span class=s>&#34;corrupted size vs. prev_size&#34;</span><span class=p>);</span>			      
</span></span></code></pre></div></div><h3 id=sysmalloc>sysmalloc</h3><h4 id=223-1>2.23</h4><h5 id=sysmalloc-1>sysmalloc</h5><div class="code-block code-line-numbers" style="counter-reset:code-block 0"><div class="code-header language-c"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=复制到剪贴板><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>static</span> <span class=kt>void</span> <span class=o>*</span><span class=nf>sysmalloc</span><span class=p>(</span><span class=n>INTERNAL_SIZE_T</span> <span class=n>nb</span><span class=p>,</span> <span class=n>mstate</span> <span class=n>av</span><span class=p>)</span> <span class=c1>// 需要申请的大小need_bytes + mainarena
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>mchunkptr</span> <span class=n>old_top</span><span class=p>;</span>        <span class=cm>/* av-&gt;top的原始值 */</span>
</span></span><span class=line><span class=cl>  <span class=n>INTERNAL_SIZE_T</span> <span class=n>old_size</span><span class=p>;</span> <span class=cm>/* av-&gt;top大小 */</span>
</span></span><span class=line><span class=cl>  <span class=kt>char</span> <span class=o>*</span><span class=n>old_end</span><span class=p>;</span>            <span class=cm>/* av-&gt;top结束地址 */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kt>long</span> <span class=n>size</span><span class=p>;</span> <span class=cm>/* 给MORECORE或mmap调用的参数 */</span>
</span></span><span class=line><span class=cl>  <span class=kt>char</span> <span class=o>*</span><span class=n>brk</span><span class=p>;</span> <span class=cm>/* MORECORE返回值 */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kt>long</span> <span class=n>correction</span><span class=p>;</span> <span class=cm>/* 给第二个MORECORE调用的参数 */</span>
</span></span><span class=line><span class=cl>  <span class=kt>char</span> <span class=o>*</span><span class=n>snd_brk</span><span class=p>;</span>   <span class=cm>/* MORECORE第二个返回值 */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>INTERNAL_SIZE_T</span> <span class=n>front_misalign</span><span class=p>;</span> <span class=cm>/* 新空间前的不可用字节 */</span>
</span></span><span class=line><span class=cl>  <span class=n>INTERNAL_SIZE_T</span> <span class=n>end_misalign</span><span class=p>;</span>   <span class=cm>/* partial page left at end of new space */</span>
</span></span><span class=line><span class=cl>  <span class=kt>char</span> <span class=o>*</span><span class=n>aligned_brk</span><span class=p>;</span>              <span class=cm>/* aligned offset into brk */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>mchunkptr</span> <span class=n>p</span><span class=p>;</span>                  <span class=cm>/* the allocated/returned chunk */</span>
</span></span><span class=line><span class=cl>  <span class=n>mchunkptr</span> <span class=n>remainder</span><span class=p>;</span>          <span class=cm>/* remainder from allocation */</span>
</span></span><span class=line><span class=cl>  <span class=kt>unsigned</span> <span class=kt>long</span> <span class=n>remainder_size</span><span class=p>;</span> <span class=cm>/* its size */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kt>size_t</span> <span class=n>pagesize</span> <span class=o>=</span> <span class=nf>GLRO</span><span class=p>(</span><span class=n>dl_pagesize</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=kt>bool</span> <span class=n>tried_mmap</span> <span class=o>=</span> <span class=nb>false</span><span class=p>;</span> <span class=c1>// 标记是否尝试过mmap
</span></span></span><span class=line><span class=cl><span class=c1></span>  
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>av</span> <span class=o>==</span> <span class=nb>NULL</span> <span class=o>||</span> <span class=c1>// 无arena，则也没有top chunk
</span></span></span><span class=line><span class=cl><span class=c1></span>     <span class=p>((</span><span class=kt>unsigned</span> <span class=kt>long</span><span class=p>)(</span><span class=n>nb</span><span class=p>)</span> <span class=o>&gt;=</span> <span class=p>(</span><span class=kt>unsigned</span> <span class=kt>long</span><span class=p>)(</span><span class=n>mp_</span><span class=p>.</span><span class=n>mmap_threshold</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=c1>// 大于mmap阈值则使用mmap
</span></span></span><span class=line><span class=cl><span class=c1></span>     <span class=p>(</span><span class=n>mp_</span><span class=p>.</span><span class=n>n_mmaps</span> <span class=o>&lt;</span> <span class=n>mp_</span><span class=p>.</span><span class=n>n_mmaps_max</span><span class=p>)))</span> <span class=c1>// 且mmap的次数小于最大的nmap的次数
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>char</span> <span class=o>*</span><span class=n>mm</span><span class=p>;</span> <span class=cm>/* mmap调用的返回值 */</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 走mmap调用
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nl>try_mmap</span><span class=p>:</span>
</span></span><span class=line><span class=cl><span class=cm>/* 
</span></span></span><span class=line><span class=cl><span class=cm>	mmap直接分配内存，不需要添加到管理free bin的链表中，所以不存在chunk前后关系
</span></span></span><span class=line><span class=cl><span class=cm>	当chunk被使用时无法借用后一个chunk的prev_size字段，需要将prev_size的SIZE_SZ加上进行内存向上取整对齐
</span></span></span><span class=line><span class=cl><span class=cm>	nb 向上对齐为 size
</span></span></span><span class=line><span class=cl><span class=cm>*/</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>MALLOC_ALIGNMENT</span> <span class=o>==</span> <span class=mi>2</span> <span class=o>*</span> <span class=n>SIZE_SZ</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=n>size</span> <span class=o>=</span> <span class=nf>ALIGN_UP</span><span class=p>(</span><span class=n>nb</span> <span class=o>+</span> <span class=n>SIZE_SZ</span><span class=p>,</span> <span class=n>pagesize</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span>
</span></span><span class=line><span class=cl>      <span class=n>size</span> <span class=o>=</span> <span class=nf>ALIGN_UP</span><span class=p>(</span><span class=n>nb</span> <span class=o>+</span> <span class=n>SIZE_SZ</span> <span class=o>+</span> <span class=n>MALLOC_ALIGN_MASK</span><span class=p>,</span> <span class=n>pagesize</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>tried_mmap</span> <span class=o>=</span> <span class=nb>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>((</span><span class=kt>unsigned</span> <span class=kt>long</span><span class=p>)(</span><span class=n>size</span><span class=p>)</span> <span class=o>&gt;</span> <span class=p>(</span><span class=kt>unsigned</span> <span class=kt>long</span><span class=p>)(</span><span class=n>nb</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span> 
</span></span><span class=line><span class=cl>      <span class=c1>// 若size&gt;nb 调用MMAP
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=n>mm</span> <span class=o>=</span> <span class=p>(</span><span class=kt>char</span> <span class=o>*</span><span class=p>)(</span><span class=nf>MMAP</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=n>size</span><span class=p>,</span> <span class=n>PROT_READ</span> <span class=o>|</span> <span class=n>PROT_WRITE</span><span class=p>,</span> <span class=mi>0</span><span class=p>));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=n>mm</span> <span class=o>!=</span> <span class=n>MAP_FAILED</span><span class=p>)</span> <span class=c1>// MMAP成功
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>MALLOC_ALIGNMENT</span> <span class=o>==</span> <span class=mi>2</span> <span class=o>*</span> <span class=n>SIZE_SZ</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span> <span class=c1>// 若对齐，进行检查，不可用字节设为0
</span></span></span><span class=line><span class=cl><span class=c1></span>          <span class=nf>assert</span><span class=p>(((</span><span class=n>INTERNAL_SIZE_T</span><span class=p>)</span><span class=nf>chunk2mem</span><span class=p>(</span><span class=n>mm</span><span class=p>)</span> <span class=o>&amp;</span> <span class=n>MALLOC_ALIGN_MASK</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>          <span class=n>front_misalign</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span> <span class=c1>// 未对齐获取不可用字节大小
</span></span></span><span class=line><span class=cl><span class=c1></span>          <span class=n>front_misalign</span> <span class=o>=</span> <span class=p>(</span><span class=n>INTERNAL_SIZE_T</span><span class=p>)</span><span class=nf>chunk2mem</span><span class=p>(</span><span class=n>mm</span><span class=p>)</span> <span class=o>&amp;</span> <span class=n>MALLOC_ALIGN_MASK</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>front_misalign</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=n>correction</span> <span class=o>=</span> <span class=n>MALLOC_ALIGNMENT</span> <span class=o>-</span> <span class=n>front_misalign</span><span class=p>;</span> <span class=c1>// 进行纠正
</span></span></span><span class=line><span class=cl><span class=c1></span>          <span class=n>p</span> <span class=o>=</span> <span class=p>(</span><span class=n>mchunkptr</span><span class=p>)(</span><span class=n>mm</span> <span class=o>+</span> <span class=n>correction</span><span class=p>);</span>
</span></span><span class=line><span class=cl>          <span class=n>p</span><span class=o>-&gt;</span><span class=n>prev_size</span> <span class=o>=</span> <span class=n>correction</span><span class=p>;</span>
</span></span><span class=line><span class=cl>          <span class=nf>set_head</span><span class=p>(</span><span class=n>p</span><span class=p>,</span> <span class=p>(</span><span class=n>size</span> <span class=o>-</span> <span class=n>correction</span><span class=p>)</span> <span class=o>|</span> <span class=n>IS_MMAPPED</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=n>p</span> <span class=o>=</span> <span class=p>(</span><span class=n>mchunkptr</span><span class=p>)</span><span class=n>mm</span><span class=p>;</span>
</span></span><span class=line><span class=cl>          <span class=nf>set_head</span><span class=p>(</span><span class=n>p</span><span class=p>,</span> <span class=n>size</span> <span class=o>|</span> <span class=n>IS_MMAPPED</span><span class=p>);</span> <span class=c1>// 设置size中标志
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=kt>int</span> <span class=n>new</span> <span class=o>=</span> <span class=nf>atomic_exchange_and_add</span><span class=p>(</span><span class=o>&amp;</span><span class=n>mp_</span><span class=p>.</span><span class=n>n_mmaps</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span> <span class=o>+</span> <span class=mi>1</span><span class=p>;</span> <span class=c1>// mmap的数量加1
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nf>atomic_max</span><span class=p>(</span><span class=o>&amp;</span><span class=n>mp_</span><span class=p>.</span><span class=n>max_n_mmaps</span><span class=p>,</span> <span class=n>new</span><span class=p>);</span> <span class=c1>// 取最大更新max_n_mmaps
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>        <span class=kt>unsigned</span> <span class=kt>long</span> <span class=n>sum</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>sum</span> <span class=o>=</span> <span class=nf>atomic_exchange_and_add</span><span class=p>(</span><span class=o>&amp;</span><span class=n>mp_</span><span class=p>.</span><span class=n>mmapped_mem</span><span class=p>,</span> <span class=n>size</span><span class=p>)</span> <span class=o>+</span> <span class=n>size</span><span class=p>;</span> <span class=c1>// mmap的内存大小加上size
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nf>atomic_max</span><span class=p>(</span><span class=o>&amp;</span><span class=n>mp_</span><span class=p>.</span><span class=n>max_mmapped_mem</span><span class=p>,</span> <span class=n>sum</span><span class=p>);</span> <span class=c1>// 取最大值更新max_mmapped_mem
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>        <span class=nf>check_chunk</span><span class=p>(</span><span class=n>av</span><span class=p>,</span> <span class=n>p</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nf>chunk2mem</span><span class=p>(</span><span class=n>p</span><span class=p>);</span> <span class=c1>// 返回内存
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>av</span> <span class=o>==</span> <span class=nb>NULL</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=mi>0</span><span class=p>;</span> <span class=c1>// mmap失败且无arena，系统调用失败
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=c1>// 有arena则有top chunk，需要扩展top chunk，切割内存返回
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>old_top</span> <span class=o>=</span> <span class=n>av</span><span class=o>-&gt;</span><span class=n>top</span><span class=p>;</span> <span class=c1>// 获取原top chunk
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>old_size</span> <span class=o>=</span> <span class=nf>chunksize</span><span class=p>(</span><span class=n>old_top</span><span class=p>);</span> <span class=c1>// 获取原top chunk 大小
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>old_end</span> <span class=o>=</span> <span class=p>(</span><span class=kt>char</span> <span class=o>*</span><span class=p>)(</span><span class=nf>chunk_at_offset</span><span class=p>(</span><span class=n>old_top</span><span class=p>,</span> <span class=n>old_size</span><span class=p>));</span> <span class=c1>// 获取原top chunk结束地址
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=n>brk</span> <span class=o>=</span> <span class=n>snd_brk</span> <span class=o>=</span> <span class=p>(</span><span class=kt>char</span> <span class=o>*</span><span class=p>)(</span><span class=n>MORECORE_FAILURE</span><span class=p>);</span> <span class=c1>// 初始化brk和snd_brk为0，#define MORECORE_FAILURE 0
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=nf>assert</span><span class=p>((</span><span class=n>old_top</span> <span class=o>==</span> <span class=nf>initial_top</span><span class=p>(</span><span class=n>av</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=n>old_size</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=o>||</span>
</span></span><span class=line><span class=cl>         <span class=c1>// 1. arena第一次结构体初始化时，top chunk未被分配，此时top chunk指向自己, size为0
</span></span></span><span class=line><span class=cl><span class=c1></span>         <span class=p>((</span><span class=kt>unsigned</span> <span class=kt>long</span><span class=p>)(</span><span class=n>old_size</span><span class=p>)</span> <span class=o>&gt;=</span> <span class=n>MINSIZE</span> <span class=o>&amp;&amp;</span>
</span></span><span class=line><span class=cl>         <span class=nf>prev_inuse</span><span class=p>(</span><span class=n>old_top</span><span class=p>)</span> <span class=o>&amp;&amp;</span>
</span></span><span class=line><span class=cl>         <span class=p>((</span><span class=kt>unsigned</span> <span class=kt>long</span><span class=p>)</span><span class=n>old_end</span> <span class=o>&amp;</span> <span class=p>(</span><span class=n>pagesize</span> <span class=o>-</span> <span class=mi>1</span><span class=p>))</span> <span class=o>==</span> <span class=mi>0</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    	 <span class=c1>// 2. 非第一次，top chunk已有，检查size大于等于0x20，prev_inuse置位，且与页面对齐
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=nf>assert</span><span class=p>((</span><span class=kt>unsigned</span> <span class=kt>long</span><span class=p>)(</span><span class=n>old_size</span><span class=p>)</span> <span class=o>&lt;</span> <span class=p>(</span><span class=kt>unsigned</span> <span class=kt>long</span><span class=p>)(</span><span class=n>nb</span> <span class=o>+</span> <span class=n>MINSIZE</span><span class=p>));</span>
</span></span><span class=line><span class=cl>  <span class=c1>// top chunk 不够用：原top chunk 大小 &lt; 申请大小+0x20 
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=c1>// 非主线程
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=p>(</span><span class=n>av</span> <span class=o>!=</span> <span class=o>&amp;</span><span class=n>main_arena</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>heap_info</span> <span class=o>*</span><span class=n>old_heap</span><span class=p>,</span> <span class=o>*</span><span class=n>heap</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>size_t</span> <span class=n>old_heap_size</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>old_heap</span> <span class=o>=</span> <span class=nf>heap_for_ptr</span><span class=p>(</span><span class=n>old_top</span><span class=p>);</span> <span class=c1>// 获取原始heap堆段的起始地址，heap_info在堆块开头
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>old_heap_size</span> <span class=o>=</span> <span class=n>old_heap</span><span class=o>-&gt;</span><span class=n>size</span><span class=p>;</span>	<span class=c1>// 获取原始堆大小
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// 尝试扩展堆块
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>((</span><span class=kt>long</span><span class=p>)(</span><span class=n>MINSIZE</span> <span class=o>+</span> <span class=n>nb</span> <span class=o>-</span> <span class=n>old_size</span><span class=p>)</span> <span class=o>&gt;</span> <span class=mi>0</span> <span class=o>&amp;&amp;</span> <span class=nf>grow_heap</span><span class=p>(</span><span class=n>old_heap</span><span class=p>,</span> <span class=n>MINSIZE</span> <span class=o>+</span> <span class=n>nb</span> <span class=o>-</span> <span class=n>old_size</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span><span class=c1>// 堆块扩展成功
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=c1>// 更新
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=n>av</span><span class=o>-&gt;</span><span class=n>system_mem</span> <span class=o>+=</span> <span class=n>old_heap</span><span class=o>-&gt;</span><span class=n>size</span> <span class=o>-</span> <span class=n>old_heap_size</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=n>arena_mem</span> <span class=o>+=</span> <span class=n>old_heap</span><span class=o>-&gt;</span><span class=n>size</span> <span class=o>-</span> <span class=n>old_heap_size</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=c1>// 新堆顶块大小: old_heap + old_heap-&gt;size - old_top
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nf>set_head</span><span class=p>(</span><span class=n>old_top</span><span class=p>,</span> <span class=p>(((</span><span class=kt>char</span> <span class=o>*</span><span class=p>)</span><span class=n>old_heap</span> <span class=o>+</span> <span class=n>old_heap</span><span class=o>-&gt;</span><span class=n>size</span><span class=p>)</span> <span class=o>-</span> <span class=p>(</span><span class=kt>char</span> <span class=o>*</span><span class=p>)</span><span class=n>old_top</span><span class=p>)</span> <span class=o>|</span> <span class=n>PREV_INUSE</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=c1>// 或创建新堆
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>else</span> <span class=k>if</span> <span class=p>((</span><span class=n>heap</span> <span class=o>=</span> <span class=nf>new_heap</span><span class=p>(</span><span class=n>nb</span> <span class=o>+</span> <span class=p>(</span><span class=n>MINSIZE</span> <span class=o>+</span> <span class=k>sizeof</span><span class=p>(</span><span class=o>*</span><span class=n>heap</span><span class=p>)),</span> <span class=n>mp_</span><span class=p>.</span><span class=n>top_pad</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// 创建新堆后更新数据
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=n>heap</span><span class=o>-&gt;</span><span class=n>ar_ptr</span> <span class=o>=</span> <span class=n>av</span><span class=p>;</span> <span class=c1>// 更新 arena 管理分配区
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=n>heap</span><span class=o>-&gt;</span><span class=n>prev</span> <span class=o>=</span> <span class=n>old_heap</span><span class=p>;</span> 
</span></span><span class=line><span class=cl>      <span class=n>av</span><span class=o>-&gt;</span><span class=n>system_mem</span> <span class=o>+=</span> <span class=n>heap</span><span class=o>-&gt;</span><span class=n>size</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=n>arena_mem</span> <span class=o>+=</span> <span class=n>heap</span><span class=o>-&gt;</span><span class=n>size</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>	  <span class=c1>// 更新新的top chunk位置，之前的top chunk作废
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nf>top</span><span class=p>(</span><span class=n>av</span><span class=p>)</span> <span class=o>=</span> <span class=nf>chunk_at_offset</span><span class=p>(</span><span class=n>heap</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=o>*</span><span class=n>heap</span><span class=p>));</span>
</span></span><span class=line><span class=cl>      <span class=c1>// top chunk大小: heap大小减去开头heap结构体大小
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nf>set_head</span><span class=p>(</span><span class=nf>top</span><span class=p>(</span><span class=n>av</span><span class=p>),</span> <span class=p>(</span><span class=n>heap</span><span class=o>-&gt;</span><span class=n>size</span> <span class=o>-</span> <span class=k>sizeof</span><span class=p>(</span><span class=o>*</span><span class=n>heap</span><span class=p>))</span> <span class=o>|</span> <span class=n>PREV_INUSE</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=cm>/* 释放旧的top chunk,  */</span>
</span></span><span class=line><span class=cl>      <span class=n>old_size</span> <span class=o>=</span> <span class=p>(</span><span class=n>old_size</span> <span class=o>-</span> <span class=n>MINSIZE</span><span class=p>)</span> <span class=o>&amp;</span> <span class=o>~</span><span class=n>MALLOC_ALIGN_MASK</span><span class=p>;</span> <span class=c1>// 预留两个chunk和align来作为标记，防止错误
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nf>set_head</span><span class=p>(</span><span class=nf>chunk_at_offset</span><span class=p>(</span><span class=n>old_top</span><span class=p>,</span> <span class=n>old_size</span> <span class=o>+</span> <span class=mi>2</span> <span class=o>*</span> <span class=n>SIZE_SZ</span><span class=p>),</span> <span class=mi>0</span> <span class=o>|</span> <span class=n>PREV_INUSE</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=n>old_size</span> <span class=o>&gt;=</span> <span class=n>MINSIZE</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>set_head</span><span class=p>(</span><span class=nf>chunk_at_offset</span><span class=p>(</span><span class=n>old_top</span><span class=p>,</span> <span class=n>old_size</span><span class=p>),</span> <span class=p>(</span><span class=mi>2</span> <span class=o>*</span> <span class=n>SIZE_SZ</span><span class=p>)</span> <span class=o>|</span> <span class=n>PREV_INUSE</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nf>set_foot</span><span class=p>(</span><span class=nf>chunk_at_offset</span><span class=p>(</span><span class=n>old_top</span><span class=p>,</span> <span class=n>old_size</span><span class=p>),</span> <span class=p>(</span><span class=mi>2</span> <span class=o>*</span> <span class=n>SIZE_SZ</span><span class=p>));</span>
</span></span><span class=line><span class=cl>        <span class=nf>set_head</span><span class=p>(</span><span class=n>old_top</span><span class=p>,</span> <span class=n>old_size</span> <span class=o>|</span> <span class=n>PREV_INUSE</span> <span class=o>|</span> <span class=n>NON_MAIN_ARENA</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nf>_int_free</span><span class=p>(</span><span class=n>av</span><span class=p>,</span> <span class=n>old_top</span><span class=p>,</span> <span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=k>else</span>
</span></span><span class=line><span class=cl>      <span class=p>{</span> <span class=c1>// 不够大小直接设置标记，不释放了
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nf>set_head</span><span class=p>(</span><span class=n>old_top</span><span class=p>,</span> <span class=p>(</span><span class=n>old_size</span> <span class=o>+</span> <span class=mi>2</span> <span class=o>*</span> <span class=n>SIZE_SZ</span><span class=p>)</span> <span class=o>|</span> <span class=n>PREV_INUSE</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nf>set_foot</span><span class=p>(</span><span class=n>old_top</span><span class=p>,</span> <span class=p>(</span><span class=n>old_size</span> <span class=o>+</span> <span class=mi>2</span> <span class=o>*</span> <span class=n>SIZE_SZ</span><span class=p>));</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>tried_mmap</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=k>goto</span> <span class=n>try_mmap</span><span class=p>;</span> <span class=c1>// 还是不行，只能调mmap
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>else</span><span class=c1>// 主线程：main_arena
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>size</span> <span class=o>=</span> <span class=n>nb</span> <span class=o>+</span> <span class=n>mp_</span><span class=p>.</span><span class=n>top_pad</span> <span class=o>+</span> <span class=n>MINSIZE</span><span class=p>;</span> <span class=c1>// 请求足够的空间来扩展top chunk，nb需要申请走
</span></span></span><span class=line><span class=cl><span class=c1></span>      
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nf>contiguous</span><span class=p>(</span><span class=n>av</span><span class=p>))</span> <span class=c1>// 若top chunk 连续
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=n>size</span> <span class=o>-=</span> <span class=n>old_size</span><span class=p>;</span> <span class=c1>// 实际涨一点大小即可，不需要再申请nb那么大的size，nb比top chunk还大
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>size</span> <span class=o>=</span> <span class=nf>ALIGN_UP</span><span class=p>(</span><span class=n>size</span><span class=p>,</span> <span class=n>pagesize</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>size</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>brk</span> <span class=o>=</span> <span class=p>(</span><span class=kt>char</span> <span class=o>*</span><span class=p>)(</span><span class=nf>MORECORE</span><span class=p>(</span><span class=n>size</span><span class=p>));</span> <span class=c1>// 通过brk来扩展
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// 系统调用的__brk是将最高地址指针向高地址推，参数为最终地址，返回最终地址
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// glibc的sbrk参数是大小，将扩展多少大小向高地址，返回原来未扩展时的顶
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nf>LIBC_PROBE</span><span class=p>(</span><span class=n>memory_sbrk_more</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=n>brk</span><span class=p>,</span> <span class=n>size</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>brk</span> <span class=o>!=</span> <span class=p>(</span><span class=kt>char</span> <span class=o>*</span><span class=p>)(</span><span class=n>MORECORE_FAILURE</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span> <span class=c1>// brk调用成功，将top chunk 扩展了size大小
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=kt>void</span> <span class=p>(</span><span class=o>*</span><span class=n>hook</span><span class=p>)(</span><span class=kt>void</span><span class=p>)</span> <span class=o>=</span> <span class=nf>atomic_forced_read</span><span class=p>(</span><span class=n>__after_morecore_hook</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=nf>__builtin_expect</span><span class=p>(</span><span class=n>hook</span> <span class=o>!=</span> <span class=nb>NULL</span><span class=p>,</span> <span class=mi>0</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=p>(</span><span class=o>*</span><span class=n>hook</span><span class=p>)();</span> <span class=c1>// after_morecore_hook不为空则执行
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span> <span class=c1>// 若brk调用失败，说明不能再维护连续内存
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=k>if</span> <span class=p>(</span><span class=nf>contiguous</span><span class=p>(</span><span class=n>av</span><span class=p>))</span> <span class=c1>// 由于之前连续减去过old_size，此处要加回来
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>size</span> <span class=o>=</span> <span class=nf>ALIGN_UP</span><span class=p>(</span><span class=n>size</span> <span class=o>+</span> <span class=n>old_size</span><span class=p>,</span> <span class=n>pagesize</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>((</span><span class=kt>unsigned</span> <span class=kt>long</span><span class=p>)(</span><span class=n>size</span><span class=p>)</span> <span class=o>&lt;</span> <span class=p>(</span><span class=kt>unsigned</span> <span class=kt>long</span><span class=p>)(</span><span class=n>MMAP_AS_MORECORE_SIZE</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=c1>// #define MMAP_AS_MORECORE_SIZE (1024 * 1024) 小于则使用mmap最小的size
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>size</span> <span class=o>=</span> <span class=n>MMAP_AS_MORECORE_SIZE</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>((</span><span class=kt>unsigned</span> <span class=kt>long</span><span class=p>)(</span><span class=n>size</span><span class=p>)</span> <span class=o>&gt;</span> <span class=p>(</span><span class=kt>unsigned</span> <span class=kt>long</span><span class=p>)(</span><span class=n>nb</span><span class=p>))</span>
</span></span><span class=line><span class=cl>      <span class=p>{</span> <span class=c1>// 若size可以包含申请的大小
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=kt>char</span> <span class=o>*</span><span class=n>mbrk</span> <span class=o>=</span> <span class=p>(</span><span class=kt>char</span> <span class=o>*</span><span class=p>)(</span><span class=nf>MMAP</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=n>size</span><span class=p>,</span> <span class=n>PROT_READ</span> <span class=o>|</span> <span class=n>PROT_WRITE</span><span class=p>,</span> <span class=mi>0</span><span class=p>));</span> <span class=c1>// mmap系统调用
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>mbrk</span> <span class=o>!=</span> <span class=n>MAP_FAILED</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span> <span class=c1>// mmap未失败
</span></span></span><span class=line><span class=cl><span class=c1></span>          <span class=n>brk</span> <span class=o>=</span> <span class=n>mbrk</span><span class=p>;</span> <span class=c1>// 新mmap的内存起始位置
</span></span></span><span class=line><span class=cl><span class=c1></span>          <span class=n>snd_brk</span> <span class=o>=</span> <span class=n>brk</span> <span class=o>+</span> <span class=n>size</span><span class=p>;</span> <span class=c1>// 新的mmap的内存结束位置
</span></span></span><span class=line><span class=cl><span class=c1></span>          <span class=nf>set_noncontiguous</span><span class=p>(</span><span class=n>av</span><span class=p>);</span> <span class=c1>// 设置arena为不连续
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>      
</span></span><span class=line><span class=cl>	<span class=c1>// 若brk不再是0，已经获取了内存地址
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=n>brk</span> <span class=o>!=</span> <span class=p>(</span><span class=kt>char</span> <span class=o>*</span><span class=p>)(</span><span class=n>MORECORE_FAILURE</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=n>mp_</span><span class=p>.</span><span class=n>sbrk_base</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>mp_</span><span class=p>.</span><span class=n>sbrk_base</span> <span class=o>=</span> <span class=n>brk</span><span class=p>;</span> <span class=c1>// 更新 sbrk_base
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=n>av</span><span class=o>-&gt;</span><span class=n>system_mem</span> <span class=o>+=</span> <span class=n>size</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=c1>// 【1】: topchunk通过brk向下扩展了一小段，nb申请后也够用
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=k>if</span> <span class=p>(</span><span class=n>brk</span> <span class=o>==</span> <span class=n>old_end</span> <span class=o>&amp;&amp;</span> <span class=n>snd_brk</span> <span class=o>==</span> <span class=p>(</span><span class=kt>char</span> <span class=o>*</span><span class=p>)(</span><span class=n>MORECORE_FAILURE</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=nf>set_head</span><span class=p>(</span><span class=n>old_top</span><span class=p>,</span> <span class=p>(</span><span class=n>size</span> <span class=o>+</span> <span class=n>old_size</span><span class=p>)</span> <span class=o>|</span> <span class=n>PREV_INUSE</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=c1>// 【2】: arena连续则不是mmap出来的，old_size排除了未初始化情况，越brk却越小的情况
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=nf>contiguous</span><span class=p>(</span><span class=n>av</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=n>old_size</span> <span class=o>&amp;&amp;</span> <span class=n>brk</span> <span class=o>&lt;</span> <span class=n>old_end</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>{</span> <span class=c1>// 崩溃
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nf>malloc_printerr</span><span class=p>(</span><span class=mi>3</span><span class=p>,</span> <span class=s>&#34;break adjusted to free malloc space&#34;</span><span class=p>,</span> <span class=n>brk</span><span class=p>,</span> <span class=n>av</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=k>else</span>
</span></span><span class=line><span class=cl>      <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>front_misalign</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>end_misalign</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>correction</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>aligned_brk</span> <span class=o>=</span> <span class=n>brk</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=c1>// 【3】: 新分配的内存地址大于原来top chunk结束地址，不连续但分配区连续标志位置位 
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>if</span> <span class=p>(</span><span class=nf>contiguous</span><span class=p>(</span><span class=n>av</span><span class=p>))</span> <span class=c1>// 说明是其他线程调用了brk在堆上分配了内存
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=k>if</span> <span class=p>(</span><span class=n>old_size</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>av</span><span class=o>-&gt;</span><span class=n>system_mem</span> <span class=o>+=</span> <span class=n>brk</span> <span class=o>-</span> <span class=n>old_end</span><span class=p>;</span> <span class=c1>// 其他线程分配的内存一并计入
</span></span></span><span class=line><span class=cl><span class=c1></span>	      <span class=c1>// 对齐操作
</span></span></span><span class=line><span class=cl><span class=c1></span>          <span class=n>front_misalign</span> <span class=o>=</span> <span class=p>(</span><span class=n>INTERNAL_SIZE_T</span><span class=p>)</span><span class=nf>chunk2mem</span><span class=p>(</span><span class=n>brk</span><span class=p>)</span> <span class=o>&amp;</span> <span class=n>MALLOC_ALIGN_MASK</span><span class=p>;</span>
</span></span><span class=line><span class=cl>          <span class=c1>// 假设两个top chunk 1,2, 计算1和2中间不对齐的部分
</span></span></span><span class=line><span class=cl><span class=c1></span>          <span class=k>if</span> <span class=p>(</span><span class=n>front_misalign</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>          <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 获取校正，即2开头需要加上该校正，得到地址才和MALLOC_ALIGN_MASK对齐
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>correction</span> <span class=o>=</span> <span class=n>MALLOC_ALIGNMENT</span> <span class=o>-</span> <span class=n>front_misalign</span><span class=p>;</span> 
</span></span><span class=line><span class=cl>            <span class=n>aligned_brk</span> <span class=o>+=</span> <span class=n>correction</span><span class=p>;</span> <span class=c1>// 不向上对齐，向下对齐，此时aligned_brk指向top chunk
</span></span></span><span class=line><span class=cl><span class=c1></span>          <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>          <span class=n>correction</span> <span class=o>+=</span> <span class=n>old_size</span><span class=p>;</span> <span class=c1>// top chunk的大小
</span></span></span><span class=line><span class=cl><span class=c1></span>		  <span class=c1>// 2结尾也同样对齐，correction为 top chunk结束位置到新分配内存空间的大小
</span></span></span><span class=line><span class=cl><span class=c1></span>          <span class=n>end_misalign</span> <span class=o>=</span> <span class=p>(</span><span class=n>INTERNAL_SIZE_T</span><span class=p>)(</span><span class=n>brk</span> <span class=o>+</span> <span class=n>size</span> <span class=o>+</span> <span class=n>correction</span><span class=p>);</span>
</span></span><span class=line><span class=cl>          <span class=n>correction</span> <span class=o>+=</span> <span class=p>(</span><span class=nf>ALIGN_UP</span><span class=p>(</span><span class=n>end_misalign</span><span class=p>,</span> <span class=n>pagesize</span><span class=p>))</span> <span class=o>-</span> <span class=n>end_misalign</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>          <span class=nf>assert</span><span class=p>(</span><span class=n>correction</span> <span class=o>&gt;=</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>          <span class=n>snd_brk</span> <span class=o>=</span> <span class=p>(</span><span class=kt>char</span> <span class=o>*</span><span class=p>)(</span><span class=nf>MORECORE</span><span class=p>(</span><span class=n>correction</span><span class=p>));</span> <span class=c1>// 再次调用brk补充correction的内存
</span></span></span><span class=line><span class=cl><span class=c1></span>            
</span></span><span class=line><span class=cl>          <span class=k>if</span> <span class=p>(</span><span class=n>snd_brk</span> <span class=o>==</span> <span class=p>(</span><span class=kt>char</span> <span class=o>*</span><span class=p>)(</span><span class=n>MORECORE_FAILURE</span><span class=p>))</span> <span class=c1>// 失败
</span></span></span><span class=line><span class=cl><span class=c1></span>          <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>correction</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=n>snd_brk</span> <span class=o>=</span> <span class=p>(</span><span class=kt>char</span> <span class=o>*</span><span class=p>)(</span><span class=nf>MORECORE</span><span class=p>(</span><span class=mi>0</span><span class=p>));</span> <span class=c1>// 重置为原来分配内存的brk结束地址
</span></span></span><span class=line><span class=cl><span class=c1></span>          <span class=p>}</span>
</span></span><span class=line><span class=cl>          <span class=k>else</span>
</span></span><span class=line><span class=cl>          <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=kt>void</span> <span class=p>(</span><span class=o>*</span><span class=n>hook</span><span class=p>)(</span><span class=kt>void</span><span class=p>)</span> <span class=o>=</span> <span class=nf>atomic_forced_read</span><span class=p>(</span><span class=n>__after_morecore_hook</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=nf>__builtin_expect</span><span class=p>(</span><span class=n>hook</span> <span class=o>!=</span> <span class=nb>NULL</span><span class=p>,</span> <span class=mi>0</span><span class=p>))</span>
</span></span><span class=line><span class=cl>              <span class=p>(</span><span class=o>*</span><span class=n>hook</span><span class=p>)();</span> <span class=c1>// 提供hook点
</span></span></span><span class=line><span class=cl><span class=c1></span>          <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 【4】: 新分配的内存地址大于原来top chunk结束地址，均不连续
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>else</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=k>if</span> <span class=p>(</span><span class=n>MALLOC_ALIGNMENT</span> <span class=o>==</span> <span class=mi>2</span> <span class=o>*</span> <span class=n>SIZE_SZ</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=nf>assert</span><span class=p>(((</span><span class=kt>unsigned</span> <span class=kt>long</span><span class=p>)</span><span class=nf>chunk2mem</span><span class=p>(</span><span class=n>brk</span><span class=p>)</span> <span class=o>&amp;</span> <span class=n>MALLOC_ALIGN_MASK</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>          <span class=k>else</span>
</span></span><span class=line><span class=cl>          <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>front_misalign</span> <span class=o>=</span> <span class=p>(</span><span class=n>INTERNAL_SIZE_T</span><span class=p>)</span><span class=nf>chunk2mem</span><span class=p>(</span><span class=n>brk</span><span class=p>)</span> <span class=o>&amp;</span> <span class=n>MALLOC_ALIGN_MASK</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=n>front_misalign</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=p>{</span>
</span></span><span class=line><span class=cl>              <span class=n>aligned_brk</span> <span class=o>+=</span> <span class=n>MALLOC_ALIGNMENT</span> <span class=o>-</span> <span class=n>front_misalign</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>          <span class=p>}</span>
</span></span><span class=line><span class=cl>          <span class=k>if</span> <span class=p>(</span><span class=n>snd_brk</span> <span class=o>==</span> <span class=p>(</span><span class=kt>char</span> <span class=o>*</span><span class=p>)(</span><span class=n>MORECORE_FAILURE</span><span class=p>))</span>
</span></span><span class=line><span class=cl>          <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>snd_brk</span> <span class=o>=</span> <span class=p>(</span><span class=kt>char</span> <span class=o>*</span><span class=p>)(</span><span class=nf>MORECORE</span><span class=p>(</span><span class=mi>0</span><span class=p>));</span> <span class=c1>// 同样为了对齐进行brk调用申请来补充新top chunk
</span></span></span><span class=line><span class=cl><span class=c1></span>          <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>snd_brk</span> <span class=o>!=</span> <span class=p>(</span><span class=kt>char</span> <span class=o>*</span><span class=p>)(</span><span class=n>MORECORE_FAILURE</span><span class=p>))</span> <span class=c1>// 表示申请成功
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=p>{</span> <span class=c1>// 需要对不连续的原先top chunk进行处理
</span></span></span><span class=line><span class=cl><span class=c1></span>          <span class=n>av</span><span class=o>-&gt;</span><span class=n>top</span> <span class=o>=</span> <span class=p>(</span><span class=n>mchunkptr</span><span class=p>)</span><span class=n>aligned_brk</span><span class=p>;</span> <span class=c1>// 上一个不连续的top chunk
</span></span></span><span class=line><span class=cl><span class=c1></span>          <span class=nf>set_head</span><span class=p>(</span><span class=n>av</span><span class=o>-&gt;</span><span class=n>top</span><span class=p>,</span> <span class=p>(</span><span class=n>snd_brk</span> <span class=o>-</span> <span class=n>aligned_brk</span> <span class=o>+</span> <span class=n>correction</span><span class=p>)</span> <span class=o>|</span> <span class=n>PREV_INUSE</span><span class=p>);</span>
</span></span><span class=line><span class=cl>          <span class=n>av</span><span class=o>-&gt;</span><span class=n>system_mem</span> <span class=o>+=</span> <span class=n>correction</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>          <span class=k>if</span> <span class=p>(</span><span class=n>old_size</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>          <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>old_size</span> <span class=o>=</span> <span class=p>(</span><span class=n>old_size</span> <span class=o>-</span> <span class=mi>4</span> <span class=o>*</span> <span class=n>SIZE_SZ</span><span class=p>)</span> <span class=o>&amp;</span> <span class=o>~</span><span class=n>MALLOC_ALIGN_MASK</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=nf>set_head</span><span class=p>(</span><span class=n>old_top</span><span class=p>,</span> <span class=n>old_size</span> <span class=o>|</span> <span class=n>PREV_INUSE</span><span class=p>);</span>
</span></span><span class=line><span class=cl>			<span class=c1>// 设置标记防止后续需要后续堆块prev_size情况的错误
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=nf>chunk_at_offset</span><span class=p>(</span><span class=n>old_top</span><span class=p>,</span> <span class=n>old_size</span><span class=p>)</span><span class=o>-&gt;</span><span class=n>size</span> <span class=o>=</span> <span class=p>(</span><span class=mi>2</span> <span class=o>*</span> <span class=n>SIZE_SZ</span><span class=p>)</span> <span class=o>|</span> <span class=n>PREV_INUSE</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=nf>chunk_at_offset</span><span class=p>(</span><span class=n>old_top</span><span class=p>,</span> <span class=n>old_size</span> <span class=o>+</span> <span class=mi>2</span> <span class=o>*</span> <span class=n>SIZE_SZ</span><span class=p>)</span><span class=o>-&gt;</span><span class=n>size</span> <span class=o>=</span> <span class=p>(</span><span class=mi>2</span> <span class=o>*</span> <span class=n>SIZE_SZ</span><span class=p>)</span> <span class=o>|</span> <span class=n>PREV_INUSE</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=n>old_size</span> <span class=o>&gt;=</span> <span class=n>MINSIZE</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=p>{</span>
</span></span><span class=line><span class=cl>              <span class=nf>_int_free</span><span class=p>(</span><span class=n>av</span><span class=p>,</span> <span class=n>old_top</span><span class=p>,</span> <span class=mi>1</span><span class=p>);</span> <span class=c1>// 释放掉之前的 top chunk
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=p>}</span>
</span></span><span class=line><span class=cl>          <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 更新
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=p>((</span><span class=kt>unsigned</span> <span class=kt>long</span><span class=p>)</span><span class=n>av</span><span class=o>-&gt;</span><span class=n>system_mem</span> <span class=o>&gt;</span> <span class=p>(</span><span class=kt>unsigned</span> <span class=kt>long</span><span class=p>)(</span><span class=n>av</span><span class=o>-&gt;</span><span class=n>max_system_mem</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>av</span><span class=o>-&gt;</span><span class=n>max_system_mem</span> <span class=o>=</span> <span class=n>av</span><span class=o>-&gt;</span><span class=n>system_mem</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nf>check_malloc_state</span><span class=p>(</span><span class=n>av</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>p</span> <span class=o>=</span> <span class=n>av</span><span class=o>-&gt;</span><span class=n>top</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>size</span> <span class=o>=</span> <span class=nf>chunksize</span><span class=p>(</span><span class=n>p</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 进行 top chunk 的分配，切一块分配给nb，剩余为top chunk
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=p>((</span><span class=kt>unsigned</span> <span class=kt>long</span><span class=p>)(</span><span class=n>size</span><span class=p>)</span> <span class=o>&gt;=</span> <span class=p>(</span><span class=kt>unsigned</span> <span class=kt>long</span><span class=p>)(</span><span class=n>nb</span> <span class=o>+</span> <span class=n>MINSIZE</span><span class=p>))</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>remainder_size</span> <span class=o>=</span> <span class=n>size</span> <span class=o>-</span> <span class=n>nb</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>remainder</span> <span class=o>=</span> <span class=nf>chunk_at_offset</span><span class=p>(</span><span class=n>p</span><span class=p>,</span> <span class=n>nb</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>av</span><span class=o>-&gt;</span><span class=n>top</span> <span class=o>=</span> <span class=n>remainder</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nf>set_head</span><span class=p>(</span><span class=n>p</span><span class=p>,</span> <span class=n>nb</span> <span class=o>|</span> <span class=n>PREV_INUSE</span> <span class=o>|</span> <span class=p>(</span><span class=n>av</span> <span class=o>!=</span> <span class=o>&amp;</span><span class=n>main_arena</span> <span class=o>?</span> <span class=nl>NON_MAIN_ARENA</span> <span class=p>:</span> <span class=mi>0</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=nf>set_head</span><span class=p>(</span><span class=n>remainder</span><span class=p>,</span> <span class=n>remainder_size</span> <span class=o>|</span> <span class=n>PREV_INUSE</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>check_malloced_chunk</span><span class=p>(</span><span class=n>av</span><span class=p>,</span> <span class=n>p</span><span class=p>,</span> <span class=n>nb</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nf>chunk2mem</span><span class=p>(</span><span class=n>p</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nf>__set_errno</span><span class=p>(</span><span class=n>ENOMEM</span><span class=p>);</span> <span class=c1>// 抓取所有未申请到内存情况
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div><h5 id=mmap>MMAP</h5><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-c"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=复制到剪贴板><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#define MMAP(addr, size, prot, flags)
</span></span></span><span class=line><span class=cl><span class=cp></span>	<span class=nf>__mmap</span><span class=p>((</span><span class=n>addr</span><span class=p>),</span> <span class=p>(</span><span class=n>size</span><span class=p>),</span> <span class=p>(</span><span class=n>prot</span><span class=p>),</span> <span class=p>(</span><span class=n>flags</span><span class=p>)</span> <span class=o>|</span> <span class=n>MAP_ANONYMOUS</span> <span class=o>|</span> <span class=n>MAP_PRIVATE</span><span class=p>,</span> <span class=o>-</span><span class=mi>1</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span></span></span></code></pre></div></div><h5 id=initial_top>initial_top</h5><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-c"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=复制到剪贴板><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=c1>// 为方便，unsorted bin在第一次调用时可作为虚假的top chunk
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=cp>#define initial_top(M) (unsorted_chunks(M))
</span></span></span><span class=line><span class=cl><span class=cp>#define unsorted_chunks(M) (bin_at(M, 1))</span></span></span></code></pre></div></div><h5 id=heap_for_ptr>heap_for_ptr</h5><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-c"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=复制到剪贴板><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#define heap_for_ptr(ptr) 
</span></span></span><span class=line><span class=cl><span class=cp></span>	<span class=p>((</span><span class=n>heap_info</span> <span class=o>*</span><span class=p>)</span> <span class=p>((</span><span class=kt>unsigned</span> <span class=kt>long</span><span class=p>)</span> <span class=p>(</span><span class=n>ptr</span><span class=p>)</span> <span class=o>&amp;</span> <span class=o>~</span><span class=p>(</span><span class=n>HEAP_MAX_SIZE</span> <span class=o>-</span> <span class=mi>1</span><span class=p>)))</span>
</span></span><span class=line><span class=cl><span class=cm>/* 
</span></span></span><span class=line><span class=cl><span class=cm>	非主线程的堆都按照 HEAP_MAX_SIZE对齐分配，
</span></span></span><span class=line><span class=cl><span class=cm>	ptr &amp; ~0xfffff 即将ptr的后5位置0，可以获取 heap_info 结构体的起始地址
</span></span></span><span class=line><span class=cl><span class=cm>*/</span>
</span></span><span class=line><span class=cl><span class=cp>#  define HEAP_MAX_SIZE (1024 * 1024) </span><span class=cm>/* 0x100000，必须是2的幂 */</span></span></span></code></pre></div></div><h5 id=grow_heap>grow_heap</h5><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-c"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=复制到剪贴板><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>static</span> <span class=kt>int</span> <span class=nf>grow_heap</span> <span class=p>(</span><span class=n>heap_info</span> <span class=o>*</span><span class=n>h</span><span class=p>,</span> <span class=kt>long</span> <span class=n>diff</span><span class=p>)</span> <span class=c1>// diff为差的size
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kt>size_t</span> <span class=n>pagesize</span> <span class=o>=</span> <span class=nf>GLRO</span> <span class=p>(</span><span class=n>dl_pagesize</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=kt>long</span> <span class=n>new_size</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>diff</span> <span class=o>=</span> <span class=nf>ALIGN_UP</span> <span class=p>(</span><span class=n>diff</span><span class=p>,</span> <span class=n>pagesize</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=n>new_size</span> <span class=o>=</span> <span class=p>(</span><span class=kt>long</span><span class=p>)</span> <span class=n>h</span><span class=o>-&gt;</span><span class=n>size</span> <span class=o>+</span> <span class=n>diff</span><span class=p>;</span> <span class=c1>// 扩展堆后 新的size
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=p>((</span><span class=kt>unsigned</span> <span class=kt>long</span><span class=p>)</span> <span class=n>new_size</span> <span class=o>&gt;</span> <span class=p>(</span><span class=kt>unsigned</span> <span class=kt>long</span><span class=p>)</span> <span class=n>HEAP_MAX_SIZE</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span> <span class=c1>// 若大于HEAP_MAX_SIZE则失败
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>((</span><span class=kt>unsigned</span> <span class=kt>long</span><span class=p>)</span> <span class=n>new_size</span> <span class=o>&gt;</span> <span class=n>h</span><span class=o>-&gt;</span><span class=n>mprotect_size</span><span class=p>)</span> <span class=c1>// 若新堆块大小超出mprotect保护的大小
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nf>__mprotect</span> <span class=p>(</span> <span class=c1>// 调用mprotect将超过的部分设置为可读可写
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=p>(</span><span class=kt>char</span> <span class=o>*</span><span class=p>)</span> <span class=n>h</span> <span class=o>+</span> <span class=n>h</span><span class=o>-&gt;</span><span class=n>mprotect_size</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=p>(</span><span class=kt>unsigned</span> <span class=kt>long</span><span class=p>)</span> <span class=n>new_size</span> <span class=o>-</span> <span class=n>h</span><span class=o>-&gt;</span><span class=n>mprotect_size</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=n>PROT_READ</span> <span class=o>|</span> <span class=n>PROT_WRITE</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=o>!=</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=o>-</span><span class=mi>2</span><span class=p>;</span><span class=c1>// 设置失败
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=n>h</span><span class=o>-&gt;</span><span class=n>mprotect_size</span> <span class=o>=</span> <span class=n>new_size</span><span class=p>;</span> <span class=c1>// 设置成功后将mprotect_size更新
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>h</span><span class=o>-&gt;</span><span class=n>size</span> <span class=o>=</span> <span class=n>new_size</span><span class=p>;</span> <span class=c1>// 更新堆大小
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nf>LIBC_PROBE</span> <span class=p>(</span><span class=n>memory_heap_more</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=n>h</span><span class=p>,</span> <span class=n>h</span><span class=o>-&gt;</span><span class=n>size</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div><h5 id=new_heap>new_heap</h5><div class="code-block code-line-numbers" style="counter-reset:code-block 0"><div class="code-header language-c"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=复制到剪贴板><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>static</span> <span class=n>heap_info</span> <span class=o>*</span><span class=n>internal_function</span> <span class=nf>new_heap</span> <span class=p>(</span><span class=kt>size_t</span> <span class=n>size</span><span class=p>,</span> <span class=kt>size_t</span> <span class=n>top_pad</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kt>size_t</span> <span class=n>pagesize</span> <span class=o>=</span> <span class=nf>GLRO</span> <span class=p>(</span><span class=n>dl_pagesize</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=kt>char</span> <span class=o>*</span><span class=n>p1</span><span class=p>,</span> <span class=o>*</span><span class=n>p2</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>unsigned</span> <span class=kt>long</span> <span class=n>ul</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>heap_info</span> <span class=o>*</span><span class=n>h</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>size</span> <span class=o>+</span> <span class=n>top_pad</span> <span class=o>&lt;</span> <span class=n>HEAP_MIN_SIZE</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>size</span> <span class=o>=</span> <span class=n>HEAP_MIN_SIZE</span><span class=p>;</span> <span class=c1>// 大小加填充后小于最小size则用HEAP_MIN_SIZE
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>size</span> <span class=o>+</span> <span class=n>top_pad</span> <span class=o>&lt;=</span> <span class=n>HEAP_MAX_SIZE</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>size</span> <span class=o>+=</span> <span class=n>top_pad</span><span class=p>;</span> <span class=c1>// 小于最大size则用【大小+填充】
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>size</span> <span class=o>&gt;</span> <span class=n>HEAP_MAX_SIZE</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=mi>0</span><span class=p>;</span> <span class=c1>// 大于最大size则创建失败
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>else</span>
</span></span><span class=line><span class=cl>    <span class=n>size</span> <span class=o>=</span> <span class=n>HEAP_MAX_SIZE</span><span class=p>;</span> 
</span></span><span class=line><span class=cl>  <span class=n>size</span> <span class=o>=</span> <span class=nf>ALIGN_UP</span> <span class=p>(</span><span class=n>size</span><span class=p>,</span> <span class=n>pagesize</span><span class=p>);</span> <span class=c1>// 确定创建的对齐堆大小
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=n>p2</span> <span class=o>=</span> <span class=n>MAP_FAILED</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>aligned_heap_area</span><span class=p>)</span> <span class=c1>// aligned_heap_area记录了上一次分配的堆
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>{</span> <span class=c1>// mmap申请，其与HEAP_MAX_SIZE对齐
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=n>p2</span> <span class=o>=</span> <span class=p>(</span><span class=kt>char</span> <span class=o>*</span><span class=p>)</span> <span class=nf>MMAP</span> <span class=p>(</span><span class=n>aligned_heap_area</span><span class=p>,</span> <span class=n>HEAP_MAX_SIZE</span><span class=p>,</span> <span class=n>PROT_NONE</span><span class=p>,</span><span class=n>MAP_NORESERVE</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=n>aligned_heap_area</span> <span class=o>=</span> <span class=nb>NULL</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=c1>// mmap成功但未对齐
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=k>if</span> <span class=p>(</span><span class=n>p2</span> <span class=o>!=</span> <span class=n>MAP_FAILED</span> <span class=o>&amp;&amp;</span> <span class=p>((</span><span class=kt>unsigned</span> <span class=kt>long</span><span class=p>)</span> <span class=n>p2</span> <span class=o>&amp;</span> <span class=p>(</span><span class=n>HEAP_MAX_SIZE</span> <span class=o>-</span> <span class=mi>1</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=nf>__munmap</span> <span class=p>(</span><span class=n>p2</span><span class=p>,</span> <span class=n>HEAP_MAX_SIZE</span><span class=p>);</span> <span class=c1>// 取消分配，删除地址区域的对象映射
</span></span></span><span class=line><span class=cl><span class=c1></span>          <span class=n>p2</span> <span class=o>=</span> <span class=n>MAP_FAILED</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>p2</span> <span class=o>==</span> <span class=n>MAP_FAILED</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span> <span class=c1>// mmap申请只保证页面对齐，于是申请两倍HEAP_MAX_SIZE，&lt;&lt;1即乘以2，总有关于HEAP_MAX_SIZE对齐的地方
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=n>p1</span> <span class=o>=</span> <span class=p>(</span><span class=kt>char</span> <span class=o>*</span><span class=p>)</span> <span class=nf>MMAP</span> <span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=n>HEAP_MAX_SIZE</span> <span class=o>&lt;&lt;</span> <span class=mi>1</span><span class=p>,</span> <span class=n>PROT_NONE</span><span class=p>,</span> <span class=n>MAP_NORESERVE</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=n>p1</span> <span class=o>!=</span> <span class=n>MAP_FAILED</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=c1>// 从p1出发截取对齐HEAP_MAX_SIZE的位置p2
</span></span></span><span class=line><span class=cl><span class=c1></span>          <span class=n>p2</span> <span class=o>=</span> <span class=p>(</span><span class=kt>char</span> <span class=o>*</span><span class=p>)</span> <span class=p>(((</span><span class=kt>unsigned</span> <span class=kt>long</span><span class=p>)</span> <span class=n>p1</span> <span class=o>+</span> <span class=p>(</span><span class=n>HEAP_MAX_SIZE</span> <span class=o>-</span> <span class=mi>1</span><span class=p>))</span> <span class=o>&amp;</span> <span class=o>~</span><span class=p>(</span><span class=n>HEAP_MAX_SIZE</span> <span class=o>-</span> <span class=mi>1</span><span class=p>));</span>
</span></span><span class=line><span class=cl>          <span class=n>ul</span> <span class=o>=</span> <span class=n>p2</span> <span class=o>-</span> <span class=n>p1</span><span class=p>;</span> 
</span></span><span class=line><span class=cl>          <span class=k>if</span> <span class=p>(</span><span class=n>ul</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=nf>__munmap</span> <span class=p>(</span><span class=n>p1</span><span class=p>,</span> <span class=n>ul</span><span class=p>);</span> <span class=c1>// 将多出来那段映射删除
</span></span></span><span class=line><span class=cl><span class=c1></span>          <span class=k>else</span>
</span></span><span class=line><span class=cl>            <span class=n>aligned_heap_area</span> <span class=o>=</span> <span class=n>p2</span> <span class=o>+</span> <span class=n>HEAP_MAX_SIZE</span><span class=p>;</span> <span class=c1>// 否则刚好可以申请，更新aligned_heap_area留后续使用
</span></span></span><span class=line><span class=cl><span class=c1></span>          <span class=nf>__munmap</span> <span class=p>(</span><span class=n>p2</span> <span class=o>+</span> <span class=n>HEAP_MAX_SIZE</span><span class=p>,</span> <span class=n>HEAP_MAX_SIZE</span> <span class=o>-</span> <span class=n>ul</span><span class=p>);</span> <span class=c1>// 记录后再将后面这块映射删除
</span></span></span><span class=line><span class=cl><span class=c1></span>          <span class=c1>// 此时获得p2与HEAP_MAX_SIZE对齐，大小为HEAP_MAX_SIZE的堆块
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=k>else</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span> <span class=c1>// 尝试只申请一倍，刚好已经与HEAP_MAX_SIZE对齐得堆块
</span></span></span><span class=line><span class=cl><span class=c1></span>          <span class=n>p2</span> <span class=o>=</span> <span class=p>(</span><span class=kt>char</span> <span class=o>*</span><span class=p>)</span> <span class=nf>MMAP</span> <span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=n>HEAP_MAX_SIZE</span><span class=p>,</span> <span class=n>PROT_NONE</span><span class=p>,</span> <span class=n>MAP_NORESERVE</span><span class=p>);</span>
</span></span><span class=line><span class=cl>          <span class=k>if</span> <span class=p>(</span><span class=n>p2</span> <span class=o>==</span> <span class=n>MAP_FAILED</span><span class=p>)</span> <span class=c1>// 分配失败返回0
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>          <span class=k>if</span> <span class=p>((</span><span class=kt>unsigned</span> <span class=kt>long</span><span class=p>)</span> <span class=n>p2</span> <span class=o>&amp;</span> <span class=p>(</span><span class=n>HEAP_MAX_SIZE</span> <span class=o>-</span> <span class=mi>1</span><span class=p>))</span> <span class=c1>// 未对齐返回0
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=p>{</span>
</span></span><span class=line><span class=cl>              <span class=nf>__munmap</span> <span class=p>(</span><span class=n>p2</span><span class=p>,</span> <span class=n>HEAP_MAX_SIZE</span><span class=p>);</span> <span class=c1>// 取消分配
</span></span></span><span class=line><span class=cl><span class=c1></span>              <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nf>__mprotect</span> <span class=p>(</span><span class=n>p2</span><span class=p>,</span> <span class=n>size</span><span class=p>,</span> <span class=n>PROT_READ</span> <span class=o>|</span> <span class=n>PROT_WRITE</span><span class=p>)</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=c1>// mprotect只将HEAP_MAX_SIZE前面的size大小设置可读可写
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nf>__munmap</span> <span class=p>(</span><span class=n>p2</span><span class=p>,</span> <span class=n>HEAP_MAX_SIZE</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=n>h</span> <span class=o>=</span> <span class=p>(</span><span class=n>heap_info</span> <span class=o>*</span><span class=p>)</span> <span class=n>p2</span><span class=p>;</span> <span class=c1>// 最终返回p2指向的内存
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>h</span><span class=o>-&gt;</span><span class=n>size</span> <span class=o>=</span> <span class=n>size</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>h</span><span class=o>-&gt;</span><span class=n>mprotect_size</span> <span class=o>=</span> <span class=n>size</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nf>LIBC_PROBE</span> <span class=p>(</span><span class=n>memory_heap_new</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=n>h</span><span class=p>,</span> <span class=n>h</span><span class=o>-&gt;</span><span class=n>size</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>h</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div><h5 id=morecore>MORECORE</h5><div class="code-block code-line-numbers" style="counter-reset:code-block 0"><div class="code-header language-c"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=复制到剪贴板><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#define MORECORE (*__morecore)
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=o>*</span><span class=p>(</span><span class=o>*</span><span class=n>__morecore</span><span class=p>)(</span><span class=kt>ptrdiff_t</span><span class=p>)</span> <span class=o>=</span> <span class=n>__default_morecore</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=o>*</span> <span class=nf>__default_morecore</span> <span class=p>(</span><span class=kt>ptrdiff_t</span> <span class=n>increment</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 调用 __sbrk 增加或减少堆内存
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kt>void</span> <span class=o>*</span><span class=n>result</span> <span class=o>=</span> <span class=p>(</span><span class=kt>void</span> <span class=o>*</span><span class=p>)</span> <span class=nf>__sbrk</span> <span class=p>(</span><span class=n>increment</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>result</span> <span class=o>==</span> <span class=p>(</span><span class=kt>void</span> <span class=o>*</span><span class=p>)</span> <span class=o>-</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nb>NULL</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>result</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=o>*</span> <span class=nf>__sbrk</span> <span class=p>(</span><span class=kt>intptr_t</span> <span class=n>increment</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kt>void</span> <span class=o>*</span><span class=n>oldbrk</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>__curbrk</span> <span class=o>==</span> <span class=nb>NULL</span> <span class=o>||</span> <span class=n>__libc_multiple_libcs</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 若__curbrk为空：即尚未设置堆起始地址
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=nf>__brk</span> <span class=p>(</span><span class=mi>0</span><span class=p>)</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span> <span class=c1>// 调用__brk(0)获取当前堆顶__curbrk
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=k>return</span> <span class=p>(</span><span class=kt>void</span> <span class=o>*</span><span class=p>)</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>increment</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>__curbrk</span><span class=p>;</span> <span class=c1>// 返回当前堆顶地址
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=n>oldbrk</span> <span class=o>=</span> <span class=n>__curbrk</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>increment</span> <span class=o>&gt;</span> <span class=mi>0</span> <span class=c1>// 检测溢出
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=o>?</span> <span class=p>((</span><span class=kt>uintptr_t</span><span class=p>)</span> <span class=n>oldbrk</span> <span class=o>+</span> <span class=p>(</span><span class=kt>uintptr_t</span><span class=p>)</span> <span class=n>increment</span> <span class=o>&lt;</span> <span class=p>(</span><span class=kt>uintptr_t</span><span class=p>)</span> <span class=n>oldbrk</span><span class=p>)</span> <span class=c1>// 扩展正值后反而大小变小
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=o>:</span> <span class=p>((</span><span class=kt>uintptr_t</span><span class=p>)</span> <span class=n>oldbrk</span> <span class=o>&lt;</span> <span class=p>(</span><span class=kt>uintptr_t</span><span class=p>)</span> <span class=o>-</span><span class=n>increment</span><span class=p>))</span> <span class=c1>// 扩展后变为负值
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nf>__set_errno</span> <span class=p>(</span><span class=n>ENOMEM</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=p>(</span><span class=kt>void</span> <span class=o>*</span><span class=p>)</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nf>__brk</span> <span class=p>(</span><span class=n>oldbrk</span> <span class=o>+</span> <span class=n>increment</span><span class=p>)</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span> <span class=c1>// 最终调用__brk扩展地址
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>return</span> <span class=p>(</span><span class=kt>void</span> <span class=o>*</span><span class=p>)</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>oldbrk</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>__brk</span> <span class=p>(</span><span class=kt>void</span> <span class=o>*</span><span class=n>addr</span><span class=p>)</span> <span class=c1>// 目标堆顶地址
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kt>void</span> <span class=o>*</span><span class=n>newbrk</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>__curbrk</span> <span class=o>=</span> <span class=n>newbrk</span> <span class=o>=</span> <span class=p>(</span><span class=kt>void</span> <span class=o>*</span><span class=p>)</span> <span class=nf>INLINE_SYSCALL</span> <span class=p>(</span><span class=n>brk</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=n>addr</span><span class=p>);</span> 
</span></span><span class=line><span class=cl>  <span class=c1>// 内核brk系统调用调整堆顶地址，此时__curbrk为当前堆顶地址
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>newbrk</span> <span class=o>&lt;</span> <span class=n>addr</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nf>__set_errno</span> <span class=p>(</span><span class=n>ENOMEM</span><span class=p>);</span> <span class=c1>// 操作失败返回-1
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=k>return</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=mi>0</span><span class=p>;</span> <span class=c1>// 成功返回0
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span></span></span></code></pre></div></div><h3 id=free>free</h3><h4 id=223-2>2.23</h4><h5 id=__libc_free>__libc_free</h5><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-c"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=复制到剪贴板><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=kt>void</span> <span class=nf>__libc_free</span><span class=p>(</span><span class=kt>void</span> <span class=o>*</span><span class=n>mem</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>mstate</span> <span class=n>ar_ptr</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>mchunkptr</span> <span class=n>p</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kt>void</span> <span class=p>(</span><span class=o>*</span><span class=n>hook</span><span class=p>)(</span><span class=kt>void</span> <span class=o>*</span><span class=p>,</span> <span class=k>const</span> <span class=kt>void</span> <span class=o>*</span><span class=p>)</span> <span class=o>=</span> <span class=nf>atomic_forced_read</span><span class=p>(</span><span class=n>__free_hook</span><span class=p>);</span> <span class=c1>// 原子读free_hook
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=p>(</span><span class=nf>__builtin_expect</span><span class=p>(</span><span class=n>hook</span> <span class=o>!=</span> <span class=nb>NULL</span><span class=p>,</span> <span class=mi>0</span><span class=p>))</span> <span class=c1>// 查看free_hook是否被设置
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=p>(</span><span class=o>*</span><span class=n>hook</span><span class=p>)(</span><span class=n>mem</span><span class=p>,</span> <span class=nf>RETURN_ADDRESS</span><span class=p>(</span><span class=mi>0</span><span class=p>));</span> <span class=c1>// 非空则调用该hook
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>mem</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=cm>/* 需要释放的内存为0，free(0)无效 */</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>p</span> <span class=o>=</span> <span class=nf>mem2chunk</span><span class=p>(</span><span class=n>mem</span><span class=p>);</span> <span class=c1>// 用户内存指针转换为chunk指针
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nf>chunk_is_mmapped</span><span class=p>(</span><span class=n>p</span><span class=p>))</span> <span class=cm>/* 若是mmap申请的内存 */</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=cm>/* 
</span></span></span><span class=line><span class=cl><span class=cm>    	no_dyn_threshold初始默认为0, free的堆大小大于mmap阈值且小于默认最大的mmap阈值
</span></span></span><span class=line><span class=cl><span class=cm>    	说明mmap需求量大，但耗时大，于是调节阈值mmap_threshold来使得倾向于用brk而非mmap
</span></span></span><span class=line><span class=cl><span class=cm>    	#define DEFAULT_MMAP_THRESHOLD_MAX (4 * 1024 * 1024 * sizeof(long))
</span></span></span><span class=line><span class=cl><span class=cm>    	trim_threshold 为是否 systrim 减少 ptmalloc 保留内存的参考值
</span></span></span><span class=line><span class=cl><span class=cm>    */</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>mp_</span><span class=p>.</span><span class=n>no_dyn_threshold</span> <span class=o>&amp;&amp;</span> <span class=n>p</span><span class=o>-&gt;</span><span class=n>size</span> <span class=o>&gt;</span> <span class=n>mp_</span><span class=p>.</span><span class=n>mmap_threshold</span> <span class=o>&amp;&amp;</span> <span class=n>p</span><span class=o>-&gt;</span><span class=n>size</span> <span class=o>&lt;=</span> <span class=n>DEFAULT_MMAP_THRESHOLD_MAX</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>mp_</span><span class=p>.</span><span class=n>mmap_threshold</span> <span class=o>=</span> <span class=nf>chunksize</span><span class=p>(</span><span class=n>p</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=n>mp_</span><span class=p>.</span><span class=n>trim_threshold</span> <span class=o>=</span> <span class=mi>2</span> <span class=o>*</span> <span class=n>mp_</span><span class=p>.</span><span class=n>mmap_threshold</span><span class=p>;</span> <span class=c1>// 收缩阈值也提高
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nf>LIBC_PROBE</span><span class=p>(</span><span class=n>memory_mallopt_free_dyn_thresholds</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=n>mp_</span><span class=p>.</span><span class=n>mmap_threshold</span><span class=p>,</span> <span class=n>mp_</span><span class=p>.</span><span class=n>trim_threshold</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nf>munmap_chunk</span><span class=p>(</span><span class=n>p</span><span class=p>);</span> <span class=c1>// 调用了__munmap释放映射
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>      
</span></span><span class=line><span class=cl>  <span class=c1>// 内存由ptmalloc申请的而非mmap申请
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>ar_ptr</span> <span class=o>=</span> <span class=nf>arena_for_chunk</span><span class=p>(</span><span class=n>p</span><span class=p>);</span> <span class=c1>// 获取arena
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nf>_int_free</span><span class=p>(</span><span class=n>ar_ptr</span><span class=p>,</span> <span class=n>p</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span> <span class=c1>// 调用_int_free进行堆块释放
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span></span></span></code></pre></div></div><h5 id=_int_free>_int_free</h5><div class="code-block code-line-numbers" style="counter-reset:code-block 0"><div class="code-header language-c"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=复制到剪贴板><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>static</span> <span class=kt>void</span> <span class=nf>_int_free</span><span class=p>(</span><span class=n>mstate</span> <span class=n>av</span><span class=p>,</span> <span class=n>mchunkptr</span> <span class=n>p</span><span class=p>,</span> <span class=kt>int</span> <span class=n>have_lock</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>INTERNAL_SIZE_T</span> <span class=n>size</span><span class=p>;</span>     <span class=cm>/* 释放的chunk的大小 */</span>
</span></span><span class=line><span class=cl>  <span class=n>mfastbinptr</span> <span class=o>*</span><span class=n>fb</span><span class=p>;</span>          <span class=cm>/* 对应的fastbin */</span>
</span></span><span class=line><span class=cl>  <span class=n>mchunkptr</span> <span class=n>nextchunk</span><span class=p>;</span>      <span class=cm>/* 内存空间中下一个连续的chunk */</span>
</span></span><span class=line><span class=cl>  <span class=n>INTERNAL_SIZE_T</span> <span class=n>nextsize</span><span class=p>;</span> <span class=cm>/* 下一个chunk大小 */</span>
</span></span><span class=line><span class=cl>  <span class=kt>int</span> <span class=n>nextinuse</span><span class=p>;</span>            <span class=cm>/* 下一个chunk是否在使用 */</span>
</span></span><span class=line><span class=cl>  <span class=n>INTERNAL_SIZE_T</span> <span class=n>prevsize</span><span class=p>;</span> <span class=cm>/* 内存空间中上一个连续的chunk */</span>
</span></span><span class=line><span class=cl>  <span class=n>mchunkptr</span> <span class=n>bck</span><span class=p>;</span>            <span class=cm>/* 存储bin链表指针 */</span>
</span></span><span class=line><span class=cl>  <span class=n>mchunkptr</span> <span class=n>fwd</span><span class=p>;</span>            <span class=cm>/* 存储bin链表指针 */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=n>errstr</span> <span class=o>=</span> <span class=nb>NULL</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>int</span> <span class=n>locked</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>size</span> <span class=o>=</span> <span class=nf>chunksize</span><span class=p>(</span><span class=n>p</span><span class=p>);</span> <span class=c1>// 获取chunk大小
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// 检查1：-size强制转换为无符号整型会发生模运算转换为接近地址空间的最大值，通过判断p和-size防止指针越界溢出
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=p>(</span><span class=nf>__builtin_expect</span><span class=p>((</span><span class=kt>uintptr_t</span><span class=p>)</span><span class=n>p</span> <span class=o>&gt;</span> <span class=p>(</span><span class=kt>uintptr_t</span><span class=p>)</span><span class=o>-</span><span class=n>size</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span> <span class=o>||</span> <span class=nf>__builtin_expect</span><span class=p>(</span><span class=nf>misaligned_chunk</span><span class=p>(</span><span class=n>p</span><span class=p>),</span> <span class=mi>0</span><span class=p>))</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// 检查2：是否与MALLOC_ALIGN_MASK对齐
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>errstr</span> <span class=o>=</span> <span class=s>&#34;free(): invalid pointer&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nl>errout</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>have_lock</span> <span class=o>&amp;&amp;</span> <span class=n>locked</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>(</span><span class=kt>void</span><span class=p>)</span><span class=nf>mutex_unlock</span><span class=p>(</span><span class=o>&amp;</span><span class=n>av</span><span class=o>-&gt;</span><span class=n>mutex</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>malloc_printerr</span><span class=p>(</span><span class=n>check_action</span><span class=p>,</span> <span class=n>errstr</span><span class=p>,</span> <span class=nf>chunk2mem</span><span class=p>(</span><span class=n>p</span><span class=p>),</span> <span class=n>av</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 若大小比 MINSIZE小或size不对齐，则不能free
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=p>(</span><span class=nf>__glibc_unlikely</span><span class=p>(</span><span class=n>size</span> <span class=o>&lt;</span> <span class=n>MINSIZE</span> <span class=o>||</span> <span class=o>!</span><span class=nf>aligned_OK</span><span class=p>(</span><span class=n>size</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>errstr</span> <span class=o>=</span> <span class=s>&#34;free(): invalid size&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>goto</span> <span class=n>errout</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nf>check_inuse_chunk</span><span class=p>(</span><span class=n>av</span><span class=p>,</span> <span class=n>p</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>  <span class=c1>// 在 fastbin 范围内
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=p>((</span><span class=kt>unsigned</span> <span class=kt>long</span><span class=p>)(</span><span class=n>size</span><span class=p>)</span> <span class=o>&lt;=</span> <span class=p>(</span><span class=kt>unsigned</span> <span class=kt>long</span><span class=p>)(</span><span class=nf>get_max_fast</span><span class=p>())</span>
</span></span><span class=line><span class=cl><span class=cp>#if TRIM_FASTBINS
</span></span></span><span class=line><span class=cl><span class=cp></span>      <span class=o>&amp;&amp;</span> <span class=p>(</span><span class=nf>chunk_at_offset</span><span class=p>(</span><span class=n>p</span><span class=p>,</span> <span class=n>size</span><span class=p>)</span> <span class=o>!=</span> <span class=n>av</span><span class=o>-&gt;</span><span class=n>top</span><span class=p>)</span> <span class=c1>// 且下一个chunk不是top chunk
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=cp>#endif
</span></span></span><span class=line><span class=cl><span class=cp></span>  <span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>		<span class=c1>// 若下一个chunk大小小于2*0x8=0x10或大于系统可用的内存，进入报错部分
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=nf>__builtin_expect</span><span class=p>(</span><span class=nf>chunk_at_offset</span><span class=p>(</span><span class=n>p</span><span class=p>,</span> <span class=n>size</span><span class=p>)</span><span class=o>-&gt;</span><span class=n>size</span> <span class=o>&lt;=</span> <span class=mi>2</span> <span class=o>*</span> <span class=n>SIZE_SZ</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span> <span class=o>||</span> 
</span></span><span class=line><span class=cl>        <span class=nf>__builtin_expect</span><span class=p>(</span><span class=nf>chunksize</span><span class=p>(</span><span class=nf>chunk_at_offset</span><span class=p>(</span><span class=n>p</span><span class=p>,</span> <span class=n>size</span><span class=p>))</span> <span class=o>&gt;=</span> <span class=n>av</span><span class=o>-&gt;</span><span class=n>system_mem</span><span class=p>,</span> <span class=mi>0</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=n>have_lock</span> <span class=o>||</span> <span class=c1>// 有互斥锁则直接进入报错
</span></span></span><span class=line><span class=cl><span class=c1></span>         	<span class=p>({</span><span class=nf>assert</span><span class=p>(</span><span class=n>locked</span> <span class=o>==</span> <span class=mi>0</span><span class=p>);</span><span class=nf>mutex_lock</span><span class=p>(</span><span class=o>&amp;</span><span class=n>av</span><span class=o>-&gt;</span><span class=n>mutex</span><span class=p>);</span><span class=n>locked</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span> <span class=c1>// 无锁则显式上锁之后再检查判断
</span></span></span><span class=line><span class=cl><span class=c1></span>            		<span class=nf>chunk_at_offset</span><span class=p>(</span><span class=n>p</span><span class=p>,</span> <span class=n>size</span><span class=p>)</span><span class=o>-&gt;</span><span class=n>size</span> <span class=o>&lt;=</span> <span class=mi>2</span> <span class=o>*</span> <span class=n>SIZE_SZ</span> <span class=o>||</span> 
</span></span><span class=line><span class=cl>            		<span class=nf>chunksize</span><span class=p>(</span><span class=nf>chunk_at_offset</span><span class=p>(</span><span class=n>p</span><span class=p>,</span> <span class=n>size</span><span class=p>))</span> <span class=o>&gt;=</span> <span class=n>av</span><span class=o>-&gt;</span><span class=n>system_mem</span><span class=p>;</span>
</span></span><span class=line><span class=cl>             <span class=p>})</span>
</span></span><span class=line><span class=cl>         <span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>errstr</span> <span class=o>=</span> <span class=s>&#34;free(): invalid next size (fast)&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>goto</span> <span class=n>errout</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>have_lock</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>{</span> <span class=c1>// 读取分配区所分配的内存总量需要对分配区加锁,检查完以后,释放分配区的锁
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=p>(</span><span class=kt>void</span><span class=p>)</span><span class=nf>mutex_unlock</span><span class=p>(</span><span class=o>&amp;</span><span class=n>av</span><span class=o>-&gt;</span><span class=n>mutex</span><span class=p>);</span> <span class=c1>// 解锁
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>locked</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nf>free_perturb</span><span class=p>(</span><span class=nf>chunk2mem</span><span class=p>(</span><span class=n>p</span><span class=p>),</span> <span class=n>size</span> <span class=o>-</span> <span class=mi>2</span> <span class=o>*</span> <span class=n>SIZE_SZ</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nf>set_fastchunks</span><span class=p>(</span><span class=n>av</span><span class=p>);</span> <span class=c1>// 设置arena fastchunk标志位表明有使用fastbin
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kt>unsigned</span> <span class=kt>int</span> <span class=n>idx</span> <span class=o>=</span> <span class=nf>fastbin_index</span><span class=p>(</span><span class=n>size</span><span class=p>);</span> <span class=c1>// 获取fastbin索引
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>fb</span> <span class=o>=</span> <span class=o>&amp;</span><span class=nf>fastbin</span><span class=p>(</span><span class=n>av</span><span class=p>,</span> <span class=n>idx</span><span class=p>);</span> <span class=c1>// fb指向fastbin的地址
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=n>mchunkptr</span> <span class=n>old</span> <span class=o>=</span> <span class=o>*</span><span class=n>fb</span><span class=p>,</span> <span class=n>old2</span><span class=p>;</span> <span class=c1>// old为fastbin中第一个chunk
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kt>unsigned</span> <span class=kt>int</span> <span class=n>old_idx</span> <span class=o>=</span> <span class=o>~</span><span class=mi>0u</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>do</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=nf>__builtin_expect</span><span class=p>(</span><span class=n>old</span> <span class=o>==</span> <span class=n>p</span><span class=p>,</span> <span class=mi>0</span><span class=p>))</span>
</span></span><span class=line><span class=cl>      <span class=p>{</span> <span class=c1>// 释放的chunk p和fastbin中第一个chunk是同一个chunk，报错double free
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>errstr</span> <span class=o>=</span> <span class=s>&#34;double free or corruption (fasttop)&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>goto</span> <span class=n>errout</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=n>have_lock</span> <span class=o>&amp;&amp;</span> <span class=n>old</span> <span class=o>!=</span> <span class=nb>NULL</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>old_idx</span> <span class=o>=</span> <span class=nf>fastbin_index</span><span class=p>(</span><span class=nf>chunksize</span><span class=p>(</span><span class=n>old</span><span class=p>));</span>
</span></span><span class=line><span class=cl>      <span class=n>p</span><span class=o>-&gt;</span><span class=n>fd</span> <span class=o>=</span> <span class=n>old2</span> <span class=o>=</span> <span class=n>old</span><span class=p>;</span> <span class=c1>// p的fd指向old，即将p插到第一个chunk位置
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=c1>// *fb = p，即将fastbin的fd指向p
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>}</span> <span class=k>while</span> <span class=p>((</span><span class=n>old</span> <span class=o>=</span> <span class=nf>catomic_compare_and_exchange_val_rel</span><span class=p>(</span><span class=n>fb</span><span class=p>,</span> <span class=n>p</span><span class=p>,</span> <span class=n>old2</span><span class=p>))</span> <span class=o>!=</span> <span class=n>old2</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>have_lock</span> <span class=o>&amp;&amp;</span> <span class=n>old</span> <span class=o>!=</span> <span class=nb>NULL</span> <span class=o>&amp;&amp;</span> <span class=nf>__builtin_expect</span><span class=p>(</span><span class=n>old_idx</span> <span class=o>!=</span> <span class=n>idx</span><span class=p>,</span> <span class=mi>0</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span> <span class=c1>// 判断：old的索引是否也是该fastbin对应索引
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=n>errstr</span> <span class=o>=</span> <span class=s>&#34;invalid fastbin entry (free)&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=k>goto</span> <span class=n>errout</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 再次判断，若不是mmap的，则是ptmalloc，前向后向合并放入unsorted bin
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nf>chunk_is_mmapped</span><span class=p>(</span><span class=n>p</span><span class=p>))</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>have_lock</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=p>(</span><span class=kt>void</span><span class=p>)</span><span class=nf>mutex_lock</span><span class=p>(</span><span class=o>&amp;</span><span class=n>av</span><span class=o>-&gt;</span><span class=n>mutex</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=n>locked</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>nextchunk</span> <span class=o>=</span> <span class=nf>chunk_at_offset</span><span class=p>(</span><span class=n>p</span><span class=p>,</span> <span class=n>size</span><span class=p>);</span> <span class=c1>// 找到其下一个chunk
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nf>__glibc_unlikely</span><span class=p>(</span><span class=n>p</span> <span class=o>==</span> <span class=n>av</span><span class=o>-&gt;</span><span class=n>top</span><span class=p>))</span> <span class=c1>// 检查是不是释放top chunk
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>errstr</span> <span class=o>=</span> <span class=s>&#34;double free or corruption (top)&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=k>goto</span> <span class=n>errout</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nf>__builtin_expect</span><span class=p>(</span><span class=nf>contiguous</span><span class=p>(</span><span class=n>av</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=p>(</span><span class=kt>char</span> <span class=o>*</span><span class=p>)</span><span class=n>nextchunk</span> <span class=o>&gt;=</span> <span class=p>((</span><span class=kt>char</span> <span class=o>*</span><span class=p>)</span><span class=n>av</span><span class=o>-&gt;</span><span class=n>top</span> <span class=o>+</span> <span class=nf>chunksize</span><span class=p>(</span><span class=n>av</span><span class=o>-&gt;</span><span class=n>top</span><span class=p>)),</span> <span class=mi>0</span><span class=p>))</span><span class=c1>// 若arena连续且下一个chunk地址大于top chunk的结束地址，即已经到top chunk外
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>errstr</span> <span class=o>=</span> <span class=s>&#34;double free or corruption (out)&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=k>goto</span> <span class=n>errout</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=c1>// 下一个chunk的prev_inuse未置位表示p是已经释放了的
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=nf>__glibc_unlikely</span><span class=p>(</span><span class=o>!</span><span class=nf>prev_inuse</span><span class=p>(</span><span class=n>nextchunk</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>errstr</span> <span class=o>=</span> <span class=s>&#34;double free or corruption (!prev)&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=k>goto</span> <span class=n>errout</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=c1>// 获取下一个chunk的大小
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>nextsize</span> <span class=o>=</span> <span class=nf>chunksize</span><span class=p>(</span><span class=n>nextchunk</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nf>__builtin_expect</span><span class=p>(</span><span class=n>nextchunk</span><span class=o>-&gt;</span><span class=n>size</span> <span class=o>&lt;=</span> <span class=mi>2</span> <span class=o>*</span> <span class=n>SIZE_SZ</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span> <span class=o>||</span> <span class=nf>__builtin_expect</span><span class=p>(</span><span class=n>nextsize</span> <span class=o>&gt;=</span> <span class=n>av</span><span class=o>-&gt;</span><span class=n>system_mem</span><span class=p>,</span> <span class=mi>0</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span> <span class=c1>// 大小小于0x10或大于系统内存大小，报错
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=n>errstr</span> <span class=o>=</span> <span class=s>&#34;free(): invalid next size (normal)&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=k>goto</span> <span class=n>errout</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nf>free_perturb</span><span class=p>(</span><span class=nf>chunk2mem</span><span class=p>(</span><span class=n>p</span><span class=p>),</span> <span class=n>size</span> <span class=o>-</span> <span class=mi>2</span> <span class=o>*</span> <span class=n>SIZE_SZ</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 若p的前一个chunk是空闲的，向前合并
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nf>prev_inuse</span><span class=p>(</span><span class=n>p</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>prevsize</span> <span class=o>=</span> <span class=n>p</span><span class=o>-&gt;</span><span class=n>prev_size</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=n>size</span> <span class=o>+=</span> <span class=n>prevsize</span><span class=p>;</span> <span class=c1>// 合并后chunk大小
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=n>p</span> <span class=o>=</span> <span class=nf>chunk_at_offset</span><span class=p>(</span><span class=n>p</span><span class=p>,</span> <span class=o>-</span><span class=p>((</span><span class=kt>long</span><span class=p>)</span><span class=n>prevsize</span><span class=p>));</span> <span class=c1>// p指向前一个chunk
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nf>unlink</span><span class=p>(</span><span class=n>av</span><span class=p>,</span> <span class=n>p</span><span class=p>,</span> <span class=n>bck</span><span class=p>,</span> <span class=n>fwd</span><span class=p>);</span> <span class=c1>// 将两个chunk合并脱链
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>nextchunk</span> <span class=o>!=</span> <span class=n>av</span><span class=o>-&gt;</span><span class=n>top</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span> <span class=c1>// 若下一个chunk不是 top chunk
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=n>nextinuse</span> <span class=o>=</span> <span class=nf>inuse_bit_at_offset</span><span class=p>(</span><span class=n>nextchunk</span><span class=p>,</span> <span class=n>nextsize</span><span class=p>);</span> <span class=c1>// 下一个chunk的下一个chunk的prev_inuse
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>nextinuse</span><span class=p>)</span> <span class=c1>// 表示下一个chunk未使用，空闲，则后向合并
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>unlink</span><span class=p>(</span><span class=n>av</span><span class=p>,</span> <span class=n>nextchunk</span><span class=p>,</span> <span class=n>bck</span><span class=p>,</span> <span class=n>fwd</span><span class=p>);</span> <span class=c1>// 将下一个chunk脱链
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>size</span> <span class=o>+=</span> <span class=n>nextsize</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=k>else</span> <span class=c1>// 下一个chunk不空闲
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nf>clear_inuse_bit_at_offset</span><span class=p>(</span><span class=n>nextchunk</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span> <span class=c1>// 则清除下一个chunk的prev_inuse
</span></span></span><span class=line><span class=cl><span class=c1></span>	  
</span></span><span class=line><span class=cl>      <span class=c1>// 准备插入合并的chunk到unsorted bin
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=n>bck</span> <span class=o>=</span> <span class=nf>unsorted_chunks</span><span class=p>(</span><span class=n>av</span><span class=p>);</span> <span class=c1>// 获取unsorted bin地址
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=n>fwd</span> <span class=o>=</span> <span class=n>bck</span><span class=o>-&gt;</span><span class=n>fd</span><span class=p>;</span> <span class=c1>// 获取unsorted bin的fd指向的第一个chunk
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=k>if</span> <span class=p>(</span><span class=nf>__glibc_unlikely</span><span class=p>(</span><span class=n>fwd</span><span class=o>-&gt;</span><span class=n>bk</span> <span class=o>!=</span> <span class=n>bck</span><span class=p>))</span> <span class=c1>// 判断：fwd的bk是否反向指回bck
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>errstr</span> <span class=o>=</span> <span class=s>&#34;free(): corrupted unsorted chunks&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>goto</span> <span class=n>errout</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=c1>// 将 p 插入到unsorted bin中
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=n>p</span><span class=o>-&gt;</span><span class=n>fd</span> <span class=o>=</span> <span class=n>fwd</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=n>p</span><span class=o>-&gt;</span><span class=n>bk</span> <span class=o>=</span> <span class=n>bck</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nf>in_smallbin_range</span><span class=p>(</span><span class=n>size</span><span class=p>))</span>
</span></span><span class=line><span class=cl>      <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>p</span><span class=o>-&gt;</span><span class=n>fd_nextsize</span> <span class=o>=</span> <span class=nb>NULL</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>p</span><span class=o>-&gt;</span><span class=n>bk_nextsize</span> <span class=o>=</span> <span class=nb>NULL</span><span class=p>;</span> <span class=c1>// large bin要设置两个nextsize
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=n>bck</span><span class=o>-&gt;</span><span class=n>fd</span> <span class=o>=</span> <span class=n>p</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=n>fwd</span><span class=o>-&gt;</span><span class=n>bk</span> <span class=o>=</span> <span class=n>p</span><span class=p>;</span> <span class=c1>// 此时 p 插入到bin 的 fd 指向的第一个 chunk 位置
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>      <span class=nf>set_head</span><span class=p>(</span><span class=n>p</span><span class=p>,</span> <span class=n>size</span> <span class=o>|</span> <span class=n>PREV_INUSE</span><span class=p>);</span> <span class=c1>// 更新
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nf>set_foot</span><span class=p>(</span><span class=n>p</span><span class=p>,</span> <span class=n>size</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=nf>check_free_chunk</span><span class=p>(</span><span class=n>av</span><span class=p>,</span> <span class=n>p</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span> <span class=c1>// 若下一个chunk是 top chunk
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=n>size</span> <span class=o>+=</span> <span class=n>nextsize</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=nf>set_head</span><span class=p>(</span><span class=n>p</span><span class=p>,</span> <span class=n>size</span> <span class=o>|</span> <span class=n>PREV_INUSE</span><span class=p>);</span> <span class=c1>// 更新标志
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=n>av</span><span class=o>-&gt;</span><span class=n>top</span> <span class=o>=</span> <span class=n>p</span><span class=p>;</span> <span class=c1>// 与p后的top chunk合并，更新p为 top chunk地址
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nf>check_chunk</span><span class=p>(</span><span class=n>av</span><span class=p>,</span> <span class=n>p</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1>// 大小大于 65536，进行堆收缩操作
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>((</span><span class=kt>unsigned</span> <span class=kt>long</span><span class=p>)(</span><span class=n>size</span><span class=p>)</span> <span class=o>&gt;=</span> <span class=n>FASTBIN_CONSOLIDATION_THRESHOLD</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=nf>have_fastchunks</span><span class=p>(</span><span class=n>av</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=nf>malloc_consolidate</span><span class=p>(</span><span class=n>av</span><span class=p>);</span> <span class=c1>// 有fast chunk则将fastbin中chunk合并放入unsorted bin中
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=n>av</span> <span class=o>==</span> <span class=o>&amp;</span><span class=n>main_arena</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>{</span> <span class=c1>// 主线程中，brk申请的
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=cp>#ifndef MORECORE_CANNOT_TRIM </span><span class=c1>// top chunk 大小大于 收缩阈值
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>if</span> <span class=p>((</span><span class=kt>unsigned</span> <span class=kt>long</span><span class=p>)(</span><span class=nf>chunksize</span><span class=p>(</span><span class=n>av</span><span class=o>-&gt;</span><span class=n>top</span><span class=p>))</span> <span class=o>&gt;=</span> <span class=p>(</span><span class=kt>unsigned</span> <span class=kt>long</span><span class=p>)(</span><span class=n>mp_</span><span class=p>.</span><span class=n>trim_threshold</span><span class=p>))</span>
</span></span><span class=line><span class=cl>          <span class=nf>systrim</span><span class=p>(</span><span class=n>mp_</span><span class=p>.</span><span class=n>top_pad</span><span class=p>,</span> <span class=n>av</span><span class=p>);</span> <span class=c1>// 进行top chunk收缩操作
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=cp>#endif
</span></span></span><span class=line><span class=cl><span class=cp></span>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=k>else</span> <span class=c1>// 非主线程中，mmap申请的
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>heap_info</span> <span class=o>*</span><span class=n>heap</span> <span class=o>=</span> <span class=nf>heap_for_ptr</span><span class=p>(</span><span class=nf>top</span><span class=p>(</span><span class=n>av</span><span class=p>));</span> <span class=c1>// 先找到heap结构体
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nf>assert</span><span class=p>(</span><span class=n>heap</span><span class=o>-&gt;</span><span class=n>ar_ptr</span> <span class=o>==</span> <span class=n>av</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nf>heap_trim</span><span class=p>(</span><span class=n>heap</span><span class=p>,</span> <span class=n>mp_</span><span class=p>.</span><span class=n>top_pad</span><span class=p>);</span><span class=c1>// 进行堆收缩操作
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>have_lock</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nf>assert</span><span class=p>(</span><span class=n>locked</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=p>(</span><span class=kt>void</span><span class=p>)</span><span class=nf>mutex_unlock</span><span class=p>(</span><span class=o>&amp;</span><span class=n>av</span><span class=o>-&gt;</span><span class=n>mutex</span><span class=p>);</span> <span class=c1>// 解锁
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>else</span> <span class=c1>// 若是mmap的chunk，则释放映射，类似__libc_free中的检查
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nf>munmap_chunk</span><span class=p>(</span><span class=n>p</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div><h5 id=munmap_chunk>munmap_chunk</h5><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-c"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=复制到剪贴板><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>static</span> <span class=kt>void</span> <span class=n>internal_function</span> <span class=nf>munmap_chunk</span><span class=p>(</span><span class=n>mchunkptr</span> <span class=n>p</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>INTERNAL_SIZE_T</span> <span class=n>size</span> <span class=o>=</span> <span class=nf>chunksize</span><span class=p>(</span><span class=n>p</span><span class=p>);</span> <span class=c1>// 获取chunk大小
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nf>assert</span><span class=p>(</span><span class=nf>chunk_is_mmapped</span><span class=p>(</span><span class=n>p</span><span class=p>));</span> <span class=c1>// 检查是mmap分配
</span></span></span><span class=line><span class=cl><span class=c1></span>    
</span></span><span class=line><span class=cl>  <span class=c1>// mmap分配的chunk一般为独立的即p-&gt;prev_size为0，因此还是释放一个chunk
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kt>uintptr_t</span> <span class=n>block</span> <span class=o>=</span> <span class=p>(</span><span class=kt>uintptr_t</span><span class=p>)</span><span class=n>p</span> <span class=o>-</span> <span class=n>p</span><span class=o>-&gt;</span><span class=n>prev_size</span><span class=p>;</span>  <span class=c1>// 获取前一个chunk的指针block
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kt>size_t</span> <span class=n>total_size</span> <span class=o>=</span> <span class=n>p</span><span class=o>-&gt;</span><span class=n>prev_size</span> <span class=o>+</span> <span class=n>size</span><span class=p>;</span> <span class=c1>// 计算两个chunk的总大小
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nf>__builtin_expect</span><span class=p>(((</span><span class=n>block</span> <span class=o>|</span> <span class=n>total_size</span><span class=p>)</span> <span class=o>&amp;</span> <span class=p>(</span><span class=nf>GLRO</span><span class=p>(</span><span class=n>dl_pagesize</span><span class=p>)</span> <span class=o>-</span> <span class=mi>1</span><span class=p>))</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>))</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span> <span class=c1>// 检查是否页对齐
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nf>malloc_printerr</span><span class=p>(</span><span class=n>check_action</span><span class=p>,</span> <span class=s>&#34;munmap_chunk(): invalid pointer&#34;</span><span class=p>,</span> <span class=nf>chunk2mem</span><span class=p>(</span><span class=n>p</span><span class=p>),</span> <span class=nb>NULL</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=nf>atomic_decrement</span><span class=p>(</span><span class=o>&amp;</span><span class=n>mp_</span><span class=p>.</span><span class=n>n_mmaps</span><span class=p>);</span> <span class=c1>// 减少mmap内存快的计数
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nf>atomic_add</span><span class=p>(</span><span class=o>&amp;</span><span class=n>mp_</span><span class=p>.</span><span class=n>mmapped_mem</span><span class=p>,</span> <span class=o>-</span><span class=n>total_size</span><span class=p>);</span> <span class=c1>// 更新mmap分配的总内存量
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=nf>__munmap</span><span class=p>((</span><span class=kt>char</span> <span class=o>*</span><span class=p>)</span><span class=n>block</span><span class=p>,</span> <span class=n>total_size</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div><h5 id=arena_for_chunk>arena_for_chunk</h5><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-c"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=复制到剪贴板><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#define arena_for_chunk(ptr)
</span></span></span><span class=line><span class=cl><span class=cp></span>  <span class=p>(</span><span class=nf>chunk_non_main_arena</span> <span class=p>(</span><span class=n>ptr</span><span class=p>)</span> <span class=o>?</span> <span class=nf>heap_for_ptr</span> <span class=p>(</span><span class=n>ptr</span><span class=p>)</span><span class=o>-&gt;</span><span class=nl>ar_ptr</span> <span class=p>:</span> <span class=o>&amp;</span><span class=n>main_arena</span><span class=p>)</span> 
</span></span><span class=line><span class=cl><span class=c1>// 是main_arena直接返回，否则用heap_for_ptr宏
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=cp>#define chunk_non_main_arena(p) ((p)-&gt;size &amp; NON_MAIN_ARENA)
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=cp>#define heap_for_ptr(ptr)
</span></span></span><span class=line><span class=cl><span class=cp></span>  <span class=p>((</span><span class=n>heap_info</span> <span class=o>*</span><span class=p>)</span> <span class=p>((</span><span class=kt>unsigned</span> <span class=kt>long</span><span class=p>)</span> <span class=p>(</span><span class=n>ptr</span><span class=p>)</span> <span class=o>&amp;</span> <span class=o>~</span><span class=p>(</span><span class=n>HEAP_MAX_SIZE</span> <span class=o>-</span> <span class=mi>1</span><span class=p>)))</span> <span class=c1>// 对ptr对齐找arena
</span></span></span></code></pre></div></div><h5 id=systrim>systrim</h5><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-c"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=复制到剪贴板><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>static</span> <span class=kt>int</span>
</span></span><span class=line><span class=cl><span class=nf>systrim</span><span class=p>(</span><span class=kt>size_t</span> <span class=n>pad</span><span class=p>,</span> <span class=n>mstate</span> <span class=n>av</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kt>long</span> <span class=n>top_size</span><span class=p>;</span>     <span class=cm>/* Amount of top-most memory */</span>
</span></span><span class=line><span class=cl>  <span class=kt>long</span> <span class=n>extra</span><span class=p>;</span>        <span class=cm>/* Amount to release */</span>
</span></span><span class=line><span class=cl>  <span class=kt>long</span> <span class=n>released</span><span class=p>;</span>     <span class=cm>/* Amount actually released */</span>
</span></span><span class=line><span class=cl>  <span class=kt>char</span> <span class=o>*</span><span class=n>current_brk</span><span class=p>;</span> <span class=cm>/* address returned by pre-check sbrk call */</span>
</span></span><span class=line><span class=cl>  <span class=kt>char</span> <span class=o>*</span><span class=n>new_brk</span><span class=p>;</span>     <span class=cm>/* address returned by post-check sbrk call */</span>
</span></span><span class=line><span class=cl>  <span class=kt>size_t</span> <span class=n>pagesize</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>long</span> <span class=n>top_area</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>pagesize</span> <span class=o>=</span> <span class=nf>GLRO</span><span class=p>(</span><span class=n>dl_pagesize</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=n>top_size</span> <span class=o>=</span> <span class=nf>chunksize</span><span class=p>(</span><span class=n>av</span><span class=o>-&gt;</span><span class=n>top</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>top_area</span> <span class=o>=</span> <span class=n>top_size</span> <span class=o>-</span> <span class=n>MINSIZE</span> <span class=o>-</span> <span class=mi>1</span><span class=p>;</span> <span class=c1>// top chunk 大小 - 0x20 - 1
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=p>(</span><span class=n>top_area</span> <span class=o>&lt;=</span> <span class=n>pad</span><span class=p>)</span> <span class=c1>// 若小于则说明 top chunk 本来就没啥空间，直接返回
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>extra</span> <span class=o>=</span> <span class=nf>ALIGN_DOWN</span><span class=p>(</span><span class=n>top_area</span> <span class=o>-</span> <span class=n>pad</span><span class=p>,</span> <span class=n>pagesize</span><span class=p>);</span> <span class=c1>// 将主分配区中可以缩小的大小对页面对齐后保存在extra中
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>extra</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=c1>// 无可收缩则退出
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>current_brk</span> <span class=o>=</span> <span class=p>(</span><span class=kt>char</span> <span class=o>*</span><span class=p>)(</span><span class=nf>MORECORE</span><span class=p>(</span><span class=mi>0</span><span class=p>));</span> <span class=c1>// 0 即返回当前的堆顶地址
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=p>(</span><span class=n>current_brk</span> <span class=o>==</span> <span class=p>(</span><span class=kt>char</span> <span class=o>*</span><span class=p>)(</span><span class=n>av</span><span class=o>-&gt;</span><span class=n>top</span><span class=p>)</span> <span class=o>+</span> <span class=n>top_size</span><span class=p>)</span> <span class=c1>// 判断当前堆顶地址就是top chunk地址加上大小后的结束地址(堆顶)
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nf>MORECORE</span><span class=p>(</span><span class=o>-</span><span class=n>extra</span><span class=p>);</span> <span class=c1>// 将堆顶往回收缩extra大小
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kt>void</span> <span class=p>(</span><span class=o>*</span><span class=n>hook</span><span class=p>)(</span><span class=kt>void</span><span class=p>)</span> <span class=o>=</span> <span class=nf>atomic_forced_read</span><span class=p>(</span><span class=n>__after_morecore_hook</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nf>__builtin_expect</span><span class=p>(</span><span class=n>hook</span> <span class=o>!=</span> <span class=nb>NULL</span><span class=p>,</span> <span class=mi>0</span><span class=p>))</span>
</span></span><span class=line><span class=cl>      <span class=p>(</span><span class=o>*</span><span class=n>hook</span><span class=p>)();</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 新堆顶地址
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>new_brk</span> <span class=o>=</span> <span class=p>(</span><span class=kt>char</span> <span class=o>*</span><span class=p>)(</span><span class=nf>MORECORE</span><span class=p>(</span><span class=mi>0</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=nf>LIBC_PROBE</span><span class=p>(</span><span class=n>memory_sbrk_less</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=n>new_brk</span><span class=p>,</span> <span class=n>extra</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>new_brk</span> <span class=o>!=</span> <span class=p>(</span><span class=kt>char</span> <span class=o>*</span><span class=p>)</span><span class=n>MORECORE_FAILURE</span><span class=p>)</span> <span class=c1>// 若brk成功
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>{</span> 
</span></span><span class=line><span class=cl>      <span class=n>released</span> <span class=o>=</span> <span class=p>(</span><span class=kt>long</span><span class=p>)(</span><span class=n>current_brk</span> <span class=o>-</span> <span class=n>new_brk</span><span class=p>);</span> <span class=c1>// 获取收缩了的部分，即释放归还给操作系统的内存
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=k>if</span> <span class=p>(</span><span class=n>released</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>av</span><span class=o>-&gt;</span><span class=n>system_mem</span> <span class=o>-=</span> <span class=n>released</span><span class=p>;</span> <span class=c1>// 更新系统内存大小
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nf>set_head</span><span class=p>(</span><span class=n>av</span><span class=o>-&gt;</span><span class=n>top</span><span class=p>,</span> <span class=p>(</span><span class=n>top_size</span> <span class=o>-</span> <span class=n>released</span><span class=p>)</span> <span class=o>|</span> <span class=n>PREV_INUSE</span><span class=p>);</span> <span class=c1>// 更新top chunk的头
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nf>check_malloc_state</span><span class=p>(</span><span class=n>av</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div><h5 id=heap_trim>heap_trim</h5><div class="code-block code-line-numbers" style="counter-reset:code-block 0"><div class="code-header language-c"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=复制到剪贴板><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>static</span> <span class=kt>int</span> <span class=n>internal_function</span> <span class=nf>heap_trim</span> <span class=p>(</span><span class=n>heap_info</span> <span class=o>*</span><span class=n>heap</span><span class=p>,</span> <span class=kt>size_t</span> <span class=n>pad</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>mstate</span> <span class=n>ar_ptr</span> <span class=o>=</span> <span class=n>heap</span><span class=o>-&gt;</span><span class=n>ar_ptr</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>unsigned</span> <span class=kt>long</span> <span class=n>pagesz</span> <span class=o>=</span> <span class=nf>GLRO</span> <span class=p>(</span><span class=n>dl_pagesize</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=n>mchunkptr</span> <span class=n>top_chunk</span> <span class=o>=</span> <span class=nf>top</span> <span class=p>(</span><span class=n>ar_ptr</span><span class=p>),</span> <span class=n>p</span><span class=p>,</span> <span class=n>bck</span><span class=p>,</span> <span class=n>fwd</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>heap_info</span> <span class=o>*</span><span class=n>prev_heap</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>long</span> <span class=n>new_size</span><span class=p>,</span> <span class=n>top_size</span><span class=p>,</span> <span class=n>top_area</span><span class=p>,</span> <span class=n>extra</span><span class=p>,</span> <span class=n>prev_size</span><span class=p>,</span> <span class=n>misalign</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>while</span> <span class=p>(</span><span class=n>top_chunk</span> <span class=o>==</span> <span class=nf>chunk_at_offset</span> <span class=p>(</span><span class=n>heap</span><span class=p>,</span> <span class=k>sizeof</span> <span class=p>(</span><span class=o>*</span><span class=n>heap</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span> <span class=c1>// heap结构体地址加上结构体大小若是 top chunk 地址则说明：后续的 top chunk 均为空闲，考虑释放整个 heap
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=c1>// 但需要检查该heap的前一个heap是否有足够空间，否则删除后剩余空间太小
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=cm>/*	结合sysmalloc中非主线程 top chunk 添加的两个chunk+align
</span></span></span><span class=line><span class=cl><span class=cm>      		【1】[prev_size]
</span></span></span><span class=line><span class=cl><span class=cm>      		【2】[size]		&gt; (2*SIZE_SZ) | PREV_INUSE
</span></span></span><span class=line><span class=cl><span class=cm>      		【3】[prev_size]	&gt; (2*SIZE_SZ)
</span></span></span><span class=line><span class=cl><span class=cm>      		【4】[size]		&gt; 0 | PREV_INUSE
</span></span></span><span class=line><span class=cl><span class=cm>      		【5】[align]
</span></span></span><span class=line><span class=cl><span class=cm>      */</span>
</span></span><span class=line><span class=cl>      <span class=n>prev_heap</span> <span class=o>=</span> <span class=n>heap</span><span class=o>-&gt;</span><span class=n>prev</span><span class=p>;</span> <span class=c1>// 上一个heap堆块
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=n>prev_size</span> <span class=o>=</span> <span class=n>prev_heap</span><span class=o>-&gt;</span><span class=n>size</span> <span class=o>-</span> <span class=p>(</span><span class=n>MINSIZE</span> <span class=o>-</span> <span class=mi>2</span> <span class=o>*</span> <span class=n>SIZE_SZ</span><span class=p>);</span> <span class=c1>// 上一个堆块大小 - 0x10
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=n>p</span> <span class=o>=</span> <span class=nf>chunk_at_offset</span> <span class=p>(</span><span class=n>prev_heap</span><span class=p>,</span> <span class=n>prev_size</span><span class=p>);</span> 
</span></span><span class=line><span class=cl>      <span class=n>misalign</span> <span class=o>=</span> <span class=p>((</span><span class=kt>long</span><span class=p>)</span> <span class=n>p</span><span class=p>)</span> <span class=o>&amp;</span> <span class=n>MALLOC_ALIGN_MASK</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=n>p</span> <span class=o>=</span> <span class=nf>chunk_at_offset</span> <span class=p>(</span><span class=n>prev_heap</span><span class=p>,</span> <span class=n>prev_size</span> <span class=o>-</span> <span class=n>misalign</span><span class=p>);</span> <span class=c1>// 通过对齐操作使得p指向【3,4】chunk
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nf>assert</span> <span class=p>(</span><span class=n>p</span><span class=o>-&gt;</span><span class=n>size</span> <span class=o>==</span> <span class=p>(</span><span class=mi>0</span> <span class=o>|</span> <span class=n>PREV_INUSE</span><span class=p>));</span> <span class=c1>// 判断一下
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=n>p</span> <span class=o>=</span> <span class=nf>prev_chunk</span> <span class=p>(</span><span class=n>p</span><span class=p>);</span> <span class=c1>// 通过取前一个chunk使得p指向【1,2】chunk
</span></span></span><span class=line><span class=cl><span class=c1></span>      
</span></span><span class=line><span class=cl>      <span class=c1>// 计算【1,2,3,4,5】大小
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=n>new_size</span> <span class=o>=</span> <span class=nf>chunksize</span> <span class=p>(</span><span class=n>p</span><span class=p>)</span> <span class=o>+</span> <span class=p>(</span><span class=n>MINSIZE</span> <span class=o>-</span> <span class=mi>2</span> <span class=o>*</span> <span class=n>SIZE_SZ</span><span class=p>)</span> <span class=o>+</span> <span class=n>misalign</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=nf>assert</span> <span class=p>(</span><span class=n>new_size</span> <span class=o>&gt;</span> <span class=mi>0</span> <span class=o>&amp;&amp;</span> <span class=n>new_size</span> <span class=o>&lt;</span> <span class=p>(</span><span class=kt>long</span><span class=p>)</span> <span class=p>(</span><span class=mi>2</span> <span class=o>*</span> <span class=n>MINSIZE</span><span class=p>));</span> <span class=c1>// 安全检查 0 &lt; new_size &lt; 0x40
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nf>prev_inuse</span> <span class=p>(</span><span class=n>p</span><span class=p>))</span> <span class=c1>// 前一个chunk空闲则加上大小
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>new_size</span> <span class=o>+=</span> <span class=n>p</span><span class=o>-&gt;</span><span class=n>prev_size</span><span class=p>;</span> <span class=c1>// 作为新堆块 top chunk大小
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nf>assert</span> <span class=p>(</span><span class=n>new_size</span> <span class=o>&gt;</span> <span class=mi>0</span> <span class=o>&amp;&amp;</span> <span class=n>new_size</span> <span class=o>&lt;</span> <span class=n>HEAP_MAX_SIZE</span><span class=p>);</span> <span class=c1>// 安全大小检查
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=k>if</span> <span class=p>(</span><span class=n>new_size</span> <span class=o>+</span> <span class=p>(</span><span class=n>HEAP_MAX_SIZE</span> <span class=o>-</span> <span class=n>prev_heap</span><span class=o>-&gt;</span><span class=n>size</span><span class=p>)</span> <span class=o>&lt;</span> <span class=n>pad</span> <span class=o>+</span> <span class=n>MINSIZE</span> <span class=o>+</span> <span class=n>pagesz</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>break</span><span class=p>;</span> <span class=c1>// 若空间不足够则退出不再释放
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=c1>// 更新
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=n>ar_ptr</span><span class=o>-&gt;</span><span class=n>system_mem</span> <span class=o>-=</span> <span class=n>heap</span><span class=o>-&gt;</span><span class=n>size</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=n>arena_mem</span> <span class=o>-=</span> <span class=n>heap</span><span class=o>-&gt;</span><span class=n>size</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=nf>LIBC_PROBE</span> <span class=p>(</span><span class=n>memory_heap_free</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=n>heap</span><span class=p>,</span> <span class=n>heap</span><span class=o>-&gt;</span><span class=n>size</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      
</span></span><span class=line><span class=cl>      <span class=nf>delete_heap</span> <span class=p>(</span><span class=n>heap</span><span class=p>);</span> <span class=c1>// 调用宏释放heap
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=n>heap</span> <span class=o>=</span> <span class=n>prev_heap</span><span class=p>;</span> <span class=c1>// 此时heap变为前一个堆heap chunk
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nf>prev_inuse</span> <span class=p>(</span><span class=n>p</span><span class=p>))</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=n>p</span> <span class=o>=</span> <span class=nf>prev_chunk</span> <span class=p>(</span><span class=n>p</span><span class=p>);</span>
</span></span><span class=line><span class=cl>          <span class=nf>unlink</span> <span class=p>(</span><span class=n>ar_ptr</span><span class=p>,</span> <span class=n>p</span><span class=p>,</span> <span class=n>bck</span><span class=p>,</span> <span class=n>fwd</span><span class=p>);</span> <span class=c1>// 前向合并 脱链
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=nf>assert</span> <span class=p>(((</span><span class=kt>unsigned</span> <span class=kt>long</span><span class=p>)</span> <span class=p>((</span><span class=kt>char</span> <span class=o>*</span><span class=p>)</span> <span class=n>p</span> <span class=o>+</span> <span class=n>new_size</span><span class=p>)</span> <span class=o>&amp;</span> <span class=p>(</span><span class=n>pagesz</span> <span class=o>-</span> <span class=mi>1</span><span class=p>))</span> <span class=o>==</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=nf>assert</span> <span class=p>(((</span><span class=kt>char</span> <span class=o>*</span><span class=p>)</span> <span class=n>p</span> <span class=o>+</span> <span class=n>new_size</span><span class=p>)</span> <span class=o>==</span> <span class=p>((</span><span class=kt>char</span> <span class=o>*</span><span class=p>)</span> <span class=n>heap</span> <span class=o>+</span> <span class=n>heap</span><span class=o>-&gt;</span><span class=n>size</span><span class=p>));</span>
</span></span><span class=line><span class=cl>      <span class=nf>top</span> <span class=p>(</span><span class=n>ar_ptr</span><span class=p>)</span> <span class=o>=</span> <span class=n>top_chunk</span> <span class=o>=</span> <span class=n>p</span><span class=p>;</span> <span class=c1>// 更新 top chunk
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nf>set_head</span> <span class=p>(</span><span class=n>top_chunk</span><span class=p>,</span> <span class=n>new_size</span> <span class=o>|</span> <span class=n>PREV_INUSE</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>top_size</span> <span class=o>=</span> <span class=nf>chunksize</span> <span class=p>(</span><span class=n>top_chunk</span><span class=p>);</span> <span class=c1>// 获取top chunk大小
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=p>((</span><span class=kt>unsigned</span> <span class=kt>long</span><span class=p>)(</span><span class=n>top_size</span><span class=p>)</span> <span class=o>&lt;</span> <span class=p>(</span><span class=kt>unsigned</span> <span class=kt>long</span><span class=p>)(</span><span class=n>mp_</span><span class=p>.</span><span class=n>trim_threshold</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=mi>0</span><span class=p>;</span> <span class=c1>// 小于阈值无法收缩，退出
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=n>top_area</span> <span class=o>=</span> <span class=n>top_size</span> <span class=o>-</span> <span class=n>MINSIZE</span> <span class=o>-</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>top_area</span> <span class=o>&lt;</span> <span class=mi>0</span> <span class=o>||</span> <span class=p>(</span><span class=kt>size_t</span><span class=p>)</span> <span class=n>top_area</span> <span class=o>&lt;=</span> <span class=n>pad</span><span class=p>)</span> 
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=mi>0</span><span class=p>;</span> <span class=c1>// 可收缩值过小，退出
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=n>extra</span> <span class=o>=</span> <span class=nf>ALIGN_DOWN</span><span class=p>(</span><span class=n>top_area</span> <span class=o>-</span> <span class=n>pad</span><span class=p>,</span> <span class=n>pagesz</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>extra</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=mi>0</span><span class=p>;</span> <span class=c1>// 对齐后的区域不足以收缩，退出
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nf>shrink_heap</span> <span class=p>(</span><span class=n>heap</span><span class=p>,</span> <span class=n>extra</span><span class=p>)</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>)</span> <span class=c1>// 释放刚计算的对齐extra
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>ar_ptr</span><span class=o>-&gt;</span><span class=n>system_mem</span> <span class=o>-=</span> <span class=n>extra</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>arena_mem</span> <span class=o>-=</span> <span class=n>extra</span><span class=p>;</span> <span class=c1>// 更新
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=nf>set_head</span> <span class=p>(</span><span class=n>top_chunk</span><span class=p>,</span> <span class=p>(</span><span class=n>top_size</span> <span class=o>-</span> <span class=n>extra</span><span class=p>)</span> <span class=o>|</span> <span class=n>PREV_INUSE</span><span class=p>);</span> <span class=c1>// 设置标志
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>return</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div><h5 id=shrink_heap>shrink_heap</h5><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-c"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=复制到剪贴板><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>static</span> <span class=kt>int</span> <span class=nf>shrink_heap</span> <span class=p>(</span><span class=n>heap_info</span> <span class=o>*</span><span class=n>h</span><span class=p>,</span> <span class=kt>long</span> <span class=n>diff</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kt>long</span> <span class=n>new_size</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>new_size</span> <span class=o>=</span> <span class=p>(</span><span class=kt>long</span><span class=p>)</span> <span class=n>h</span><span class=o>-&gt;</span><span class=n>size</span> <span class=o>-</span> <span class=n>diff</span><span class=p>;</span> <span class=c1>// 减去 diff 后的新堆的大小
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=p>(</span><span class=n>new_size</span> <span class=o>&lt;</span> <span class=p>(</span><span class=kt>long</span><span class=p>)</span> <span class=k>sizeof</span> <span class=p>(</span><span class=o>*</span><span class=n>h</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span> <span class=c1>// 小于heap结构体大小则退出
</span></span></span><span class=line><span class=cl><span class=c1></span>    
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nf>__glibc_unlikely</span> <span class=p>(</span><span class=nf>check_may_shrink_heap</span> <span class=p>()))</span> <span class=c1>// 检查当前系统环境是否支持通过重新映射的方式释放堆空间
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>((</span><span class=kt>char</span> <span class=o>*</span><span class=p>)</span> <span class=nf>MMAP</span> <span class=p>((</span><span class=kt>char</span> <span class=o>*</span><span class=p>)</span> <span class=n>h</span> <span class=o>+</span> <span class=n>new_size</span><span class=p>,</span> <span class=n>diff</span><span class=p>,</span> <span class=n>PROT_NONE</span><span class=p>,</span> <span class=n>MAP_FIXED</span><span class=p>)</span> <span class=o>==</span> <span class=p>(</span><span class=kt>char</span> <span class=o>*</span><span class=p>)</span> <span class=n>MAP_FAILED</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=o>-</span><span class=mi>2</span><span class=p>;</span> <span class=c1>// 尝试 mmap 将新释放的内存段重新映射为不可访问的内存区域
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>      <span class=n>h</span><span class=o>-&gt;</span><span class=n>mprotect_size</span> <span class=o>=</span> <span class=n>new_size</span><span class=p>;</span> <span class=c1>// 更新mprotect记录的映射大小
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>else</span> <span class=c1>// 不支持mmap重新映射则调用madvise系统调用，指示OS回收这些内存
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nf>__madvise</span> <span class=p>((</span><span class=kt>char</span> <span class=o>*</span><span class=p>)</span> <span class=n>h</span> <span class=o>+</span> <span class=n>new_size</span><span class=p>,</span> <span class=n>diff</span><span class=p>,</span> <span class=n>MADV_DONTNEED</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>h</span><span class=o>-&gt;</span><span class=n>size</span> <span class=o>=</span> <span class=n>new_size</span><span class=p>;</span> <span class=c1>// 更新堆大小
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nf>LIBC_PROBE</span> <span class=p>(</span><span class=n>memory_heap_less</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=n>h</span><span class=p>,</span> <span class=n>h</span><span class=o>-&gt;</span><span class=n>size</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div><h4 id=227-1>2.27</h4><h5 id=__libc_free-1>__libc_free</h5><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-c"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=复制到剪贴板><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=c1>// 增加
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nf>MAYBE_INIT_TCACHE</span><span class=p>();</span> <span class=c1>// tcache初始化
</span></span></span></code></pre></div></div><h5 id=maybe_init_tcache>MAYBE_INIT_TCACHE</h5><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-c"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=复制到剪贴板><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp># define MAYBE_INIT_TCACHE()
</span></span></span><span class=line><span class=cl><span class=cp></span>  <span class=k>if</span> <span class=p>(</span><span class=nf>__glibc_unlikely</span> <span class=p>(</span><span class=n>tcache</span> <span class=o>==</span> <span class=nb>NULL</span><span class=p>))</span> 
</span></span><span class=line><span class=cl>    <span class=nf>tcache_init</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=kt>void</span> <span class=nf>tcache_init</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>mstate</span> <span class=n>ar_ptr</span><span class=p>;</span> <span class=c1>// arena指针
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kt>void</span> <span class=o>*</span><span class=n>victim</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=c1>// 用于存储分配得到的内存块(tcache_perthread_struct)
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>const</span> <span class=kt>size_t</span> <span class=n>bytes</span> <span class=o>=</span> <span class=k>sizeof</span> <span class=p>(</span><span class=n>tcache_perthread_struct</span><span class=p>);</span> <span class=c1>// 分配的字节数
</span></span></span><span class=line><span class=cl><span class=c1></span>  
</span></span><span class=line><span class=cl>  <span class=c1>// static __thread bool tcache_shutting_down = false;
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=p>(</span><span class=n>tcache_shutting_down</span><span class=p>)</span> <span class=c1>// 若tcache系统关闭则不初始化
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nf>arena_get</span> <span class=p>(</span><span class=n>ar_ptr</span><span class=p>,</span> <span class=n>bytes</span><span class=p>);</span> <span class=c1>// 获取一个arena用于分配内存
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>victim</span> <span class=o>=</span> <span class=nf>_int_malloc</span> <span class=p>(</span><span class=n>ar_ptr</span><span class=p>,</span> <span class=n>bytes</span><span class=p>);</span> <span class=c1>// 从 arena 中分配bytes字节的内存块
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>victim</span> <span class=o>&amp;&amp;</span> <span class=n>ar_ptr</span> <span class=o>!=</span> <span class=nb>NULL</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>ar_ptr</span> <span class=o>=</span> <span class=nf>arena_get_retry</span> <span class=p>(</span><span class=n>ar_ptr</span><span class=p>,</span> <span class=n>bytes</span><span class=p>);</span> <span class=c1>// 分配失败重新尝试
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=n>victim</span> <span class=o>=</span> <span class=nf>_int_malloc</span> <span class=p>(</span><span class=n>ar_ptr</span><span class=p>,</span> <span class=n>bytes</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>ar_ptr</span> <span class=o>!=</span> <span class=nb>NULL</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nf>__libc_lock_unlock</span> <span class=p>(</span><span class=n>ar_ptr</span><span class=o>-&gt;</span><span class=n>mutex</span><span class=p>);</span> <span class=c1>// 使用了某个arena，解锁允许其他线程访问
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>victim</span><span class=p>)</span> <span class=c1>// 内存分配成功
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>tcache</span> <span class=o>=</span> <span class=p>(</span><span class=n>tcache_perthread_struct</span> <span class=o>*</span><span class=p>)</span> <span class=n>victim</span><span class=p>;</span> 
</span></span><span class=line><span class=cl>      <span class=c1>// victim转换为tcache_perthread_struct指针存在全局变量tcache中
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nf>memset</span> <span class=p>(</span><span class=n>tcache</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=k>sizeof</span> <span class=p>(</span><span class=n>tcache_perthread_struct</span><span class=p>));</span> <span class=c1>// 初始化内存为0
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div><h5 id=_int_free-1>_int_free</h5><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-c"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=复制到剪贴板><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=c1>// 增加
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=cp>#if USE_TCACHE
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>size_t</span> <span class=n>tc_idx</span> <span class=o>=</span> <span class=nf>csize2tidx</span> <span class=p>(</span><span class=n>size</span><span class=p>);</span> <span class=c1>// 获取tcache的索引
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// 若 tcache已初始化 + tcache索引在范围内 + tcache的数量此时小于7
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=n>tcache</span> <span class=o>&amp;&amp;</span> <span class=n>tc_idx</span> <span class=o>&lt;</span> <span class=n>mp_</span><span class=p>.</span><span class=n>tcache_bins</span> <span class=o>&amp;&amp;</span> <span class=n>tcache</span><span class=o>-&gt;</span><span class=n>counts</span><span class=p>[</span><span class=n>tc_idx</span><span class=p>]</span> <span class=o>&lt;</span> <span class=n>mp_</span><span class=p>.</span><span class=n>tcache_count</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>tcache_put</span> <span class=p>(</span><span class=n>p</span><span class=p>,</span> <span class=n>tc_idx</span><span class=p>);</span><span class=c1>// 将chunk放入tcache中
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=cp>#endif</span></span></span></code></pre></div></div><h5 id=tcache_put-1>tcache_put</h5><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-c"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=复制到剪贴板><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>static</span> <span class=n>__always_inline</span> <span class=kt>void</span> <span class=nf>tcache_put</span> <span class=p>(</span><span class=n>mchunkptr</span> <span class=n>chunk</span><span class=p>,</span> <span class=kt>size_t</span> <span class=n>tc_idx</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>tcache_entry</span> <span class=o>*</span><span class=n>e</span> <span class=o>=</span> <span class=p>(</span><span class=n>tcache_entry</span> <span class=o>*</span><span class=p>)</span> <span class=nf>chunk2mem</span> <span class=p>(</span><span class=n>chunk</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=nf>assert</span> <span class=p>(</span><span class=n>tc_idx</span> <span class=o>&lt;</span> <span class=n>TCACHE_MAX_BINS</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=n>e</span><span class=o>-&gt;</span><span class=n>next</span> <span class=o>=</span> <span class=n>tcache</span><span class=o>-&gt;</span><span class=n>entries</span><span class=p>[</span><span class=n>tc_idx</span><span class=p>];</span> <span class=c1>// chunk插入tcache中
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>tcache</span><span class=o>-&gt;</span><span class=n>entries</span><span class=p>[</span><span class=n>tc_idx</span><span class=p>]</span> <span class=o>=</span> <span class=n>e</span><span class=p>;</span> <span class=c1>// 设置新入口
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=o>++</span><span class=p>(</span><span class=n>tcache</span><span class=o>-&gt;</span><span class=n>counts</span><span class=p>[</span><span class=n>tc_idx</span><span class=p>]);</span> <span class=c1>// 增加tcache的数量
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span></span></span></code></pre></div></div><h4 id=231>2.31</h4><h5 id=_int_free-2>_int_free</h5><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-c"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=复制到剪贴板><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=c1>// 增加
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=cp>#if USE_TCACHE
</span></span></span><span class=line><span class=cl><span class=cp></span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>size_t</span> <span class=n>tc_idx</span> <span class=o>=</span> <span class=nf>csize2tidx</span> <span class=p>(</span><span class=n>size</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>tcache</span> <span class=o>!=</span> <span class=nb>NULL</span> <span class=o>&amp;&amp;</span> <span class=n>tc_idx</span> <span class=o>&lt;</span> <span class=n>mp_</span><span class=p>.</span><span class=n>tcache_bins</span><span class=p>)</span> <span class=c1>// tcache已初始化且索引在tcache范围内
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>{</span>	<span class=c1>// 内存块地址转换为 tcache_entry 结构体指针
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=n>tcache_entry</span> <span class=o>*</span><span class=n>e</span> <span class=o>=</span> <span class=p>(</span><span class=n>tcache_entry</span> <span class=o>*</span><span class=p>)</span> <span class=nf>chunk2mem</span> <span class=p>(</span><span class=n>p</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nf>__glibc_unlikely</span> <span class=p>(</span><span class=n>e</span><span class=o>-&gt;</span><span class=n>key</span> <span class=o>==</span> <span class=n>tcache</span><span class=p>))</span> <span class=c1>// tcache为tcacche_perthread_structure的地址
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>tcache_entry</span> <span class=o>*</span><span class=n>tmp</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=nf>LIBC_PROBE</span> <span class=p>(</span><span class=n>memory_tcache_double_free</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=n>e</span><span class=p>,</span> <span class=n>tc_idx</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 循环检测tcache中是否有与e相等的chunk，可能double free
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=k>for</span> <span class=p>(</span><span class=n>tmp</span> <span class=o>=</span> <span class=n>tcache</span><span class=o>-&gt;</span><span class=n>entries</span><span class=p>[</span><span class=n>tc_idx</span><span class=p>];</span> <span class=n>tmp</span><span class=p>;</span> <span class=n>tmp</span> <span class=o>=</span> <span class=n>tmp</span><span class=o>-&gt;</span><span class=n>next</span><span class=p>)</span>
</span></span><span class=line><span class=cl>              <span class=k>if</span> <span class=p>(</span><span class=n>tmp</span> <span class=o>==</span> <span class=n>e</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=nf>malloc_printerr</span> <span class=p>(</span><span class=s>&#34;free(): double free detected in tcache 2&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>         <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>tcache</span><span class=o>-&gt;</span><span class=n>counts</span><span class=p>[</span><span class=n>tc_idx</span><span class=p>]</span> <span class=o>&lt;</span> <span class=n>mp_</span><span class=p>.</span><span class=n>tcache_count</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span> <span class=c1>// 将当前内存块放入 tcache 中进行缓存
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=nf>tcache_put</span> <span class=p>(</span><span class=n>p</span><span class=p>,</span> <span class=n>tc_idx</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>     <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=cp>#endif</span></span></span></code></pre></div></div><h3 id=calloc>calloc</h3><h4 id=223-3>2.23</h4><h5 id=__libc_calloc>__libc_calloc</h5><p>分配一块内存并初始化为零，calloc申请内存不会从tcache中获取，而是直接从堆块中获取</p><div class="code-block code-line-numbers" style="counter-reset:code-block 0"><div class="code-header language-c"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=复制到剪贴板><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=kt>void</span> <span class=o>*</span><span class=nf>__libc_calloc</span><span class=p>(</span><span class=kt>size_t</span> <span class=n>n</span><span class=p>,</span> <span class=kt>size_t</span> <span class=n>elem_size</span><span class=p>)</span> <span class=c1>// n项，每一项大小为elem_size
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>mstate</span> <span class=n>av</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>mchunkptr</span> <span class=n>oldtop</span><span class=p>,</span> <span class=n>p</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>INTERNAL_SIZE_T</span> <span class=n>bytes</span><span class=p>,</span> <span class=n>sz</span><span class=p>,</span> <span class=n>csz</span><span class=p>,</span> <span class=n>oldtopsize</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>void</span> <span class=o>*</span><span class=n>mem</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>unsigned</span> <span class=kt>long</span> <span class=n>clearsize</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>unsigned</span> <span class=kt>long</span> <span class=n>nclears</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>INTERNAL_SIZE_T</span> <span class=o>*</span><span class=n>d</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>bytes</span> <span class=o>=</span> <span class=n>n</span> <span class=o>*</span> <span class=n>elem_size</span><span class=p>;</span> <span class=c1>// 相乘将需要申请的内存大小转换为以字节为单位
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// 判断溢出
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=cp>#define HALF_INTERNAL_SIZE_T (((INTERNAL_SIZE_T)1) &lt;&lt; (8 * sizeof(INTERNAL_SIZE_T) / 2))
</span></span></span><span class=line><span class=cl><span class=cp></span>  <span class=k>if</span> <span class=p>(</span><span class=nf>__builtin_expect</span><span class=p>((</span><span class=n>n</span> <span class=o>|</span> <span class=n>elem_size</span><span class=p>)</span> <span class=o>&gt;=</span> <span class=n>HALF_INTERNAL_SIZE_T</span><span class=p>,</span> <span class=mi>0</span><span class=p>))</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>elem_size</span> <span class=o>!=</span> <span class=mi>0</span> <span class=o>&amp;&amp;</span> <span class=n>bytes</span> <span class=o>/</span> <span class=n>elem_size</span> <span class=o>!=</span> <span class=n>n</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nf>__set_errno</span><span class=p>(</span><span class=n>ENOMEM</span><span class=p>);</span> <span class=c1>// 发生整数溢出，退出
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kt>void</span> <span class=o>*</span><span class=p>(</span><span class=o>*</span><span class=n>hook</span><span class=p>)(</span><span class=kt>size_t</span><span class=p>,</span> <span class=k>const</span> <span class=kt>void</span> <span class=o>*</span><span class=p>)</span> <span class=o>=</span> <span class=nf>atomic_forced_read</span><span class=p>(</span><span class=n>__malloc_hook</span><span class=p>);</span> 
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nf>__builtin_expect</span><span class=p>(</span><span class=n>hook</span> <span class=o>!=</span> <span class=nb>NULL</span><span class=p>,</span> <span class=mi>0</span><span class=p>))</span> <span class=c1>// 若malloc_hook被定义
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>sz</span> <span class=o>=</span> <span class=n>bytes</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>mem</span> <span class=o>=</span> <span class=p>(</span><span class=o>*</span><span class=n>hook</span><span class=p>)(</span><span class=n>sz</span><span class=p>,</span> <span class=nf>RETURN_ADDRESS</span><span class=p>(</span><span class=mi>0</span><span class=p>));</span> <span class=c1>// 调用malloc_hook
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=n>mem</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=c1>// 失败则退出
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nf>memset</span><span class=p>(</span><span class=n>mem</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=n>sz</span><span class=p>);</span> <span class=c1>// 并将内存清零
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=n>sz</span> <span class=o>=</span> <span class=n>bytes</span><span class=p>;</span> <span class=c1>// 大小赋值
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=nf>arena_get</span><span class=p>(</span><span class=n>av</span><span class=p>,</span> <span class=n>sz</span><span class=p>);</span> <span class=c1>// 获取arena
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=p>(</span><span class=n>av</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl><span class=cp>#if MORECORE_CLEARS
</span></span></span><span class=line><span class=cl><span class=cp></span>    <span class=cm>/* 
</span></span></span><span class=line><span class=cl><span class=cm>    	由于无论是main_arena控制的堆通过sbrk扩展还是非main_arena通过heap_info向后扩展受保护的内存区域
</span></span></span><span class=line><span class=cl><span class=cm>      	新扩展的内存区初始值为0，不需要清空，因此后续需要清理的内存大小只清理与 top chunk 重合区域，提升效率
</span></span></span><span class=line><span class=cl><span class=cm>    */</span>
</span></span><span class=line><span class=cl>    <span class=n>oldtop</span> <span class=o>=</span> <span class=nf>top</span><span class=p>(</span><span class=n>av</span><span class=p>);</span> <span class=c1>// 获取top chunk
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>oldtopsize</span> <span class=o>=</span> <span class=nf>chunksize</span><span class=p>(</span><span class=nf>top</span><span class=p>(</span><span class=n>av</span><span class=p>));</span> <span class=c1>// 获取 top chunk 头之后可控制的内存大小
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=cp>#if MORECORE_CLEARS &lt; 2
</span></span></span><span class=line><span class=cl><span class=cp></span>    <span class=c1>// 主线程 + top chunk需要清空的内存大小为 top chunk 到原先 heap 区域末尾位置
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=n>av</span> <span class=o>==</span> <span class=o>&amp;</span><span class=n>main_arena</span> <span class=o>&amp;&amp;</span> <span class=n>oldtopsize</span> <span class=o>&lt;</span>  <span class=n>mp_</span><span class=p>.</span><span class=n>sbrk_base</span> <span class=o>+</span> <span class=n>av</span><span class=o>-&gt;</span><span class=n>max_system_mem</span> <span class=o>-</span> <span class=p>(</span><span class=kt>char</span> <span class=o>*</span><span class=p>)</span><span class=n>oldtop</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=n>oldtopsize</span> <span class=o>=</span> <span class=p>(</span><span class=n>mp_</span><span class=p>.</span><span class=n>sbrk_base</span> <span class=o>+</span> <span class=n>av</span><span class=o>-&gt;</span><span class=n>max_system_mem</span> <span class=o>-</span> <span class=p>(</span><span class=kt>char</span> <span class=o>*</span><span class=p>)</span><span class=n>oldtop</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=cp>#endif
</span></span></span><span class=line><span class=cl><span class=cp></span>    <span class=c1>// 非主线程
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=n>av</span> <span class=o>!=</span> <span class=o>&amp;</span><span class=n>main_arena</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span> <span class=c1>// top chunk 需要清空的内存大小为 top chunk 到原先 heap_info 受保护区域末尾位置
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=n>heap_info</span> <span class=o>*</span><span class=n>heap</span> <span class=o>=</span> <span class=nf>heap_for_ptr</span><span class=p>(</span><span class=n>oldtop</span><span class=p>);</span> <span class=c1>// 获取heap_info
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=k>if</span> <span class=p>(</span><span class=n>oldtopsize</span> <span class=o>&lt;</span> <span class=p>(</span><span class=kt>char</span> <span class=o>*</span><span class=p>)</span><span class=n>heap</span> <span class=o>+</span> <span class=n>heap</span><span class=o>-&gt;</span><span class=n>mprotect_size</span> <span class=o>-</span> <span class=p>(</span><span class=kt>char</span> <span class=o>*</span><span class=p>)</span><span class=n>oldtop</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>oldtopsize</span> <span class=o>=</span> <span class=p>(</span><span class=kt>char</span> <span class=o>*</span><span class=p>)</span><span class=n>heap</span> <span class=o>+</span> <span class=n>heap</span><span class=o>-&gt;</span><span class=n>mprotect_size</span> <span class=o>-</span> <span class=p>(</span><span class=kt>char</span> <span class=o>*</span><span class=p>)</span><span class=n>oldtop</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=cp>#endif
</span></span></span><span class=line><span class=cl><span class=cp></span>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>else</span> 
</span></span><span class=line><span class=cl>  <span class=p>{</span> <span class=c1>// 无可用的arena，后续_int_malloc会直接mmap获取内存，而mmap获取内存初始值为0，不需要清零
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>oldtop</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>oldtopsize</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=n>mem</span> <span class=o>=</span> <span class=nf>_int_malloc</span><span class=p>(</span><span class=n>av</span><span class=p>,</span> <span class=n>sz</span><span class=p>);</span> <span class=c1>// 在 arena 中尝试分配内存
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=nf>assert</span><span class=p>(</span><span class=o>!</span><span class=n>mem</span> <span class=o>||</span> <span class=nf>chunk_is_mmapped</span><span class=p>(</span><span class=nf>mem2chunk</span><span class=p>(</span><span class=n>mem</span><span class=p>))</span> <span class=o>||</span> <span class=c1>// 未申请到内存或mmap获取的内存
</span></span></span><span class=line><span class=cl><span class=c1></span>         <span class=n>av</span> <span class=o>==</span> <span class=nf>arena_for_chunk</span><span class=p>(</span><span class=nf>mem2chunk</span><span class=p>(</span><span class=n>mem</span><span class=p>)));</span> <span class=c1>// 内存从当前线程对应的arena管理的内存中获取
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// 未申请到内存且arena不为空
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=p>(</span><span class=n>mem</span> <span class=o>==</span> <span class=mi>0</span> <span class=o>&amp;&amp;</span> <span class=n>av</span> <span class=o>!=</span> <span class=nb>NULL</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nf>LIBC_PROBE</span><span class=p>(</span><span class=n>memory_calloc_retry</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=n>sz</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>av</span> <span class=o>=</span> <span class=nf>arena_get_retry</span><span class=p>(</span><span class=n>av</span><span class=p>,</span> <span class=n>sz</span><span class=p>);</span> <span class=c1>// 再次获取arena
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>mem</span> <span class=o>=</span> <span class=nf>_int_malloc</span><span class=p>(</span><span class=n>av</span><span class=p>,</span> <span class=n>sz</span><span class=p>);</span> <span class=c1>// 再次申请分配内存
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>av</span> <span class=o>!=</span> <span class=nb>NULL</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>(</span><span class=kt>void</span><span class=p>)</span><span class=nf>mutex_unlock</span><span class=p>(</span><span class=o>&amp;</span><span class=n>av</span><span class=o>-&gt;</span><span class=n>mutex</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>mem</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=mi>0</span><span class=p>;</span> <span class=c1>// 申请为0则退出
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=n>p</span> <span class=o>=</span> <span class=nf>mem2chunk</span><span class=p>(</span><span class=n>mem</span><span class=p>);</span> <span class=c1>// 将申请到的内存转换为chunk地址
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nf>chunk_is_mmapped</span><span class=p>(</span><span class=n>p</span><span class=p>))</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nf>__builtin_expect</span><span class=p>(</span><span class=n>perturb_byte</span><span class=p>,</span> <span class=mi>0</span><span class=p>))</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=nf>memset</span><span class=p>(</span><span class=n>mem</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=n>sz</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>mem</span><span class=p>;</span> <span class=c1>// 直接返回，因为mmap的内存默认初始化为0
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=n>csz</span> <span class=o>=</span> <span class=nf>chunksize</span><span class=p>(</span><span class=n>p</span><span class=p>);</span> <span class=c1>// 需要清空的堆大小
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=cp>#if MORECORE_CLEARS
</span></span></span><span class=line><span class=cl><span class=cp></span>  <span class=k>if</span> <span class=p>(</span><span class=n>perturb_byte</span> <span class=o>==</span> <span class=mi>0</span> <span class=o>&amp;&amp;</span> <span class=p>(</span><span class=n>p</span> <span class=o>==</span> <span class=n>oldtop</span> <span class=o>&amp;&amp;</span> <span class=n>csz</span> <span class=o>&gt;</span> <span class=n>oldtopsize</span><span class=p>))</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span> <span class=c1>// 如果是从 top chunk 上切下来的，申请比原先top chunk大小大，则说明原来top chunk扩展
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// 只需要清零 top chunk 范围的内存
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>csz</span> <span class=o>=</span> <span class=n>oldtopsize</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=cp>#endif
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl>  <span class=n>d</span> <span class=o>=</span> <span class=p>(</span><span class=n>INTERNAL_SIZE_T</span> <span class=o>*</span><span class=p>)</span><span class=n>mem</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>clearsize</span> <span class=o>=</span> <span class=n>csz</span> <span class=o>-</span> <span class=n>SIZE_SZ</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>nclears</span> <span class=o>=</span> <span class=n>clearsize</span> <span class=o>/</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>INTERNAL_SIZE_T</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=nf>assert</span><span class=p>(</span><span class=n>nclears</span> <span class=o>&gt;=</span> <span class=mi>3</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>nclears</span> <span class=o>&gt;</span> <span class=mi>9</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nf>memset</span><span class=p>(</span><span class=n>d</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=n>clearsize</span><span class=p>);</span><span class=c1>// 清零字节数较多，直接调用 memset
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>else</span> <span class=c1>// 字节数较少，使用循环展开手动清零，以优化性能
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=o>*</span><span class=p>(</span><span class=n>d</span> <span class=o>+</span> <span class=mi>0</span><span class=p>)</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=o>*</span><span class=p>(</span><span class=n>d</span> <span class=o>+</span> <span class=mi>1</span><span class=p>)</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=o>*</span><span class=p>(</span><span class=n>d</span> <span class=o>+</span> <span class=mi>2</span><span class=p>)</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>nclears</span> <span class=o>&gt;</span> <span class=mi>4</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=o>*</span><span class=p>(</span><span class=n>d</span> <span class=o>+</span> <span class=mi>3</span><span class=p>)</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=o>*</span><span class=p>(</span><span class=n>d</span> <span class=o>+</span> <span class=mi>4</span><span class=p>)</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=n>nclears</span> <span class=o>&gt;</span> <span class=mi>6</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=o>*</span><span class=p>(</span><span class=n>d</span> <span class=o>+</span> <span class=mi>5</span><span class=p>)</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=o>*</span><span class=p>(</span><span class=n>d</span> <span class=o>+</span> <span class=mi>6</span><span class=p>)</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>nclears</span> <span class=o>&gt;</span> <span class=mi>8</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=o>*</span><span class=p>(</span><span class=n>d</span> <span class=o>+</span> <span class=mi>7</span><span class=p>)</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>          <span class=o>*</span><span class=p>(</span><span class=n>d</span> <span class=o>+</span> <span class=mi>8</span><span class=p>)</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>mem</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div><h3 id=realloc>realloc</h3><h4 id=223-4>2.23</h4><h5 id=__libc_realloc>__libc_realloc</h5><div class="code-block code-line-numbers" style="counter-reset:code-block 0"><div class="code-header language-c"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=复制到剪贴板><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=kt>void</span> <span class=o>*</span><span class=nf>__libc_realloc</span><span class=p>(</span><span class=kt>void</span> <span class=o>*</span><span class=n>oldmem</span><span class=p>,</span> <span class=kt>size_t</span> <span class=n>bytes</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>mstate</span> <span class=n>ar_ptr</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>INTERNAL_SIZE_T</span> <span class=n>nb</span><span class=p>;</span> <span class=cm>/* padded request size */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kt>void</span> <span class=o>*</span><span class=n>newp</span><span class=p>;</span> <span class=cm>/* 返回的堆块 */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kt>void</span> <span class=o>*</span><span class=p>(</span><span class=o>*</span><span class=n>hook</span><span class=p>)(</span><span class=kt>void</span> <span class=o>*</span><span class=p>,</span> <span class=kt>size_t</span><span class=p>,</span> <span class=k>const</span> <span class=kt>void</span> <span class=o>*</span><span class=p>)</span> <span class=o>=</span> <span class=nf>atomic_forced_read</span><span class=p>(</span><span class=n>__realloc_hook</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nf>__builtin_expect</span><span class=p>(</span><span class=n>hook</span> <span class=o>!=</span> <span class=nb>NULL</span><span class=p>,</span> <span class=mi>0</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>(</span><span class=o>*</span><span class=n>hook</span><span class=p>)(</span><span class=n>oldmem</span><span class=p>,</span> <span class=n>bytes</span><span class=p>,</span> <span class=nf>RETURN_ADDRESS</span><span class=p>(</span><span class=mi>0</span><span class=p>));</span> <span class=c1>// 若realloc_hook被设置则调用
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=cp>#if REALLOC_ZERO_BYTES_FREES
</span></span></span><span class=line><span class=cl><span class=cp></span>  <span class=k>if</span> <span class=p>(</span><span class=n>bytes</span> <span class=o>==</span> <span class=mi>0</span> <span class=o>&amp;&amp;</span> <span class=n>oldmem</span> <span class=o>!=</span> <span class=nb>NULL</span><span class=p>)</span> <span class=c1>// 若大小为0即 realloc(0)
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nf>__libc_free</span><span class=p>(</span><span class=n>oldmem</span><span class=p>);</span> <span class=c1>// 相当于free，将oldmem指针对应堆块释放
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=cp>#endif
</span></span></span><span class=line><span class=cl><span class=cp></span>  <span class=k>if</span> <span class=p>(</span><span class=n>oldmem</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=c1>// 若 oldmem 为 NULL，相当于 malloc(bytes)
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>return</span> <span class=nf>__libc_malloc</span><span class=p>(</span><span class=n>bytes</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>const</span> <span class=n>mchunkptr</span> <span class=n>oldp</span> <span class=o>=</span> <span class=nf>mem2chunk</span><span class=p>(</span><span class=n>oldmem</span><span class=p>);</span> <span class=c1>// 将chunk转换为对应内存大小
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>const</span> <span class=n>INTERNAL_SIZE_T</span> <span class=n>oldsize</span> <span class=o>=</span> <span class=nf>chunksize</span><span class=p>(</span><span class=n>oldp</span><span class=p>);</span> <span class=c1>// 获取chunk大小
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nf>chunk_is_mmapped</span><span class=p>(</span><span class=n>oldp</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>ar_ptr</span> <span class=o>=</span> <span class=nb>NULL</span><span class=p>;</span> <span class=c1>// 若是mmap申请，则arena指针为空
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>else</span>
</span></span><span class=line><span class=cl>    <span class=n>ar_ptr</span> <span class=o>=</span> <span class=nf>arena_for_chunk</span><span class=p>(</span><span class=n>oldp</span><span class=p>);</span> <span class=c1>// 否则通过该chunk获取arena地址
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nf>__builtin_expect</span><span class=p>((</span><span class=kt>uintptr_t</span><span class=p>)</span><span class=n>oldp</span> <span class=o>&gt;</span> <span class=p>(</span><span class=kt>uintptr_t</span><span class=p>)</span><span class=o>-</span><span class=n>oldsize</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span> <span class=o>||</span> <span class=c1>// 不超过内存空间，判断溢出
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nf>__builtin_expect</span><span class=p>(</span><span class=nf>misaligned_chunk</span><span class=p>(</span><span class=n>oldp</span><span class=p>),</span> <span class=mi>0</span><span class=p>))</span> <span class=c1>// 该堆块必须关于0x10对齐
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nf>malloc_printerr</span><span class=p>(</span><span class=n>check_action</span><span class=p>,</span> <span class=s>&#34;realloc(): invalid pointer&#34;</span><span class=p>,</span> <span class=n>oldmem</span><span class=p>,</span> <span class=n>ar_ptr</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nb>NULL</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=nf>checked_request2size</span><span class=p>(</span><span class=n>bytes</span><span class=p>,</span> <span class=n>nb</span><span class=p>);</span> <span class=c1>// 将申请内存转换为适合内存分配的块大小, 转换为nb大小
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=c1>// 若该chunk是mmap的
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=p>(</span><span class=nf>chunk_is_mmapped</span><span class=p>(</span><span class=n>oldp</span><span class=p>))</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>void</span> <span class=o>*</span><span class=n>newmem</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cp>#if HAVE_MREMAP
</span></span></span><span class=line><span class=cl><span class=cp></span>    <span class=n>newp</span> <span class=o>=</span> <span class=nf>mremap_chunk</span><span class=p>(</span><span class=n>oldp</span><span class=p>,</span> <span class=n>nb</span><span class=p>);</span> <span class=c1>// 将oldp原来的chunk的大小调整为nb
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=n>newp</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=nf>chunk2mem</span><span class=p>(</span><span class=n>newp</span><span class=p>);</span> <span class=c1>// 调整成功返回
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=cp>#endif
</span></span></span><span class=line><span class=cl><span class=cp></span>    <span class=k>if</span> <span class=p>(</span><span class=n>oldsize</span> <span class=o>-</span> <span class=n>SIZE_SZ</span> <span class=o>&gt;=</span> <span class=n>nb</span><span class=p>)</span> <span class=c1>// 减去头的用户数据大小要大于申请的堆块大小
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=k>return</span> <span class=n>oldmem</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 若 mremap失败，则通过malloc获取内存
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>newmem</span> <span class=o>=</span> <span class=nf>__libc_malloc</span><span class=p>(</span><span class=n>bytes</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>newmem</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	
</span></span><span class=line><span class=cl>    <span class=c1>// 将原先内存的数据复制到新内存中
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nf>memcpy</span><span class=p>(</span><span class=n>newmem</span><span class=p>,</span> <span class=n>oldmem</span><span class=p>,</span> <span class=n>oldsize</span> <span class=o>-</span> <span class=mi>2</span> <span class=o>*</span> <span class=n>SIZE_SZ</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>munmap_chunk</span><span class=p>(</span><span class=n>oldp</span><span class=p>);</span> <span class=c1>// 将原先内存释放掉
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>return</span> <span class=n>newmem</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>  <span class=c1>// 若不是mmap的则为ptmalloc申请 
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=p>(</span><span class=kt>void</span><span class=p>)</span><span class=nf>mutex_lock</span><span class=p>(</span><span class=o>&amp;</span><span class=n>ar_ptr</span><span class=o>-&gt;</span><span class=n>mutex</span><span class=p>);</span> <span class=c1>// 上锁
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=n>newp</span> <span class=o>=</span> <span class=nf>_int_realloc</span><span class=p>(</span><span class=n>ar_ptr</span><span class=p>,</span> <span class=n>oldp</span><span class=p>,</span> <span class=n>oldsize</span><span class=p>,</span> <span class=n>nb</span><span class=p>);</span> <span class=c1>// 调用 _int_realloc 核心函数
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=p>(</span><span class=kt>void</span><span class=p>)</span><span class=nf>mutex_unlock</span><span class=p>(</span><span class=o>&amp;</span><span class=n>ar_ptr</span><span class=o>-&gt;</span><span class=n>mutex</span><span class=p>);</span> <span class=c1>// 解锁
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// 判断三种情况
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nf>assert</span><span class=p>(</span><span class=o>!</span><span class=n>newp</span> <span class=o>||</span> <span class=nf>chunk_is_mmapped</span><span class=p>(</span><span class=nf>mem2chunk</span><span class=p>(</span><span class=n>newp</span><span class=p>))</span> <span class=o>||</span>
</span></span><span class=line><span class=cl>         <span class=n>ar_ptr</span> <span class=o>==</span> <span class=nf>arena_for_chunk</span><span class=p>(</span><span class=nf>mem2chunk</span><span class=p>(</span><span class=n>newp</span><span class=p>)));</span>
</span></span><span class=line><span class=cl>  <span class=c1>// realloc 申请没调整成功
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=p>(</span><span class=n>newp</span> <span class=o>==</span> <span class=nb>NULL</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nf>LIBC_PROBE</span><span class=p>(</span><span class=n>memory_realloc_retry</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=n>bytes</span><span class=p>,</span> <span class=n>oldmem</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>newp</span> <span class=o>=</span> <span class=nf>__libc_malloc</span><span class=p>(</span><span class=n>bytes</span><span class=p>);</span> <span class=c1>// 尝试malloc
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=n>newp</span> <span class=o>!=</span> <span class=nb>NULL</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nf>memcpy</span><span class=p>(</span><span class=n>newp</span><span class=p>,</span> <span class=n>oldmem</span><span class=p>,</span> <span class=n>oldsize</span> <span class=o>-</span> <span class=n>SIZE_SZ</span><span class=p>);</span> <span class=c1>// 复制数据到新内存
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nf>_int_free</span><span class=p>(</span><span class=n>ar_ptr</span><span class=p>,</span> <span class=n>oldp</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span> <span class=c1>// 释放旧内存
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>newp</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div><h5 id=int_realloc>int_realloc</h5><p>用于重新分配内存块，尝试更改内存块大小</p><div class="code-block code-line-numbers" style="counter-reset:code-block 0"><div class="code-header language-c"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=复制到剪贴板><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=c1>// av指向内存状态的指针，oldp指向内存状态的指针，oldsize当前块的大小，nb请求的新大小
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>void</span> <span class=o>*</span> <span class=nf>_int_realloc</span><span class=p>(</span><span class=n>mstate</span> <span class=n>av</span><span class=p>,</span> <span class=n>mchunkptr</span> <span class=n>oldp</span><span class=p>,</span> <span class=n>INTERNAL_SIZE_T</span> <span class=n>oldsize</span><span class=p>,</span> <span class=n>INTERNAL_SIZE_T</span> <span class=n>nb</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>mchunkptr</span> <span class=n>newp</span><span class=p>;</span>          <span class=cm>/* 新分配的内存块指针 */</span>
</span></span><span class=line><span class=cl>  <span class=n>INTERNAL_SIZE_T</span> <span class=n>newsize</span><span class=p>;</span> <span class=cm>/* 新内存块大小 */</span>
</span></span><span class=line><span class=cl>  <span class=kt>void</span> <span class=o>*</span><span class=n>newmem</span><span class=p>;</span>            <span class=cm>/* 对应用户内存的指针 */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>mchunkptr</span> <span class=n>next</span><span class=p>;</span> <span class=cm>/* 指向oldp后面的连续内存块 */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>mchunkptr</span> <span class=n>remainder</span><span class=p>;</span>          <span class=cm>/* 新分配内存后剩余的内存块 */</span>
</span></span><span class=line><span class=cl>  <span class=kt>unsigned</span> <span class=kt>long</span> <span class=n>remainder_size</span><span class=p>;</span> <span class=cm>/* 剩余内存块大小 */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>mchunkptr</span> <span class=n>bck</span><span class=p>;</span> <span class=cm>/* 链表临时变量 */</span>
</span></span><span class=line><span class=cl>  <span class=n>mchunkptr</span> <span class=n>fwd</span><span class=p>;</span> <span class=cm>/* 链表临时变量 */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kt>unsigned</span> <span class=kt>long</span> <span class=n>copysize</span><span class=p>;</span> <span class=cm>/* 需要复制的字节数 */</span>
</span></span><span class=line><span class=cl>  <span class=kt>unsigned</span> <span class=kt>int</span> <span class=n>ncopies</span><span class=p>;</span>   <span class=cm>/* 需要复制的INTERNAL_SIZE_T字数 */</span>
</span></span><span class=line><span class=cl>  <span class=n>INTERNAL_SIZE_T</span> <span class=o>*</span><span class=n>s</span><span class=p>;</span>     <span class=cm>/* 复制源的指针 */</span>
</span></span><span class=line><span class=cl>  <span class=n>INTERNAL_SIZE_T</span> <span class=o>*</span><span class=n>d</span><span class=p>;</span>     <span class=cm>/* 复制目标的指针 */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=n>errstr</span> <span class=o>=</span> <span class=nb>NULL</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 若大小小于0x10或大于系统内存
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=p>(</span><span class=nf>__builtin_expect</span><span class=p>(</span><span class=n>oldp</span><span class=o>-&gt;</span><span class=n>size</span> <span class=o>&lt;=</span> <span class=mi>2</span> <span class=o>*</span> <span class=n>SIZE_SZ</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span> <span class=o>||</span> <span class=nf>__builtin_expect</span><span class=p>(</span><span class=n>oldsize</span> <span class=o>&gt;=</span> <span class=n>av</span><span class=o>-&gt;</span><span class=n>system_mem</span><span class=p>,</span> <span class=mi>0</span><span class=p>))</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>errstr</span> <span class=o>=</span> <span class=s>&#34;realloc(): invalid old size&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nl>errout</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=nf>malloc_printerr</span><span class=p>(</span><span class=n>check_action</span><span class=p>,</span> <span class=n>errstr</span><span class=p>,</span> <span class=nf>chunk2mem</span><span class=p>(</span><span class=n>oldp</span><span class=p>),</span> <span class=n>av</span><span class=p>);</span> <span class=c1>// 报错
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>return</span> <span class=nb>NULL</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nf>check_inuse_chunk</span><span class=p>(</span><span class=n>av</span><span class=p>,</span> <span class=n>oldp</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=nf>assert</span><span class=p>(</span><span class=o>!</span><span class=nf>chunk_is_mmapped</span><span class=p>(</span><span class=n>oldp</span><span class=p>));</span> <span class=c1>// 检查该chunk不是mmap申请的
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=n>next</span> <span class=o>=</span> <span class=nf>chunk_at_offset</span><span class=p>(</span><span class=n>oldp</span><span class=p>,</span> <span class=n>oldsize</span><span class=p>);</span> <span class=c1>// 获取下一个chunk
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>INTERNAL_SIZE_T</span> <span class=n>nextsize</span> <span class=o>=</span> <span class=nf>chunksize</span><span class=p>(</span><span class=n>next</span><span class=p>);</span> <span class=c1>// 下一个chunk大小
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=p>(</span><span class=nf>__builtin_expect</span><span class=p>(</span><span class=n>next</span><span class=o>-&gt;</span><span class=n>size</span> <span class=o>&lt;=</span> <span class=mi>2</span> <span class=o>*</span> <span class=n>SIZE_SZ</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span> <span class=o>||</span> <span class=nf>__builtin_expect</span><span class=p>(</span><span class=n>nextsize</span> <span class=o>&gt;=</span> <span class=n>av</span><span class=o>-&gt;</span><span class=n>system_mem</span><span class=p>,</span> <span class=mi>0</span><span class=p>))</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>errstr</span> <span class=o>=</span> <span class=s>&#34;realloc(): invalid next size&#34;</span><span class=p>;</span> <span class=c1>// 安全检查下一个chunk大小
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>goto</span> <span class=n>errout</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>((</span><span class=kt>unsigned</span> <span class=kt>long</span><span class=p>)(</span><span class=n>oldsize</span><span class=p>)</span> <span class=o>&gt;=</span> <span class=p>(</span><span class=kt>unsigned</span> <span class=kt>long</span><span class=p>)(</span><span class=n>nb</span><span class=p>))</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span> <span class=c1>// chunk大小足够大
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>newp</span> <span class=o>=</span> <span class=n>oldp</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>newsize</span> <span class=o>=</span> <span class=n>oldsize</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>else</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span> <span class=c1>// chunk大小不足够申请的大小nb，尝试扩展内存
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=n>next</span> <span class=o>==</span> <span class=n>av</span><span class=o>-&gt;</span><span class=n>top</span> <span class=o>&amp;&amp;</span> <span class=c1>// 下一个chunk是top chunk
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=p>(</span><span class=kt>unsigned</span> <span class=kt>long</span><span class=p>)(</span><span class=n>newsize</span> <span class=o>=</span> <span class=n>oldsize</span> <span class=o>+</span> <span class=n>nextsize</span><span class=p>)</span> <span class=o>&gt;=</span> <span class=p>(</span><span class=kt>unsigned</span> <span class=kt>long</span><span class=p>)(</span><span class=n>nb</span> <span class=o>+</span> <span class=n>MINSIZE</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span> <span class=c1>// 且两个chunk大小大于nb+MINSIZE
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nf>set_head_size</span><span class=p>(</span><span class=n>oldp</span><span class=p>,</span> <span class=n>nb</span> <span class=o>|</span> <span class=p>(</span><span class=n>av</span> <span class=o>!=</span> <span class=o>&amp;</span><span class=n>main_arena</span> <span class=o>?</span> <span class=nl>NON_MAIN_ARENA</span> <span class=p>:</span> <span class=mi>0</span><span class=p>));</span>
</span></span><span class=line><span class=cl>      <span class=n>av</span><span class=o>-&gt;</span><span class=n>top</span> <span class=o>=</span> <span class=nf>chunk_at_offset</span><span class=p>(</span><span class=n>oldp</span><span class=p>,</span> <span class=n>nb</span><span class=p>);</span> <span class=c1>// 设置top chunk为oldp偏移nb，即切割一片内存与原堆块合并
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nf>set_head</span><span class=p>(</span><span class=n>av</span><span class=o>-&gt;</span><span class=n>top</span><span class=p>,</span> <span class=p>(</span><span class=n>newsize</span> <span class=o>-</span> <span class=n>nb</span><span class=p>)</span> <span class=o>|</span> <span class=n>PREV_INUSE</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=nf>check_inuse_chunk</span><span class=p>(</span><span class=n>av</span><span class=p>,</span> <span class=n>oldp</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=nf>chunk2mem</span><span class=p>(</span><span class=n>oldp</span><span class=p>);</span> <span class=c1>// 返回合并后堆块
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>}</span> 
</span></span><span class=line><span class=cl>    <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>next</span> <span class=o>!=</span> <span class=n>av</span><span class=o>-&gt;</span><span class=n>top</span> <span class=o>&amp;&amp;</span> <span class=c1>// 若下一个chunk不是 top chunk
</span></span></span><span class=line><span class=cl><span class=c1></span>             <span class=o>!</span><span class=nf>inuse</span><span class=p>(</span><span class=n>next</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=c1>// 下一个chunk空闲
</span></span></span><span class=line><span class=cl><span class=c1></span>             <span class=p>(</span><span class=kt>unsigned</span> <span class=kt>long</span><span class=p>)(</span><span class=n>newsize</span> <span class=o>=</span> <span class=n>oldsize</span> <span class=o>+</span> <span class=n>nextsize</span><span class=p>)</span> <span class=o>&gt;=</span> <span class=p>(</span><span class=kt>unsigned</span> <span class=kt>long</span><span class=p>)(</span><span class=n>nb</span><span class=p>))</span> <span class=c1>// 两个chunk大小大于nb
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>newp</span> <span class=o>=</span> <span class=n>oldp</span><span class=p>;</span> <span class=c1>// 后向合并 next
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nf>unlink</span><span class=p>(</span><span class=n>av</span><span class=p>,</span> <span class=n>next</span><span class=p>,</span> <span class=n>bck</span><span class=p>,</span> <span class=n>fwd</span><span class=p>);</span> <span class=c1>// 把下一个chunk脱链，还未返回，后续还需要切割后面的chunk
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span> <span class=c1>// 下一个chunk不是空闲的
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>newmem</span> <span class=o>=</span> <span class=nf>_int_malloc</span><span class=p>(</span><span class=n>av</span><span class=p>,</span> <span class=n>nb</span> <span class=o>-</span> <span class=n>MALLOC_ALIGN_MASK</span><span class=p>);</span> <span class=c1>// 新申请一块内存
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=k>if</span> <span class=p>(</span><span class=n>newmem</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=n>newp</span> <span class=o>=</span> <span class=nf>mem2chunk</span><span class=p>(</span><span class=n>newmem</span><span class=p>);</span> <span class=c1>// 内存转换为chunk指针
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=n>newsize</span> <span class=o>=</span> <span class=nf>chunksize</span><span class=p>(</span><span class=n>newp</span><span class=p>);</span> <span class=c1>// 获取chunk大小
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=n>newp</span> <span class=o>==</span> <span class=n>next</span><span class=p>)</span> <span class=c1>// 之前判断空闲不能判断是否在fastbin，所以此处申请可能为fastbin相连
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>newsize</span> <span class=o>+=</span> <span class=n>oldsize</span><span class=p>;</span> <span class=c1>// 相邻则直接加在一起
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>newp</span> <span class=o>=</span> <span class=n>oldp</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=k>else</span> <span class=c1>// 否则拷贝＋释放操作
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>copysize</span> <span class=o>=</span> <span class=n>oldsize</span> <span class=o>-</span> <span class=n>SIZE_SZ</span><span class=p>;</span> <span class=c1>// 复制的大小
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>s</span> <span class=o>=</span> <span class=p>(</span><span class=n>INTERNAL_SIZE_T</span> <span class=o>*</span><span class=p>)(</span><span class=nf>chunk2mem</span><span class=p>(</span><span class=n>oldp</span><span class=p>));</span>
</span></span><span class=line><span class=cl>        <span class=n>d</span> <span class=o>=</span> <span class=p>(</span><span class=n>INTERNAL_SIZE_T</span> <span class=o>*</span><span class=p>)(</span><span class=n>newmem</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>ncopies</span> <span class=o>=</span> <span class=n>copysize</span> <span class=o>/</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>INTERNAL_SIZE_T</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=nf>assert</span><span class=p>(</span><span class=n>ncopies</span> <span class=o>&gt;=</span> <span class=mi>3</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>ncopies</span> <span class=o>&gt;</span> <span class=mi>9</span><span class=p>)</span>
</span></span><span class=line><span class=cl>          <span class=nf>memcpy</span><span class=p>(</span><span class=n>d</span><span class=p>,</span> <span class=n>s</span><span class=p>,</span> <span class=n>copysize</span><span class=p>);</span> <span class=c1>// 大于9直接向d中拷贝copysize大小的s中数据
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>        <span class=k>else</span> <span class=c1>// 否则手动拷贝，一次拷贝8字节优化
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=o>*</span><span class=p>(</span><span class=n>d</span> <span class=o>+</span> <span class=mi>0</span><span class=p>)</span> <span class=o>=</span> <span class=o>*</span><span class=p>(</span><span class=n>s</span> <span class=o>+</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>          <span class=o>*</span><span class=p>(</span><span class=n>d</span> <span class=o>+</span> <span class=mi>1</span><span class=p>)</span> <span class=o>=</span> <span class=o>*</span><span class=p>(</span><span class=n>s</span> <span class=o>+</span> <span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>          <span class=o>*</span><span class=p>(</span><span class=n>d</span> <span class=o>+</span> <span class=mi>2</span><span class=p>)</span> <span class=o>=</span> <span class=o>*</span><span class=p>(</span><span class=n>s</span> <span class=o>+</span> <span class=mi>2</span><span class=p>);</span>
</span></span><span class=line><span class=cl>          <span class=k>if</span> <span class=p>(</span><span class=n>ncopies</span> <span class=o>&gt;</span> <span class=mi>4</span><span class=p>)</span>
</span></span><span class=line><span class=cl>          <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=o>*</span><span class=p>(</span><span class=n>d</span> <span class=o>+</span> <span class=mi>3</span><span class=p>)</span> <span class=o>=</span> <span class=o>*</span><span class=p>(</span><span class=n>s</span> <span class=o>+</span> <span class=mi>3</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=o>*</span><span class=p>(</span><span class=n>d</span> <span class=o>+</span> <span class=mi>4</span><span class=p>)</span> <span class=o>=</span> <span class=o>*</span><span class=p>(</span><span class=n>s</span> <span class=o>+</span> <span class=mi>4</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=n>ncopies</span> <span class=o>&gt;</span> <span class=mi>6</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=p>{</span>
</span></span><span class=line><span class=cl>              <span class=o>*</span><span class=p>(</span><span class=n>d</span> <span class=o>+</span> <span class=mi>5</span><span class=p>)</span> <span class=o>=</span> <span class=o>*</span><span class=p>(</span><span class=n>s</span> <span class=o>+</span> <span class=mi>5</span><span class=p>);</span>
</span></span><span class=line><span class=cl>              <span class=o>*</span><span class=p>(</span><span class=n>d</span> <span class=o>+</span> <span class=mi>6</span><span class=p>)</span> <span class=o>=</span> <span class=o>*</span><span class=p>(</span><span class=n>s</span> <span class=o>+</span> <span class=mi>6</span><span class=p>);</span>
</span></span><span class=line><span class=cl>              <span class=k>if</span> <span class=p>(</span><span class=n>ncopies</span> <span class=o>&gt;</span> <span class=mi>8</span><span class=p>)</span>
</span></span><span class=line><span class=cl>              <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=o>*</span><span class=p>(</span><span class=n>d</span> <span class=o>+</span> <span class=mi>7</span><span class=p>)</span> <span class=o>=</span> <span class=o>*</span><span class=p>(</span><span class=n>s</span> <span class=o>+</span> <span class=mi>7</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=o>*</span><span class=p>(</span><span class=n>d</span> <span class=o>+</span> <span class=mi>8</span><span class=p>)</span> <span class=o>=</span> <span class=o>*</span><span class=p>(</span><span class=n>s</span> <span class=o>+</span> <span class=mi>8</span><span class=p>);</span>
</span></span><span class=line><span class=cl>              <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>          <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nf>_int_free</span><span class=p>(</span><span class=n>av</span><span class=p>,</span> <span class=n>oldp</span><span class=p>,</span> <span class=mi>1</span><span class=p>);</span> <span class=c1>// 释放之前的chunk
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nf>check_inuse_chunk</span><span class=p>(</span><span class=n>av</span><span class=p>,</span> <span class=n>newp</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nf>chunk2mem</span><span class=p>(</span><span class=n>newp</span><span class=p>);</span> <span class=c1>// 直接返回了
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nf>assert</span><span class=p>((</span><span class=kt>unsigned</span> <span class=kt>long</span><span class=p>)(</span><span class=n>newsize</span><span class=p>)</span> <span class=o>&gt;=</span> <span class=p>(</span><span class=kt>unsigned</span> <span class=kt>long</span><span class=p>)(</span><span class=n>nb</span><span class=p>));</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 用于切割
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>remainder_size</span> <span class=o>=</span> <span class=n>newsize</span> <span class=o>-</span> <span class=n>nb</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>remainder_size</span> <span class=o>&lt;</span> <span class=n>MINSIZE</span><span class=p>)</span><span class=c1>// 无法切割出一个chunk
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nf>set_head_size</span><span class=p>(</span><span class=n>newp</span><span class=p>,</span> <span class=n>newsize</span> <span class=o>|</span> <span class=p>(</span><span class=n>av</span> <span class=o>!=</span> <span class=o>&amp;</span><span class=n>main_arena</span> <span class=o>?</span> <span class=nl>NON_MAIN_ARENA</span> <span class=p>:</span> <span class=mi>0</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=nf>set_inuse_bit_at_offset</span><span class=p>(</span><span class=n>newp</span><span class=p>,</span> <span class=n>newsize</span><span class=p>);</span> <span class=c1>// 设置标志位
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>else</span><span class=c1>// 剩余部分还可以切割一个chunk
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>remainder</span> <span class=o>=</span> <span class=nf>chunk_at_offset</span><span class=p>(</span><span class=n>newp</span><span class=p>,</span> <span class=n>nb</span><span class=p>);</span> <span class=c1>// 切割
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nf>set_head_size</span><span class=p>(</span><span class=n>newp</span><span class=p>,</span> <span class=n>nb</span> <span class=o>|</span> <span class=p>(</span><span class=n>av</span> <span class=o>!=</span> <span class=o>&amp;</span><span class=n>main_arena</span> <span class=o>?</span> <span class=nl>NON_MAIN_ARENA</span> <span class=p>:</span> <span class=mi>0</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=nf>set_head</span><span class=p>(</span><span class=n>remainder</span><span class=p>,</span> <span class=n>remainder_size</span> <span class=o>|</span> <span class=n>PREV_INUSE</span> <span class=o>|</span> <span class=p>(</span><span class=n>av</span> <span class=o>!=</span> <span class=o>&amp;</span><span class=n>main_arena</span> <span class=o>?</span> <span class=nl>NON_MAIN_ARENA</span> <span class=p>:</span> <span class=mi>0</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=nf>set_inuse_bit_at_offset</span><span class=p>(</span><span class=n>remainder</span><span class=p>,</span> <span class=n>remainder_size</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>_int_free</span><span class=p>(</span><span class=n>av</span><span class=p>,</span> <span class=n>remainder</span><span class=p>,</span> <span class=mi>1</span><span class=p>);</span> <span class=c1>// 释放remainder
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nf>check_inuse_chunk</span><span class=p>(</span><span class=n>av</span><span class=p>,</span> <span class=n>newp</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nf>chunk2mem</span><span class=p>(</span><span class=n>newp</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div><h5 id=mremap_chunk>mremap_chunk</h5><p>调整mmap分配的内存块大小</p><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-c"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=复制到剪贴板><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>static</span> <span class=n>mchunkptr</span> <span class=n>internal_function</span> <span class=nf>mremap_chunk</span><span class=p>(</span><span class=n>mchunkptr</span> <span class=n>p</span><span class=p>,</span> <span class=kt>size_t</span> <span class=n>new_size</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span> <span class=c1>// 调整由mmap分配的内存块 p 的大小到 new_size
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kt>size_t</span> <span class=n>pagesize</span> <span class=o>=</span> <span class=nf>GLRO</span><span class=p>(</span><span class=n>dl_pagesize</span><span class=p>);</span> <span class=c1>// 当前系统页大小
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>INTERNAL_SIZE_T</span> <span class=n>offset</span> <span class=o>=</span> <span class=n>p</span><span class=o>-&gt;</span><span class=n>prev_size</span><span class=p>;</span> <span class=c1>// 当前块的偏移量，prev_size
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>INTERNAL_SIZE_T</span> <span class=n>size</span> <span class=o>=</span> <span class=nf>chunksize</span><span class=p>(</span><span class=n>p</span><span class=p>);</span> <span class=c1>// 当前块大小
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kt>char</span> <span class=o>*</span><span class=n>cp</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nf>assert</span><span class=p>(</span><span class=nf>chunk_is_mmapped</span><span class=p>(</span><span class=n>p</span><span class=p>));</span> <span class=c1>// 确保是mmap分配
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nf>assert</span><span class=p>(((</span><span class=n>size</span> <span class=o>+</span> <span class=n>offset</span><span class=p>)</span> <span class=o>&amp;</span> <span class=p>(</span><span class=nf>GLRO</span><span class=p>(</span><span class=n>dl_pagesize</span><span class=p>)</span> <span class=o>-</span> <span class=mi>1</span><span class=p>))</span> <span class=o>==</span> <span class=mi>0</span><span class=p>);</span> <span class=c1>// 确保块大小加上偏移量是页大小整数倍对齐
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=n>new_size</span> <span class=o>=</span> <span class=nf>ALIGN_UP</span><span class=p>(</span><span class=n>new_size</span> <span class=o>+</span> <span class=n>offset</span> <span class=o>+</span> <span class=n>SIZE_SZ</span><span class=p>,</span> <span class=n>pagesize</span><span class=p>);</span> <span class=c1>// 将new_size调整为与系统页对齐
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>size</span> <span class=o>+</span> <span class=n>offset</span> <span class=o>==</span> <span class=n>new_size</span><span class=p>)</span> <span class=c1>// 若刚好等于调整后则返回
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>return</span> <span class=n>p</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 否则调用系统调用__mremap重新映射内存块，mremap重新分配一块内存并将之前的数据复制到新的内存上
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>cp</span> <span class=o>=</span> <span class=p>(</span><span class=kt>char</span> <span class=o>*</span><span class=p>)</span><span class=nf>__mremap</span><span class=p>((</span><span class=kt>char</span> <span class=o>*</span><span class=p>)</span><span class=n>p</span> <span class=o>-</span> <span class=n>offset</span><span class=p>,</span> <span class=n>size</span> <span class=o>+</span> <span class=n>offset</span><span class=p>,</span> <span class=n>new_size</span><span class=p>,</span><span class=n>MREMAP_MAYMOVE</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>cp</span> <span class=o>==</span> <span class=n>MAP_FAILED</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=mi>0</span><span class=p>;</span> <span class=c1>// 调整失败
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=n>p</span> <span class=o>=</span> <span class=p>(</span><span class=n>mchunkptr</span><span class=p>)(</span><span class=n>cp</span> <span class=o>+</span> <span class=n>offset</span><span class=p>);</span> <span class=c1>// mremap返回地址cp加上偏移得到新的块指针p
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=nf>assert</span><span class=p>(</span><span class=nf>aligned_OK</span><span class=p>(</span><span class=nf>chunk2mem</span><span class=p>(</span><span class=n>p</span><span class=p>)));</span> <span class=c1>// 地址对齐
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nf>assert</span><span class=p>((</span><span class=n>p</span><span class=o>-&gt;</span><span class=n>prev_size</span> <span class=o>==</span> <span class=n>offset</span><span class=p>));</span> <span class=c1>// 偏移量未变
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nf>set_head</span><span class=p>(</span><span class=n>p</span><span class=p>,</span> <span class=p>(</span><span class=n>new_size</span> <span class=o>-</span> <span class=n>offset</span><span class=p>)</span> <span class=o>|</span> <span class=n>IS_MMAPPED</span><span class=p>);</span> <span class=c1>// 更新头信息
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=n>INTERNAL_SIZE_T</span> <span class=n>new</span><span class=p>;</span> <span class=c1>// 更新mmaped_mem信息
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>new</span> <span class=o>=</span> <span class=nf>atomic_exchange_and_add</span><span class=p>(</span><span class=o>&amp;</span><span class=n>mp_</span><span class=p>.</span><span class=n>mmapped_mem</span><span class=p>,</span> <span class=n>new_size</span> <span class=o>-</span> <span class=n>size</span> <span class=o>-</span> <span class=n>offset</span><span class=p>)</span> <span class=o>+</span> <span class=n>new_size</span> <span class=o>-</span> <span class=n>size</span> <span class=o>-</span> <span class=n>offset</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nf>atomic_max</span><span class=p>(</span><span class=o>&amp;</span><span class=n>mp_</span><span class=p>.</span><span class=n>max_mmapped_mem</span><span class=p>,</span> <span class=n>new</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>p</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div><h2 id=io_file>IO_FILE</h2><h3 id=结构-1>结构</h3><h4 id=_io_list_all>_IO_list_all</h4><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-c"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=复制到剪贴板><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=c1>// 指向_IO_FILE单链表的链表头
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>extern</span> <span class=k>struct</span> <span class=n>_IO_FILE_plus</span> <span class=o>*</span><span class=n>_IO_list_all</span><span class=p>;</span></span></span></code></pre></div></div><h4 id=_io_file_plus>_IO_FILE_plus</h4><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-c"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=复制到剪贴板><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>struct</span> <span class=n>_IO_FILE_plus</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>_IO_FILE</span> <span class=n>file</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=c1>// vtable: 实现文件流操作的虚函数表,包含一组函数指针,指向实现各种IO操作的函数，不同的对象指向函数可能不同
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>const</span> <span class=k>struct</span> <span class=n>_IO_jump_t</span> <span class=o>*</span><span class=n>vtable</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>};</span></span></span></code></pre></div></div><h4 id=_io_file>_IO_FILE</h4><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-c"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=复制到剪贴板><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>struct</span> <span class=n>_IO_FILE</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kt>int</span> <span class=n>_flags</span><span class=p>;</span>		<span class=cm>/* High-order word is _IO_MAGIC; rest is flags. */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=cm>/* The following pointers correspond to the C++ streambuf protocol. */</span>
</span></span><span class=line><span class=cl>  <span class=kt>char</span> <span class=o>*</span><span class=n>_IO_read_ptr</span><span class=p>;</span>	<span class=cm>/* 指针指向当前读到的位置 */</span>
</span></span><span class=line><span class=cl>  <span class=kt>char</span> <span class=o>*</span><span class=n>_IO_read_end</span><span class=p>;</span>	<span class=cm>/* get area的结束，系统读取数据的结尾 */</span>
</span></span><span class=line><span class=cl>  <span class=kt>char</span> <span class=o>*</span><span class=n>_IO_read_base</span><span class=p>;</span>	<span class=cm>/* putback+get area的开始，系统读取数据的开头 */</span>
</span></span><span class=line><span class=cl>  <span class=kt>char</span> <span class=o>*</span><span class=n>_IO_write_base</span><span class=p>;</span>	<span class=cm>/* IO文件缓冲区开头 */</span>
</span></span><span class=line><span class=cl>  <span class=kt>char</span> <span class=o>*</span><span class=n>_IO_write_ptr</span><span class=p>;</span>	<span class=cm>/* 指针指向当前写到的位置 */</span>
</span></span><span class=line><span class=cl>  <span class=kt>char</span> <span class=o>*</span><span class=n>_IO_write_end</span><span class=p>;</span>	<span class=cm>/* IO文件缓冲区结尾 */</span>
</span></span><span class=line><span class=cl>  <span class=kt>char</span> <span class=o>*</span><span class=n>_IO_buf_base</span><span class=p>;</span>	<span class=cm>/* buf缓冲区的开始 */</span>
</span></span><span class=line><span class=cl>  <span class=kt>char</span> <span class=o>*</span><span class=n>_IO_buf_end</span><span class=p>;</span>	<span class=cm>/* buf缓冲区的结束 */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=cm>/* The following fields are used to support backing up and undo. */</span>
</span></span><span class=line><span class=cl>  <span class=kt>char</span> <span class=o>*</span><span class=n>_IO_save_base</span><span class=p>;</span> <span class=cm>/* Pointer to start of non-current get area. */</span>
</span></span><span class=line><span class=cl>  <span class=kt>char</span> <span class=o>*</span><span class=n>_IO_backup_base</span><span class=p>;</span>  <span class=cm>/* Pointer to first valid character of backup area */</span>
</span></span><span class=line><span class=cl>  <span class=kt>char</span> <span class=o>*</span><span class=n>_IO_save_end</span><span class=p>;</span> <span class=cm>/* Pointer to end of non-current get area. */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>struct</span> <span class=n>_IO_marker</span> <span class=o>*</span><span class=n>_markers</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>struct</span> <span class=n>_IO_FILE</span> <span class=o>*</span><span class=n>_chain</span><span class=p>;</span> <span class=c1>// 指向下一个_IO_FILE结构体
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=kt>int</span> <span class=n>_fileno</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>int</span> <span class=n>_flags2</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>__off_t</span> <span class=n>_old_offset</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>unsigned</span> <span class=kt>short</span> <span class=n>_cur_column</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>signed</span> <span class=kt>char</span> <span class=n>_vtable_offset</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>char</span> <span class=n>_shortbuf</span><span class=p>[</span><span class=mi>1</span><span class=p>];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>_IO_lock_t</span> <span class=o>*</span><span class=n>_lock</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=cp>#ifdef _IO_USE_OLD_IO_FILE
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=p>};</span></span></span></code></pre></div></div><p><strong>偏移</strong></p><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-c"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=复制到剪贴板><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=mh>0x0</span><span class=o>:</span><span class=err>&#39;</span><span class=n>_flags</span><span class=err>&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=mh>0x8</span><span class=o>:</span><span class=err>&#39;</span><span class=n>_IO_read_ptr</span><span class=err>&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=mh>0x10</span><span class=o>:</span><span class=err>&#39;</span><span class=n>_IO_read_end</span><span class=err>&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=mh>0x18</span><span class=o>:</span><span class=err>&#39;</span><span class=n>_IO_read_base</span><span class=err>&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=mh>0x20</span><span class=o>:</span><span class=err>&#39;</span><span class=n>_IO_write_base</span><span class=err>&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=mh>0x28</span><span class=o>:</span><span class=err>&#39;</span><span class=n>_IO_write_ptr</span><span class=err>&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=mh>0x30</span><span class=o>:</span><span class=err>&#39;</span><span class=n>_IO_write_end</span><span class=err>&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=mh>0x38</span><span class=o>:</span><span class=err>&#39;</span><span class=n>_IO_buf_base</span><span class=err>&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=mh>0x40</span><span class=o>:</span><span class=err>&#39;</span><span class=n>_IO_buf_end</span><span class=err>&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=mh>0x48</span><span class=o>:</span><span class=err>&#39;</span><span class=n>_IO_save_base</span><span class=err>&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=mh>0x50</span><span class=o>:</span><span class=err>&#39;</span><span class=n>_IO_backup_base</span><span class=err>&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=mh>0x58</span><span class=o>:</span><span class=err>&#39;</span><span class=n>_IO_save_end</span><span class=err>&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=mh>0x60</span><span class=o>:</span><span class=err>&#39;</span><span class=n>_markers</span><span class=err>&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=mh>0x68</span><span class=o>:</span><span class=err>&#39;</span><span class=n>_chain</span><span class=err>&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=mh>0x70</span><span class=o>:</span><span class=err>&#39;</span><span class=n>_fileno</span><span class=err>&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=mh>0x74</span><span class=o>:</span><span class=err>&#39;</span><span class=n>_flags2</span><span class=err>&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=mh>0x78</span><span class=o>:</span><span class=err>&#39;</span><span class=n>_old_offset</span><span class=err>&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=mh>0x80</span><span class=o>:</span><span class=err>&#39;</span><span class=n>_cur_column</span><span class=err>&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=mh>0x82</span><span class=o>:</span><span class=err>&#39;</span><span class=n>_vtable_offset</span><span class=err>&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=mh>0x83</span><span class=o>:</span><span class=err>&#39;</span><span class=n>_shortbuf</span><span class=err>&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=mh>0x88</span><span class=o>:</span><span class=err>&#39;</span><span class=n>_lock</span><span class=err>&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=mh>0x90</span><span class=o>:</span><span class=err>&#39;</span><span class=n>_offset</span><span class=err>&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=mh>0x98</span><span class=o>:</span><span class=err>&#39;</span><span class=n>_codecvt</span><span class=err>&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=mh>0xa0</span><span class=o>:</span><span class=err>&#39;</span><span class=n>_wide_data</span><span class=err>&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=mh>0xa8</span><span class=o>:</span><span class=err>&#39;</span><span class=n>_freeres_list</span><span class=err>&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=mh>0xb0</span><span class=o>:</span><span class=err>&#39;</span><span class=n>_freeres_buf</span><span class=err>&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=mh>0xb8</span><span class=o>:</span><span class=err>&#39;</span><span class=n>__pad5</span><span class=err>&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=mh>0xc0</span><span class=o>:</span><span class=err>&#39;</span><span class=n>_mode</span><span class=err>&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=mh>0xc4</span><span class=o>:</span><span class=err>&#39;</span><span class=n>_unused2</span><span class=err>&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=mh>0xd8</span><span class=o>:</span><span class=err>&#39;</span><span class=n>vtable</span><span class=err>&#39;</span></span></span></code></pre></div></div><h4 id=_io_file_complete>_IO_FILE_complete</h4><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-c"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=复制到剪贴板><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>struct</span> <span class=n>_IO_FILE_complete</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>struct</span> <span class=n>_IO_FILE</span> <span class=n>_file</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>__off64_t</span> <span class=n>_offset</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>struct</span> <span class=n>_IO_codecvt</span> <span class=o>*</span><span class=n>_codecvt</span><span class=p>;</span> <span class=c1>// house of apple 3利用
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>struct</span> <span class=n>_IO_wide_data</span> <span class=o>*</span><span class=n>_wide_data</span><span class=p>;</span> <span class=c1>// house of apple 2劫持这个变量
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>struct</span> <span class=n>_IO_FILE</span> <span class=o>*</span><span class=n>_freeres_list</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>void</span> <span class=o>*</span><span class=n>_freeres_buf</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>size_t</span> <span class=n>__pad5</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>int</span> <span class=n>_mode</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>char</span> <span class=n>_unused2</span><span class=p>[</span><span class=mi>15</span> <span class=o>*</span> <span class=k>sizeof</span> <span class=p>(</span><span class=kt>int</span><span class=p>)</span> <span class=o>-</span> <span class=mi>4</span> <span class=o>*</span> <span class=k>sizeof</span> <span class=p>(</span><span class=kt>void</span> <span class=o>*</span><span class=p>)</span> <span class=o>-</span> <span class=k>sizeof</span> <span class=p>(</span><span class=kt>size_t</span><span class=p>)];</span>
</span></span><span class=line><span class=cl><span class=p>};</span></span></span></code></pre></div></div><h4 id=_io_codecvt>_IO_codecvt</h4><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-c"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=复制到剪贴板><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>struct</span> <span class=n>_IO_codecvt</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>_IO_iconv_t</span> <span class=n>__cd_in</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>_IO_iconv_t</span> <span class=n>__cd_out</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>};</span></span></span></code></pre></div></div><h4 id=_io_iconv_t>_IO_iconv_t</h4><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-c"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=复制到剪贴板><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>typedef</span> <span class=k>struct</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>struct</span> <span class=n>__gconv_step</span> <span class=o>*</span><span class=n>step</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>struct</span> <span class=n>__gconv_step_data</span> <span class=n>step_data</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span> <span class=n>_IO_iconv_t</span><span class=p>;</span></span></span></code></pre></div></div><h4 id=__gconv_step>__gconv_step</h4><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-c"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=复制到剪贴板><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>struct</span> <span class=n>__gconv_step</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>struct</span> <span class=n>__gconv_loaded_object</span> <span class=o>*</span><span class=n>__shlib_handle</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=n>__modname</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>int</span> <span class=n>__counter</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kt>char</span> <span class=o>*</span><span class=n>__from_name</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>char</span> <span class=o>*</span><span class=n>__to_name</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>__gconv_fct</span> <span class=n>__fct</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>__gconv_btowc_fct</span> <span class=n>__btowc_fct</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>__gconv_init_fct</span> <span class=n>__init_fct</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>__gconv_end_fct</span> <span class=n>__end_fct</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>  <span class=kt>int</span> <span class=n>__min_needed_from</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>int</span> <span class=n>__max_needed_from</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>int</span> <span class=n>__min_needed_to</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>int</span> <span class=n>__max_needed_to</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kt>int</span> <span class=n>__stateful</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>void</span> <span class=o>*</span><span class=n>__data</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>};</span></span></span></code></pre></div></div><h4 id=_io_wstrnfile>_IO_wstrnfile</h4><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-c"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=复制到剪贴板><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>typedef</span> <span class=k>struct</span><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>_IO_strfile</span> <span class=n>f</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>wchar_t</span> <span class=n>overflow_buf</span><span class=p>[</span><span class=mi>64</span><span class=p>];</span> <span class=c1>// overflow_buf
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span> <span class=n>_IO_wstrnfile</span><span class=p>;</span></span></span></code></pre></div></div><h4 id=_io_strnfile>_IO_strnfile</h4><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-c"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=复制到剪贴板><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>typedef</span> <span class=k>struct</span><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>_IO_strfile</span> <span class=n>f</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>char</span> <span class=n>overflow_buf</span><span class=p>[</span><span class=mi>64</span><span class=p>];</span>
</span></span><span class=line><span class=cl><span class=p>}</span> <span class=n>_IO_strnfile</span><span class=p>;</span></span></span></code></pre></div></div><h4 id=_io_strfile>_IO_strfile</h4><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-c"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=复制到剪贴板><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>typedef</span> <span class=k>struct</span> <span class=n>_IO_strfile_</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>struct</span> <span class=n>_IO_streambuf</span> <span class=n>_sbf</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>struct</span> <span class=n>_IO_str_fields</span> <span class=n>_s</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span> <span class=n>_IO_strfile</span><span class=p>;</span></span></span></code></pre></div></div><h4 id=_io_streambuf>_IO_streambuf</h4><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-c"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=复制到剪贴板><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>struct</span> <span class=n>_IO_streambuf</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>FILE</span> <span class=n>_f</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>const</span> <span class=k>struct</span> <span class=n>_IO_jump_t</span> <span class=o>*</span><span class=n>vtable</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>};</span></span></span></code></pre></div></div><h4 id=_io_str_fields>_IO_str_fields</h4><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-c"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=复制到剪贴板><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>struct</span> <span class=n>_IO_str_fields</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>_IO_alloc_type</span> <span class=n>_allocate_buffer_unused</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>_IO_free_type</span> <span class=n>_free_buffer_unused</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>};</span></span></span></code></pre></div></div><h4 id=_io_wide_data>_IO_wide_data</h4><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-c"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=复制到剪贴板><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=c1>// 结构与_IO_FILE很像
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>struct</span> <span class=n>_IO_wide_data</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kt>wchar_t</span> <span class=o>*</span><span class=n>_IO_read_ptr</span><span class=p>;</span>	<span class=cm>/* Current read pointer */</span>
</span></span><span class=line><span class=cl>  <span class=kt>wchar_t</span> <span class=o>*</span><span class=n>_IO_read_end</span><span class=p>;</span>	<span class=cm>/* End of get area. */</span>
</span></span><span class=line><span class=cl>  <span class=kt>wchar_t</span> <span class=o>*</span><span class=n>_IO_read_base</span><span class=p>;</span>	<span class=cm>/* Start of putback+get area. */</span>
</span></span><span class=line><span class=cl>  <span class=kt>wchar_t</span> <span class=o>*</span><span class=n>_IO_write_base</span><span class=p>;</span>	<span class=cm>/* Start of put area. */</span>
</span></span><span class=line><span class=cl>  <span class=kt>wchar_t</span> <span class=o>*</span><span class=n>_IO_write_ptr</span><span class=p>;</span>	<span class=cm>/* Current put pointer. */</span>
</span></span><span class=line><span class=cl>  <span class=kt>wchar_t</span> <span class=o>*</span><span class=n>_IO_write_end</span><span class=p>;</span>	<span class=cm>/* End of put area. */</span>
</span></span><span class=line><span class=cl>  <span class=kt>wchar_t</span> <span class=o>*</span><span class=n>_IO_buf_base</span><span class=p>;</span>	<span class=cm>/* Start of reserve area. */</span>
</span></span><span class=line><span class=cl>  <span class=kt>wchar_t</span> <span class=o>*</span><span class=n>_IO_buf_end</span><span class=p>;</span>		<span class=cm>/* End of reserve area. */</span>
</span></span><span class=line><span class=cl>  <span class=cm>/* The following fields are used to support backing up and undo. */</span>
</span></span><span class=line><span class=cl>  <span class=kt>wchar_t</span> <span class=o>*</span><span class=n>_IO_save_base</span><span class=p>;</span>	<span class=cm>/* Pointer to start of non-current get area. */</span>
</span></span><span class=line><span class=cl>  <span class=kt>wchar_t</span> <span class=o>*</span><span class=n>_IO_backup_base</span><span class=p>;</span>	<span class=cm>/* Pointer to first valid character of
</span></span></span><span class=line><span class=cl><span class=cm>				   backup area */</span>
</span></span><span class=line><span class=cl>  <span class=kt>wchar_t</span> <span class=o>*</span><span class=n>_IO_save_end</span><span class=p>;</span>	<span class=cm>/* Pointer to end of non-current get area. */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>__mbstate_t</span> <span class=n>_IO_state</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>__mbstate_t</span> <span class=n>_IO_last_state</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>struct</span> <span class=n>_IO_codecvt</span> <span class=n>_codecvt</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>wchar_t</span> <span class=n>_shortbuf</span><span class=p>[</span><span class=mi>1</span><span class=p>];</span>
</span></span><span class=line><span class=cl>  <span class=k>const</span> <span class=k>struct</span> <span class=n>_IO_jump_t</span> <span class=o>*</span><span class=n>_wide_vtable</span><span class=p>;</span> <span class=c1>// vtable表
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>};</span></span></span></code></pre></div></div><h4 id=_io_jump_t>_IO_jump_t</h4><p>不同的实例对象指向的函数可能不同</p><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-c"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=复制到剪贴板><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>struct</span> <span class=n>_IO_jump_t</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nf>JUMP_FIELD</span><span class=p>(</span><span class=kt>size_t</span><span class=p>,</span> <span class=n>__dummy</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>JUMP_FIELD</span><span class=p>(</span><span class=kt>size_t</span><span class=p>,</span> <span class=n>__dummy2</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>JUMP_FIELD</span><span class=p>(</span><span class=n>_IO_finish_t</span><span class=p>,</span> <span class=n>__finish</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>JUMP_FIELD</span><span class=p>(</span><span class=n>_IO_overflow_t</span><span class=p>,</span> <span class=n>__overflow</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>JUMP_FIELD</span><span class=p>(</span><span class=n>_IO_underflow_t</span><span class=p>,</span> <span class=n>__underflow</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>JUMP_FIELD</span><span class=p>(</span><span class=n>_IO_underflow_t</span><span class=p>,</span> <span class=n>__uflow</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>JUMP_FIELD</span><span class=p>(</span><span class=n>_IO_pbackfail_t</span><span class=p>,</span> <span class=n>__pbackfail</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>JUMP_FIELD</span><span class=p>(</span><span class=n>_IO_xsputn_t</span><span class=p>,</span> <span class=n>__xsputn</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>JUMP_FIELD</span><span class=p>(</span><span class=n>_IO_xsgetn_t</span><span class=p>,</span> <span class=n>__xsgetn</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>JUMP_FIELD</span><span class=p>(</span><span class=n>_IO_seekoff_t</span><span class=p>,</span> <span class=n>__seekoff</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>JUMP_FIELD</span><span class=p>(</span><span class=n>_IO_seekpos_t</span><span class=p>,</span> <span class=n>__seekpos</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>JUMP_FIELD</span><span class=p>(</span><span class=n>_IO_setbuf_t</span><span class=p>,</span> <span class=n>__setbuf</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>JUMP_FIELD</span><span class=p>(</span><span class=n>_IO_sync_t</span><span class=p>,</span> <span class=n>__sync</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>JUMP_FIELD</span><span class=p>(</span><span class=n>_IO_doallocate_t</span><span class=p>,</span> <span class=n>__doallocate</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>JUMP_FIELD</span><span class=p>(</span><span class=n>_IO_read_t</span><span class=p>,</span> <span class=n>__read</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>JUMP_FIELD</span><span class=p>(</span><span class=n>_IO_write_t</span><span class=p>,</span> <span class=n>__write</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>JUMP_FIELD</span><span class=p>(</span><span class=n>_IO_seek_t</span><span class=p>,</span> <span class=n>__seek</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>JUMP_FIELD</span><span class=p>(</span><span class=n>_IO_close_t</span><span class=p>,</span> <span class=n>__close</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>JUMP_FIELD</span><span class=p>(</span><span class=n>_IO_stat_t</span><span class=p>,</span> <span class=n>__stat</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>JUMP_FIELD</span><span class=p>(</span><span class=n>_IO_showmanyc_t</span><span class=p>,</span> <span class=n>__showmanyc</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>JUMP_FIELD</span><span class=p>(</span><span class=n>_IO_imbue_t</span><span class=p>,</span> <span class=n>__imbue</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=cp>#if 0</span><span class=c>
</span></span></span><span class=line><span class=cl><span class=c>    get_column;
</span></span></span><span class=line><span class=cl><span class=c>    set_column;
</span></span></span><span class=line><span class=cl><span class=c></span><span class=cp>#endif
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=p>};</span></span></span></code></pre></div></div><h4 id=std>STD</h4><ul><li>初始情况<code>_IO_list_all</code>指向<code>_IO_2_1_stdin_</code>，<code>_IO_2_1_stdout_</code>，<code>_IO_2_1_stderr_</code>三个<code>_IO_FILE</code>结构体，开在libc的数据段上</li></ul><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-c"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=复制到剪贴板><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=c1>// stdfiles.c
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nf>DEF_STDFILE</span><span class=p>(</span><span class=n>_IO_2_1_stdin_</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=n>_IO_NO_WRITES</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nf>DEF_STDFILE</span><span class=p>(</span><span class=n>_IO_2_1_stdout_</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>_IO_2_1_stdin_</span><span class=p>,</span> <span class=n>_IO_NO_READS</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nf>DEF_STDFILE</span><span class=p>(</span><span class=n>_IO_2_1_stderr_</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>_IO_2_1_stdout_</span><span class=p>,</span> <span class=n>_IO_NO_READS</span><span class=o>+</span><span class=n>_IO_UNBUFFERED</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>struct</span> <span class=n>_IO_FILE_plus</span> <span class=o>*</span><span class=n>_IO_list_all</span> <span class=o>=</span> <span class=o>&amp;</span><span class=n>_IO_2_1_stderr_</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=nf>libc_hidden_data_def</span> <span class=p>(</span><span class=n>_IO_list_all</span><span class=p>)</span></span></span></code></pre></div></div><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-c"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=复制到剪贴板><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=c1>// stdio.c
</span></span></span><span class=line><span class=cl><span class=c1>// 三个全局指针指向三个结构体
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>_IO_FILE</span> <span class=o>*</span><span class=n>stdin</span> <span class=o>=</span> <span class=p>(</span><span class=n>FILE</span> <span class=o>*</span><span class=p>)</span> <span class=o>&amp;</span><span class=n>_IO_2_1_stdin_</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=n>_IO_FILE</span> <span class=o>*</span><span class=n>stdout</span> <span class=o>=</span> <span class=p>(</span><span class=n>FILE</span> <span class=o>*</span><span class=p>)</span> <span class=o>&amp;</span><span class=n>_IO_2_1_stdout_</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=n>_IO_FILE</span> <span class=o>*</span><span class=n>stderr</span> <span class=o>=</span> <span class=p>(</span><span class=n>FILE</span> <span class=o>*</span><span class=p>)</span> <span class=o>&amp;</span><span class=n>_IO_2_1_stderr_</span><span class=p>;</span></span></span></code></pre></div></div><img src=img/source_analyze.zh-cn.assets/image-20241206005717674.png alt=图片无法加载><h4 id=def_stdfile>DEF_STDFILE</h4><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-c"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=复制到剪贴板><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=c1>// stdfiles.c
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=cp># define DEF_STDFILE(NAME, FD, CHAIN, FLAGS) </span><span class=c1>// 文件流对象名、文件描述符、文件链、标志[只读只写]
</span></span></span><span class=line><span class=cl><span class=c1>// 锁，保护文件流的并发访问
</span></span></span><span class=line><span class=cl><span class=c1></span> <span class=k>static</span> <span class=n>_IO_lock_t</span> <span class=n>_IO_stdfile_</span><span class=err>##</span><span class=n>FD</span><span class=err>##</span><span class=n>_lock</span> <span class=o>=</span> <span class=n>_IO_lock_initializer</span><span class=p>;</span> 
</span></span><span class=line><span class=cl><span class=c1>// 宽字符数据结构
</span></span></span><span class=line><span class=cl><span class=c1></span> <span class=k>static</span> <span class=k>struct</span> <span class=n>_IO_wide_data</span> <span class=n>_IO_wide_data_</span><span class=err>##</span><span class=n>FD</span> <span class=o>=</span> <span class=p>{</span> <span class=p>.</span><span class=n>_wide_vtable</span> <span class=o>=</span> <span class=o>&amp;</span><span class=n>_IO_wfile_jumps</span> <span class=p>};</span> 
</span></span><span class=line><span class=cl><span class=c1>// 文件流结构体
</span></span></span><span class=line><span class=cl><span class=c1></span> <span class=k>struct</span> <span class=n>_IO_FILE_plus</span> <span class=n>NAME</span> <span class=o>=</span> <span class=p>{</span><span class=nf>FILEBUF_LITERAL</span><span class=p>(</span><span class=n>CHAIN</span><span class=p>,</span> <span class=n>FLAGS</span><span class=p>,</span> <span class=n>FD</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>_IO_wide_data_</span><span class=err>##</span><span class=n>FD</span><span class=p>),</span> <span class=o>&amp;</span><span class=n>_IO_file_jumps</span><span class=p>};</span></span></span></code></pre></div></div><h4 id=_io_link_in>_IO_link_in</h4><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-c"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=复制到剪贴板><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=c1>// 有文件读写操作，为对应文件创建_IO_FILE结构体，头插法链接到_IO_list_all链表上
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>void</span> <span class=nf>_IO_link_in</span> <span class=p>(</span><span class=k>struct</span> <span class=n>_IO_FILE_plus</span> <span class=o>*</span><span class=n>fp</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// _IO_LINKED 标志未被设置, 执行插入操作
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=p>((</span><span class=n>fp</span><span class=o>-&gt;</span><span class=n>file</span><span class=p>.</span><span class=n>_flags</span> <span class=o>&amp;</span> <span class=n>_IO_LINKED</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// 设置标志位
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=n>fp</span><span class=o>-&gt;</span><span class=n>file</span><span class=p>.</span><span class=n>_flags</span> <span class=o>|=</span> <span class=n>_IO_LINKED</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=cp>#ifdef _IO_MTSAFE_IO
</span></span></span><span class=line><span class=cl><span class=cp></span>      <span class=c1>// 线程安全操作
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nf>_IO_cleanup_region_start_noarg</span> <span class=p>(</span><span class=n>flush_cleanup</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=nf>_IO_lock_lock</span> <span class=p>(</span><span class=n>list_all_lock</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=n>run_fp</span> <span class=o>=</span> <span class=p>(</span><span class=n>_IO_FILE</span> <span class=o>*</span><span class=p>)</span> <span class=n>fp</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=nf>_IO_flockfile</span> <span class=p>((</span><span class=n>_IO_FILE</span> <span class=o>*</span><span class=p>)</span> <span class=n>fp</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=cp>#endif
</span></span></span><span class=line><span class=cl><span class=cp></span>      <span class=c1>// 链接到开头
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=n>fp</span><span class=o>-&gt;</span><span class=n>file</span><span class=p>.</span><span class=n>_chain</span> <span class=o>=</span> <span class=p>(</span><span class=n>_IO_FILE</span> <span class=o>*</span><span class=p>)</span> <span class=n>_IO_list_all</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=n>_IO_list_all</span> <span class=o>=</span> <span class=n>fp</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=cp>#ifdef _IO_MTSAFE_IO
</span></span></span><span class=line><span class=cl><span class=cp></span>      <span class=c1>// 线程安全操作
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nf>_IO_funlockfile</span> <span class=p>((</span><span class=n>_IO_FILE</span> <span class=o>*</span><span class=p>)</span> <span class=n>fp</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=n>run_fp</span> <span class=o>=</span> <span class=nb>NULL</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=nf>_IO_lock_unlock</span> <span class=p>(</span><span class=n>list_all_lock</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=nf>_IO_cleanup_region_end</span> <span class=p>(</span><span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=cp>#endif
</span></span></span><span class=line><span class=cl><span class=cp></span>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=nf>libc_hidden_def</span> <span class=p>(</span><span class=n>_IO_link_in</span><span class=p>)</span></span></span></code></pre></div></div><h4 id=_io_cookie_file>_IO_cookie_file</h4><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-c"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=复制到剪贴板><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>struct</span> <span class=n>_IO_cookie_file</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>struct</span> <span class=n>_IO_FILE_plus</span> <span class=n>__fp</span><span class=p>;</span> <span class=c1>// 包含一个FILE结构体和一个_IO_jump_t指针vtable
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kt>void</span> <span class=o>*</span><span class=n>__cookie</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>cookie_io_functions_t</span> <span class=n>__io_functions</span><span class=p>;</span> <span class=c1>// 包含4个函数指针
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>};</span></span></span></code></pre></div></div><h4 id=_io_cookie_io_functions_t>_IO_cookie_io_functions_t</h4><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-c"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=复制到剪贴板><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>typedef</span> <span class=k>struct</span> <span class=n>_IO_cookie_io_functions_t</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kt>cookie_read_function_t</span> <span class=o>*</span><span class=n>read</span><span class=p>;</span>		<span class=cm>/* Read bytes.  */</span>
</span></span><span class=line><span class=cl>  <span class=kt>cookie_write_function_t</span> <span class=o>*</span><span class=n>write</span><span class=p>;</span>	<span class=cm>/* Write bytes.  */</span>
</span></span><span class=line><span class=cl>  <span class=kt>cookie_seek_function_t</span> <span class=o>*</span><span class=n>seek</span><span class=p>;</span>		<span class=cm>/* Seek/tell file position.  */</span>
</span></span><span class=line><span class=cl>  <span class=kt>cookie_close_function_t</span> <span class=o>*</span><span class=n>close</span><span class=p>;</span>	<span class=cm>/* Close file.  */</span>
</span></span><span class=line><span class=cl><span class=p>}</span> <span class=kt>cookie_io_functions_t</span><span class=p>;</span></span></span></code></pre></div></div><h3 id=fopen>fopen</h3><h4 id=fopen-1>fopen</h4><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-c"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=复制到剪贴板><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp># define fopen(fname, mode) _IO_new_fopen (fname, mode)</span></span></span></code></pre></div></div><h4 id=_io_new_fopen>_IO_new_fopen</h4><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-c"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=复制到剪贴板><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=n>FILE</span> <span class=o>*</span><span class=nf>_IO_new_fopen</span> <span class=p>(</span><span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=n>filename</span><span class=p>,</span> <span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=n>mode</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nf>__fopen_internal</span> <span class=p>(</span><span class=n>filename</span><span class=p>,</span> <span class=n>mode</span><span class=p>,</span> <span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div><h4 id=__fopen_internal>__fopen_internal</h4><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-c"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=复制到剪贴板><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=n>FILE</span> <span class=o>*</span><span class=nf>__fopen_internal</span> <span class=p>(</span><span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=n>filename</span><span class=p>,</span> <span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=n>mode</span><span class=p>,</span> <span class=kt>int</span> <span class=n>is32</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>struct</span> <span class=n>locked_FILE</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>struct</span> <span class=n>_IO_FILE_plus</span> <span class=n>fp</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 若定义了 _IO_MTSAFE_IO 宏，结构体将包含 lock 成员，
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// 实现条件性编译，针对是否支持多线程安全生成不同的结构体布局
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=cp>#ifdef _IO_MTSAFE_IO
</span></span></span><span class=line><span class=cl><span class=cp></span>    <span class=n>_IO_lock_t</span> <span class=n>lock</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=cp>#endif
</span></span></span><span class=line><span class=cl><span class=cp></span>    <span class=k>struct</span> <span class=n>_IO_wide_data</span> <span class=n>wd</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=o>*</span><span class=n>new_f</span> <span class=o>=</span> <span class=p>(</span><span class=k>struct</span> <span class=n>locked_FILE</span> <span class=o>*</span><span class=p>)</span> <span class=nf>malloc</span> <span class=p>(</span><span class=k>sizeof</span> <span class=p>(</span><span class=k>struct</span> <span class=n>locked_FILE</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=c1>// malloc创建locked_FILE结构体
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>new_f</span> <span class=o>==</span> <span class=nb>NULL</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nb>NULL</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=cp>#ifdef _IO_MTSAFE_IO
</span></span></span><span class=line><span class=cl><span class=cp></span>  <span class=c1>// 初始化多线程锁
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>new_f</span><span class=o>-&gt;</span><span class=n>fp</span><span class=p>.</span><span class=n>file</span><span class=p>.</span><span class=n>_lock</span> <span class=o>=</span> <span class=o>&amp;</span><span class=n>new_f</span><span class=o>-&gt;</span><span class=n>lock</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=cp>#endif
</span></span></span><span class=line><span class=cl><span class=cp></span>  <span class=c1>// NULL初始化
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nf>_IO_no_init</span> <span class=p>(</span><span class=o>&amp;</span><span class=n>new_f</span><span class=o>-&gt;</span><span class=n>fp</span><span class=p>.</span><span class=n>file</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>new_f</span><span class=o>-&gt;</span><span class=n>wd</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>_IO_wfile_jumps</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 设置vtable
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nf>_IO_JUMPS</span> <span class=p>(</span><span class=o>&amp;</span><span class=n>new_f</span><span class=o>-&gt;</span><span class=n>fp</span><span class=p>)</span> <span class=o>=</span> <span class=o>&amp;</span><span class=n>_IO_file_jumps</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 将结构体插入链表中
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nf>_IO_new_file_init_internal</span> <span class=p>(</span><span class=o>&amp;</span><span class=n>new_f</span><span class=o>-&gt;</span><span class=n>fp</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 执行系统调用打开文件
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=p>(</span><span class=nf>_IO_file_fopen</span> <span class=p>((</span><span class=n>FILE</span> <span class=o>*</span><span class=p>)</span> <span class=n>new_f</span><span class=p>,</span> <span class=n>filename</span><span class=p>,</span> <span class=n>mode</span><span class=p>,</span> <span class=n>is32</span><span class=p>)</span> <span class=o>!=</span> <span class=nb>NULL</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nf>__fopen_maybe_mmap</span> <span class=p>(</span><span class=o>&amp;</span><span class=n>new_f</span><span class=o>-&gt;</span><span class=n>fp</span><span class=p>.</span><span class=n>file</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nf>_IO_un_link</span> <span class=p>(</span><span class=o>&amp;</span><span class=n>new_f</span><span class=o>-&gt;</span><span class=n>fp</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=nf>free</span> <span class=p>(</span><span class=n>new_f</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nb>NULL</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div><h4 id=_io_no_init>_IO_no_init</h4><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-c"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=复制到剪贴板><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=c1>// 初始化操作
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>void</span> <span class=nf>_IO_no_init</span> <span class=p>(</span><span class=n>FILE</span> <span class=o>*</span><span class=n>fp</span><span class=p>,</span> <span class=kt>int</span> <span class=n>flags</span><span class=p>,</span> <span class=kt>int</span> <span class=n>orientation</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	     <span class=k>struct</span> <span class=n>_IO_wide_data</span> <span class=o>*</span><span class=n>wd</span><span class=p>,</span> <span class=k>const</span> <span class=k>struct</span> <span class=n>_IO_jump_t</span> <span class=o>*</span><span class=n>jmp</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nf>_IO_old_init</span> <span class=p>(</span><span class=n>fp</span><span class=p>,</span> <span class=n>flags</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=n>fp</span><span class=o>-&gt;</span><span class=n>_mode</span> <span class=o>=</span> <span class=n>orientation</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>orientation</span> <span class=o>&gt;=</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>fp</span><span class=o>-&gt;</span><span class=n>_wide_data</span> <span class=o>=</span> <span class=n>wd</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=n>fp</span><span class=o>-&gt;</span><span class=n>_wide_data</span><span class=o>-&gt;</span><span class=n>_IO_buf_base</span> <span class=o>=</span> <span class=nb>NULL</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=n>fp</span><span class=o>-&gt;</span><span class=n>_wide_data</span><span class=o>-&gt;</span><span class=n>_IO_buf_end</span> <span class=o>=</span> <span class=nb>NULL</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=n>fp</span><span class=o>-&gt;</span><span class=n>_wide_data</span><span class=o>-&gt;</span><span class=n>_IO_read_base</span> <span class=o>=</span> <span class=nb>NULL</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=n>fp</span><span class=o>-&gt;</span><span class=n>_wide_data</span><span class=o>-&gt;</span><span class=n>_IO_read_ptr</span> <span class=o>=</span> <span class=nb>NULL</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=n>fp</span><span class=o>-&gt;</span><span class=n>_wide_data</span><span class=o>-&gt;</span><span class=n>_IO_read_end</span> <span class=o>=</span> <span class=nb>NULL</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=n>fp</span><span class=o>-&gt;</span><span class=n>_wide_data</span><span class=o>-&gt;</span><span class=n>_IO_write_base</span> <span class=o>=</span> <span class=nb>NULL</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=n>fp</span><span class=o>-&gt;</span><span class=n>_wide_data</span><span class=o>-&gt;</span><span class=n>_IO_write_ptr</span> <span class=o>=</span> <span class=nb>NULL</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=n>fp</span><span class=o>-&gt;</span><span class=n>_wide_data</span><span class=o>-&gt;</span><span class=n>_IO_write_end</span> <span class=o>=</span> <span class=nb>NULL</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=n>fp</span><span class=o>-&gt;</span><span class=n>_wide_data</span><span class=o>-&gt;</span><span class=n>_IO_save_base</span> <span class=o>=</span> <span class=nb>NULL</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=n>fp</span><span class=o>-&gt;</span><span class=n>_wide_data</span><span class=o>-&gt;</span><span class=n>_IO_backup_base</span> <span class=o>=</span> <span class=nb>NULL</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=n>fp</span><span class=o>-&gt;</span><span class=n>_wide_data</span><span class=o>-&gt;</span><span class=n>_IO_save_end</span> <span class=o>=</span> <span class=nb>NULL</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=n>fp</span><span class=o>-&gt;</span><span class=n>_wide_data</span><span class=o>-&gt;</span><span class=n>_wide_vtable</span> <span class=o>=</span> <span class=n>jmp</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>else</span>
</span></span><span class=line><span class=cl>    <span class=n>fp</span><span class=o>-&gt;</span><span class=n>_wide_data</span> <span class=o>=</span> <span class=p>(</span><span class=k>struct</span> <span class=n>_IO_wide_data</span> <span class=o>*</span><span class=p>)</span> <span class=o>-</span><span class=mi>1L</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>fp</span><span class=o>-&gt;</span><span class=n>_freeres_list</span> <span class=o>=</span> <span class=nb>NULL</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div><h4 id=_io_old_init>_IO_old_init</h4><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-c"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=复制到剪贴板><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=kt>void</span> <span class=nf>_IO_old_init</span> <span class=p>(</span><span class=n>FILE</span> <span class=o>*</span><span class=n>fp</span><span class=p>,</span> <span class=kt>int</span> <span class=n>flags</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>fp</span><span class=o>-&gt;</span><span class=n>_flags</span> <span class=o>=</span> <span class=n>_IO_MAGIC</span><span class=o>|</span><span class=n>flags</span><span class=p>;</span> <span class=c1>// #define _IO_MAGIC 0xFBAD0000 魔数
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>fp</span><span class=o>-&gt;</span><span class=n>_flags2</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>stdio_needs_locking</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>fp</span><span class=o>-&gt;</span><span class=n>_flags2</span> <span class=o>|=</span> <span class=n>_IO_FLAGS2_NEED_LOCK</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>fp</span><span class=o>-&gt;</span><span class=n>_IO_buf_base</span> <span class=o>=</span> <span class=nb>NULL</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>fp</span><span class=o>-&gt;</span><span class=n>_IO_buf_end</span> <span class=o>=</span> <span class=nb>NULL</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>fp</span><span class=o>-&gt;</span><span class=n>_IO_read_base</span> <span class=o>=</span> <span class=nb>NULL</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>fp</span><span class=o>-&gt;</span><span class=n>_IO_read_ptr</span> <span class=o>=</span> <span class=nb>NULL</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>fp</span><span class=o>-&gt;</span><span class=n>_IO_read_end</span> <span class=o>=</span> <span class=nb>NULL</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>fp</span><span class=o>-&gt;</span><span class=n>_IO_write_base</span> <span class=o>=</span> <span class=nb>NULL</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>fp</span><span class=o>-&gt;</span><span class=n>_IO_write_ptr</span> <span class=o>=</span> <span class=nb>NULL</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>fp</span><span class=o>-&gt;</span><span class=n>_IO_write_end</span> <span class=o>=</span> <span class=nb>NULL</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>fp</span><span class=o>-&gt;</span><span class=n>_chain</span> <span class=o>=</span> <span class=nb>NULL</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>fp</span><span class=o>-&gt;</span><span class=n>_IO_save_base</span> <span class=o>=</span> <span class=nb>NULL</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>fp</span><span class=o>-&gt;</span><span class=n>_IO_backup_base</span> <span class=o>=</span> <span class=nb>NULL</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>fp</span><span class=o>-&gt;</span><span class=n>_IO_save_end</span> <span class=o>=</span> <span class=nb>NULL</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>fp</span><span class=o>-&gt;</span><span class=n>_markers</span> <span class=o>=</span> <span class=nb>NULL</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>fp</span><span class=o>-&gt;</span><span class=n>_cur_column</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=cp>#if _IO_JUMPS_OFFSET
</span></span></span><span class=line><span class=cl><span class=cp></span>  <span class=n>fp</span><span class=o>-&gt;</span><span class=n>_vtable_offset</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=cp>#endif
</span></span></span><span class=line><span class=cl><span class=cp>#ifdef _IO_MTSAFE_IO
</span></span></span><span class=line><span class=cl><span class=cp></span>  <span class=k>if</span> <span class=p>(</span><span class=n>fp</span><span class=o>-&gt;</span><span class=n>_lock</span> <span class=o>!=</span> <span class=nb>NULL</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nf>_IO_lock_init</span> <span class=p>(</span><span class=o>*</span><span class=n>fp</span><span class=o>-&gt;</span><span class=n>_lock</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=cp>#endif
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=p>}</span></span></span></code></pre></div></div><h4 id=_io_new_file_init_internal>_IO_new_file_init_internal</h4><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-c"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=复制到剪贴板><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=kt>void</span> <span class=nf>_IO_new_file_init_internal</span> <span class=p>(</span><span class=k>struct</span> <span class=n>_IO_FILE_plus</span> <span class=o>*</span><span class=n>fp</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 设置一些标志
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>fp</span><span class=o>-&gt;</span><span class=n>file</span><span class=p>.</span><span class=n>_offset</span> <span class=o>=</span> <span class=n>_IO_pos_BAD</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>fp</span><span class=o>-&gt;</span><span class=n>file</span><span class=p>.</span><span class=n>_flags</span> <span class=o>|=</span> <span class=n>CLOSED_FILEBUF_FLAGS</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nf>_IO_link_in</span> <span class=p>(</span><span class=n>fp</span><span class=p>);</span> <span class=c1>// 头插法加到链表中
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>fp</span><span class=o>-&gt;</span><span class=n>file</span><span class=p>.</span><span class=n>_fileno</span> <span class=o>=</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div><h4 id=_io_new_file_fopen>_IO_new_file_fopen</h4><div class="code-block code-line-numbers" style="counter-reset:code-block 0"><div class="code-header language-c"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=复制到剪贴板><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=n>FILE</span> <span class=o>*</span><span class=nf>_IO_new_file_fopen</span> <span class=p>(</span><span class=n>FILE</span> <span class=o>*</span><span class=n>fp</span><span class=p>,</span> <span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=n>filename</span><span class=p>,</span> <span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=n>mode</span><span class=p>,</span> <span class=kt>int</span> <span class=n>is32not64</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kt>int</span> <span class=n>oflags</span> <span class=o>=</span> <span class=mi>0</span><span class=p>,</span> <span class=n>omode</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>int</span> <span class=n>read_write</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>int</span> <span class=n>oprot</span> <span class=o>=</span> <span class=mo>0666</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>int</span> <span class=n>i</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>FILE</span> <span class=o>*</span><span class=n>result</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=n>cs</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=n>last_recognized</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nf>_IO_file_is_open</span> <span class=p>(</span><span class=n>fp</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>switch</span> <span class=p>(</span><span class=o>*</span><span class=n>mode</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>case</span> <span class=sc>&#39;r&#39;</span><span class=o>:</span>
</span></span><span class=line><span class=cl>      <span class=n>omode</span> <span class=o>=</span> <span class=n>O_RDONLY</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=n>read_write</span> <span class=o>=</span> <span class=n>_IO_NO_WRITES</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>case</span> <span class=sc>&#39;w&#39;</span><span class=o>:</span>
</span></span><span class=line><span class=cl>      <span class=n>omode</span> <span class=o>=</span> <span class=n>O_WRONLY</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=n>oflags</span> <span class=o>=</span> <span class=n>O_CREAT</span><span class=o>|</span><span class=n>O_TRUNC</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=n>read_write</span> <span class=o>=</span> <span class=n>_IO_NO_READS</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>case</span> <span class=sc>&#39;a&#39;</span><span class=o>:</span>
</span></span><span class=line><span class=cl>      <span class=n>omode</span> <span class=o>=</span> <span class=n>O_WRONLY</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=n>oflags</span> <span class=o>=</span> <span class=n>O_CREAT</span><span class=o>|</span><span class=n>O_APPEND</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=n>read_write</span> <span class=o>=</span> <span class=n>_IO_NO_READS</span><span class=o>|</span><span class=n>_IO_IS_APPENDING</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>default</span><span class=o>:</span>
</span></span><span class=line><span class=cl>      <span class=nf>__set_errno</span> <span class=p>(</span><span class=n>EINVAL</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=nb>NULL</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=n>last_recognized</span> <span class=o>=</span> <span class=n>mode</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>for</span> <span class=p>(</span><span class=n>i</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=mi>7</span><span class=p>;</span> <span class=o>++</span><span class=n>i</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>switch</span> <span class=p>(</span><span class=o>*++</span><span class=n>mode</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>case</span> <span class=sc>&#39;\0&#39;</span><span class=o>:</span>
</span></span><span class=line><span class=cl>	  <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>case</span> <span class=sc>&#39;+&#39;</span><span class=o>:</span>
</span></span><span class=line><span class=cl>	  <span class=n>omode</span> <span class=o>=</span> <span class=n>O_RDWR</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	  <span class=n>read_write</span> <span class=o>&amp;=</span> <span class=n>_IO_IS_APPENDING</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	  <span class=n>last_recognized</span> <span class=o>=</span> <span class=n>mode</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	  <span class=k>continue</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>case</span> <span class=sc>&#39;x&#39;</span><span class=o>:</span>
</span></span><span class=line><span class=cl>	  <span class=n>oflags</span> <span class=o>|=</span> <span class=n>O_EXCL</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	  <span class=n>last_recognized</span> <span class=o>=</span> <span class=n>mode</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	  <span class=k>continue</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>case</span> <span class=sc>&#39;b&#39;</span><span class=o>:</span>
</span></span><span class=line><span class=cl>	  <span class=n>last_recognized</span> <span class=o>=</span> <span class=n>mode</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	  <span class=k>continue</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>case</span> <span class=sc>&#39;m&#39;</span><span class=o>:</span>
</span></span><span class=line><span class=cl>	  <span class=n>fp</span><span class=o>-&gt;</span><span class=n>_flags2</span> <span class=o>|=</span> <span class=n>_IO_FLAGS2_MMAP</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	  <span class=k>continue</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>case</span> <span class=sc>&#39;c&#39;</span><span class=o>:</span>
</span></span><span class=line><span class=cl>	  <span class=n>fp</span><span class=o>-&gt;</span><span class=n>_flags2</span> <span class=o>|=</span> <span class=n>_IO_FLAGS2_NOTCANCEL</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	  <span class=k>continue</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>case</span> <span class=sc>&#39;e&#39;</span><span class=o>:</span>
</span></span><span class=line><span class=cl>	  <span class=n>oflags</span> <span class=o>|=</span> <span class=n>O_CLOEXEC</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	  <span class=n>fp</span><span class=o>-&gt;</span><span class=n>_flags2</span> <span class=o>|=</span> <span class=n>_IO_FLAGS2_CLOEXEC</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	  <span class=k>continue</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>default</span><span class=o>:</span>
</span></span><span class=line><span class=cl>	  <span class=k>continue</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>result</span> <span class=o>=</span> <span class=nf>_IO_file_open</span> <span class=p>(</span><span class=n>fp</span><span class=p>,</span> <span class=n>filename</span><span class=p>,</span> <span class=n>omode</span><span class=o>|</span><span class=n>oflags</span><span class=p>,</span> <span class=n>oprot</span><span class=p>,</span> <span class=n>read_write</span><span class=p>,</span> <span class=n>is32not64</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>result</span> <span class=o>!=</span> <span class=nb>NULL</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>cs</span> <span class=o>=</span> <span class=nf>strstr</span> <span class=p>(</span><span class=n>last_recognized</span> <span class=o>+</span> <span class=mi>1</span><span class=p>,</span> <span class=s>&#34;,ccs=&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=n>cs</span> <span class=o>!=</span> <span class=nb>NULL</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>{</span>
</span></span><span class=line><span class=cl>	  <span class=k>struct</span> <span class=n>gconv_fcts</span> <span class=n>fcts</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	  <span class=k>struct</span> <span class=n>_IO_codecvt</span> <span class=o>*</span><span class=n>cc</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	  <span class=kt>char</span> <span class=o>*</span><span class=n>endp</span> <span class=o>=</span> <span class=nf>__strchrnul</span> <span class=p>(</span><span class=n>cs</span> <span class=o>+</span> <span class=mi>5</span><span class=p>,</span> <span class=sc>&#39;,&#39;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	  <span class=kt>char</span> <span class=o>*</span><span class=n>ccs</span> <span class=o>=</span> <span class=nf>malloc</span> <span class=p>(</span><span class=n>endp</span> <span class=o>-</span> <span class=p>(</span><span class=n>cs</span> <span class=o>+</span> <span class=mi>5</span><span class=p>)</span> <span class=o>+</span> <span class=mi>3</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	  <span class=k>if</span> <span class=p>(</span><span class=n>ccs</span> <span class=o>==</span> <span class=nb>NULL</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	    <span class=p>{</span>
</span></span><span class=line><span class=cl>	      <span class=kt>int</span> <span class=n>malloc_err</span> <span class=o>=</span> <span class=n>errno</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	      <span class=p>(</span><span class=kt>void</span><span class=p>)</span> <span class=nf>_IO_file_close_it</span> <span class=p>(</span><span class=n>fp</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	      <span class=nf>__set_errno</span> <span class=p>(</span><span class=n>malloc_err</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	      <span class=k>return</span> <span class=nb>NULL</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	  <span class=o>*</span><span class=p>((</span><span class=kt>char</span> <span class=o>*</span><span class=p>)</span> <span class=nf>__mempcpy</span> <span class=p>(</span><span class=n>ccs</span><span class=p>,</span> <span class=n>cs</span> <span class=o>+</span> <span class=mi>5</span><span class=p>,</span> <span class=n>endp</span> <span class=o>-</span> <span class=p>(</span><span class=n>cs</span> <span class=o>+</span> <span class=mi>5</span><span class=p>)))</span> <span class=o>=</span> <span class=sc>&#39;\0&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	  <span class=nf>strip</span> <span class=p>(</span><span class=n>ccs</span><span class=p>,</span> <span class=n>ccs</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	  <span class=k>if</span> <span class=p>(</span><span class=nf>__wcsmbs_named_conv</span> <span class=p>(</span><span class=o>&amp;</span><span class=n>fcts</span><span class=p>,</span> <span class=n>ccs</span><span class=p>[</span><span class=mi>2</span><span class=p>]</span> <span class=o>==</span> <span class=sc>&#39;\0&#39;</span> <span class=o>?</span> <span class=nf>upstr</span> <span class=p>(</span><span class=n>ccs</span><span class=p>,</span> <span class=n>cs</span> <span class=o>+</span> <span class=mi>5</span><span class=p>)</span> <span class=o>:</span> <span class=n>ccs</span><span class=p>)</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	    <span class=p>{</span>
</span></span><span class=line><span class=cl>	      <span class=p>(</span><span class=kt>void</span><span class=p>)</span> <span class=nf>_IO_file_close_it</span> <span class=p>(</span><span class=n>fp</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	      <span class=nf>free</span> <span class=p>(</span><span class=n>ccs</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	      <span class=nf>__set_errno</span> <span class=p>(</span><span class=n>EINVAL</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	      <span class=k>return</span> <span class=nb>NULL</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	  <span class=nf>free</span> <span class=p>(</span><span class=n>ccs</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	  <span class=nf>assert</span> <span class=p>(</span><span class=n>fcts</span><span class=p>.</span><span class=n>towc_nsteps</span> <span class=o>==</span> <span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	  <span class=nf>assert</span> <span class=p>(</span><span class=n>fcts</span><span class=p>.</span><span class=n>tomb_nsteps</span> <span class=o>==</span> <span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	  <span class=n>fp</span><span class=o>-&gt;</span><span class=n>_wide_data</span><span class=o>-&gt;</span><span class=n>_IO_read_ptr</span> <span class=o>=</span> <span class=n>fp</span><span class=o>-&gt;</span><span class=n>_wide_data</span><span class=o>-&gt;</span><span class=n>_IO_read_end</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	  <span class=n>fp</span><span class=o>-&gt;</span><span class=n>_wide_data</span><span class=o>-&gt;</span><span class=n>_IO_write_ptr</span> <span class=o>=</span> <span class=n>fp</span><span class=o>-&gt;</span><span class=n>_wide_data</span><span class=o>-&gt;</span><span class=n>_IO_write_base</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	  <span class=nf>memset</span> <span class=p>(</span><span class=o>&amp;</span><span class=n>fp</span><span class=o>-&gt;</span><span class=n>_wide_data</span><span class=o>-&gt;</span><span class=n>_IO_state</span><span class=p>,</span> <span class=sc>&#39;\0&#39;</span><span class=p>,</span> <span class=k>sizeof</span> <span class=p>(</span><span class=n>__mbstate_t</span><span class=p>));</span>
</span></span><span class=line><span class=cl>	  <span class=nf>memset</span> <span class=p>(</span><span class=o>&amp;</span><span class=n>fp</span><span class=o>-&gt;</span><span class=n>_wide_data</span><span class=o>-&gt;</span><span class=n>_IO_last_state</span><span class=p>,</span> <span class=sc>&#39;\0&#39;</span><span class=p>,</span> <span class=k>sizeof</span> <span class=p>(</span><span class=n>__mbstate_t</span><span class=p>));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	  <span class=n>cc</span> <span class=o>=</span> <span class=n>fp</span><span class=o>-&gt;</span><span class=n>_codecvt</span> <span class=o>=</span> <span class=o>&amp;</span><span class=n>fp</span><span class=o>-&gt;</span><span class=n>_wide_data</span><span class=o>-&gt;</span><span class=n>_codecvt</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	  <span class=n>cc</span><span class=o>-&gt;</span><span class=n>__cd_in</span><span class=p>.</span><span class=n>step</span> <span class=o>=</span> <span class=n>fcts</span><span class=p>.</span><span class=n>towc</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	  <span class=n>cc</span><span class=o>-&gt;</span><span class=n>__cd_in</span><span class=p>.</span><span class=n>step_data</span><span class=p>.</span><span class=n>__invocation_counter</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	  <span class=n>cc</span><span class=o>-&gt;</span><span class=n>__cd_in</span><span class=p>.</span><span class=n>step_data</span><span class=p>.</span><span class=n>__internal_use</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	  <span class=n>cc</span><span class=o>-&gt;</span><span class=n>__cd_in</span><span class=p>.</span><span class=n>step_data</span><span class=p>.</span><span class=n>__flags</span> <span class=o>=</span> <span class=n>__GCONV_IS_LAST</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	  <span class=n>cc</span><span class=o>-&gt;</span><span class=n>__cd_in</span><span class=p>.</span><span class=n>step_data</span><span class=p>.</span><span class=n>__statep</span> <span class=o>=</span> <span class=o>&amp;</span><span class=n>result</span><span class=o>-&gt;</span><span class=n>_wide_data</span><span class=o>-&gt;</span><span class=n>_IO_state</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	  <span class=n>cc</span><span class=o>-&gt;</span><span class=n>__cd_out</span><span class=p>.</span><span class=n>step</span> <span class=o>=</span> <span class=n>fcts</span><span class=p>.</span><span class=n>tomb</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	  <span class=n>cc</span><span class=o>-&gt;</span><span class=n>__cd_out</span><span class=p>.</span><span class=n>step_data</span><span class=p>.</span><span class=n>__invocation_counter</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	  <span class=n>cc</span><span class=o>-&gt;</span><span class=n>__cd_out</span><span class=p>.</span><span class=n>step_data</span><span class=p>.</span><span class=n>__internal_use</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	  <span class=n>cc</span><span class=o>-&gt;</span><span class=n>__cd_out</span><span class=p>.</span><span class=n>step_data</span><span class=p>.</span><span class=n>__flags</span> <span class=o>=</span> <span class=n>__GCONV_IS_LAST</span> <span class=o>|</span> <span class=n>__GCONV_TRANSLIT</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	  <span class=n>cc</span><span class=o>-&gt;</span><span class=n>__cd_out</span><span class=p>.</span><span class=n>step_data</span><span class=p>.</span><span class=n>__statep</span> <span class=o>=</span> <span class=o>&amp;</span><span class=n>result</span><span class=o>-&gt;</span><span class=n>_wide_data</span><span class=o>-&gt;</span><span class=n>_IO_state</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	  <span class=nf>_IO_JUMPS_FILE_plus</span> <span class=p>(</span><span class=n>fp</span><span class=p>)</span> <span class=o>=</span> <span class=n>fp</span><span class=o>-&gt;</span><span class=n>_wide_data</span><span class=o>-&gt;</span><span class=n>_wide_vtable</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	  <span class=n>result</span><span class=o>-&gt;</span><span class=n>_mode</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>result</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=nf>libc_hidden_ver</span> <span class=p>(</span><span class=n>_IO_new_file_fopen</span><span class=p>,</span> <span class=n>_IO_file_fopen</span><span class=p>)</span></span></span></code></pre></div></div><h4 id=_io_file_open>_IO_file_open</h4><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-c"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=复制到剪贴板><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=n>FILE</span> <span class=o>*</span><span class=nf>_IO_file_open</span> <span class=p>(</span><span class=n>FILE</span> <span class=o>*</span><span class=n>fp</span><span class=p>,</span> <span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=n>filename</span><span class=p>,</span> <span class=kt>int</span> <span class=n>posix_mode</span><span class=p>,</span> <span class=kt>int</span> <span class=n>prot</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	       <span class=kt>int</span> <span class=n>read_write</span><span class=p>,</span> <span class=kt>int</span> <span class=n>is32not64</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kt>int</span> <span class=n>fdesc</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nf>__glibc_unlikely</span> <span class=p>(</span><span class=n>fp</span><span class=o>-&gt;</span><span class=n>_flags2</span> <span class=o>&amp;</span> <span class=n>_IO_FLAGS2_NOTCANCEL</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>fdesc</span> <span class=o>=</span> <span class=nf>__open_nocancel</span> <span class=p>(</span><span class=n>filename</span><span class=p>,</span> <span class=n>posix_mode</span> <span class=o>|</span> <span class=p>(</span><span class=n>is32not64</span> <span class=o>?</span> <span class=mi>0</span> <span class=o>:</span> <span class=n>O_LARGEFILE</span><span class=p>),</span> <span class=n>prot</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>else</span>
</span></span><span class=line><span class=cl>    <span class=n>fdesc</span> <span class=o>=</span> <span class=nf>__open</span> <span class=p>(</span><span class=n>filename</span><span class=p>,</span> <span class=n>posix_mode</span> <span class=o>|</span> <span class=p>(</span><span class=n>is32not64</span> <span class=o>?</span> <span class=mi>0</span> <span class=o>:</span> <span class=n>O_LARGEFILE</span><span class=p>),</span> <span class=n>prot</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>fdesc</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nb>NULL</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>fp</span><span class=o>-&gt;</span><span class=n>_fileno</span> <span class=o>=</span> <span class=n>fdesc</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nf>_IO_mask_flags</span> <span class=p>(</span><span class=n>fp</span><span class=p>,</span> <span class=n>read_write</span><span class=p>,</span><span class=n>_IO_NO_READS</span><span class=o>+</span><span class=n>_IO_NO_WRITES</span><span class=o>+</span><span class=n>_IO_IS_APPENDING</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>((</span><span class=n>read_write</span> <span class=o>&amp;</span> <span class=p>(</span><span class=n>_IO_IS_APPENDING</span> <span class=o>|</span> <span class=n>_IO_NO_READS</span><span class=p>))</span> <span class=o>==</span> <span class=p>(</span><span class=n>_IO_IS_APPENDING</span> <span class=o>|</span> <span class=n>_IO_NO_READS</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=kt>off64_t</span> <span class=n>new_pos</span> <span class=o>=</span> <span class=nf>_IO_SYSSEEK</span> <span class=p>(</span><span class=n>fp</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=n>_IO_seek_end</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=n>new_pos</span> <span class=o>==</span> <span class=n>_IO_pos_BAD</span> <span class=o>&amp;&amp;</span> <span class=n>errno</span> <span class=o>!=</span> <span class=n>ESPIPE</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=nf>__close_nocancel</span> <span class=p>(</span><span class=n>fdesc</span><span class=p>);</span>
</span></span><span class=line><span class=cl>          <span class=k>return</span> <span class=nb>NULL</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=nf>_IO_link_in</span> <span class=p>((</span><span class=k>struct</span> <span class=n>_IO_FILE_plus</span> <span class=o>*</span><span class=p>)</span> <span class=n>fp</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>fp</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=nf>libc_hidden_def</span> <span class=p>(</span><span class=n>_IO_file_open</span><span class=p>)</span></span></span></code></pre></div></div><h3 id=fread>fread</h3><img src=/img/source_analyze.zh-cn.assets/image-20241206210233580.png alt=图片无法加载><h4 id=fread-1>fread</h4><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-c"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=复制到剪贴板><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#define fread(p, m, n, s) _IO_fread (p, m, n, s)</span></span></span></code></pre></div></div><h4 id=_io_fread>_IO_fread</h4><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-c"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=复制到剪贴板><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=kt>size_t</span> <span class=nf>_IO_fread</span> <span class=p>(</span><span class=kt>void</span> <span class=o>*</span><span class=n>buf</span><span class=p>,</span> <span class=kt>size_t</span> <span class=n>size</span><span class=p>,</span> <span class=kt>size_t</span> <span class=n>count</span><span class=p>,</span> <span class=n>FILE</span> <span class=o>*</span><span class=n>fp</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kt>size_t</span> <span class=n>bytes_requested</span> <span class=o>=</span> <span class=n>size</span> <span class=o>*</span> <span class=n>count</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>size_t</span> <span class=n>bytes_read</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nf>CHECK_FILE</span> <span class=p>(</span><span class=n>fp</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>bytes_requested</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nf>_IO_acquire_lock</span> <span class=p>(</span><span class=n>fp</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=n>bytes_read</span> <span class=o>=</span> <span class=nf>_IO_sgetn</span> <span class=p>(</span><span class=n>fp</span><span class=p>,</span> <span class=p>(</span><span class=kt>char</span> <span class=o>*</span><span class=p>)</span> <span class=n>buf</span><span class=p>,</span> <span class=n>bytes_requested</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=nf>_IO_release_lock</span> <span class=p>(</span><span class=n>fp</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>bytes_requested</span> <span class=o>==</span> <span class=n>bytes_read</span> <span class=o>?</span> <span class=nl>count</span> <span class=p>:</span> <span class=n>bytes_read</span> <span class=o>/</span> <span class=n>size</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=nf>libc_hidden_def</span> <span class=p>(</span><span class=n>_IO_fread</span><span class=p>)</span></span></span></code></pre></div></div><h4 id=_io_sgetn>_IO_sgetn</h4><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-c"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=复制到剪贴板><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#define _IO_XSGETN(FP, DATA, N) JUMP2 (__xsgetn, FP, DATA, N)
</span></span></span><span class=line><span class=cl><span class=cp>#define JUMP2(FUNC, THIS, X1, X2) (_IO_JUMPS_FUNC(THIS)-&gt;FUNC) (THIS, X1, X2)
</span></span></span><span class=line><span class=cl><span class=cp># define _IO_JUMPS_FUNC(THIS) (IO_validate_vtable (_IO_JUMPS_FILE_plus (THIS)))
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=kt>size_t</span> <span class=nf>_IO_sgetn</span> <span class=p>(</span><span class=n>FILE</span> <span class=o>*</span><span class=n>fp</span><span class=p>,</span> <span class=kt>void</span> <span class=o>*</span><span class=n>data</span><span class=p>,</span> <span class=kt>size_t</span> <span class=n>n</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span> <span class=c1>// 会通过vtable调用不同结构体的函数 _IO_file_xsgetn
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>return</span> <span class=nf>_IO_XSGETN</span> <span class=p>(</span><span class=n>fp</span><span class=p>,</span> <span class=n>data</span><span class=p>,</span> <span class=n>n</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=nf>libc_hidden_def</span> <span class=p>(</span><span class=n>_IO_sgetn</span><span class=p>)</span></span></span></code></pre></div></div><h4 id=_io_file_xsgetn>_IO_file_xsgetn</h4><div class="code-block code-line-numbers" style="counter-reset:code-block 0"><div class="code-header language-c"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=复制到剪贴板><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=c1>// 通过文件流fp从文件系统读取最多n字节数据到用户缓冲区data中
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>size_t</span> <span class=nf>_IO_file_xsgetn</span><span class=p>(</span><span class=n>FILE</span> <span class=o>*</span><span class=n>fp</span><span class=p>,</span> <span class=kt>void</span> <span class=o>*</span><span class=n>data</span><span class=p>,</span> <span class=kt>size_t</span> <span class=n>n</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kt>size_t</span> <span class=n>want</span><span class=p>,</span> <span class=n>have</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>ssize_t</span> <span class=n>count</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>char</span> <span class=o>*</span><span class=n>s</span> <span class=o>=</span> <span class=n>data</span><span class=p>;</span> <span class=c1>// 指向用户缓冲区data
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>want</span> <span class=o>=</span> <span class=n>n</span><span class=p>;</span> <span class=c1>// 剩余需要读取的字节数，初始为n
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>fp</span><span class=o>-&gt;</span><span class=n>_IO_buf_base</span> <span class=o>==</span> <span class=nb>NULL</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 文件流缓冲区未初始化
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>fp</span><span class=o>-&gt;</span><span class=n>_IO_save_base</span> <span class=o>!=</span> <span class=nb>NULL</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nf>free</span><span class=p>(</span><span class=n>fp</span><span class=o>-&gt;</span><span class=n>_IO_save_base</span><span class=p>);</span> <span class=c1>// 释放备份缓冲区
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=n>fp</span><span class=o>-&gt;</span><span class=n>_flags</span> <span class=o>&amp;=</span> <span class=o>~</span><span class=n>_IO_IN_BACKUP</span><span class=p>;</span> <span class=c1>// 清除备份模式标志
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 初始化文件流缓冲区
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nf>_IO_doallocbuf</span><span class=p>(</span><span class=n>fp</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  <span class=c1>// 仍有数据需要读取
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>while</span> <span class=p>(</span><span class=n>want</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>have</span> <span class=o>=</span> <span class=n>fp</span><span class=o>-&gt;</span><span class=n>_IO_read_end</span> <span class=o>-</span> <span class=n>fp</span><span class=o>-&gt;</span><span class=n>_IO_read_ptr</span><span class=p>;</span> <span class=c1>// 文件流缓冲区剩余数据大小
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// 文件流缓冲区大小足够满足需要读取的字节数want
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=n>want</span> <span class=o>&lt;=</span> <span class=n>have</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nf>memcpy</span><span class=p>(</span><span class=n>s</span><span class=p>,</span> <span class=n>fp</span><span class=o>-&gt;</span><span class=n>_IO_read_ptr</span><span class=p>,</span> <span class=n>want</span><span class=p>);</span> <span class=c1>// 从文件流缓冲区复制到用户缓冲区
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=n>fp</span><span class=o>-&gt;</span><span class=n>_IO_read_ptr</span> <span class=o>+=</span> <span class=n>want</span><span class=p>;</span> <span class=c1>// 更新指针
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=n>want</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=c1>// 标记读取完成
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 若文件流缓冲区数据不足
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>else</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=n>have</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>)</span> <span class=c1>// 文件流缓冲区中还有部分数据可用
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 先尽可能多的从文件流缓冲区复制到用户缓冲区
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>s</span> <span class=o>=</span> <span class=nf>__mempcpy</span><span class=p>(</span><span class=n>s</span><span class=p>,</span> <span class=n>fp</span><span class=o>-&gt;</span><span class=n>_IO_read_ptr</span><span class=p>,</span> <span class=n>have</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>want</span> <span class=o>-=</span> <span class=n>have</span><span class=p>;</span> <span class=c1>// 更新剩余需求
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>fp</span><span class=o>-&gt;</span><span class=n>_IO_read_ptr</span> <span class=o>+=</span> <span class=n>have</span><span class=p>;</span> <span class=c1>// 更新文件流缓冲区读取指针
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=p>}</span>
</span></span><span class=line><span class=cl>	  <span class=c1>// 处于备份模式
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=k>if</span> <span class=p>(</span><span class=nf>_IO_in_backup</span><span class=p>(</span><span class=n>fp</span><span class=p>))</span>
</span></span><span class=line><span class=cl>      <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nf>_IO_switch_to_main_get_area</span><span class=p>(</span><span class=n>fp</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>continue</span><span class=p>;</span> <span class=c1>// 切换备份缓冲区重新尝试读取
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=c1>// 若文件流缓冲区未满 且 需要读取的数据小于文件流缓冲区总容量
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=k>if</span> <span class=p>(</span><span class=n>fp</span><span class=o>-&gt;</span><span class=n>_IO_buf_base</span> <span class=o>&amp;&amp;</span> <span class=n>want</span> <span class=o>&lt;</span> <span class=p>(</span><span class=kt>size_t</span><span class=p>)(</span><span class=n>fp</span><span class=o>-&gt;</span><span class=n>_IO_buf_end</span> <span class=o>-</span> <span class=n>fp</span><span class=o>-&gt;</span><span class=n>_IO_buf_base</span><span class=p>))</span>
</span></span><span class=line><span class=cl>      <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// underflow 调用系统函数将数据读入文件流缓冲区, 实际调用 _IO_UNDERFLOW
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// 最终调用 _IO_new_file_underflow 函数
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>if</span> <span class=p>(</span><span class=nf>__underflow</span><span class=p>(</span><span class=n>fp</span><span class=p>)</span> <span class=o>==</span> <span class=n>EOF</span><span class=p>)</span>
</span></span><span class=line><span class=cl>          <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>continue</span><span class=p>;</span> <span class=c1>// 填充完文件流缓冲区，继续尝试读取
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=c1>// 所需读取的数据大于文件流缓冲区总容量
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=c1>// 重置文件流缓冲区指针
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nf>_IO_setg</span><span class=p>(</span><span class=n>fp</span><span class=p>,</span> <span class=n>fp</span><span class=o>-&gt;</span><span class=n>_IO_buf_base</span><span class=p>,</span> <span class=n>fp</span><span class=o>-&gt;</span><span class=n>_IO_buf_base</span><span class=p>,</span> <span class=n>fp</span><span class=o>-&gt;</span><span class=n>_IO_buf_base</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=nf>_IO_setp</span><span class=p>(</span><span class=n>fp</span><span class=p>,</span> <span class=n>fp</span><span class=o>-&gt;</span><span class=n>_IO_buf_base</span><span class=p>,</span> <span class=n>fp</span><span class=o>-&gt;</span><span class=n>_IO_buf_base</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	  
</span></span><span class=line><span class=cl>      <span class=c1>// 对齐，若文件流缓冲区大小不小于128字节，则读入长度为文件流缓冲区长度整数倍
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=n>count</span> <span class=o>=</span> <span class=n>want</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=n>fp</span><span class=o>-&gt;</span><span class=n>_IO_buf_base</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kt>size_t</span> <span class=n>block_size</span> <span class=o>=</span> <span class=n>fp</span><span class=o>-&gt;</span><span class=n>_IO_buf_end</span> <span class=o>-</span> <span class=n>fp</span><span class=o>-&gt;</span><span class=n>_IO_buf_base</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>block_size</span> <span class=o>&gt;=</span> <span class=mi>128</span><span class=p>)</span>
</span></span><span class=line><span class=cl>          <span class=n>count</span> <span class=o>-=</span> <span class=n>want</span> <span class=o>%</span> <span class=n>block_size</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>	  <span class=c1>// 直接系统调用读取文件中数据到用户缓冲区中
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=n>count</span> <span class=o>=</span> <span class=nf>_IO_SYSREAD</span><span class=p>(</span><span class=n>fp</span><span class=p>,</span> <span class=n>s</span><span class=p>,</span> <span class=n>count</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=n>count</span> <span class=o>&lt;=</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>count</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>          <span class=n>fp</span><span class=o>-&gt;</span><span class=n>_flags</span> <span class=o>|=</span> <span class=n>_IO_EOF_SEEN</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span>
</span></span><span class=line><span class=cl>          <span class=n>fp</span><span class=o>-&gt;</span><span class=n>_flags</span> <span class=o>|=</span> <span class=n>_IO_ERR_SEEN</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>	  <span class=c1>// 更新
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=n>s</span> <span class=o>+=</span> <span class=n>count</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=n>want</span> <span class=o>-=</span> <span class=n>count</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=n>fp</span><span class=o>-&gt;</span><span class=n>_offset</span> <span class=o>!=</span> <span class=n>_IO_pos_BAD</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nf>_IO_pos_adjust</span><span class=p>(</span><span class=n>fp</span><span class=o>-&gt;</span><span class=n>_offset</span><span class=p>,</span> <span class=n>count</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>n</span> <span class=o>-</span> <span class=n>want</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=nf>libc_hidden_def</span><span class=p>(</span><span class=n>_IO_file_xsgetn</span><span class=p>)</span></span></span></code></pre></div></div><h4 id=_io_doallocbuf>_IO_doallocbuf</h4><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-c"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=复制到剪贴板><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=kt>void</span> <span class=nf>_IO_doallocbuf</span> <span class=p>(</span><span class=n>FILE</span> <span class=o>*</span><span class=n>fp</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>fp</span><span class=o>-&gt;</span><span class=n>_IO_buf_base</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=p>(</span><span class=n>fp</span><span class=o>-&gt;</span><span class=n>_flags</span> <span class=o>&amp;</span> <span class=n>_IO_UNBUFFERED</span><span class=p>)</span> <span class=o>||</span> <span class=n>fp</span><span class=o>-&gt;</span><span class=n>_mode</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nf>_IO_DOALLOCATE</span> <span class=p>(</span><span class=n>fp</span><span class=p>)</span> <span class=o>!=</span> <span class=n>EOF</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nf>_IO_setb</span> <span class=p>(</span><span class=n>fp</span><span class=p>,</span> <span class=n>fp</span><span class=o>-&gt;</span><span class=n>_shortbuf</span><span class=p>,</span> <span class=n>fp</span><span class=o>-&gt;</span><span class=n>_shortbuf</span><span class=o>+</span><span class=mi>1</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=nf>libc_hidden_def</span> <span class=p>(</span><span class=n>_IO_doallocbuf</span><span class=p>)</span></span></span></code></pre></div></div><h4 id=_io_new_file_underflow>_IO_new_file_underflow</h4><div class="code-block code-line-numbers" style="counter-reset:code-block 0"><div class="code-header language-c"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=复制到剪贴板><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=kt>int</span> <span class=nf>_IO_new_file_underflow</span><span class=p>(</span><span class=n>_IO_FILE</span> <span class=o>*</span><span class=n>fp</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>_IO_ssize_t</span> <span class=n>count</span><span class=p>;</span> <span class=c1>// 存储从文件中读取的字节数
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=cp>#if 0</span><span class=c>
</span></span></span><span class=line><span class=cl><span class=c>  if (fp-&gt;_flags &amp; _IO_EOF_SEEN)
</span></span></span><span class=line><span class=cl><span class=c>    return (EOF);
</span></span></span><span class=line><span class=cl><span class=c></span><span class=cp>#endif
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>fp</span><span class=o>-&gt;</span><span class=n>_flags</span> <span class=o>&amp;</span> <span class=n>_IO_NO_READS</span><span class=p>)</span> <span class=c1>// 文件末尾已经被读取, 表示不允许读取数据
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>fp</span><span class=o>-&gt;</span><span class=n>_flags</span> <span class=o>|=</span> <span class=n>_IO_ERR_SEEN</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nf>__set_errno</span><span class=p>(</span><span class=n>EBADF</span><span class=p>);</span> <span class=c1>// 文件描述符无效
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>return</span> <span class=n>EOF</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 文件流缓冲区已有数据，直接返回_IO_read_ptr指向的数据
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=p>(</span><span class=n>fp</span><span class=o>-&gt;</span><span class=n>_IO_read_ptr</span> <span class=o>&lt;</span> <span class=n>fp</span><span class=o>-&gt;</span><span class=n>_IO_read_end</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=o>*</span><span class=p>(</span><span class=kt>unsigned</span> <span class=kt>char</span> <span class=o>*</span><span class=p>)</span><span class=n>fp</span><span class=o>-&gt;</span><span class=n>_IO_read_ptr</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// 若文件流没有为读取分配缓冲区
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=p>(</span><span class=n>fp</span><span class=o>-&gt;</span><span class=n>_IO_buf_base</span> <span class=o>==</span> <span class=nb>NULL</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>fp</span><span class=o>-&gt;</span><span class=n>_IO_save_base</span> <span class=o>!=</span> <span class=nb>NULL</span><span class=p>)</span> <span class=c1>// 之前有分配过备份的缓冲区
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nf>free</span><span class=p>(</span><span class=n>fp</span><span class=o>-&gt;</span><span class=n>_IO_save_base</span><span class=p>);</span> <span class=c1>// 释放这些缓冲区
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=n>fp</span><span class=o>-&gt;</span><span class=n>_flags</span> <span class=o>&amp;=</span> <span class=o>~</span><span class=n>_IO_IN_BACKUP</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nf>_IO_doallocbuf</span><span class=p>(</span><span class=n>fp</span><span class=p>);</span> <span class=c1>// 分配新文件流缓冲区
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 是否设置 行缓冲 或 无缓冲
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=p>(</span><span class=n>fp</span><span class=o>-&gt;</span><span class=n>_flags</span> <span class=o>&amp;</span> <span class=p>(</span><span class=n>_IO_LINE_BUF</span> <span class=o>|</span> <span class=n>_IO_UNBUFFERED</span><span class=p>))</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl><span class=cp>#if 0</span><span class=c>
</span></span></span><span class=line><span class=cl><span class=c>      _IO_flush_all_linebuffered ();
</span></span></span><span class=line><span class=cl><span class=c></span><span class=cp>#else
</span></span></span><span class=line><span class=cl><span class=cp></span>    <span class=nf>_IO_acquire_lock</span><span class=p>(</span><span class=n>_IO_stdout</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>((</span><span class=n>_IO_stdout</span><span class=o>-&gt;</span><span class=n>_flags</span> <span class=o>&amp;</span> 
</span></span><span class=line><span class=cl>        <span class=p>(</span><span class=n>_IO_LINKED</span> <span class=o>|</span> <span class=n>_IO_NO_WRITES</span> <span class=o>|</span> <span class=n>_IO_LINE_BUF</span><span class=p>))</span> <span class=o>==</span> <span class=p>(</span><span class=n>_IO_LINKED</span> <span class=o>|</span> <span class=n>_IO_LINE_BUF</span><span class=p>))</span>
</span></span><span class=line><span class=cl>      <span class=nf>_IO_OVERFLOW</span><span class=p>(</span><span class=n>_IO_stdout</span><span class=p>,</span> <span class=n>EOF</span><span class=p>);</span><span class=c1>// 调用_IO_OVERFLOW函数处理标准输出的溢出情况
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=nf>_IO_release_lock</span><span class=p>(</span><span class=n>_IO_stdout</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=cp>#endif
</span></span></span><span class=line><span class=cl><span class=cp></span>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nf>_IO_switch_to_get_mode</span><span class=p>(</span><span class=n>fp</span><span class=p>);</span> <span class=c1>// 切换为读取模式
</span></span></span><span class=line><span class=cl><span class=c1></span>  
</span></span><span class=line><span class=cl>  <span class=c1>// 设置读写指针均为缓冲区基地址
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>fp</span><span class=o>-&gt;</span><span class=n>_IO_read_base</span> <span class=o>=</span> <span class=n>fp</span><span class=o>-&gt;</span><span class=n>_IO_read_ptr</span> <span class=o>=</span> <span class=n>fp</span><span class=o>-&gt;</span><span class=n>_IO_buf_base</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>fp</span><span class=o>-&gt;</span><span class=n>_IO_read_end</span> <span class=o>=</span> <span class=n>fp</span><span class=o>-&gt;</span><span class=n>_IO_buf_base</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>fp</span><span class=o>-&gt;</span><span class=n>_IO_write_base</span> <span class=o>=</span> <span class=n>fp</span><span class=o>-&gt;</span><span class=n>_IO_write_ptr</span> <span class=o>=</span> <span class=n>fp</span><span class=o>-&gt;</span><span class=n>_IO_write_end</span> <span class=o>=</span> <span class=n>fp</span><span class=o>-&gt;</span><span class=n>_IO_buf_base</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 调用系统SYSREAD调用从文件读取数据存储到缓冲区中，返回实际读取的字节数
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>count</span> <span class=o>=</span> <span class=nf>_IO_SYSREAD</span><span class=p>(</span><span class=n>fp</span><span class=p>,</span> <span class=n>fp</span><span class=o>-&gt;</span><span class=n>_IO_buf_base</span><span class=p>,</span> <span class=n>fp</span><span class=o>-&gt;</span><span class=n>_IO_buf_end</span> <span class=o>-</span> <span class=n>fp</span><span class=o>-&gt;</span><span class=n>_IO_buf_base</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>count</span> <span class=o>&lt;=</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>count</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=n>fp</span><span class=o>-&gt;</span><span class=n>_flags</span> <span class=o>|=</span> <span class=n>_IO_EOF_SEEN</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span>
</span></span><span class=line><span class=cl>      <span class=n>fp</span><span class=o>-&gt;</span><span class=n>_flags</span> <span class=o>|=</span> <span class=n>_IO_ERR_SEEN</span><span class=p>,</span> <span class=n>count</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 读取结束指针移动count字节
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>fp</span><span class=o>-&gt;</span><span class=n>_IO_read_end</span> <span class=o>+=</span> <span class=n>count</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>count</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=c1>// 未成功读取任何数据
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>fp</span><span class=o>-&gt;</span><span class=n>_offset</span> <span class=o>=</span> <span class=n>_IO_pos_BAD</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>EOF</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>fp</span><span class=o>-&gt;</span><span class=n>_offset</span> <span class=o>!=</span> <span class=n>_IO_pos_BAD</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nf>_IO_pos_adjust</span><span class=p>(</span><span class=n>fp</span><span class=o>-&gt;</span><span class=n>_offset</span><span class=p>,</span> <span class=n>count</span><span class=p>);</span> <span class=c1>// 调整文件流的偏移量
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>return</span> <span class=o>*</span><span class=p>(</span><span class=kt>unsigned</span> <span class=kt>char</span> <span class=o>*</span><span class=p>)</span><span class=n>fp</span><span class=o>-&gt;</span><span class=n>_IO_read_ptr</span><span class=p>;</span> <span class=c1>// 返回当前读取指针指向字节
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=nf>libc_hidden_ver</span><span class=p>(</span><span class=n>_IO_new_file_underflow</span><span class=p>,</span> <span class=n>_IO_file_underflow</span><span class=p>)</span></span></span></code></pre></div></div><h3 id=fwrite>fwrite</h3><img src=/img/source_analyze.zh-cn.assets/image-20241206205821979.png alt=图片无法加载><h4 id=fwrite-1>fwrite</h4><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-c"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=复制到剪贴板><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#define fwrite(buf, size, count, fp) _IO_fwrite (buf, size, count, fp)</span></span></span></code></pre></div></div><h4 id=_io_fwrite>_IO_fwrite</h4><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-c"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=复制到剪贴板><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=kt>size_t</span> <span class=nf>_IO_fwrite</span> <span class=p>(</span><span class=k>const</span> <span class=kt>void</span> <span class=o>*</span><span class=n>buf</span><span class=p>,</span> <span class=kt>size_t</span> <span class=n>size</span><span class=p>,</span> <span class=kt>size_t</span> <span class=n>count</span><span class=p>,</span> <span class=n>FILE</span> <span class=o>*</span><span class=n>fp</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kt>size_t</span> <span class=n>request</span> <span class=o>=</span> <span class=n>size</span> <span class=o>*</span> <span class=n>count</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>size_t</span> <span class=n>written</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nf>CHECK_FILE</span> <span class=p>(</span><span class=n>fp</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>request</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nf>_IO_acquire_lock</span> <span class=p>(</span><span class=n>fp</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nf>_IO_vtable_offset</span> <span class=p>(</span><span class=n>fp</span><span class=p>)</span> <span class=o>!=</span> <span class=mi>0</span> <span class=o>||</span> <span class=nf>_IO_fwide</span> <span class=p>(</span><span class=n>fp</span><span class=p>,</span> <span class=o>-</span><span class=mi>1</span><span class=p>)</span> <span class=o>==</span> <span class=o>-</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>written</span> <span class=o>=</span> <span class=nf>_IO_sputn</span> <span class=p>(</span><span class=n>fp</span><span class=p>,</span> <span class=p>(</span><span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=p>)</span> <span class=n>buf</span><span class=p>,</span> <span class=n>request</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=nf>_IO_release_lock</span> <span class=p>(</span><span class=n>fp</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>written</span> <span class=o>==</span> <span class=n>request</span> <span class=o>||</span> <span class=n>written</span> <span class=o>==</span> <span class=n>EOF</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>count</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>else</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>written</span> <span class=o>/</span> <span class=n>size</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=nf>libc_hidden_def</span> <span class=p>(</span><span class=n>_IO_fwrite</span><span class=p>)</span></span></span></code></pre></div></div><h4 id=_io_new_file_xsputn>_IO_new_file_xsputn</h4><div class="code-block code-line-numbers" style="counter-reset:code-block 0"><div class="code-header language-c"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=复制到剪贴板><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=c1>// 从用户缓冲区data写入文件流f中
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>size_t</span> <span class=nf>_IO_new_file_xsputn</span><span class=p>(</span><span class=n>FILE</span> <span class=o>*</span><span class=n>f</span><span class=p>,</span> <span class=k>const</span> <span class=kt>void</span> <span class=o>*</span><span class=n>data</span><span class=p>,</span> <span class=kt>size_t</span> <span class=n>n</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=n>s</span> <span class=o>=</span> <span class=p>(</span><span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=p>)</span><span class=n>data</span><span class=p>;</span> <span class=c1>// 用户缓冲区指针
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kt>size_t</span> <span class=n>to_do</span> <span class=o>=</span> <span class=n>n</span><span class=p>;</span> <span class=c1>// 写入数据长度
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kt>int</span> <span class=n>must_flush</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=c1>// 标志是否需要立即刷新文件流缓冲区
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kt>size_t</span> <span class=n>count</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> 
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>n</span> <span class=o>&lt;=</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 判断是否为行缓冲模式，即遇到换行符立即刷新文件流缓冲区
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=p>((</span><span class=n>f</span><span class=o>-&gt;</span><span class=n>_flags</span> <span class=o>&amp;</span> <span class=n>_IO_LINE_BUF</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=p>(</span><span class=n>f</span><span class=o>-&gt;</span><span class=n>_flags</span> <span class=o>&amp;</span> <span class=n>_IO_CURRENTLY_PUTTING</span><span class=p>))</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 文件流缓冲区剩余空间大小
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>count</span> <span class=o>=</span> <span class=n>f</span><span class=o>-&gt;</span><span class=n>_IO_buf_end</span> <span class=o>-</span> <span class=n>f</span><span class=o>-&gt;</span><span class=n>_IO_write_ptr</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>count</span> <span class=o>&gt;=</span> <span class=n>n</span><span class=p>)</span> <span class=c1>// 若文件流缓冲区能容纳所有数据data
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=n>p</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=k>for</span> <span class=p>(</span><span class=n>p</span> <span class=o>=</span> <span class=n>s</span> <span class=o>+</span> <span class=n>n</span><span class=p>;</span> <span class=n>p</span> <span class=o>&gt;</span> <span class=n>s</span><span class=p>;)</span> <span class=c1>// 从用户数据末尾向前查找换行符
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=o>*--</span><span class=n>p</span> <span class=o>==</span> <span class=sc>&#39;\n&#39;</span><span class=p>)</span> <span class=c1>// 找到换行符
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=n>count</span> <span class=o>=</span> <span class=n>p</span> <span class=o>-</span> <span class=n>s</span> <span class=o>+</span> <span class=mi>1</span><span class=p>;</span> <span class=c1>// 只写入到换行符前数据
</span></span></span><span class=line><span class=cl><span class=c1></span>          <span class=n>must_flush</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span> <span class=c1>// 立即刷新输出数据
</span></span></span><span class=line><span class=cl><span class=c1></span>          <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 非行缓冲模式，文件流缓冲区仍有可用空间，获取剩余空间count
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>f</span><span class=o>-&gt;</span><span class=n>_IO_write_end</span> <span class=o>&gt;</span> <span class=n>f</span><span class=o>-&gt;</span><span class=n>_IO_write_ptr</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>count</span> <span class=o>=</span> <span class=n>f</span><span class=o>-&gt;</span><span class=n>_IO_write_end</span> <span class=o>-</span> <span class=n>f</span><span class=o>-&gt;</span><span class=n>_IO_write_ptr</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>count</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>count</span> <span class=o>&gt;</span> <span class=n>to_do</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=n>count</span> <span class=o>=</span> <span class=n>to_do</span><span class=p>;</span> <span class=c1>// 若文件流缓冲区能容纳所有剩余数据
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// 将数据data写入到文件流缓冲区中
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>f</span><span class=o>-&gt;</span><span class=n>_IO_write_ptr</span> <span class=o>=</span> <span class=nf>__mempcpy</span><span class=p>(</span><span class=n>f</span><span class=o>-&gt;</span><span class=n>_IO_write_ptr</span><span class=p>,</span> <span class=n>s</span><span class=p>,</span> <span class=n>count</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 更新
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>s</span> <span class=o>+=</span> <span class=n>count</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>to_do</span> <span class=o>-=</span> <span class=n>count</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 若需要刷新缓冲区或仍有数据未写
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=p>(</span><span class=n>to_do</span> <span class=o>+</span> <span class=n>must_flush</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>size_t</span> <span class=n>block_size</span><span class=p>,</span> <span class=n>do_write</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=c1>// 强制输出并刷新清空文件流缓冲区
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// 实际调用了_IO_new_file_overflow
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=nf>_IO_OVERFLOW</span><span class=p>(</span><span class=n>f</span><span class=p>,</span> <span class=n>EOF</span><span class=p>)</span> <span class=o>==</span> <span class=n>EOF</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=n>to_do</span> <span class=o>==</span> <span class=mi>0</span> <span class=o>?</span> <span class=nl>EOF</span> <span class=p>:</span> <span class=n>n</span> <span class=o>-</span> <span class=n>to_do</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=c1>// 对齐
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>block_size</span> <span class=o>=</span> <span class=n>f</span><span class=o>-&gt;</span><span class=n>_IO_buf_end</span> <span class=o>-</span> <span class=n>f</span><span class=o>-&gt;</span><span class=n>_IO_buf_base</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>do_write</span> <span class=o>=</span> <span class=n>to_do</span> <span class=o>-</span> <span class=p>(</span><span class=n>block_size</span> <span class=o>&gt;=</span> <span class=mi>128</span> <span class=o>?</span> <span class=n>to_do</span> <span class=o>%</span> <span class=nl>block_size</span> <span class=p>:</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>do_write</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// 调用new_do_write直接输出数据
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=n>count</span> <span class=o>=</span> <span class=nf>new_do_write</span><span class=p>(</span><span class=n>f</span><span class=p>,</span> <span class=n>s</span><span class=p>,</span> <span class=n>do_write</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=n>to_do</span> <span class=o>-=</span> <span class=n>count</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=n>count</span> <span class=o>&lt;</span> <span class=n>do_write</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>n</span> <span class=o>-</span> <span class=n>to_do</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>to_do</span><span class=p>)</span> <span class=c1>// 将剩余数据复制到文件流缓冲区
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=n>to_do</span> <span class=o>-=</span> <span class=nf>_IO_default_xsputn</span><span class=p>(</span><span class=n>f</span><span class=p>,</span> <span class=n>s</span> <span class=o>+</span> <span class=n>do_write</span><span class=p>,</span> <span class=n>to_do</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>n</span> <span class=o>-</span> <span class=n>to_do</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=nf>libc_hidden_ver</span><span class=p>(</span><span class=n>_IO_new_file_xsputn</span><span class=p>,</span> <span class=n>_IO_file_xsputn</span><span class=p>)</span></span></span></code></pre></div></div><h4 id=_io_new_file_overflow>_IO_new_file_overflow</h4><div class="code-block code-line-numbers" style="counter-reset:code-block 0"><div class="code-header language-c"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=复制到剪贴板><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=kt>int</span> <span class=nf>_IO_new_file_overflow</span><span class=p>(</span><span class=n>_IO_FILE</span> <span class=o>*</span><span class=n>f</span><span class=p>,</span> <span class=kt>int</span> <span class=n>ch</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 检查是否允许写入
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=p>(</span><span class=n>f</span><span class=o>-&gt;</span><span class=n>_flags</span> <span class=o>&amp;</span> <span class=n>_IO_NO_WRITES</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>f</span><span class=o>-&gt;</span><span class=n>_flags</span> <span class=o>|=</span> <span class=n>_IO_ERR_SEEN</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nf>__set_errno</span><span class=p>(</span><span class=n>EBADF</span><span class=p>);</span> <span class=c1>// 操作失败，写入错误
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>return</span> <span class=n>EOF</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>((</span><span class=n>f</span><span class=o>-&gt;</span><span class=n>_flags</span> <span class=o>&amp;</span> <span class=n>_IO_CURRENTLY_PUTTING</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span> <span class=o>||</span> <span class=n>f</span><span class=o>-&gt;</span><span class=n>_IO_write_base</span> <span class=o>==</span> <span class=nb>NULL</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span> 
</span></span><span class=line><span class=cl>    <span class=c1>// 若未分配写入缓冲区
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=n>f</span><span class=o>-&gt;</span><span class=n>_IO_write_base</span> <span class=o>==</span> <span class=nb>NULL</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nf>_IO_doallocbuf</span><span class=p>(</span><span class=n>f</span><span class=p>);</span> <span class=c1>// 初始化分配缓冲区
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nf>_IO_setg</span><span class=p>(</span><span class=n>f</span><span class=p>,</span> <span class=n>f</span><span class=o>-&gt;</span><span class=n>_IO_buf_base</span><span class=p>,</span> <span class=n>f</span><span class=o>-&gt;</span><span class=n>_IO_buf_base</span><span class=p>,</span> <span class=n>f</span><span class=o>-&gt;</span><span class=n>_IO_buf_base</span><span class=p>);</span> <span class=c1>// 设置缓冲区起点
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 处理备份缓冲区
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=nf>__glibc_unlikely</span><span class=p>(</span><span class=nf>_IO_in_backup</span><span class=p>(</span><span class=n>f</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=kt>size_t</span> <span class=n>nbackup</span> <span class=o>=</span> <span class=n>f</span><span class=o>-&gt;</span><span class=n>_IO_read_end</span> <span class=o>-</span> <span class=n>f</span><span class=o>-&gt;</span><span class=n>_IO_read_ptr</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=nf>_IO_free_backup_area</span><span class=p>(</span><span class=n>f</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=n>f</span><span class=o>-&gt;</span><span class=n>_IO_read_base</span> <span class=o>-=</span> <span class=nf>MIN</span><span class=p>(</span><span class=n>nbackup</span><span class=p>,</span> <span class=n>f</span><span class=o>-&gt;</span><span class=n>_IO_read_base</span> <span class=o>-</span> <span class=n>f</span><span class=o>-&gt;</span><span class=n>_IO_buf_base</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=n>f</span><span class=o>-&gt;</span><span class=n>_IO_read_ptr</span> <span class=o>=</span> <span class=n>f</span><span class=o>-&gt;</span><span class=n>_IO_read_base</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>	
</span></span><span class=line><span class=cl>    <span class=c1>// 若读取指针到达缓冲区末尾，重置为缓冲区起始位置
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=n>f</span><span class=o>-&gt;</span><span class=n>_IO_read_ptr</span> <span class=o>==</span> <span class=n>f</span><span class=o>-&gt;</span><span class=n>_IO_buf_end</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=n>f</span><span class=o>-&gt;</span><span class=n>_IO_read_end</span> <span class=o>=</span> <span class=n>f</span><span class=o>-&gt;</span><span class=n>_IO_read_ptr</span> <span class=o>=</span> <span class=n>f</span><span class=o>-&gt;</span><span class=n>_IO_buf_base</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 写入指针和缓冲区指针统一到读取指针位置
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>f</span><span class=o>-&gt;</span><span class=n>_IO_write_ptr</span> <span class=o>=</span> <span class=n>f</span><span class=o>-&gt;</span><span class=n>_IO_read_ptr</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>f</span><span class=o>-&gt;</span><span class=n>_IO_write_base</span> <span class=o>=</span> <span class=n>f</span><span class=o>-&gt;</span><span class=n>_IO_write_ptr</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>f</span><span class=o>-&gt;</span><span class=n>_IO_write_end</span> <span class=o>=</span> <span class=n>f</span><span class=o>-&gt;</span><span class=n>_IO_buf_end</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>f</span><span class=o>-&gt;</span><span class=n>_IO_read_base</span> <span class=o>=</span> <span class=n>f</span><span class=o>-&gt;</span><span class=n>_IO_read_ptr</span> <span class=o>=</span> <span class=n>f</span><span class=o>-&gt;</span><span class=n>_IO_read_end</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 文件流进入写入模式
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>f</span><span class=o>-&gt;</span><span class=n>_flags</span> <span class=o>|=</span> <span class=n>_IO_CURRENTLY_PUTTING</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 文件流处于行缓冲或无缓冲模式
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=n>f</span><span class=o>-&gt;</span><span class=n>_mode</span> <span class=o>&lt;=</span> <span class=mi>0</span> <span class=o>&amp;&amp;</span> <span class=n>f</span><span class=o>-&gt;</span><span class=n>_flags</span> <span class=o>&amp;</span> <span class=p>(</span><span class=n>_IO_LINE_BUF</span> <span class=o>|</span> <span class=n>_IO_UNBUFFERED</span><span class=p>))</span>
</span></span><span class=line><span class=cl>      <span class=n>f</span><span class=o>-&gt;</span><span class=n>_IO_write_end</span> <span class=o>=</span> <span class=n>f</span><span class=o>-&gt;</span><span class=n>_IO_write_ptr</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>ch</span> <span class=o>==</span> <span class=n>EOF</span><span class=p>)</span> <span class=c1>// 直接将缓冲区内容写入文件，实际调用new_do_write
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>return</span> <span class=nf>_IO_do_write</span><span class=p>(</span><span class=n>f</span><span class=p>,</span> <span class=n>f</span><span class=o>-&gt;</span><span class=n>_IO_write_base</span><span class=p>,</span> <span class=n>f</span><span class=o>-&gt;</span><span class=n>_IO_write_ptr</span> <span class=o>-</span> <span class=n>f</span><span class=o>-&gt;</span><span class=n>_IO_write_base</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 写入指针已到达缓冲区末尾，表示缓冲区已满，调用_IO_do_flush刷新缓冲区
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=p>(</span><span class=n>f</span><span class=o>-&gt;</span><span class=n>_IO_write_ptr</span> <span class=o>==</span> <span class=n>f</span><span class=o>-&gt;</span><span class=n>_IO_buf_end</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nf>_IO_do_flush</span><span class=p>(</span><span class=n>f</span><span class=p>)</span> <span class=o>==</span> <span class=n>EOF</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=n>EOF</span><span class=p>;</span> <span class=c1>// 刷新失败
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// 将ch写入当前的写入指针位置，写入指针移动
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=o>*</span><span class=n>f</span><span class=o>-&gt;</span><span class=n>_IO_write_ptr</span><span class=o>++</span> <span class=o>=</span> <span class=n>ch</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 无缓冲模式/行缓冲模式且写入\n，立即将缓冲区数据写入文件
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=p>((</span><span class=n>f</span><span class=o>-&gt;</span><span class=n>_flags</span> <span class=o>&amp;</span> <span class=n>_IO_UNBUFFERED</span><span class=p>)</span> <span class=o>||</span> <span class=p>((</span><span class=n>f</span><span class=o>-&gt;</span><span class=n>_flags</span> <span class=o>&amp;</span> <span class=n>_IO_LINE_BUF</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=n>ch</span> <span class=o>==</span> <span class=sc>&#39;\n&#39;</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nf>_IO_do_write</span><span class=p>(</span><span class=n>f</span><span class=p>,</span> <span class=n>f</span><span class=o>-&gt;</span><span class=n>_IO_write_base</span><span class=p>,</span> <span class=n>f</span><span class=o>-&gt;</span><span class=n>_IO_write_ptr</span> <span class=o>-</span> <span class=n>f</span><span class=o>-&gt;</span><span class=n>_IO_write_base</span><span class=p>)</span> <span class=o>==</span> <span class=n>EOF</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=n>EOF</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 返回写入的字符
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>return</span> <span class=p>(</span><span class=kt>unsigned</span> <span class=kt>char</span><span class=p>)</span><span class=n>ch</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=nf>libc_hidden_ver</span><span class=p>(</span><span class=n>_IO_new_file_overflow</span><span class=p>,</span> <span class=n>_IO_file_overflow</span><span class=p>)</span></span></span></code></pre></div></div><h4 id=new_do_write>new_do_write</h4><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-c"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=复制到剪贴板><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=c1>// 调用了系统调用 将data写入fp
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>static</span> <span class=kt>size_t</span> <span class=nf>new_do_write</span><span class=p>(</span><span class=n>FILE</span> <span class=o>*</span><span class=n>fp</span><span class=p>,</span> <span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=n>data</span><span class=p>,</span> <span class=kt>size_t</span> <span class=n>to_do</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kt>size_t</span> <span class=n>count</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 文件流处于追加模式
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=p>(</span><span class=n>fp</span><span class=o>-&gt;</span><span class=n>_flags</span> <span class=o>&amp;</span> <span class=n>_IO_IS_APPENDING</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>fp</span><span class=o>-&gt;</span><span class=n>_offset</span> <span class=o>=</span> <span class=n>_IO_pos_BAD</span><span class=p>;</span> <span class=c1>// 偏移量设置为无效值
</span></span></span><span class=line><span class=cl><span class=c1></span>  
</span></span><span class=line><span class=cl>  <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>fp</span><span class=o>-&gt;</span><span class=n>_IO_read_end</span> <span class=o>!=</span> <span class=n>fp</span><span class=o>-&gt;</span><span class=n>_IO_write_base</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span> <span class=c1>// 读取指针和写入缓冲区基址不相同，需要调整文件偏移量
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kt>off64_t</span> <span class=n>new_pos</span> <span class=o>=</span> <span class=nf>_IO_SYSSEEK</span><span class=p>(</span><span class=n>fp</span><span class=p>,</span> <span class=n>fp</span><span class=o>-&gt;</span><span class=n>_IO_write_base</span> <span class=o>-</span> <span class=n>fp</span><span class=o>-&gt;</span><span class=n>_IO_read_end</span><span class=p>,</span> <span class=mi>1</span><span class=p>);</span> <span class=c1>// 移到写缓冲区基址
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=n>new_pos</span> <span class=o>==</span> <span class=n>_IO_pos_BAD</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>fp</span><span class=o>-&gt;</span><span class=n>_offset</span> <span class=o>=</span> <span class=n>new_pos</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 系统调用，data指向的to_do字节数据写入文件流fp
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>count</span> <span class=o>=</span> <span class=nf>_IO_SYSWRITE</span><span class=p>(</span><span class=n>fp</span><span class=p>,</span> <span class=n>data</span><span class=p>,</span> <span class=n>to_do</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 若当前流的列信息存在且成功写入数据
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=p>(</span><span class=n>fp</span><span class=o>-&gt;</span><span class=n>_cur_column</span> <span class=o>&amp;&amp;</span> <span class=n>count</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=c1>// 调整列信息
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>fp</span><span class=o>-&gt;</span><span class=n>_cur_column</span> <span class=o>=</span> <span class=nf>_IO_adjust_column</span><span class=p>(</span><span class=n>fp</span><span class=o>-&gt;</span><span class=n>_cur_column</span> <span class=o>-</span> <span class=mi>1</span><span class=p>,</span> <span class=n>data</span><span class=p>,</span> <span class=n>count</span><span class=p>)</span> <span class=o>+</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 重置读缓冲区
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nf>_IO_setg</span><span class=p>(</span><span class=n>fp</span><span class=p>,</span> <span class=n>fp</span><span class=o>-&gt;</span><span class=n>_IO_buf_base</span><span class=p>,</span> <span class=n>fp</span><span class=o>-&gt;</span><span class=n>_IO_buf_base</span><span class=p>,</span> <span class=n>fp</span><span class=o>-&gt;</span><span class=n>_IO_buf_base</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 初始化写入缓冲区
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>fp</span><span class=o>-&gt;</span><span class=n>_IO_write_base</span> <span class=o>=</span> <span class=n>fp</span><span class=o>-&gt;</span><span class=n>_IO_write_ptr</span> <span class=o>=</span> <span class=n>fp</span><span class=o>-&gt;</span><span class=n>_IO_buf_base</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>fp</span><span class=o>-&gt;</span><span class=n>_IO_write_end</span> <span class=o>=</span> <span class=p>(</span><span class=n>fp</span><span class=o>-&gt;</span><span class=n>_mode</span> <span class=o>&lt;=</span> <span class=mi>0</span> <span class=o>&amp;&amp;</span> <span class=p>(</span><span class=n>fp</span><span class=o>-&gt;</span><span class=n>_flags</span> <span class=o>&amp;</span> <span class=p>(</span><span class=n>_IO_LINE_BUF</span> <span class=o>|</span> <span class=n>_IO_UNBUFFERED</span><span class=p>))</span>
</span></span><span class=line><span class=cl>                           <span class=o>?</span> <span class=n>fp</span><span class=o>-&gt;</span><span class=nl>_IO_buf_base</span>
</span></span><span class=line><span class=cl>                           <span class=p>:</span> <span class=n>fp</span><span class=o>-&gt;</span><span class=n>_IO_buf_end</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>count</span><span class=p>;</span> <span class=c1>// 返回写入字节数
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span></span></span></code></pre></div></div><h3 id=fclose>fclose</h3><h4 id=fclose-1>fclose</h4><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-c"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=复制到剪贴板><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#define fclose(fp) _IO_new_fclose (fp)</span></span></span></code></pre></div></div><h4 id=_io_new_fclose>_IO_new_fclose</h4><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-c"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=复制到剪贴板><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=kt>int</span> <span class=nf>_IO_new_fclose</span> <span class=p>(</span><span class=n>FILE</span> <span class=o>*</span><span class=n>fp</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kt>int</span> <span class=n>status</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nf>CHECK_FILE</span><span class=p>(</span><span class=n>fp</span><span class=p>,</span> <span class=n>EOF</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cp>#if SHLIB_COMPAT (libc, GLIBC_2_0, GLIBC_2_1)
</span></span></span><span class=line><span class=cl><span class=cp></span>  <span class=k>if</span> <span class=p>(</span><span class=nf>_IO_vtable_offset</span> <span class=p>(</span><span class=n>fp</span><span class=p>)</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nf>_IO_old_fclose</span> <span class=p>(</span><span class=n>fp</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=cp>#endif
</span></span></span><span class=line><span class=cl><span class=cp></span>  <span class=k>if</span> <span class=p>(</span><span class=n>fp</span><span class=o>-&gt;</span><span class=n>_flags</span> <span class=o>&amp;</span> <span class=n>_IO_IS_FILEBUF</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nf>_IO_un_link</span> <span class=p>((</span><span class=k>struct</span> <span class=n>_IO_FILE_plus</span> <span class=o>*</span><span class=p>)</span> <span class=n>fp</span><span class=p>);</span> <span class=c1>// 将文件结构体从_IO_list_all链表中取下
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=nf>_IO_acquire_lock</span> <span class=p>(</span><span class=n>fp</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>fp</span><span class=o>-&gt;</span><span class=n>_flags</span> <span class=o>&amp;</span> <span class=n>_IO_IS_FILEBUF</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>status</span> <span class=o>=</span> <span class=nf>_IO_file_close_it</span> <span class=p>(</span><span class=n>fp</span><span class=p>);</span> <span class=c1>// 关闭文件，释放文件流缓冲区
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>else</span>
</span></span><span class=line><span class=cl>    <span class=n>status</span> <span class=o>=</span> <span class=n>fp</span><span class=o>-&gt;</span><span class=n>_flags</span> <span class=o>&amp;</span> <span class=n>_IO_ERR_SEEN</span> <span class=o>?</span> <span class=o>-</span><span class=mi>1</span> <span class=o>:</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nf>_IO_release_lock</span> <span class=p>(</span><span class=n>fp</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=nf>_IO_FINISH</span> <span class=p>(</span><span class=n>fp</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>fp</span><span class=o>-&gt;</span><span class=n>_mode</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>struct</span> <span class=n>_IO_codecvt</span> <span class=o>*</span><span class=n>cc</span> <span class=o>=</span> <span class=n>fp</span><span class=o>-&gt;</span><span class=n>_codecvt</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=nf>__libc_lock_lock</span> <span class=p>(</span><span class=n>__gconv_lock</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=nf>__gconv_release_step</span> <span class=p>(</span><span class=n>cc</span><span class=o>-&gt;</span><span class=n>__cd_in</span><span class=p>.</span><span class=n>step</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=nf>__gconv_release_step</span> <span class=p>(</span><span class=n>cc</span><span class=o>-&gt;</span><span class=n>__cd_out</span><span class=p>.</span><span class=n>step</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=nf>__libc_lock_unlock</span> <span class=p>(</span><span class=n>__gconv_lock</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>else</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=nf>_IO_have_backup</span> <span class=p>(</span><span class=n>fp</span><span class=p>))</span>
</span></span><span class=line><span class=cl>	<span class=nf>_IO_free_backup_area</span> <span class=p>(</span><span class=n>fp</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=nf>_IO_deallocate_file</span> <span class=p>(</span><span class=n>fp</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>status</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div><h4 id=_io_un_link>_IO_un_link</h4><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-c"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=复制到剪贴板><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=kt>void</span> <span class=nf>_IO_un_link</span> <span class=p>(</span><span class=k>struct</span> <span class=n>_IO_FILE_plus</span> <span class=o>*</span><span class=n>fp</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>fp</span><span class=o>-&gt;</span><span class=n>file</span><span class=p>.</span><span class=n>_flags</span> <span class=o>&amp;</span> <span class=n>_IO_LINKED</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>FILE</span> <span class=o>**</span><span class=n>f</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=cp>#ifdef _IO_MTSAFE_IO
</span></span></span><span class=line><span class=cl><span class=cp></span>      <span class=nf>_IO_cleanup_region_start_noarg</span> <span class=p>(</span><span class=n>flush_cleanup</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=nf>_IO_lock_lock</span> <span class=p>(</span><span class=n>list_all_lock</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=n>run_fp</span> <span class=o>=</span> <span class=p>(</span><span class=n>FILE</span> <span class=o>*</span><span class=p>)</span> <span class=n>fp</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=nf>_IO_flockfile</span> <span class=p>((</span><span class=n>FILE</span> <span class=o>*</span><span class=p>)</span> <span class=n>fp</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=cp>#endif
</span></span></span><span class=line><span class=cl><span class=cp></span>      <span class=k>if</span> <span class=p>(</span><span class=n>_IO_list_all</span> <span class=o>==</span> <span class=nb>NULL</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>fp</span> <span class=o>==</span> <span class=n>_IO_list_all</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=n>_IO_list_all</span> <span class=o>=</span> <span class=p>(</span><span class=k>struct</span> <span class=n>_IO_FILE_plus</span> <span class=o>*</span><span class=p>)</span> <span class=n>_IO_list_all</span><span class=o>-&gt;</span><span class=n>file</span><span class=p>.</span><span class=n>_chain</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=k>else</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=p>(</span><span class=n>f</span> <span class=o>=</span> <span class=o>&amp;</span><span class=n>_IO_list_all</span><span class=o>-&gt;</span><span class=n>file</span><span class=p>.</span><span class=n>_chain</span><span class=p>;</span> <span class=o>*</span><span class=n>f</span><span class=p>;</span> <span class=n>f</span> <span class=o>=</span> <span class=o>&amp;</span><span class=p>(</span><span class=o>*</span><span class=n>f</span><span class=p>)</span><span class=o>-&gt;</span><span class=n>_chain</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	  <span class=k>if</span> <span class=p>(</span><span class=o>*</span><span class=n>f</span> <span class=o>==</span> <span class=p>(</span><span class=n>FILE</span> <span class=o>*</span><span class=p>)</span> <span class=n>fp</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	    <span class=p>{</span>
</span></span><span class=line><span class=cl>	      <span class=o>*</span><span class=n>f</span> <span class=o>=</span> <span class=n>fp</span><span class=o>-&gt;</span><span class=n>file</span><span class=p>.</span><span class=n>_chain</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	      <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	    <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=n>fp</span><span class=o>-&gt;</span><span class=n>file</span><span class=p>.</span><span class=n>_flags</span> <span class=o>&amp;=</span> <span class=o>~</span><span class=n>_IO_LINKED</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=cp>#ifdef _IO_MTSAFE_IO
</span></span></span><span class=line><span class=cl><span class=cp></span>      <span class=nf>_IO_funlockfile</span> <span class=p>((</span><span class=n>FILE</span> <span class=o>*</span><span class=p>)</span> <span class=n>fp</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=n>run_fp</span> <span class=o>=</span> <span class=nb>NULL</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=nf>_IO_lock_unlock</span> <span class=p>(</span><span class=n>list_all_lock</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=nf>_IO_cleanup_region_end</span> <span class=p>(</span><span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=cp>#endif
</span></span></span><span class=line><span class=cl><span class=cp></span>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=nf>libc_hidden_def</span> <span class=p>(</span><span class=n>_IO_un_link</span><span class=p>)</span></span></span></code></pre></div></div><h4 id=_io_new_file_close_it>_IO_new_file_close_it</h4><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-c"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=复制到剪贴板><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=kt>int</span> <span class=nf>_IO_new_file_close_it</span><span class=p>(</span><span class=n>FILE</span> <span class=o>*</span><span class=n>fp</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kt>int</span> <span class=n>write_status</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nf>_IO_file_is_open</span><span class=p>(</span><span class=n>fp</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>EOF</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>((</span><span class=n>fp</span><span class=o>-&gt;</span><span class=n>_flags</span> <span class=o>&amp;</span> <span class=n>_IO_NO_WRITES</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span> <span class=o>&amp;&amp;</span> <span class=p>(</span><span class=n>fp</span><span class=o>-&gt;</span><span class=n>_flags</span> <span class=o>&amp;</span> <span class=n>_IO_CURRENTLY_PUTTING</span><span class=p>)</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>write_status</span> <span class=o>=</span> <span class=nf>_IO_do_flush</span><span class=p>(</span><span class=n>fp</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>else</span>
</span></span><span class=line><span class=cl>    <span class=n>write_status</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nf>_IO_unsave_markers</span><span class=p>(</span><span class=n>fp</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kt>int</span> <span class=n>close_status</span> <span class=o>=</span> <span class=p>((</span><span class=n>fp</span><span class=o>-&gt;</span><span class=n>_flags2</span> <span class=o>&amp;</span> <span class=n>_IO_FLAGS2_NOCLOSE</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>                          <span class=o>?</span> <span class=nf>_IO_SYSCLOSE</span><span class=p>(</span><span class=n>fp</span><span class=p>)</span> <span class=c1>// 系统调用关闭文件
</span></span></span><span class=line><span class=cl><span class=c1></span>                          <span class=o>:</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 释放文件流缓冲区
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=p>(</span><span class=n>fp</span><span class=o>-&gt;</span><span class=n>_mode</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=nf>_IO_have_wbackup</span><span class=p>(</span><span class=n>fp</span><span class=p>))</span>
</span></span><span class=line><span class=cl>      <span class=nf>_IO_free_wbackup_area</span><span class=p>(</span><span class=n>fp</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>_IO_wsetb</span><span class=p>(</span><span class=n>fp</span><span class=p>,</span> <span class=nb>NULL</span><span class=p>,</span> <span class=nb>NULL</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>_IO_wsetg</span><span class=p>(</span><span class=n>fp</span><span class=p>,</span> <span class=nb>NULL</span><span class=p>,</span> <span class=nb>NULL</span><span class=p>,</span> <span class=nb>NULL</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>_IO_wsetp</span><span class=p>(</span><span class=n>fp</span><span class=p>,</span> <span class=nb>NULL</span><span class=p>,</span> <span class=nb>NULL</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=nf>_IO_setb</span><span class=p>(</span><span class=n>fp</span><span class=p>,</span> <span class=nb>NULL</span><span class=p>,</span> <span class=nb>NULL</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=nf>_IO_setg</span><span class=p>(</span><span class=n>fp</span><span class=p>,</span> <span class=nb>NULL</span><span class=p>,</span> <span class=nb>NULL</span><span class=p>,</span> <span class=nb>NULL</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=nf>_IO_setp</span><span class=p>(</span><span class=n>fp</span><span class=p>,</span> <span class=nb>NULL</span><span class=p>,</span> <span class=nb>NULL</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nf>_IO_un_link</span><span class=p>((</span><span class=k>struct</span> <span class=n>_IO_FILE_plus</span> <span class=o>*</span><span class=p>)</span><span class=n>fp</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=n>fp</span><span class=o>-&gt;</span><span class=n>_flags</span> <span class=o>=</span> <span class=n>_IO_MAGIC</span> <span class=o>|</span> <span class=n>CLOSED_FILEBUF_FLAGS</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>fp</span><span class=o>-&gt;</span><span class=n>_fileno</span> <span class=o>=</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>fp</span><span class=o>-&gt;</span><span class=n>_offset</span> <span class=o>=</span> <span class=n>_IO_pos_BAD</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>close_status</span> <span class=o>?</span> <span class=nl>close_status</span> <span class=p>:</span> <span class=n>write_status</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=nf>libc_hidden_ver</span><span class=p>(</span><span class=n>_IO_new_file_close_it</span><span class=p>,</span> <span class=n>_IO_file_close_it</span><span class=p>)</span></span></span></code></pre></div></div><h3 id=puts>puts</h3><h4 id=_io_puts>_IO_puts</h4><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-c"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=复制到剪贴板><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=kt>int</span> <span class=nf>_IO_puts</span><span class=p>(</span><span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=n>str</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kt>int</span> <span class=n>result</span> <span class=o>=</span> <span class=n>EOF</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>_IO_size_t</span> <span class=n>len</span> <span class=o>=</span> <span class=nf>strlen</span><span class=p>(</span><span class=n>str</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=nf>_IO_acquire_lock</span><span class=p>(</span><span class=n>_IO_stdout</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>((</span><span class=nf>_IO_vtable_offset</span><span class=p>(</span><span class=n>_IO_stdout</span><span class=p>)</span> <span class=o>!=</span> <span class=mi>0</span> <span class=o>||</span> <span class=nf>_IO_fwide</span><span class=p>(</span><span class=n>_IO_stdout</span><span class=p>,</span> <span class=o>-</span><span class=mi>1</span><span class=p>)</span> <span class=o>==</span> <span class=o>-</span><span class=mi>1</span><span class=p>)</span> 
</span></span><span class=line><span class=cl>    <span class=o>&amp;&amp;</span> <span class=nf>_IO_sputn</span><span class=p>(</span><span class=n>_IO_stdout</span><span class=p>,</span> <span class=n>str</span><span class=p>,</span> <span class=n>len</span><span class=p>)</span> <span class=o>==</span> <span class=n>len</span>
</span></span><span class=line><span class=cl>    <span class=o>&amp;&amp;</span> <span class=nf>_IO_putc_unlocked</span><span class=p>(</span><span class=sc>&#39;\n&#39;</span><span class=p>,</span> <span class=n>_IO_stdout</span><span class=p>)</span> <span class=o>!=</span> <span class=n>EOF</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>result</span> <span class=o>=</span> <span class=nf>MIN</span><span class=p>(</span><span class=n>INT_MAX</span><span class=p>,</span> <span class=n>len</span> <span class=o>+</span> <span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nf>_IO_release_lock</span><span class=p>(</span><span class=n>_IO_stdout</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>result</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div><h4 id=_io_sputn>_IO_sputn</h4><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-c"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=复制到剪贴板><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=c1>// 2.27 宏展开
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>((</span><span class=nf>IO_validate_vtable</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=o>*</span><span class=p>(</span><span class=k>struct</span> <span class=n>_IO_jump_t</span> <span class=o>**</span><span class=p>)</span> <span class=p>(</span> <span class=c1>// 转换为_IO_jump_t * 类型指针最终传入IO_validate_vtable
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=p>(</span><span class=kt>void</span> <span class=o>*</span><span class=p>)</span> <span class=o>&amp;</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 由 char * 转换为 vtable 对应类型
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=o>*</span><span class=p>(</span><span class=nf>__typeof__</span> <span class=p>(((</span><span class=k>struct</span> <span class=n>_IO_FILE_plus</span><span class=p>){}).</span><span class=n>vtable</span><span class=p>)</span> <span class=o>*</span><span class=p>)(</span>
</span></span><span class=line><span class=cl>                <span class=c1>// 获取_IO_stdout基地址，计算出vtable成员在_IO_stdout结构体地址
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=p>((</span><span class=kt>char</span> <span class=o>*</span><span class=p>)</span> <span class=p>((</span><span class=n>_IO_stdout</span><span class=p>)))</span> <span class=o>+</span> <span class=nf>__builtin_offsetof</span> <span class=p>(</span><span class=k>struct</span> <span class=n>_IO_FILE_plus</span><span class=p>,</span> <span class=n>vtable</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span> 
</span></span><span class=line><span class=cl>  		<span class=o>+</span> <span class=p>(</span><span class=n>_IO_stdout</span><span class=p>)</span><span class=o>-&gt;</span><span class=n>_vtable_offset</span> <span class=c1>// 一般为0，应对特殊情况偏移
</span></span></span><span class=line><span class=cl><span class=c1></span>  	<span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>))</span><span class=o>-&gt;</span><span class=n>__xsputn</span><span class=p>)</span> <span class=p>(</span><span class=n>_IO_stdout</span><span class=p>,</span> <span class=n>str</span><span class=p>,</span> <span class=n>len</span><span class=p>);</span></span></span></code></pre></div></div><h4 id=io_validate_vtable>IO_validate_vtable</h4><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-c"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=复制到剪贴板><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=c1>// 2.27 检查传入的 vtable 指针是否指向 libc 库中定义的有效的 I/O 操作函数表
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>static</span> <span class=kr>inline</span> <span class=k>const</span> <span class=k>struct</span> <span class=n>_IO_jump_t</span> <span class=o>*</span><span class=nf>IO_validate_vtable</span><span class=p>(</span><span class=k>const</span> <span class=k>struct</span> <span class=n>_IO_jump_t</span> <span class=o>*</span><span class=n>vtable</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>   <span class=c1>// 计算 I/O 操作函数表在内存中总大小
</span></span></span><span class=line><span class=cl><span class=c1></span>   <span class=kt>uintptr_t</span> <span class=n>section_length</span> <span class=o>=</span> <span class=n>__stop___libc_IO_vtables</span> <span class=o>-</span> <span class=n>__start___libc_IO_vtables</span><span class=p>;</span>
</span></span><span class=line><span class=cl>   <span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=n>ptr</span> <span class=o>=</span> <span class=p>(</span><span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=p>)</span><span class=n>vtable</span><span class=p>;</span> <span class=c1>// 强制转换类型以计算偏移
</span></span></span><span class=line><span class=cl><span class=c1></span>   <span class=kt>uintptr_t</span> <span class=n>offset</span> <span class=o>=</span> <span class=n>ptr</span> <span class=o>-</span> <span class=n>__start___libc_IO_vtables</span><span class=p>;</span> <span class=c1>// 计算偏移量
</span></span></span><span class=line><span class=cl><span class=c1></span>   <span class=k>if</span> <span class=p>(</span><span class=nf>__glibc_unlikely</span><span class=p>(</span><span class=n>offset</span> <span class=o>&gt;=</span> <span class=n>section_length</span><span class=p>))</span> <span class=c1>// 判断是否超过总大小
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nf>_IO_vtable_check</span><span class=p>();</span> <span class=c1>// 最终报错
</span></span></span><span class=line><span class=cl><span class=c1></span>   <span class=k>return</span> <span class=n>vtable</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div><h4 id=_io_vtable_check>_IO_vtable_check</h4><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-c"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=复制到剪贴板><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=kt>void</span> <span class=n>attribute_hidden</span> <span class=nf>_IO_vtable_check</span> <span class=p>(</span><span class=kt>void</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl><span class=cp>#ifdef SHARED </span><span class=c1>// 仅共享库模式下编译
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kt>void</span> <span class=p>(</span><span class=o>*</span><span class=n>flag</span><span class=p>)</span> <span class=p>(</span><span class=kt>void</span><span class=p>)</span> <span class=o>=</span> <span class=nf>atomic_load_relaxed</span> <span class=p>(</span><span class=o>&amp;</span><span class=n>IO_accept_foreign_vtables</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=cp>#ifdef PTR_DEMANGLE </span><span class=c1>// 处理函数指针的混淆或解混淆
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nf>PTR_DEMANGLE</span> <span class=p>(</span><span class=n>flag</span><span class=p>);</span> <span class=c1>// 解码函数指针flag值
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=cp>#endif
</span></span></span><span class=line><span class=cl><span class=cp></span>  <span class=k>if</span> <span class=p>(</span><span class=n>flag</span> <span class=o>==</span> <span class=o>&amp;</span><span class=n>_IO_vtable_check</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>Dl_info</span> <span class=n>di</span><span class=p>;</span> <span class=c1>// 存储动态链接器返回的信息，例如符号名和地址
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>struct</span> <span class=n>link_map</span> <span class=o>*</span><span class=n>l</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nf>rtld_active</span> <span class=p>()</span> <span class=c1>// 检查运行时动态链接器是否处于活动状态
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=o>||</span> <span class=p>(</span><span class=nf>_dl_addr</span> <span class=p>(</span><span class=n>_IO_vtable_check</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>di</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>l</span><span class=p>,</span> <span class=nb>NULL</span><span class=p>)</span> <span class=o>!=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>            <span class=o>&amp;&amp;</span> <span class=n>l</span><span class=o>-&gt;</span><span class=n>l_ns</span> <span class=o>!=</span> <span class=n>LM_ID_BASE</span><span class=p>))</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cp>#else </span><span class=c1>// 非共享库模式
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=p>(</span><span class=n>__dlopen</span> <span class=o>!=</span> <span class=nb>NULL</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=cp>#endif
</span></span></span><span class=line><span class=cl><span class=cp></span>  <span class=nf>__libc_fatal</span> <span class=p>(</span><span class=s>&#34;Fatal error: glibc detected an invalid stdio handle</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div><h4 id=rtld_active>rtld_active</h4><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-c"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=复制到剪贴板><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#  define GLRO(name) _rtld_local_ro._##name
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=kr>inline</span> <span class=kt>bool</span> <span class=nf>rtld_active</span> <span class=p>(</span><span class=kt>void</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nf>GLRO</span><span class=p>(</span><span class=n>dl_init_all_dirs</span><span class=p>)</span> <span class=o>!=</span> <span class=nb>NULL</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div><h4 id=_dl_addr>_dl_addr</h4><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-c"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=复制到剪贴板><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=kt>int</span> <span class=nf>_dl_addr</span><span class=p>(</span><span class=k>const</span> <span class=kt>void</span> <span class=o>*</span><span class=n>address</span><span class=p>,</span> <span class=n>Dl_info</span> <span class=o>*</span><span class=n>info</span><span class=p>,</span>
</span></span><span class=line><span class=cl>             <span class=k>struct</span> <span class=n>link_map</span> <span class=o>**</span><span class=n>mapp</span><span class=p>,</span> <span class=k>const</span> <span class=nf>ElfW</span><span class=p>(</span><span class=n>Sym</span><span class=p>)</span> <span class=o>*</span> <span class=o>*</span><span class=n>symbolp</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>const</span> <span class=nf>ElfW</span><span class=p>(</span><span class=n>Addr</span><span class=p>)</span> <span class=n>addr</span> <span class=o>=</span> <span class=nf>DL_LOOKUP_ADDRESS</span><span class=p>(</span><span class=n>address</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=kt>int</span> <span class=n>result</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm>    libc-lockP.h 关键exit-hook
</span></span></span><span class=line><span class=cl><span class=cm>    # define __rtld_lock_lock_recursive(NAME) \
</span></span></span><span class=line><span class=cl><span class=cm>      __libc_maybe_call (__pthread_mutex_lock, (&amp;(NAME).mutex), 0)
</span></span></span><span class=line><span class=cl><span class=cm>     替换:
</span></span></span><span class=line><span class=cl><span class=cm>    (({
</span></span></span><span class=line><span class=cl><span class=cm>        __typeof(__pthread_mutex_lock) *_fn = (__pthread_mutex_lock);
</span></span></span><span class=line><span class=cl><span class=cm>        _fn != ((void *) 0) ? (*_fn)(&amp;(_dl_load_lock).mutex) : 0;
</span></span></span><span class=line><span class=cl><span class=cm>    }))
</span></span></span><span class=line><span class=cl><span class=cm>*/</span>
</span></span><span class=line><span class=cl>  <span class=nf>__rtld_lock_lock_recursive</span><span class=p>(</span><span class=nf>GL</span><span class=p>(</span><span class=n>dl_load_lock</span><span class=p>));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>struct</span> <span class=n>link_map</span> <span class=o>*</span><span class=n>l</span> <span class=o>=</span> <span class=nf>_dl_find_dso_for_object</span><span class=p>(</span><span class=n>addr</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>l</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nf>determine_info</span><span class=p>(</span><span class=n>addr</span><span class=p>,</span> <span class=n>l</span><span class=p>,</span> <span class=n>info</span><span class=p>,</span> <span class=n>mapp</span><span class=p>,</span> <span class=n>symbolp</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>result</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nf>__rtld_lock_unlock_recursive</span><span class=p>(</span><span class=nf>GL</span><span class=p>(</span><span class=n>dl_load_lock</span><span class=p>));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>result</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=nf>libc_hidden_def</span><span class=p>(</span><span class=n>_dl_addr</span><span class=p>)</span></span></span></code></pre></div></div><h3 id=flush>flush</h3><h4 id=_io_flush_all_lockp>_IO_flush_all_lockp</h4><div class="code-block code-line-numbers" style="counter-reset:code-block 0"><div class="code-header language-c"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=复制到剪贴板><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=c1>// 程序退出时会调用
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>int</span> <span class=nf>_IO_flush_all_lockp</span><span class=p>(</span><span class=kt>int</span> <span class=n>do_lock</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kt>int</span> <span class=n>result</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>struct</span> <span class=n>_IO_FILE</span> <span class=o>*</span><span class=n>fp</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>int</span> <span class=n>last_stamp</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cp>#ifdef _IO_MTSAFE_IO
</span></span></span><span class=line><span class=cl><span class=cp></span>  <span class=nf>__libc_cleanup_region_start</span><span class=p>(</span><span class=n>do_lock</span><span class=p>,</span> <span class=n>flush_cleanup</span><span class=p>,</span> <span class=nb>NULL</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>do_lock</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nf>_IO_lock_lock</span><span class=p>(</span><span class=n>list_all_lock</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=cp>#endif
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl>  <span class=n>last_stamp</span> <span class=o>=</span> <span class=n>_IO_list_all_stamp</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>fp</span> <span class=o>=</span> <span class=p>(</span><span class=n>_IO_FILE</span> <span class=o>*</span><span class=p>)</span><span class=n>_IO_list_all</span><span class=p>;</span> <span class=c1>// 获取fp
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>while</span> <span class=p>(</span><span class=n>fp</span> <span class=o>!=</span> <span class=nb>NULL</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>run_fp</span> <span class=o>=</span> <span class=n>fp</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>do_lock</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=nf>_IO_flockfile</span><span class=p>(</span><span class=n>fp</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(((</span><span class=n>fp</span><span class=o>-&gt;</span><span class=n>_mode</span> <span class=o>&lt;=</span> <span class=mi>0</span> <span class=o>&amp;&amp;</span> <span class=n>fp</span><span class=o>-&gt;</span><span class=n>_IO_write_ptr</span> <span class=o>&gt;</span> <span class=n>fp</span><span class=o>-&gt;</span><span class=n>_IO_write_base</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=cp>#if defined _LIBC || defined _GLIBCPP_USE_WCHAR_T
</span></span></span><span class=line><span class=cl><span class=cp></span>         <span class=o>||</span> <span class=p>(</span><span class=nf>_IO_vtable_offset</span><span class=p>(</span><span class=n>fp</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span> <span class=o>&amp;&amp;</span> <span class=n>fp</span><span class=o>-&gt;</span><span class=n>_mode</span> <span class=o>&gt;</span> <span class=mi>0</span> <span class=o>&amp;&amp;</span> <span class=p>(</span><span class=n>fp</span><span class=o>-&gt;</span><span class=n>_wide_data</span><span class=o>-&gt;</span><span class=n>_IO_write_ptr</span> <span class=o>&gt;</span> <span class=n>fp</span><span class=o>-&gt;</span><span class=n>_wide_data</span><span class=o>-&gt;</span><span class=n>_IO_write_base</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=cp>#endif
</span></span></span><span class=line><span class=cl><span class=cp></span>             <span class=p>)</span> <span class=o>&amp;&amp;</span>
</span></span><span class=line><span class=cl>        <span class=nf>_IO_OVERFLOW</span><span class=p>(</span><span class=n>fp</span><span class=p>,</span> <span class=n>EOF</span><span class=p>)</span> <span class=o>==</span> <span class=n>EOF</span><span class=p>)</span> <span class=c1>// 调用_IO_OVERFLOW， 参数为fp，即_IO_FILE结构体指针
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=n>result</span> <span class=o>=</span> <span class=n>EOF</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>do_lock</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=nf>_IO_funlockfile</span><span class=p>(</span><span class=n>fp</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>run_fp</span> <span class=o>=</span> <span class=nb>NULL</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>last_stamp</span> <span class=o>!=</span> <span class=n>_IO_list_all_stamp</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=cm>/* Something was added to the list.  Start all over again.  */</span>
</span></span><span class=line><span class=cl>      <span class=n>fp</span> <span class=o>=</span> <span class=p>(</span><span class=n>_IO_FILE</span> <span class=o>*</span><span class=p>)</span><span class=n>_IO_list_all</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=n>last_stamp</span> <span class=o>=</span> <span class=n>_IO_list_all_stamp</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span>
</span></span><span class=line><span class=cl>      <span class=n>fp</span> <span class=o>=</span> <span class=n>fp</span><span class=o>-&gt;</span><span class=n>_chain</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cp>#ifdef _IO_MTSAFE_IO
</span></span></span><span class=line><span class=cl><span class=cp></span>  <span class=k>if</span> <span class=p>(</span><span class=n>do_lock</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nf>_IO_lock_unlock</span><span class=p>(</span><span class=n>list_all_lock</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=nf>__libc_cleanup_region_end</span><span class=p>(</span><span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=cp>#endif
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>result</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div><h4 id=_io_str_overflow>_IO_str_overflow</h4><div class="code-block code-line-numbers" style="counter-reset:code-block 0"><div class="code-header language-c"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=复制到剪贴板><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=kt>int</span> <span class=nf>_IO_str_overflow</span> <span class=p>(</span><span class=n>FILE</span> <span class=o>*</span><span class=n>fp</span><span class=p>,</span> <span class=kt>int</span> <span class=n>c</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kt>int</span> <span class=n>flush_only</span> <span class=o>=</span> <span class=n>c</span> <span class=o>==</span> <span class=n>EOF</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>size_t</span> <span class=n>pos</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>fp</span><span class=o>-&gt;</span><span class=n>_flags</span> <span class=o>&amp;</span> <span class=n>_IO_NO_WRITES</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=n>flush_only</span> <span class=o>?</span> <span class=mi>0</span> <span class=o>:</span> <span class=n>EOF</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>((</span><span class=n>fp</span><span class=o>-&gt;</span><span class=n>_flags</span> <span class=o>&amp;</span> <span class=n>_IO_TIED_PUT_GET</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=p>(</span><span class=n>fp</span><span class=o>-&gt;</span><span class=n>_flags</span> <span class=o>&amp;</span> <span class=n>_IO_CURRENTLY_PUTTING</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>fp</span><span class=o>-&gt;</span><span class=n>_flags</span> <span class=o>|=</span> <span class=n>_IO_CURRENTLY_PUTTING</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=n>fp</span><span class=o>-&gt;</span><span class=n>_IO_write_ptr</span> <span class=o>=</span> <span class=n>fp</span><span class=o>-&gt;</span><span class=n>_IO_read_ptr</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=n>fp</span><span class=o>-&gt;</span><span class=n>_IO_read_ptr</span> <span class=o>=</span> <span class=n>fp</span><span class=o>-&gt;</span><span class=n>_IO_read_end</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=n>pos</span> <span class=o>=</span> <span class=n>fp</span><span class=o>-&gt;</span><span class=n>_IO_write_ptr</span> <span class=o>-</span> <span class=n>fp</span><span class=o>-&gt;</span><span class=n>_IO_write_base</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>pos</span> <span class=o>&gt;=</span> <span class=p>(</span><span class=kt>size_t</span><span class=p>)</span> <span class=p>(</span><span class=nf>_IO_blen</span> <span class=p>(</span><span class=n>fp</span><span class=p>)</span> <span class=o>+</span> <span class=n>flush_only</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>if</span> <span class=p>(</span><span class=n>fp</span><span class=o>-&gt;</span><span class=n>_flags</span> <span class=o>&amp;</span> <span class=n>_IO_USER_BUF</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=n>EOF</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=k>else</span>
</span></span><span class=line><span class=cl>	<span class=p>{</span>
</span></span><span class=line><span class=cl>	  <span class=kt>char</span> <span class=o>*</span><span class=n>new_buf</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	  <span class=kt>char</span> <span class=o>*</span><span class=n>old_buf</span> <span class=o>=</span> <span class=n>fp</span><span class=o>-&gt;</span><span class=n>_IO_buf_base</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	  <span class=kt>size_t</span> <span class=n>old_blen</span> <span class=o>=</span> <span class=nf>_IO_blen</span> <span class=p>(</span><span class=n>fp</span><span class=p>);</span> <span class=c1>// _IO_buf_end - _IO_buf_base
</span></span></span><span class=line><span class=cl><span class=c1></span>	  <span class=kt>size_t</span> <span class=n>new_size</span> <span class=o>=</span> <span class=mi>2</span> <span class=o>*</span> <span class=n>old_blen</span> <span class=o>+</span> <span class=mi>100</span><span class=p>;</span> <span class=c1>// 获取新大小
</span></span></span><span class=line><span class=cl><span class=c1></span>	  <span class=k>if</span> <span class=p>(</span><span class=n>new_size</span> <span class=o>&lt;</span> <span class=n>old_blen</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	    <span class=k>return</span> <span class=n>EOF</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	  <span class=n>new_buf</span> <span class=o>=</span> <span class=nf>malloc</span> <span class=p>(</span><span class=n>new_size</span><span class=p>);</span> <span class=c1>// 使用malloc申请新的内存，从tcache中获取
</span></span></span><span class=line><span class=cl><span class=c1></span>	  <span class=k>if</span> <span class=p>(</span><span class=n>new_buf</span> <span class=o>==</span> <span class=nb>NULL</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	    <span class=p>{</span>
</span></span><span class=line><span class=cl>	      <span class=k>return</span> <span class=n>EOF</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	    <span class=p>}</span>
</span></span><span class=line><span class=cl>	  <span class=k>if</span> <span class=p>(</span><span class=n>old_buf</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	    <span class=p>{</span>
</span></span><span class=line><span class=cl>	      <span class=nf>memcpy</span> <span class=p>(</span><span class=n>new_buf</span><span class=p>,</span> <span class=n>old_buf</span><span class=p>,</span> <span class=n>old_blen</span><span class=p>);</span> <span class=c1>// 从old_buf内容拷贝到新的buf中
</span></span></span><span class=line><span class=cl><span class=c1></span>	      <span class=nf>free</span> <span class=p>(</span><span class=n>old_buf</span><span class=p>);</span> <span class=c1>// 释放old_buf
</span></span></span><span class=line><span class=cl><span class=c1></span>	      <span class=n>fp</span><span class=o>-&gt;</span><span class=n>_IO_buf_base</span> <span class=o>=</span> <span class=nb>NULL</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	    <span class=p>}</span>
</span></span><span class=line><span class=cl>	  <span class=nf>memset</span> <span class=p>(</span><span class=n>new_buf</span> <span class=o>+</span> <span class=n>old_blen</span><span class=p>,</span> <span class=sc>&#39;\0&#39;</span><span class=p>,</span> <span class=n>new_size</span> <span class=o>-</span> <span class=n>old_blen</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	  <span class=nf>_IO_setb</span> <span class=p>(</span><span class=n>fp</span><span class=p>,</span> <span class=n>new_buf</span><span class=p>,</span> <span class=n>new_buf</span> <span class=o>+</span> <span class=n>new_size</span><span class=p>,</span> <span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	  <span class=n>fp</span><span class=o>-&gt;</span><span class=n>_IO_read_base</span> <span class=o>=</span> <span class=n>new_buf</span> <span class=o>+</span> <span class=p>(</span><span class=n>fp</span><span class=o>-&gt;</span><span class=n>_IO_read_base</span> <span class=o>-</span> <span class=n>old_buf</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	  <span class=n>fp</span><span class=o>-&gt;</span><span class=n>_IO_read_ptr</span> <span class=o>=</span> <span class=n>new_buf</span> <span class=o>+</span> <span class=p>(</span><span class=n>fp</span><span class=o>-&gt;</span><span class=n>_IO_read_ptr</span> <span class=o>-</span> <span class=n>old_buf</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	  <span class=n>fp</span><span class=o>-&gt;</span><span class=n>_IO_read_end</span> <span class=o>=</span> <span class=n>new_buf</span> <span class=o>+</span> <span class=p>(</span><span class=n>fp</span><span class=o>-&gt;</span><span class=n>_IO_read_end</span> <span class=o>-</span> <span class=n>old_buf</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	  <span class=n>fp</span><span class=o>-&gt;</span><span class=n>_IO_write_ptr</span> <span class=o>=</span> <span class=n>new_buf</span> <span class=o>+</span> <span class=p>(</span><span class=n>fp</span><span class=o>-&gt;</span><span class=n>_IO_write_ptr</span> <span class=o>-</span> <span class=n>old_buf</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	  <span class=n>fp</span><span class=o>-&gt;</span><span class=n>_IO_write_base</span> <span class=o>=</span> <span class=n>new_buf</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	  <span class=n>fp</span><span class=o>-&gt;</span><span class=n>_IO_write_end</span> <span class=o>=</span> <span class=n>fp</span><span class=o>-&gt;</span><span class=n>_IO_buf_end</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>flush_only</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=o>*</span><span class=n>fp</span><span class=o>-&gt;</span><span class=n>_IO_write_ptr</span><span class=o>++</span> <span class=o>=</span> <span class=p>(</span><span class=kt>unsigned</span> <span class=kt>char</span><span class=p>)</span> <span class=n>c</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>fp</span><span class=o>-&gt;</span><span class=n>_IO_write_ptr</span> <span class=o>&gt;</span> <span class=n>fp</span><span class=o>-&gt;</span><span class=n>_IO_read_end</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>fp</span><span class=o>-&gt;</span><span class=n>_IO_read_end</span> <span class=o>=</span> <span class=n>fp</span><span class=o>-&gt;</span><span class=n>_IO_write_ptr</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>c</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=nf>libc_hidden_def</span> <span class=p>(</span><span class=n>_IO_str_overflow</span><span class=p>)</span></span></span></code></pre></div></div><h4 id=_io_fflush>_IO_fflush</h4><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-c"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=复制到剪贴板><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=kt>int</span> <span class=nf>_IO_fflush</span><span class=p>(</span><span class=n>FILE</span> <span class=o>*</span><span class=n>fp</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>fp</span> <span class=o>==</span> <span class=nb>NULL</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nf>_IO_flush_all</span><span class=p>();</span> <span class=c1>// 刷新所有打开可用的文件流
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>else</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span> <span class=c1>// 处理单个流
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kt>int</span> <span class=n>result</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nf>CHECK_FILE</span><span class=p>(</span><span class=n>fp</span><span class=p>,</span> <span class=n>EOF</span><span class=p>);</span> <span class=c1>// 验证是否有效
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nf>_IO_acquire_lock</span><span class=p>(</span><span class=n>fp</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm>#define _IO_SYNC(FP) JUMP0 (__sync, FP)
</span></span></span><span class=line><span class=cl><span class=cm>扩展到:
</span></span></span><span class=line><span class=cl><span class=cm>((IO_validate_vtable ((*(__typeof__ (((struct _IO_FILE_plus){}).vtable) *)(((char *) ((fp))) + __builtin_offsetof (struct _IO_FILE_plus, vtable)))))-&gt;__sync) (fp)
</span></span></span><span class=line><span class=cl><span class=cm>*/</span>
</span></span><span class=line><span class=cl>    <span class=n>result</span> <span class=o>=</span> <span class=nf>_IO_SYNC</span><span class=p>(</span><span class=n>fp</span><span class=p>)</span> <span class=o>?</span> <span class=nl>EOF</span> <span class=p>:</span> <span class=mi>0</span><span class=p>;</span> <span class=c1>// 调用vtable中的函数: 文件流的 __sync 函数指针
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=nf>_IO_release_lock</span><span class=p>(</span><span class=n>fp</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>result</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=nf>libc_hidden_def</span><span class=p>(</span><span class=n>_IO_fflush</span><span class=p>)</span></span></span></code></pre></div></div><h3 id=printf>printf</h3><h4 id=__fxprintf>__fxprintf</h4><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-c"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=复制到剪贴板><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=kt>int</span> <span class=nf>__fxprintf</span><span class=p>(</span><span class=n>FILE</span> <span class=o>*</span><span class=n>fp</span><span class=p>,</span> <span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=n>fmt</span><span class=p>,</span> <span class=p>...)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>va_list</span> <span class=n>ap</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nf>va_start</span><span class=p>(</span><span class=n>ap</span><span class=p>,</span> <span class=n>fmt</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=kt>int</span> <span class=n>res</span> <span class=o>=</span> <span class=nf>__vfxprintf</span><span class=p>(</span><span class=n>fp</span><span class=p>,</span> <span class=n>fmt</span><span class=p>,</span> <span class=n>ap</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=nf>va_end</span><span class=p>(</span><span class=n>ap</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>res</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div><h4 id=__vfxprintf>__vfxprintf</h4><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-c"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=复制到剪贴板><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=kt>int</span> <span class=nf>__vfxprintf</span><span class=p>(</span><span class=n>FILE</span> <span class=o>*</span><span class=n>fp</span><span class=p>,</span> <span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=n>fmt</span><span class=p>,</span> <span class=n>va_list</span> <span class=n>ap</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=kt>unsigned</span> <span class=kt>int</span> <span class=n>mode_flags</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>fp</span> <span class=o>==</span> <span class=nb>NULL</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>fp</span> <span class=o>=</span> <span class=n>stderr</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nf>_IO_flockfile</span><span class=p>(</span><span class=n>fp</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=kt>int</span> <span class=n>res</span> <span class=o>=</span> <span class=nf>locked_vfxprintf</span><span class=p>(</span><span class=n>fp</span><span class=p>,</span> <span class=n>fmt</span><span class=p>,</span> <span class=n>ap</span><span class=p>,</span> <span class=n>mode_flags</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=nf>_IO_funlockfile</span><span class=p>(</span><span class=n>fp</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>res</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div><h4 id=locked_vfxprintf>locked_vfxprintf</h4><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-c"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=复制到剪贴板><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=c1>// # define vfprintf	__vfprintf_internal
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=kt>int</span>
</span></span><span class=line><span class=cl><span class=nf>locked_vfxprintf</span><span class=p>(</span><span class=n>FILE</span> <span class=o>*</span><span class=n>fp</span><span class=p>,</span> <span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=n>fmt</span><span class=p>,</span> <span class=n>va_list</span> <span class=n>ap</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                 <span class=kt>unsigned</span> <span class=kt>int</span> <span class=n>mode_flags</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nf>_IO_fwide</span><span class=p>(</span><span class=n>fp</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span> <span class=o>&lt;=</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nf>__vfprintf_internal</span><span class=p>(</span><span class=n>fp</span><span class=p>,</span> <span class=n>fmt</span><span class=p>,</span> <span class=n>ap</span><span class=p>,</span> <span class=n>mode_flags</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kt>wchar_t</span> <span class=o>*</span><span class=n>wfmt</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>mbstate_t</span> <span class=n>mbstate</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>int</span> <span class=n>res</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>int</span> <span class=n>used_malloc</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>size_t</span> <span class=n>len</span> <span class=o>=</span> <span class=nf>strlen</span><span class=p>(</span><span class=n>fmt</span><span class=p>)</span> <span class=o>+</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nf>__glibc_unlikely</span><span class=p>(</span><span class=n>len</span> <span class=o>&gt;</span> <span class=n>SIZE_MAX</span> <span class=o>/</span> <span class=k>sizeof</span><span class=p>(</span><span class=kt>wchar_t</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nf>__set_errno</span><span class=p>(</span><span class=n>EOVERFLOW</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nf>__libc_use_alloca</span><span class=p>(</span><span class=n>len</span> <span class=o>*</span> <span class=k>sizeof</span><span class=p>(</span><span class=kt>wchar_t</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>    <span class=n>wfmt</span> <span class=o>=</span> <span class=nf>alloca</span><span class=p>(</span><span class=n>len</span> <span class=o>*</span> <span class=k>sizeof</span><span class=p>(</span><span class=kt>wchar_t</span><span class=p>));</span>
</span></span><span class=line><span class=cl>  <span class=k>else</span> <span class=k>if</span> <span class=p>((</span><span class=n>wfmt</span> <span class=o>=</span> <span class=nf>malloc</span><span class=p>(</span><span class=n>len</span> <span class=o>*</span> <span class=k>sizeof</span><span class=p>(</span><span class=kt>wchar_t</span><span class=p>)))</span> <span class=o>==</span> <span class=nb>NULL</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>else</span>
</span></span><span class=line><span class=cl>    <span class=n>used_malloc</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nf>memset</span><span class=p>(</span><span class=o>&amp;</span><span class=n>mbstate</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=k>sizeof</span> <span class=n>mbstate</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=n>res</span> <span class=o>=</span> <span class=nf>__mbsrtowcs</span><span class=p>(</span><span class=n>wfmt</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>fmt</span><span class=p>,</span> <span class=n>len</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>mbstate</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>res</span> <span class=o>!=</span> <span class=o>-</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>res</span> <span class=o>=</span> <span class=nf>__vfwprintf_internal</span><span class=p>(</span><span class=n>fp</span><span class=p>,</span> <span class=n>wfmt</span><span class=p>,</span> <span class=n>ap</span><span class=p>,</span> <span class=n>mode_flags</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>used_malloc</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nf>free</span><span class=p>(</span><span class=n>wfmt</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>res</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div><h4 id=__printf>__printf</h4><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-c"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=复制到剪贴板><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=kt>int</span> <span class=nf>__printf</span> <span class=p>(</span><span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=n>format</span><span class=p>,</span> <span class=p>...)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>va_list</span> <span class=n>arg</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>int</span> <span class=n>done</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nf>va_start</span> <span class=p>(</span><span class=n>arg</span><span class=p>,</span> <span class=n>format</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=n>done</span> <span class=o>=</span> <span class=nf>__vfprintf_internal</span> <span class=p>(</span><span class=n>stdout</span><span class=p>,</span> <span class=n>format</span><span class=p>,</span> <span class=n>arg</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=nf>va_end</span> <span class=p>(</span><span class=n>arg</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>done</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div><h4 id=__register_printf_function>__register_printf_function</h4><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-c"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=复制到剪贴板><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=kt>int</span> <span class=nf>__register_printf_function</span><span class=p>(</span><span class=kt>int</span> <span class=n>spec</span><span class=p>,</span> <span class=n>printf_function</span> <span class=n>converter</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>                               <span class=n>printf_arginfo_function</span> <span class=n>arginfo</span><span class=p>){</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nf>__register_printf_specifier</span><span class=p>(</span><span class=n>spec</span><span class=p>,</span> <span class=n>converter</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                                       <span class=p>(</span><span class=n>printf_arginfo_size_function</span> <span class=o>*</span><span class=p>)</span><span class=n>arginfo</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=nf>weak_alias</span><span class=p>(</span><span class=n>__register_printf_function</span><span class=p>,</span> <span class=n>register_printf_function</span><span class=p>)</span></span></span></code></pre></div></div><h4 id=__register_printf_specifier>__register_printf_specifier</h4><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-c"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=复制到剪贴板><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=kt>int</span> <span class=nf>__register_printf_specifier</span><span class=p>(</span><span class=kt>int</span> <span class=n>spec</span><span class=p>,</span> <span class=n>printf_function</span> <span class=n>converter</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                                <span class=n>printf_arginfo_size_function</span> <span class=n>arginfo</span><span class=p>){</span>
</span></span><span class=line><span class=cl>  <span class=c1>// spec: fmt的ascii码, converter与arginfo: 要绑定的函数与参数指针
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=p>(</span><span class=n>spec</span> <span class=o>&lt;</span> <span class=mi>0</span> <span class=o>||</span> <span class=n>spec</span> <span class=o>&gt;</span> <span class=p>(</span><span class=kt>int</span><span class=p>)</span><span class=n>UCHAR_MAX</span><span class=p>)</span> <span class=c1>// UCHAR_MAX: SCHAR_MAX[0x7f] * 2 + 1 = 0xff
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nf>__set_errno</span><span class=p>(</span><span class=n>EINVAL</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kt>int</span> <span class=n>result</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nf>__libc_lock_lock</span><span class=p>(</span><span class=n>lock</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  <span class=c1>// 若该表是空的
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=p>(</span><span class=n>__printf_function_table</span> <span class=o>==</span> <span class=nb>NULL</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// calloc分配一块内存对arginfo表进行初始化，一次性分配两个指针份的堆块
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>__printf_arginfo_table</span> <span class=o>=</span> <span class=p>(</span><span class=n>printf_arginfo_size_function</span> <span class=o>**</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nf>calloc</span><span class=p>(</span><span class=n>UCHAR_MAX</span> <span class=o>+</span> <span class=mi>1</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=kt>void</span> <span class=o>*</span><span class=p>)</span> <span class=o>*</span> <span class=mi>2</span><span class=p>);</span><span class=c1>// void * 为8字节，共申请0x10 * 0x100
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=n>__printf_arginfo_table</span> <span class=o>==</span> <span class=nb>NULL</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>result</span> <span class=o>=</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=k>goto</span> <span class=n>out</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=c1>// 初始化function表，紧邻arginfo表
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>__printf_function_table</span> <span class=o>=</span> <span class=p>(</span><span class=n>printf_function</span> <span class=o>**</span><span class=p>)(</span><span class=n>__printf_arginfo_table</span> <span class=o>+</span> <span class=n>UCHAR_MAX</span> <span class=o>+</span> <span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 绑定
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>__printf_function_table</span><span class=p>[</span><span class=n>spec</span><span class=p>]</span> <span class=o>=</span> <span class=n>converter</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>__printf_arginfo_table</span><span class=p>[</span><span class=n>spec</span><span class=p>]</span> <span class=o>=</span> <span class=n>arginfo</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nl>out</span><span class=p>:</span>
</span></span><span class=line><span class=cl>  <span class=nf>__libc_lock_unlock</span><span class=p>(</span><span class=n>lock</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>result</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=nf>libc_hidden_def</span><span class=p>(</span><span class=n>__register_printf_specifier</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nf>weak_alias</span><span class=p>(</span><span class=n>__register_printf_specifier</span><span class=p>,</span> <span class=n>register_printf_specifier</span><span class=p>)</span></span></span></code></pre></div></div><h3 id=assert>assert</h3><h4 id=__malloc_assert>__malloc_assert</h4><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-c"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=复制到剪贴板><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>static</span> <span class=kt>void</span>
</span></span><span class=line><span class=cl><span class=nf>__malloc_assert</span> <span class=p>(</span><span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=n>assertion</span><span class=p>,</span> <span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=n>file</span><span class=p>,</span> <span class=kt>unsigned</span> <span class=kt>int</span> <span class=n>line</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		 <span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=n>function</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=p>(</span><span class=kt>void</span><span class=p>)</span> <span class=nf>__fxprintf</span> <span class=p>(</span><span class=nb>NULL</span><span class=p>,</span> <span class=s>&#34;%s%s%s:%u: %s%sAssertion `%s&#39; failed.</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		     <span class=n>__progname</span><span class=p>,</span> <span class=n>__progname</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>?</span> <span class=s>&#34;: &#34;</span> <span class=o>:</span> <span class=s>&#34;&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		     <span class=n>file</span><span class=p>,</span> <span class=n>line</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		     <span class=n>function</span> <span class=o>?</span> <span class=nl>function</span> <span class=p>:</span> <span class=s>&#34;&#34;</span><span class=p>,</span> <span class=n>function</span> <span class=o>?</span> <span class=s>&#34;: &#34;</span> <span class=o>:</span> <span class=s>&#34;&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		     <span class=n>assertion</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=nf>fflush</span> <span class=p>(</span><span class=n>stderr</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=nf>abort</span> <span class=p>();</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div><h3 id=cookie>cookie</h3><h4 id=_io_cookie_read>_IO_cookie_read</h4><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-c"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=复制到剪贴板><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>static</span> <span class=kt>ssize_t</span>
</span></span><span class=line><span class=cl><span class=nf>_IO_cookie_read</span><span class=p>(</span><span class=n>FILE</span> <span class=o>*</span><span class=n>fp</span><span class=p>,</span> <span class=kt>void</span> <span class=o>*</span><span class=n>buf</span><span class=p>,</span> <span class=kt>ssize_t</span> <span class=n>size</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 将fp转换为_IO_cookie_file *类型的cfile结构体
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>struct</span> <span class=n>_IO_cookie_file</span> <span class=o>*</span><span class=n>cfile</span> <span class=o>=</span> <span class=p>(</span><span class=k>struct</span> <span class=n>_IO_cookie_file</span> <span class=o>*</span><span class=p>)</span><span class=n>fp</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 通过偏移取出存放在read对应对象中的函数指针
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kt>cookie_read_function_t</span> <span class=o>*</span><span class=n>read_cb</span> <span class=o>=</span> <span class=n>cfile</span><span class=o>-&gt;</span><span class=n>__io_functions</span><span class=p>.</span><span class=n>read</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=cp>#ifdef PTR_DEMANGLE
</span></span></span><span class=line><span class=cl><span class=cp></span>  <span class=nf>PTR_DEMANGLE</span><span class=p>(</span><span class=n>read_cb</span><span class=p>);</span> <span class=c1>// 进行了加密
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=cp>#endif
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>read_cb</span> <span class=o>==</span> <span class=nb>NULL</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nf>read_cb</span><span class=p>(</span><span class=n>cfile</span><span class=o>-&gt;</span><span class=n>__cookie</span><span class=p>,</span> <span class=n>buf</span><span class=p>,</span> <span class=n>size</span><span class=p>);</span> <span class=c1>// 调用该指针，传入参数为__cookie
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span></span></span></code></pre></div></div><h4 id=_io_cookie_write>_IO_cookie_write</h4><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-c"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=复制到剪贴板><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>static</span> <span class=kt>ssize_t</span>
</span></span><span class=line><span class=cl><span class=nf>_IO_cookie_write</span><span class=p>(</span><span class=n>FILE</span> <span class=o>*</span><span class=n>fp</span><span class=p>,</span> <span class=k>const</span> <span class=kt>void</span> <span class=o>*</span><span class=n>buf</span><span class=p>,</span> <span class=kt>ssize_t</span> <span class=n>size</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>struct</span> <span class=n>_IO_cookie_file</span> <span class=o>*</span><span class=n>cfile</span> <span class=o>=</span> <span class=p>(</span><span class=k>struct</span> <span class=n>_IO_cookie_file</span> <span class=o>*</span><span class=p>)</span><span class=n>fp</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>cookie_write_function_t</span> <span class=o>*</span><span class=n>write_cb</span> <span class=o>=</span> <span class=n>cfile</span><span class=o>-&gt;</span><span class=n>__io_functions</span><span class=p>.</span><span class=n>write</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=cp>#ifdef PTR_DEMANGLE
</span></span></span><span class=line><span class=cl><span class=cp></span>  <span class=c1>// 对指针进行加密：取出对应函数指针，将函数指针循环右移11位，并与`fs:[0x30]`异或得到真正函数地址
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nf>PTR_DEMANGLE</span><span class=p>(</span><span class=n>write_cb</span><span class=p>);</span> 
</span></span><span class=line><span class=cl><span class=cp>#endif
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>write_cb</span> <span class=o>==</span> <span class=nb>NULL</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>fp</span><span class=o>-&gt;</span><span class=n>_flags</span> <span class=o>|=</span> <span class=n>_IO_ERR_SEEN</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=kt>ssize_t</span> <span class=n>n</span> <span class=o>=</span> <span class=nf>write_cb</span><span class=p>(</span><span class=n>cfile</span><span class=o>-&gt;</span><span class=n>__cookie</span><span class=p>,</span> <span class=n>buf</span><span class=p>,</span> <span class=n>size</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>n</span> <span class=o>&lt;</span> <span class=n>size</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>fp</span><span class=o>-&gt;</span><span class=n>_flags</span> <span class=o>|=</span> <span class=n>_IO_ERR_SEEN</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>n</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div><h4 id=_io_cookie_close>_IO_cookie_close</h4><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-c"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=复制到剪贴板><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>static</span> <span class=kt>int</span>
</span></span><span class=line><span class=cl><span class=nf>_IO_cookie_close</span><span class=p>(</span><span class=n>FILE</span> <span class=o>*</span><span class=n>fp</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>struct</span> <span class=n>_IO_cookie_file</span> <span class=o>*</span><span class=n>cfile</span> <span class=o>=</span> <span class=p>(</span><span class=k>struct</span> <span class=n>_IO_cookie_file</span> <span class=o>*</span><span class=p>)</span><span class=n>fp</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>cookie_close_function_t</span> <span class=o>*</span><span class=n>close_cb</span> <span class=o>=</span> <span class=n>cfile</span><span class=o>-&gt;</span><span class=n>__io_functions</span><span class=p>.</span><span class=n>close</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=cp>#ifdef PTR_DEMANGLE
</span></span></span><span class=line><span class=cl><span class=cp></span>  <span class=nf>PTR_DEMANGLE</span><span class=p>(</span><span class=n>close_cb</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=cp>#endif
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>close_cb</span> <span class=o>==</span> <span class=nb>NULL</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nf>close_cb</span><span class=p>(</span><span class=n>cfile</span><span class=o>-&gt;</span><span class=n>__cookie</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div><h4 id=_io_cookie_seek>_IO_cookie_seek</h4><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-c"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=复制到剪贴板><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>static</span> <span class=kt>off64_t</span>
</span></span><span class=line><span class=cl><span class=nf>_IO_cookie_seek</span><span class=p>(</span><span class=n>FILE</span> <span class=o>*</span><span class=n>fp</span><span class=p>,</span> <span class=kt>off64_t</span> <span class=n>offset</span><span class=p>,</span> <span class=kt>int</span> <span class=n>dir</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>struct</span> <span class=n>_IO_cookie_file</span> <span class=o>*</span><span class=n>cfile</span> <span class=o>=</span> <span class=p>(</span><span class=k>struct</span> <span class=n>_IO_cookie_file</span> <span class=o>*</span><span class=p>)</span><span class=n>fp</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>cookie_seek_function_t</span> <span class=o>*</span><span class=n>seek_cb</span> <span class=o>=</span> <span class=n>cfile</span><span class=o>-&gt;</span><span class=n>__io_functions</span><span class=p>.</span><span class=n>seek</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=cp>#ifdef PTR_DEMANGLE
</span></span></span><span class=line><span class=cl><span class=cp></span>  <span class=nf>PTR_DEMANGLE</span><span class=p>(</span><span class=n>seek_cb</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=cp>#endif
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=p>((</span><span class=n>seek_cb</span> <span class=o>==</span> <span class=nb>NULL</span> <span class=o>||</span> <span class=p>(</span><span class=nf>seek_cb</span><span class=p>(</span><span class=n>cfile</span><span class=o>-&gt;</span><span class=n>__cookie</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>offset</span><span class=p>,</span> <span class=n>dir</span><span class=p>)</span> <span class=o>==</span> <span class=o>-</span><span class=mi>1</span><span class=p>)</span> <span class=o>||</span> <span class=n>offset</span> <span class=o>==</span> <span class=p>(</span><span class=kt>off64_t</span><span class=p>)</span><span class=o>-</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>              <span class=o>?</span> <span class=nl>_IO_pos_BAD</span>
</span></span><span class=line><span class=cl>              <span class=p>:</span> <span class=n>offset</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div><h3 id=house-of-apple>house of apple</h3><p>记录相关一些函数</p><h4 id=_io_wstrn_overflow>_IO_wstrn_overflow</h4><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-c"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=复制到剪贴板><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>static</span> <span class=kt>wint_t</span> <span class=nf>_IO_wstrn_overflow</span> <span class=p>(</span><span class=n>FILE</span> <span class=o>*</span><span class=n>fp</span><span class=p>,</span> <span class=kt>wint_t</span> <span class=n>c</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 先将 fp 强制转换为_IO_wstrnfile *指针
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>_IO_wstrnfile</span> <span class=o>*</span><span class=n>snf</span> <span class=o>=</span> <span class=p>(</span><span class=n>_IO_wstrnfile</span> <span class=o>*</span><span class=p>)</span> <span class=n>fp</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>fp</span><span class=o>-&gt;</span><span class=n>_wide_data</span><span class=o>-&gt;</span><span class=n>_IO_buf_base</span> <span class=o>!=</span> <span class=n>snf</span><span class=o>-&gt;</span><span class=n>overflow_buf</span><span class=p>)</span> <span class=c1>// 一般都成立
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nf>_IO_wsetb</span> <span class=p>(</span><span class=n>fp</span><span class=p>,</span> <span class=n>snf</span><span class=o>-&gt;</span><span class=n>overflow_buf</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		 <span class=n>snf</span><span class=o>-&gt;</span><span class=n>overflow_buf</span> <span class=o>+</span> <span class=p>(</span><span class=k>sizeof</span> <span class=p>(</span><span class=n>snf</span><span class=o>-&gt;</span><span class=n>overflow_buf</span><span class=p>)</span>
</span></span><span class=line><span class=cl>				      <span class=o>/</span> <span class=k>sizeof</span> <span class=p>(</span><span class=kt>wchar_t</span><span class=p>)),</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	  <span class=c1>// 成立会对以下四个值赋值为`snf-&gt;overflow_buf`或相关偏移值
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=n>fp</span><span class=o>-&gt;</span><span class=n>_wide_data</span><span class=o>-&gt;</span><span class=n>_IO_write_base</span> <span class=o>=</span> <span class=n>snf</span><span class=o>-&gt;</span><span class=n>overflow_buf</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=n>fp</span><span class=o>-&gt;</span><span class=n>_wide_data</span><span class=o>-&gt;</span><span class=n>_IO_read_base</span> <span class=o>=</span> <span class=n>snf</span><span class=o>-&gt;</span><span class=n>overflow_buf</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=n>fp</span><span class=o>-&gt;</span><span class=n>_wide_data</span><span class=o>-&gt;</span><span class=n>_IO_read_ptr</span> <span class=o>=</span> <span class=n>snf</span><span class=o>-&gt;</span><span class=n>overflow_buf</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=n>fp</span><span class=o>-&gt;</span><span class=n>_wide_data</span><span class=o>-&gt;</span><span class=n>_IO_read_end</span> <span class=o>=</span> <span class=p>(</span><span class=n>snf</span><span class=o>-&gt;</span><span class=n>overflow_buf</span>
</span></span><span class=line><span class=cl>				      <span class=o>+</span> <span class=p>(</span><span class=k>sizeof</span> <span class=p>(</span><span class=n>snf</span><span class=o>-&gt;</span><span class=n>overflow_buf</span><span class=p>)</span>
</span></span><span class=line><span class=cl>					 <span class=o>/</span> <span class=k>sizeof</span> <span class=p>(</span><span class=kt>wchar_t</span><span class=p>)));</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 赋值
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>fp</span><span class=o>-&gt;</span><span class=n>_wide_data</span><span class=o>-&gt;</span><span class=n>_IO_write_ptr</span> <span class=o>=</span> <span class=n>snf</span><span class=o>-&gt;</span><span class=n>overflow_buf</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>fp</span><span class=o>-&gt;</span><span class=n>_wide_data</span><span class=o>-&gt;</span><span class=n>_IO_write_end</span> <span class=o>=</span> <span class=n>snf</span><span class=o>-&gt;</span><span class=n>overflow_buf</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>c</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div><h4 id=_io_wsetb>_IO_wsetb</h4><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-c"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=复制到剪贴板><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=kt>void</span> <span class=nf>_IO_wsetb</span> <span class=p>(</span><span class=n>FILE</span> <span class=o>*</span><span class=n>f</span><span class=p>,</span> <span class=kt>wchar_t</span> <span class=o>*</span><span class=n>b</span><span class=p>,</span> <span class=kt>wchar_t</span> <span class=o>*</span><span class=n>eb</span><span class=p>,</span> <span class=kt>int</span> <span class=n>a</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>f</span><span class=o>-&gt;</span><span class=n>_wide_data</span><span class=o>-&gt;</span><span class=n>_IO_buf_base</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=p>(</span><span class=n>f</span><span class=o>-&gt;</span><span class=n>_flags2</span> <span class=o>&amp;</span> <span class=n>_IO_FLAGS2_USER_WBUF</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=nf>free</span> <span class=p>(</span><span class=n>f</span><span class=o>-&gt;</span><span class=n>_wide_data</span><span class=o>-&gt;</span><span class=n>_IO_buf_base</span><span class=p>);</span> <span class=c1>// 其不为0的时候不要执行到这里
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>f</span><span class=o>-&gt;</span><span class=n>_wide_data</span><span class=o>-&gt;</span><span class=n>_IO_buf_base</span> <span class=o>=</span> <span class=n>b</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>f</span><span class=o>-&gt;</span><span class=n>_wide_data</span><span class=o>-&gt;</span><span class=n>_IO_buf_end</span> <span class=o>=</span> <span class=n>eb</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>a</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>f</span><span class=o>-&gt;</span><span class=n>_flags2</span> <span class=o>&amp;=</span> <span class=o>~</span><span class=n>_IO_FLAGS2_USER_WBUF</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>else</span>
</span></span><span class=line><span class=cl>    <span class=n>f</span><span class=o>-&gt;</span><span class=n>_flags2</span> <span class=o>|=</span> <span class=n>_IO_FLAGS2_USER_WBUF</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div><h4 id=__libio_codecvt_in>__libio_codecvt_in</h4><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-c"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=复制到剪贴板><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>enum</span> <span class=n>__codecvt_result</span>
</span></span><span class=line><span class=cl><span class=nf>__libio_codecvt_in</span> <span class=p>(</span><span class=k>struct</span> <span class=n>_IO_codecvt</span> <span class=o>*</span><span class=n>codecvt</span><span class=p>,</span> <span class=n>__mbstate_t</span> <span class=o>*</span><span class=n>statep</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		    <span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=n>from_start</span><span class=p>,</span> <span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=n>from_end</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		    <span class=k>const</span> <span class=kt>char</span> <span class=o>**</span><span class=n>from_stop</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		    <span class=kt>wchar_t</span> <span class=o>*</span><span class=n>to_start</span><span class=p>,</span> <span class=kt>wchar_t</span> <span class=o>*</span><span class=n>to_end</span><span class=p>,</span> <span class=kt>wchar_t</span> <span class=o>**</span><span class=n>to_stop</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>enum</span> <span class=n>__codecvt_result</span> <span class=n>result</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>struct</span> <span class=n>__gconv_step</span> <span class=o>*</span><span class=n>gs</span> <span class=o>=</span> <span class=n>codecvt</span><span class=o>-&gt;</span><span class=n>__cd_in</span><span class=p>.</span><span class=n>step</span><span class=p>;</span> <span class=c1>// // gs 源自第一个参数
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=kt>int</span> <span class=n>status</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>size_t</span> <span class=n>dummy</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>const</span> <span class=kt>unsigned</span> <span class=kt>char</span> <span class=o>*</span><span class=n>from_start_copy</span> <span class=o>=</span> <span class=p>(</span><span class=kt>unsigned</span> <span class=kt>char</span> <span class=o>*</span><span class=p>)</span> <span class=n>from_start</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>codecvt</span><span class=o>-&gt;</span><span class=n>__cd_in</span><span class=p>.</span><span class=n>step_data</span><span class=p>.</span><span class=n>__outbuf</span> <span class=o>=</span> <span class=p>(</span><span class=kt>unsigned</span> <span class=kt>char</span> <span class=o>*</span><span class=p>)</span> <span class=n>to_start</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>codecvt</span><span class=o>-&gt;</span><span class=n>__cd_in</span><span class=p>.</span><span class=n>step_data</span><span class=p>.</span><span class=n>__outbufend</span> <span class=o>=</span> <span class=p>(</span><span class=kt>unsigned</span> <span class=kt>char</span> <span class=o>*</span><span class=p>)</span> <span class=n>to_end</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>codecvt</span><span class=o>-&gt;</span><span class=n>__cd_in</span><span class=p>.</span><span class=n>step_data</span><span class=p>.</span><span class=n>__statep</span> <span class=o>=</span> <span class=n>statep</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>__gconv_fct</span> <span class=n>fct</span> <span class=o>=</span> <span class=n>gs</span><span class=o>-&gt;</span><span class=n>__fct</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 若其不为空，用__pointer_guard解密，设置为NULL可绕过解密
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=p>(</span><span class=n>gs</span><span class=o>-&gt;</span><span class=n>__shlib_handle</span> <span class=o>!=</span> <span class=nb>NULL</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nf>PTR_DEMANGLE</span> <span class=p>(</span><span class=n>fct</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 函数指针调用，该宏实际调用fct(gs, ...)
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>status</span> <span class=o>=</span> <span class=nf>DL_CALL_FCT</span> <span class=p>(</span><span class=n>fct</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=p>(</span><span class=n>gs</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>codecvt</span><span class=o>-&gt;</span><span class=n>__cd_in</span><span class=p>.</span><span class=n>step_data</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>from_start_copy</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			 <span class=p>(</span><span class=k>const</span> <span class=kt>unsigned</span> <span class=kt>char</span> <span class=o>*</span><span class=p>)</span> <span class=n>from_end</span><span class=p>,</span> <span class=nb>NULL</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			 <span class=o>&amp;</span><span class=n>dummy</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=o>*</span><span class=n>from_stop</span> <span class=o>=</span> <span class=p>(</span><span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=p>)</span> <span class=n>from_start_copy</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=o>*</span><span class=n>to_stop</span> <span class=o>=</span> <span class=p>(</span><span class=kt>wchar_t</span> <span class=o>*</span><span class=p>)</span> <span class=n>codecvt</span><span class=o>-&gt;</span><span class=n>__cd_in</span><span class=p>.</span><span class=n>step_data</span><span class=p>.</span><span class=n>__outbuf</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>switch</span> <span class=p>(</span><span class=n>status</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>case</span> <span class=nl>__GCONV_OK</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>case</span> <span class=nl>__GCONV_EMPTY_INPUT</span><span class=p>:</span>
</span></span><span class=line><span class=cl>      <span class=n>result</span> <span class=o>=</span> <span class=n>__codecvt_ok</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>case</span> <span class=nl>__GCONV_FULL_OUTPUT</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>case</span> <span class=nl>__GCONV_INCOMPLETE_INPUT</span><span class=p>:</span>
</span></span><span class=line><span class=cl>      <span class=n>result</span> <span class=o>=</span> <span class=n>__codecvt_partial</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>default</span><span class=o>:</span>
</span></span><span class=line><span class=cl>      <span class=n>result</span> <span class=o>=</span> <span class=n>__codecvt_error</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=n>result</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div><h2 id=ldso>ld.so</h2><h3 id=结构-2>结构</h3><h4 id=rtld_global>rtld_global</h4><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-c"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=复制到剪贴板><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>struct</span> <span class=n>rtld_global</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl><span class=cp>#endif
</span></span></span><span class=line><span class=cl><span class=cp>#ifdef SHARED
</span></span></span><span class=line><span class=cl><span class=cp># define DL_NNS 16
</span></span></span><span class=line><span class=cl><span class=cp>#else
</span></span></span><span class=line><span class=cl><span class=cp># define DL_NNS 1
</span></span></span><span class=line><span class=cl><span class=cp>#endif
</span></span></span><span class=line><span class=cl><span class=cp></span>  <span class=n>EXTERN</span> <span class=k>struct</span> <span class=n>link_namespaces</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>struct</span> <span class=n>link_map</span> <span class=o>*</span><span class=n>_ns_loaded</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>unsigned</span> <span class=kt>int</span> <span class=n>_ns_nloaded</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>struct</span> <span class=n>r_scope_elem</span> <span class=o>*</span><span class=n>_ns_main_searchlist</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kt>unsigned</span> <span class=kt>int</span> <span class=n>_ns_global_scope_alloc</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>unsigned</span> <span class=kt>int</span> <span class=n>_ns_global_scope_pending_adds</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>struct</span> <span class=n>link_map</span> <span class=o>*</span><span class=n>libc_map</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>struct</span> <span class=n>unique_sym_table</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nf>__rtld_lock_define_recursive</span> <span class=p>(,</span> <span class=n>lock</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=k>struct</span> <span class=n>unique_sym</span>
</span></span><span class=line><span class=cl>      <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=kt>uint32_t</span> <span class=n>hashval</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=n>name</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>const</span> <span class=nf>ElfW</span><span class=p>(</span><span class=n>Sym</span><span class=p>)</span> <span class=o>*</span><span class=n>sym</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>const</span> <span class=k>struct</span> <span class=n>link_map</span> <span class=o>*</span><span class=n>map</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span> <span class=o>*</span><span class=n>entries</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=kt>size_t</span> <span class=n>size</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=kt>size_t</span> <span class=n>n_elements</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=kt>void</span> <span class=p>(</span><span class=o>*</span><span class=n>free</span><span class=p>)</span> <span class=p>(</span><span class=kt>void</span> <span class=o>*</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=n>_ns_unique_sym_table</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>struct</span> <span class=n>r_debug_extended</span> <span class=n>_ns_debug</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=n>_dl_ns</span><span class=p>[</span><span class=n>DL_NNS</span><span class=p>];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>EXTERN</span> <span class=kt>size_t</span> <span class=n>_dl_nns</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>......</span></span></span></code></pre></div></div><h4 id=_rtld_global>_rtld_global</h4><p>可用 gdb 查看<code>p _rtld_global</code></p><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-c"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=复制到剪贴板><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=c1>// glibc-2.38 rtld.c 该变量在 ld.so 内存地址范围内
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=k>struct</span> <span class=n>rtld_global</span> <span class=n>_rtld_global</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;dl-procruntime.c&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>    <span class=p>.</span><span class=n>_dl_stack_flags</span> <span class=o>=</span> <span class=n>DEFAULT_STACK_PERMS</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=cp>#ifdef _LIBC_REENTRANT
</span></span></span><span class=line><span class=cl><span class=cp></span>    <span class=p>.</span><span class=n>_dl_load_lock</span> <span class=o>=</span> <span class=n>_RTLD_LOCK_RECURSIVE_INITIALIZER</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=n>_dl_load_write_lock</span> <span class=o>=</span> <span class=n>_RTLD_LOCK_RECURSIVE_INITIALIZER</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=n>_dl_load_tls_lock</span> <span class=o>=</span> <span class=n>_RTLD_LOCK_RECURSIVE_INITIALIZER</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=cp>#endif
</span></span></span><span class=line><span class=cl><span class=cp></span>    <span class=p>.</span><span class=n>_dl_nns</span> <span class=o>=</span> <span class=mi>1</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=n>_dl_ns</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl><span class=cp>#ifdef _LIBC_REENTRANT
</span></span></span><span class=line><span class=cl><span class=cp></span>      <span class=p>[</span><span class=n>LM_ID_BASE</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span> <span class=p>.</span><span class=n>_ns_unique_sym_table</span>
</span></span><span class=line><span class=cl>		       <span class=o>=</span> <span class=p>{</span> <span class=p>.</span><span class=n>lock</span> <span class=o>=</span> <span class=n>_RTLD_LOCK_RECURSIVE_INITIALIZER</span> <span class=p>}</span> <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=cp>#endif
</span></span></span><span class=line><span class=cl><span class=cp></span>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>};</span></span></span></code></pre></div></div><h4 id=_dl_ns>_dl_ns</h4><div class="code-block code-line-numbers" style="counter-reset:code-block 0"><div class="code-header language-c"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=复制到剪贴板><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=c1>// _dl_ns 为 link_namespaces 结构体 16 项数组
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>pwndbg</span><span class=o>&gt;</span> <span class=n>p</span> <span class=o>&amp;</span><span class=n>_rtld_global</span><span class=p>.</span><span class=n>_dl_ns</span>
</span></span><span class=line><span class=cl><span class=err>$</span><span class=mi>1</span> <span class=o>=</span> <span class=p>(</span><span class=k>struct</span> <span class=nf>link_namespaces</span> <span class=p>(</span><span class=o>*</span><span class=p>)[</span><span class=mi>16</span><span class=p>])</span> <span class=mh>0x7ffff7ffd040</span> <span class=o>&lt;</span><span class=n>_rtld_local</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>pwndbg</span><span class=o>&gt;</span> <span class=n>p</span> <span class=n>_rtld_global</span><span class=p>.</span><span class=n>_dl_ns</span>
</span></span><span class=line><span class=cl><span class=err>$</span><span class=mi>2</span> <span class=o>=</span> <span class=p>{{</span>
</span></span><span class=line><span class=cl>    <span class=n>_ns_loaded</span> <span class=o>=</span> <span class=mh>0x7ffff7ffe168</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>_ns_nloaded</span> <span class=o>=</span> <span class=mi>4</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>_ns_main_searchlist</span> <span class=o>=</span> <span class=mh>0x7ffff7ffe420</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>_ns_global_scope_alloc</span> <span class=o>=</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>_ns_unique_sym_table</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>lock</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>mutex</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=n>__data</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>__lock</span> <span class=o>=</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>__count</span> <span class=o>=</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>__owner</span> <span class=o>=</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>__nusers</span> <span class=o>=</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>__kind</span> <span class=o>=</span> <span class=mi>1</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>__spins</span> <span class=o>=</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>__elision</span> <span class=o>=</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>__list</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>              <span class=n>__prev</span> <span class=o>=</span> <span class=mh>0x0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>              <span class=n>__next</span> <span class=o>=</span> <span class=mh>0x0</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>          <span class=p>},</span>
</span></span><span class=line><span class=cl>          <span class=n>__size</span> <span class=o>=</span> <span class=sc>&#39;\000&#39;</span> <span class=o>&lt;</span><span class=n>repeats</span> <span class=mi>16</span> <span class=n>times</span><span class=o>&gt;</span><span class=p>,</span> <span class=s>&#34;</span><span class=se>\001</span><span class=s>&#34;</span><span class=p>,</span> <span class=sc>&#39;\000&#39;</span> <span class=o>&lt;</span><span class=n>repeats</span> <span class=mi>22</span> <span class=n>times</span><span class=o>&gt;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=n>__align</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=p>},</span>
</span></span><span class=line><span class=cl>      <span class=n>entries</span> <span class=o>=</span> <span class=mh>0x0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=n>size</span> <span class=o>=</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=n>n_elements</span> <span class=o>=</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=n>free</span> <span class=o>=</span> <span class=mh>0x0</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=n>_ns_debug</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>r_version</span> <span class=o>=</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=n>r_map</span> <span class=o>=</span> <span class=mh>0x0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=n>r_brk</span> <span class=o>=</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=n>r_state</span> <span class=o>=</span> <span class=n>RT_CONSISTENT</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=n>r_ldbase</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>_ns_loaded</span> <span class=o>=</span> <span class=mh>0x0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>_ns_nloaded</span> <span class=o>=</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>_ns_main_searchlist</span> <span class=o>=</span> <span class=mh>0x0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>_ns_global_scope_alloc</span> <span class=o>=</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>_ns_unique_sym_table</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>lock</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>mutex</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=n>__data</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>__lock</span> <span class=o>=</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>__count</span> <span class=o>=</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>__owner</span> <span class=o>=</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>__nusers</span> <span class=o>=</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>__kind</span> <span class=o>=</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>__spins</span> <span class=o>=</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>__elision</span> <span class=o>=</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>__list</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>              <span class=n>__prev</span> <span class=o>=</span> <span class=mh>0x0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>              <span class=n>__next</span> <span class=o>=</span> <span class=mh>0x0</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>          <span class=p>},</span>
</span></span><span class=line><span class=cl>          <span class=n>__size</span> <span class=o>=</span> <span class=sc>&#39;\000&#39;</span> <span class=o>&lt;</span><span class=n>repeats</span> <span class=mi>39</span> <span class=n>times</span><span class=o>&gt;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=n>__align</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=p>},</span>
</span></span><span class=line><span class=cl>      <span class=n>entries</span> <span class=o>=</span> <span class=mh>0x0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=n>size</span> <span class=o>=</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=n>n_elements</span> <span class=o>=</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=n>free</span> <span class=o>=</span> <span class=mh>0x0</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=n>_ns_debug</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>r_version</span> <span class=o>=</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=n>r_map</span> <span class=o>=</span> <span class=mh>0x0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=n>r_brk</span> <span class=o>=</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=n>r_state</span> <span class=o>=</span> <span class=n>RT_CONSISTENT</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=n>r_ldbase</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=o>&lt;</span><span class=n>repeats</span> <span class=mi>15</span> <span class=n>times</span><span class=o>&gt;</span><span class=p>}</span></span></span></code></pre></div></div><p><strong>第 0 项</strong></p><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-c"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=复制到剪贴板><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=n>pwndbg</span><span class=o>&gt;</span> <span class=n>p</span> <span class=n>_rtld_global</span><span class=p>.</span><span class=n>_dl_ns</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=err>$</span><span class=mi>9</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>_ns_loaded</span> <span class=o>=</span> <span class=mh>0x7ffff7ffe168</span><span class=p>,</span> <span class=c1>// (struct link_map *) 指向 link_map 结构体的指针
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>_ns_nloaded</span> <span class=o>=</span> <span class=mi>4</span><span class=p>,</span> <span class=c1>// 表示 _ns_nloaded 有多少 link_map 结构体
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=n>_ns_main_searchlist</span> <span class=o>=</span> <span class=mh>0x7ffff7ffe420</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=n>_ns_global_scope_alloc</span> <span class=o>=</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=n>_ns_unique_sym_table</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>lock</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>mutex</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>__data</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=n>__lock</span> <span class=o>=</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=n>__count</span> <span class=o>=</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=n>__owner</span> <span class=o>=</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=n>__nusers</span> <span class=o>=</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=n>__kind</span> <span class=o>=</span> <span class=mi>1</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=n>__spins</span> <span class=o>=</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=n>__elision</span> <span class=o>=</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=n>__list</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>__prev</span> <span class=o>=</span> <span class=mh>0x0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=n>__next</span> <span class=o>=</span> <span class=mh>0x0</span>
</span></span><span class=line><span class=cl>          <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=n>__size</span> <span class=o>=</span> <span class=sc>&#39;\000&#39;</span> <span class=o>&lt;</span><span class=n>repeats</span> <span class=mi>16</span> <span class=n>times</span><span class=o>&gt;</span><span class=p>,</span> <span class=s>&#34;</span><span class=se>\001</span><span class=s>&#34;</span><span class=p>,</span> <span class=sc>&#39;\000&#39;</span> <span class=o>&lt;</span><span class=n>repeats</span> <span class=mi>22</span> <span class=n>times</span><span class=o>&gt;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>__align</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=n>entries</span> <span class=o>=</span> <span class=mh>0x0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>size</span> <span class=o>=</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>n_elements</span> <span class=o>=</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>free</span> <span class=o>=</span> <span class=mh>0x0</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=n>_ns_debug</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>r_version</span> <span class=o>=</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>r_map</span> <span class=o>=</span> <span class=mh>0x0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>r_brk</span> <span class=o>=</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>r_state</span> <span class=o>=</span> <span class=n>RT_CONSISTENT</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>r_ldbase</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div><h4 id=_dl_nns>_dl_nns</h4><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-c"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=复制到剪贴板><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=n>pwndbg</span><span class=o>&gt;</span> <span class=n>p</span> <span class=o>&amp;</span><span class=n>_rtld_global</span><span class=p>.</span><span class=n>_dl_nns</span>
</span></span><span class=line><span class=cl><span class=err>$</span><span class=mi>3</span> <span class=o>=</span> <span class=p>(</span><span class=kt>size_t</span> <span class=o>*</span><span class=p>)</span> <span class=mh>0x7ffff7ffd940</span> <span class=o>&lt;</span><span class=n>_rtld_local</span><span class=o>+</span><span class=mi>2304</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl><span class=n>pwndbg</span><span class=o>&gt;</span> <span class=n>p</span> <span class=n>_rtld_global</span><span class=p>.</span><span class=n>_dl_nns</span>
</span></span><span class=line><span class=cl><span class=err>$</span><span class=mi>4</span> <span class=o>=</span> <span class=mi>1</span> <span class=c1>// 表明 _dl_ns 数组中有效的项，一般为第0项
</span></span></span></code></pre></div></div><h4 id=link_map>link_map</h4><div class="code-block code-line-numbers" style="counter-reset:code-block 0"><div class="code-header language-c"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=复制到剪贴板><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>struct</span> <span class=n>link_map</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>   <span class=nf>ElfW</span><span class=p>(</span><span class=n>Addr</span><span class=p>)</span> <span class=n>l_addr</span><span class=p>;</span> <span class=c1>// 程序加载的内存基址
</span></span></span><span class=line><span class=cl><span class=c1></span>   <span class=kt>char</span> <span class=o>*</span><span class=n>l_name</span><span class=p>;</span>
</span></span><span class=line><span class=cl>   <span class=nf>ElfW</span><span class=p>(</span><span class=n>Dyn</span><span class=p>)</span> <span class=o>*</span> <span class=n>l_ld</span><span class=p>;</span>
</span></span><span class=line><span class=cl>   <span class=k>struct</span> <span class=n>link_map</span> <span class=o>*</span><span class=n>l_next</span><span class=p>,</span> <span class=o>*</span><span class=n>l_prev</span><span class=p>;</span> <span class=c1>// 双向链表结构，分别指向下一个和前一个link_map结构体
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>   <span class=k>struct</span> <span class=n>link_map</span> <span class=o>*</span><span class=n>l_real</span><span class=p>;</span> <span class=c1>// 标识该共享库的真实映射
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>   <span class=n>Lmid_t</span> <span class=n>l_ns</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   <span class=k>struct</span> <span class=n>libname_list</span> <span class=o>*</span><span class=n>l_libname</span><span class=p>;</span>
</span></span><span class=line><span class=cl>   <span class=c1>// l_info 指向 ELF 文件的Dynamic节，包括指向 DT_INIT、DT_FINI、DT_FINI_ARRAY 和其他Dynamic节的指针
</span></span></span><span class=line><span class=cl><span class=c1></span>   <span class=nf>ElfW</span><span class=p>(</span><span class=n>Dyn</span><span class=p>)</span> <span class=o>*</span> <span class=n>l_info</span><span class=p>[</span><span class=n>DT_NUM</span> <span class=o>+</span> <span class=n>DT_THISPROCNUM</span> <span class=o>+</span> <span class=n>DT_VERSIONTAGNUM</span> <span class=o>+</span> <span class=n>DT_EXTRANUM</span> <span class=o>+</span> <span class=n>DT_VALNUM</span> <span class=o>+</span> <span class=n>DT_ADDRNUM</span><span class=p>];</span>
</span></span><span class=line><span class=cl>   <span class=k>const</span> <span class=nf>ElfW</span><span class=p>(</span><span class=n>Phdr</span><span class=p>)</span> <span class=o>*</span> <span class=n>l_phdr</span><span class=p>;</span>
</span></span><span class=line><span class=cl>   <span class=nf>ElfW</span><span class=p>(</span><span class=n>Addr</span><span class=p>)</span> <span class=n>l_entry</span><span class=p>;</span>
</span></span><span class=line><span class=cl>   <span class=nf>ElfW</span><span class=p>(</span><span class=n>Half</span><span class=p>)</span> <span class=n>l_phnum</span><span class=p>;</span>
</span></span><span class=line><span class=cl>   <span class=nf>ElfW</span><span class=p>(</span><span class=n>Half</span><span class=p>)</span> <span class=n>l_ldnum</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   <span class=k>struct</span> <span class=n>r_scope_elem</span> <span class=n>l_searchlist</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   <span class=k>struct</span> <span class=n>r_scope_elem</span> <span class=n>l_symbolic_searchlist</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   <span class=k>struct</span> <span class=n>link_map</span> <span class=o>*</span><span class=n>l_loader</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   <span class=k>struct</span> <span class=n>r_found_version</span> <span class=o>*</span><span class=n>l_versions</span><span class=p>;</span>
</span></span><span class=line><span class=cl>   <span class=kt>unsigned</span> <span class=kt>int</span> <span class=n>l_nversions</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   <span class=n>Elf_Symndx</span> <span class=n>l_nbuckets</span><span class=p>;</span>
</span></span><span class=line><span class=cl>   <span class=n>Elf32_Word</span> <span class=n>l_gnu_bitmask_idxbits</span><span class=p>;</span>
</span></span><span class=line><span class=cl>   <span class=n>Elf32_Word</span> <span class=n>l_gnu_shift</span><span class=p>;</span>
</span></span><span class=line><span class=cl>   <span class=k>const</span> <span class=nf>ElfW</span><span class=p>(</span><span class=n>Addr</span><span class=p>)</span> <span class=o>*</span> <span class=n>l_gnu_bitmask</span><span class=p>;</span>
</span></span><span class=line><span class=cl>   <span class=k>union</span>
</span></span><span class=line><span class=cl>   <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>const</span> <span class=n>Elf32_Word</span> <span class=o>*</span><span class=n>l_gnu_buckets</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=k>const</span> <span class=n>Elf_Symndx</span> <span class=o>*</span><span class=n>l_chain</span><span class=p>;</span>
</span></span><span class=line><span class=cl>   <span class=p>};</span>
</span></span><span class=line><span class=cl>   <span class=k>union</span>
</span></span><span class=line><span class=cl>   <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>const</span> <span class=n>Elf32_Word</span> <span class=o>*</span><span class=n>l_gnu_chain_zero</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=k>const</span> <span class=n>Elf_Symndx</span> <span class=o>*</span><span class=n>l_buckets</span><span class=p>;</span>
</span></span><span class=line><span class=cl>   <span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   <span class=kt>unsigned</span> <span class=kt>int</span> <span class=n>l_direct_opencount</span><span class=p>;</span>
</span></span><span class=line><span class=cl>   <span class=k>enum</span>
</span></span><span class=line><span class=cl>   <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>lt_executable</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=n>lt_library</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=n>lt_loaded</span>
</span></span><span class=line><span class=cl>   <span class=p>}</span> <span class=nl>l_type</span> <span class=p>:</span> <span class=mi>2</span><span class=p>;</span>
</span></span><span class=line><span class=cl>   <span class=kt>unsigned</span> <span class=kt>int</span> <span class=nl>l_dt_relr_ref</span> <span class=p>:</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>   <span class=kt>unsigned</span> <span class=kt>int</span> <span class=nl>l_relocated</span> <span class=p>:</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>   <span class=kt>unsigned</span> <span class=kt>int</span> <span class=nl>l_init_called</span> <span class=p>:</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>   <span class=kt>unsigned</span> <span class=kt>int</span> <span class=nl>l_global</span> <span class=p>:</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>   <span class=kt>unsigned</span> <span class=kt>int</span> <span class=nl>l_reserved</span> <span class=p>:</span> <span class=mi>2</span><span class=p>;</span>
</span></span><span class=line><span class=cl>   <span class=kt>unsigned</span> <span class=kt>int</span> <span class=nl>l_main_map</span> <span class=p>:</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>   <span class=kt>unsigned</span> <span class=kt>int</span> <span class=nl>l_visited</span> <span class=p>:</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>   <span class=kt>unsigned</span> <span class=kt>int</span> <span class=nl>l_map_used</span> <span class=p>:</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>   <span class=kt>unsigned</span> <span class=kt>int</span> <span class=nl>l_map_done</span> <span class=p>:</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>   <span class=kt>unsigned</span> <span class=kt>int</span> <span class=nl>l_phdr_allocated</span> <span class=p>:</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>   <span class=kt>unsigned</span> <span class=kt>int</span> <span class=nl>l_soname_added</span> <span class=p>:</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>   <span class=kt>unsigned</span> <span class=kt>int</span> <span class=nl>l_faked</span> <span class=p>:</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>   <span class=kt>unsigned</span> <span class=kt>int</span> <span class=nl>l_need_tls_init</span> <span class=p>:</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>   <span class=kt>unsigned</span> <span class=kt>int</span> <span class=nl>l_auditing</span> <span class=p>:</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>   <span class=kt>unsigned</span> <span class=kt>int</span> <span class=nl>l_audit_any_plt</span> <span class=p>:</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>   <span class=kt>unsigned</span> <span class=kt>int</span> <span class=nl>l_removed</span> <span class=p>:</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>   <span class=kt>unsigned</span> <span class=kt>int</span> <span class=nl>l_contiguous</span> <span class=p>:</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>   <span class=kt>unsigned</span> <span class=kt>int</span> <span class=nl>l_free_initfini</span> <span class=p>:</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>   <span class=kt>unsigned</span> <span class=kt>int</span> <span class=nl>l_ld_readonly</span> <span class=p>:</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>   <span class=kt>unsigned</span> <span class=kt>int</span> <span class=nl>l_find_object_processed</span> <span class=p>:</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>   <span class=kt>bool</span> <span class=n>l_nodelete_active</span><span class=p>;</span>
</span></span><span class=line><span class=cl>   <span class=kt>bool</span> <span class=n>l_nodelete_pending</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;link_map.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl>   <span class=k>struct</span> <span class=n>r_search_path_struct</span> <span class=n>l_rpath_dirs</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   <span class=k>struct</span> <span class=n>reloc_result</span>
</span></span><span class=line><span class=cl>   <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>DL_FIXUP_VALUE_TYPE</span> <span class=n>addr</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=k>struct</span> <span class=n>link_map</span> <span class=o>*</span><span class=n>bound</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=kt>unsigned</span> <span class=kt>int</span> <span class=n>boundndx</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=kt>uint32_t</span> <span class=n>enterexit</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=kt>unsigned</span> <span class=kt>int</span> <span class=n>flags</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=kt>unsigned</span> <span class=kt>int</span> <span class=n>init</span><span class=p>;</span>
</span></span><span class=line><span class=cl>   <span class=p>}</span> <span class=o>*</span><span class=n>l_reloc_result</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   <span class=nf>ElfW</span><span class=p>(</span><span class=n>Versym</span><span class=p>)</span> <span class=o>*</span> <span class=n>l_versyms</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   <span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=n>l_origin</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   <span class=nf>ElfW</span><span class=p>(</span><span class=n>Addr</span><span class=p>)</span> <span class=n>l_map_start</span><span class=p>,</span> <span class=n>l_map_end</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   <span class=nf>ElfW</span><span class=p>(</span><span class=n>Addr</span><span class=p>)</span> <span class=n>l_text_end</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   <span class=k>struct</span> <span class=n>r_scope_elem</span> <span class=o>*</span><span class=n>l_scope_mem</span><span class=p>[</span><span class=mi>4</span><span class=p>];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   <span class=kt>size_t</span> <span class=n>l_scope_max</span><span class=p>;</span>
</span></span><span class=line><span class=cl>   <span class=k>struct</span> <span class=n>r_scope_elem</span> <span class=o>**</span><span class=n>l_scope</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   <span class=k>struct</span> <span class=n>r_scope_elem</span> <span class=o>*</span><span class=n>l_local_scope</span><span class=p>[</span><span class=mi>2</span><span class=p>];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   <span class=k>struct</span> <span class=n>r_file_id</span> <span class=n>l_file_id</span><span class=p>;</span>
</span></span><span class=line><span class=cl>   <span class=k>struct</span> <span class=n>r_search_path_struct</span> <span class=n>l_runpath_dirs</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   <span class=k>struct</span> <span class=n>link_map</span> <span class=o>**</span><span class=n>l_initfini</span><span class=p>;</span>
</span></span><span class=line><span class=cl>   <span class=k>struct</span> <span class=n>link_map_reldeps</span>
</span></span><span class=line><span class=cl>   <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=kt>unsigned</span> <span class=kt>int</span> <span class=n>act</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=k>struct</span> <span class=n>link_map</span> <span class=o>*</span><span class=n>list</span><span class=p>[];</span>
</span></span><span class=line><span class=cl>   <span class=p>}</span> <span class=o>*</span><span class=n>l_reldeps</span><span class=p>;</span>
</span></span><span class=line><span class=cl>   <span class=kt>unsigned</span> <span class=kt>int</span> <span class=n>l_reldepsmax</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   <span class=kt>unsigned</span> <span class=kt>int</span> <span class=n>l_used</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   <span class=nf>ElfW</span><span class=p>(</span><span class=n>Word</span><span class=p>)</span> <span class=n>l_feature_1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>   <span class=nf>ElfW</span><span class=p>(</span><span class=n>Word</span><span class=p>)</span> <span class=n>l_flags_1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>   <span class=nf>ElfW</span><span class=p>(</span><span class=n>Word</span><span class=p>)</span> <span class=n>l_flags</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   <span class=kt>int</span> <span class=n>l_idx</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   <span class=k>struct</span> <span class=n>link_map_machine</span> <span class=n>l_mach</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   <span class=k>struct</span>
</span></span><span class=line><span class=cl>   <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>const</span> <span class=nf>ElfW</span><span class=p>(</span><span class=n>Sym</span><span class=p>)</span> <span class=o>*</span> <span class=n>sym</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=kt>int</span> <span class=n>type_class</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=k>struct</span> <span class=n>link_map</span> <span class=o>*</span><span class=n>value</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=k>const</span> <span class=nf>ElfW</span><span class=p>(</span><span class=n>Sym</span><span class=p>)</span> <span class=o>*</span> <span class=n>ret</span><span class=p>;</span>
</span></span><span class=line><span class=cl>   <span class=p>}</span> <span class=n>l_lookup_cache</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   <span class=kt>void</span> <span class=o>*</span><span class=n>l_tls_initimage</span><span class=p>;</span>
</span></span><span class=line><span class=cl>   <span class=kt>size_t</span> <span class=n>l_tls_initimage_size</span><span class=p>;</span>
</span></span><span class=line><span class=cl>   <span class=kt>size_t</span> <span class=n>l_tls_blocksize</span><span class=p>;</span>
</span></span><span class=line><span class=cl>   <span class=kt>size_t</span> <span class=n>l_tls_align</span><span class=p>;</span>
</span></span><span class=line><span class=cl>   <span class=kt>size_t</span> <span class=n>l_tls_firstbyte_offset</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=cp>#ifndef NO_TLS_OFFSET
</span></span></span><span class=line><span class=cl><span class=cp>#define NO_TLS_OFFSET 0
</span></span></span><span class=line><span class=cl><span class=cp>#endif
</span></span></span><span class=line><span class=cl><span class=cp>#ifndef FORCED_DYNAMIC_TLS_OFFSET
</span></span></span><span class=line><span class=cl><span class=cp>#if NO_TLS_OFFSET == 0
</span></span></span><span class=line><span class=cl><span class=cp>#define FORCED_DYNAMIC_TLS_OFFSET -1
</span></span></span><span class=line><span class=cl><span class=cp>#elif NO_TLS_OFFSET == -1
</span></span></span><span class=line><span class=cl><span class=cp>#define FORCED_DYNAMIC_TLS_OFFSET -2
</span></span></span><span class=line><span class=cl><span class=cp>#else
</span></span></span><span class=line><span class=cl><span class=cp>#error &#34;FORCED_DYNAMIC_TLS_OFFSET is not defined&#34;
</span></span></span><span class=line><span class=cl><span class=cp>#endif
</span></span></span><span class=line><span class=cl><span class=cp>#endif
</span></span></span><span class=line><span class=cl><span class=cp></span>   <span class=kt>ptrdiff_t</span> <span class=n>l_tls_offset</span><span class=p>;</span>
</span></span><span class=line><span class=cl>   <span class=kt>size_t</span> <span class=n>l_tls_modid</span><span class=p>;</span>
</span></span><span class=line><span class=cl>   <span class=kt>size_t</span> <span class=n>l_tls_dtor_count</span><span class=p>;</span>
</span></span><span class=line><span class=cl>   <span class=nf>ElfW</span><span class=p>(</span><span class=n>Addr</span><span class=p>)</span> <span class=n>l_relro_addr</span><span class=p>;</span>
</span></span><span class=line><span class=cl>   <span class=kt>size_t</span> <span class=n>l_relro_size</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   <span class=kt>unsigned</span> <span class=kt>long</span> <span class=kt>long</span> <span class=kt>int</span> <span class=n>l_serial</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>};</span></span></span></code></pre></div></div><h3 id=238>2.38</h3><h4 id=_dl_fini>_dl_fini</h4><p>程序退出或动态库卸载时调用所有已加载共享库（ <code>.so</code> 文件）的析构函数</p><div class="code-block code-line-numbers" style="counter-reset:code-block 0"><div class="code-header language-c"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=复制到剪贴板><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=kt>void</span> <span class=nf>_dl_fini</span> <span class=p>(</span><span class=kt>void</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl><span class=cp>#ifdef SHARED
</span></span></span><span class=line><span class=cl><span class=cp></span>  <span class=kt>int</span> <span class=n>do_audit</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=c1>// 标记是否进行审计操作
</span></span></span><span class=line><span class=cl><span class=c1></span> <span class=nl>again</span><span class=p>:</span> <span class=c1>// 用于重试的逻辑
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=cp>#endif
</span></span></span><span class=line><span class=cl><span class=cp></span>  <span class=c1>// GL(dl_nns): 命名空间的数量，一般为 1，此时 ns 为 0
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>for</span> <span class=p>(</span><span class=n>Lmid_t</span> <span class=n>ns</span> <span class=o>=</span> <span class=nf>GL</span><span class=p>(</span><span class=n>dl_nns</span><span class=p>)</span> <span class=o>-</span> <span class=mi>1</span><span class=p>;</span> <span class=n>ns</span> <span class=o>&gt;=</span> <span class=mi>0</span><span class=p>;</span> <span class=o>--</span><span class=n>ns</span><span class=p>)</span> <span class=c1>// 从最后一个命名空间开始遍历所有命名空间
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nf>__rtld_lock_lock_recursive</span> <span class=p>(</span><span class=nf>GL</span><span class=p>(</span><span class=n>dl_load_lock</span><span class=p>));</span> <span class=c1>// 加锁
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>      <span class=kt>unsigned</span> <span class=kt>int</span> <span class=n>nloaded</span> <span class=o>=</span> <span class=nf>GL</span><span class=p>(</span><span class=n>dl_ns</span><span class=p>)[</span><span class=n>ns</span><span class=p>].</span><span class=n>_ns_nloaded</span><span class=p>;</span> <span class=c1>// 当前命名空间中加载的共享对象数量, 即多少个link_map
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=k>if</span> <span class=p>(</span><span class=n>nloaded</span> <span class=o>==</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl><span class=cp>#ifdef SHARED
</span></span></span><span class=line><span class=cl><span class=cp></span>	  <span class=o>||</span> <span class=nf>GL</span><span class=p>(</span><span class=n>dl_ns</span><span class=p>)[</span><span class=n>ns</span><span class=p>].</span><span class=n>_ns_loaded</span><span class=o>-&gt;</span><span class=n>l_auditing</span> <span class=o>!=</span> <span class=n>do_audit</span>
</span></span><span class=line><span class=cl><span class=cp>#endif
</span></span></span><span class=line><span class=cl><span class=cp></span>	  <span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nf>__rtld_lock_unlock_recursive</span> <span class=p>(</span><span class=nf>GL</span><span class=p>(</span><span class=n>dl_load_lock</span><span class=p>));</span> <span class=c1>// 释放锁
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=k>else</span>
</span></span><span class=line><span class=cl>	<span class=p>{</span>
</span></span><span class=line><span class=cl><span class=cp>#ifdef SHARED
</span></span></span><span class=line><span class=cl><span class=cp></span>	  <span class=nf>_dl_audit_activity_nsid</span> <span class=p>(</span><span class=n>ns</span><span class=p>,</span> <span class=n>LA_ACT_DELETE</span><span class=p>);</span> <span class=c1>// 审计活动标记为删除(LA_ACT_DELETE), 	记录审计日志
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=cp>#endif
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl>	  <span class=k>struct</span> <span class=n>link_map</span> <span class=o>*</span><span class=n>maps</span><span class=p>[</span><span class=n>nloaded</span><span class=p>];</span> <span class=c1>// maps 数组收集当前命名空间中所有加载的共享对象
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>	  <span class=kt>unsigned</span> <span class=kt>int</span> <span class=n>i</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	  <span class=k>struct</span> <span class=n>link_map</span> <span class=o>*</span><span class=n>l</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	  <span class=nf>assert</span> <span class=p>(</span><span class=n>nloaded</span> <span class=o>!=</span> <span class=mi>0</span> <span class=o>||</span> <span class=nf>GL</span><span class=p>(</span><span class=n>dl_ns</span><span class=p>)[</span><span class=n>ns</span><span class=p>].</span><span class=n>_ns_loaded</span> <span class=o>==</span> <span class=nb>NULL</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=c1>// 遍历链表中每一个link_map结构体
</span></span></span><span class=line><span class=cl><span class=c1></span>	  <span class=k>for</span> <span class=p>(</span><span class=n>l</span> <span class=o>=</span> <span class=nf>GL</span><span class=p>(</span><span class=n>dl_ns</span><span class=p>)[</span><span class=n>ns</span><span class=p>].</span><span class=n>_ns_loaded</span><span class=p>,</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>l</span> <span class=o>!=</span> <span class=nb>NULL</span><span class=p>;</span> <span class=n>l</span> <span class=o>=</span> <span class=n>l</span><span class=o>-&gt;</span><span class=n>l_next</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	    <span class=k>if</span> <span class=p>(</span><span class=n>l</span> <span class=o>==</span> <span class=n>l</span><span class=o>-&gt;</span><span class=n>l_real</span><span class=p>)</span> <span class=c1>// 需要指向自身
</span></span></span><span class=line><span class=cl><span class=c1></span>	      <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nf>assert</span> <span class=p>(</span><span class=n>i</span> <span class=o>&lt;</span> <span class=n>nloaded</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=n>maps</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=n>l</span><span class=p>;</span> <span class=c1>// 将指针存到 maps 中初始化
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=n>l</span><span class=o>-&gt;</span><span class=n>l_idx</span> <span class=o>=</span> <span class=n>i</span><span class=p>;</span> <span class=c1>// 赋值索引
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=o>++</span><span class=n>i</span><span class=p>;</span> <span class=c1>// 索引自增
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=o>++</span><span class=n>l</span><span class=o>-&gt;</span><span class=n>l_direct_opencount</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=c1>// 检查	ns = 0, LM_ID_BASE = 0
</span></span></span><span class=line><span class=cl><span class=c1></span>	  <span class=nf>assert</span> <span class=p>(</span><span class=n>ns</span> <span class=o>!=</span> <span class=n>LM_ID_BASE</span> <span class=o>||</span> <span class=n>i</span> <span class=o>==</span> <span class=n>nloaded</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	  <span class=nf>assert</span> <span class=p>(</span><span class=n>ns</span> <span class=o>==</span> <span class=n>LM_ID_BASE</span> <span class=o>||</span> <span class=n>i</span> <span class=o>==</span> <span class=n>nloaded</span> <span class=o>||</span> <span class=n>i</span> <span class=o>==</span> <span class=n>nloaded</span> <span class=o>-</span> <span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	  <span class=kt>unsigned</span> <span class=kt>int</span> <span class=n>nmaps</span> <span class=o>=</span> <span class=n>i</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      <span class=c1>// 对 maps 数组中共享对象进行排序，确保按正确的顺序调用析构函数
</span></span></span><span class=line><span class=cl><span class=c1></span>	  <span class=nf>_dl_sort_maps</span> <span class=p>(</span><span class=n>maps</span><span class=p>,</span> <span class=n>nmaps</span><span class=p>,</span> <span class=p>(</span><span class=n>ns</span> <span class=o>==</span> <span class=n>LM_ID_BASE</span><span class=p>),</span> <span class=nb>true</span><span class=p>);</span> <span class=c1>// 伪造变化可能卡在此处
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>	  <span class=nf>__rtld_lock_unlock_recursive</span> <span class=p>(</span><span class=nf>GL</span><span class=p>(</span><span class=n>dl_load_lock</span><span class=p>));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	  <span class=k>for</span> <span class=p>(</span><span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>nmaps</span><span class=p>;</span> <span class=o>++</span><span class=n>i</span><span class=p>)</span> <span class=c1>// 遍历maps数组
</span></span></span><span class=line><span class=cl><span class=c1></span>	    <span class=p>{</span>
</span></span><span class=line><span class=cl>	      <span class=k>struct</span> <span class=n>link_map</span> <span class=o>*</span><span class=n>l</span> <span class=o>=</span> <span class=n>maps</span><span class=p>[</span><span class=n>i</span><span class=p>];</span> <span class=c1>// 取出结构体
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>	      <span class=k>if</span> <span class=p>(</span><span class=n>l</span><span class=o>-&gt;</span><span class=n>l_init_called</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>{</span>
</span></span><span class=line><span class=cl>		  <span class=nf>_dl_call_fini</span> <span class=p>(</span><span class=n>l</span><span class=p>);</span> <span class=c1>// 调用每个加载对象的析构函数
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=cp>#ifdef SHARED
</span></span></span><span class=line><span class=cl><span class=cp></span>		  <span class=nf>_dl_audit_objclose</span> <span class=p>(</span><span class=n>l</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=cp>#endif
</span></span></span><span class=line><span class=cl><span class=cp></span>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	      <span class=o>--</span><span class=n>l</span><span class=o>-&gt;</span><span class=n>l_direct_opencount</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cp>#ifdef SHARED
</span></span></span><span class=line><span class=cl><span class=cp></span>	  <span class=nf>_dl_audit_activity_nsid</span> <span class=p>(</span><span class=n>ns</span><span class=p>,</span> <span class=n>LA_ACT_CONSISTENT</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=cp>#endif
</span></span></span><span class=line><span class=cl><span class=cp></span>	<span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cp>#ifdef SHARED
</span></span></span><span class=line><span class=cl><span class=cp></span>  <span class=k>if</span> <span class=p>(</span><span class=o>!</span> <span class=n>do_audit</span> <span class=o>&amp;&amp;</span> <span class=nf>GLRO</span><span class=p>(</span><span class=n>dl_naudit</span><span class=p>)</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>do_audit</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=k>goto</span> <span class=n>again</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nf>__glibc_unlikely</span> <span class=p>(</span><span class=nf>GLRO</span><span class=p>(</span><span class=n>dl_debug_mask</span><span class=p>)</span> <span class=o>&amp;</span> <span class=n>DL_DEBUG_STATISTICS</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=nf>_dl_debug_printf</span> <span class=p>(</span><span class=s>&#34;</span><span class=se>\n</span><span class=s>runtime linker statistics:</span><span class=se>\n</span><span class=s>&#34;</span>
</span></span><span class=line><span class=cl>		      <span class=s>&#34;           final number of relocations: %lu</span><span class=se>\n</span><span class=s>&#34;</span>
</span></span><span class=line><span class=cl>		      <span class=s>&#34;final number of relocations from cache: %lu</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		      <span class=nf>GL</span><span class=p>(</span><span class=n>dl_num_relocations</span><span class=p>),</span>
</span></span><span class=line><span class=cl>		      <span class=nf>GL</span><span class=p>(</span><span class=n>dl_num_cache_relocations</span><span class=p>));</span>
</span></span><span class=line><span class=cl><span class=cp>#endif
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=p>}</span></span></span></code></pre></div></div><h4 id=_dl_call_fini>_dl_call_fini</h4><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-c"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=复制到剪贴板><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=kt>void</span> <span class=nf>_dl_call_fini</span><span class=p>(</span><span class=kt>void</span> <span class=o>*</span><span class=n>closure_map</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>struct</span> <span class=n>link_map</span> <span class=o>*</span><span class=n>map</span> <span class=o>=</span> <span class=n>closure_map</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nf>__glibc_unlikely</span><span class=p>(</span><span class=nf>GLRO</span><span class=p>(</span><span class=n>dl_debug_mask</span><span class=p>)</span> <span class=o>&amp;</span> <span class=n>DL_DEBUG_IMPCALLS</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=nf>_dl_debug_printf</span><span class=p>(</span><span class=s>&#34;</span><span class=se>\n</span><span class=s>calling fini: %s [%lu]</span><span class=se>\n\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>map</span><span class=o>-&gt;</span><span class=n>l_name</span><span class=p>,</span> <span class=n>map</span><span class=o>-&gt;</span><span class=n>l_ns</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=n>map</span><span class=o>-&gt;</span><span class=n>l_init_called</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nf>ElfW</span><span class=p>(</span><span class=n>Dyn</span><span class=p>)</span> <span class=o>*</span><span class=n>fini_array</span> <span class=o>=</span> <span class=n>map</span><span class=o>-&gt;</span><span class=n>l_info</span><span class=p>[</span><span class=n>DT_FINI_ARRAY</span><span class=p>];</span> <span class=c1>// 取出第26项
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>if</span> <span class=p>(</span><span class=n>fini_array</span> <span class=o>!=</span> <span class=nb>NULL</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nf>ElfW</span><span class=p>(</span><span class=n>Addr</span><span class=p>)</span> <span class=o>*</span><span class=n>array</span> <span class=o>=</span> <span class=p>(</span><span class=nf>ElfW</span><span class=p>(</span><span class=n>Addr</span><span class=p>)</span> <span class=o>*</span><span class=p>)(</span><span class=n>map</span><span class=o>-&gt;</span><span class=n>l_addr</span> <span class=o>+</span> <span class=n>fini_array</span><span class=o>-&gt;</span><span class=n>d_un</span><span class=p>.</span><span class=n>d_ptr</span><span class=p>);</span> <span class=c1>// 相加找到array指针数组
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kt>size_t</span> <span class=n>sz</span> <span class=o>=</span> <span class=p>(</span><span class=n>map</span><span class=o>-&gt;</span><span class=n>l_info</span><span class=p>[</span><span class=n>DT_FINI_ARRAYSZ</span><span class=p>]</span><span class=o>-&gt;</span><span class=n>d_un</span><span class=p>.</span><span class=n>d_val</span> <span class=o>/</span> <span class=k>sizeof</span><span class=p>(</span><span class=nf>ElfW</span><span class=p>(</span><span class=n>Addr</span><span class=p>)));</span> <span class=c1>// 第28项获取大小size
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=p>(</span><span class=n>sz</span><span class=o>--</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>)</span> <span class=c1>// 从后往前依次调用array数组中的函数
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=p>((</span><span class=kt>fini_t</span><span class=p>)</span><span class=n>array</span><span class=p>[</span><span class=n>sz</span><span class=p>])();</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nf>ElfW</span><span class=p>(</span><span class=n>Dyn</span><span class=p>)</span> <span class=o>*</span><span class=n>fini</span> <span class=o>=</span> <span class=n>map</span><span class=o>-&gt;</span><span class=n>l_info</span><span class=p>[</span><span class=n>DT_FINI</span><span class=p>];</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>fini</span> <span class=o>!=</span> <span class=nb>NULL</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nf>DL_CALL_DT_FINI</span><span class=p>(</span><span class=n>map</span><span class=p>,</span> <span class=p>((</span><span class=kt>void</span> <span class=o>*</span><span class=p>)</span><span class=n>map</span><span class=o>-&gt;</span><span class=n>l_addr</span> <span class=o>+</span> <span class=n>fini</span><span class=o>-&gt;</span><span class=n>d_un</span><span class=p>.</span><span class=n>d_ptr</span><span class=p>));</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></div><h2 id=tls>TLS</h2><h3 id=结构-3>结构</h3><h4 id=tcbhead_t>tcbhead_t</h4><div class="code-block code-line-numbers open" style="counter-reset:code-block 0"><div class="code-header language-c"><span class=code-title><i class="arrow fas fa-angle-right fa-fw" aria-hidden=true></i></span>
<span class=ellipses><i class="fas fa-ellipsis-h fa-fw" aria-hidden=true></i></span>
<span class=copy title=复制到剪贴板><i class="far fa-copy fa-fw" aria-hidden=true></i></span></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>typedef</span> <span class=k>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kt>void</span> <span class=o>*</span><span class=n>tcb</span><span class=p>;</span>    <span class=cm>/* 指向TCB */</span>
</span></span><span class=line><span class=cl>  <span class=kt>dtv_t</span> <span class=o>*</span><span class=n>dtv</span><span class=p>;</span>       <span class=cm>/* 指向dtv数组 */</span>
</span></span><span class=line><span class=cl>  <span class=kt>void</span> <span class=o>*</span><span class=n>self</span><span class=p>;</span>   <span class=cm>/* 指向自身  */</span>
</span></span><span class=line><span class=cl>  <span class=kt>int</span> <span class=n>multiple_threads</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>int</span> <span class=n>gscope_flag</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>uintptr_t</span> <span class=n>sysinfo</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>uintptr_t</span> <span class=n>stack_guard</span><span class=p>;</span>    <span class=cm>/* canary值 */</span>
</span></span><span class=line><span class=cl>  <span class=kt>uintptr_t</span> <span class=n>pointer_guard</span><span class=p>;</span>  <span class=cm>/* 用于保护指针 */</span>
</span></span><span class=line><span class=cl>  <span class=c1>//...
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span> <span class=kt>tcbhead_t</span><span class=p>;</span></span></span></code></pre></div></div></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>更新于 2025-05-24&nbsp;<a class=git-hash href=https://github.com/dillonzq/LoveIt/commit/eada9fe65f8f62547e9d526eec1ab795b4dd6bbd target=_blank title="commit by J-shiro(541737231@qq.com) eada9fe65f8f62547e9d526eec1ab795b4dd6bbd: add ctf, linux, language, old notes">
<i class="fas fa-hashtag fa-fw" aria-hidden=true></i>eada9fe</a></span></div></div><div class=post-info-line><div class=post-info-md><span><a class=link-to-markdown href=/source_analyze/index.md target=_blank>阅读原始文档</a></span></div><div class=post-info-share><span><a href=javascript:void(0); title="分享到 Facebook" data-sharer=facebook data-url=https://j-shiro.github.io/source_analyze/ data-hashtag=pwn><i class="fab fa-facebook-square fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="分享到 Line" data-sharer=line data-url=https://j-shiro.github.io/source_analyze/ data-title=glibc源码分析><i data-svg-src=https://cdn.jsdelivr.net/npm/simple-icons@14.9.0/icons/line.svg aria-hidden=true></i></a><a href=javascript:void(0); title="分享到 微博" data-sharer=weibo data-url=https://j-shiro.github.io/source_analyze/ data-title=glibc源码分析><i class="fab fa-weibo fa-fw" aria-hidden=true></i></a><a href="https://t.me/share/url?url=https%3a%2f%2fj-shiro.github.io%2fsource_analyze%2f&amp;text=glibc%e6%ba%90%e7%a0%81%e5%88%86%e6%9e%90" target=_blank title="分享到 Telegram"><i class="fab fa-telegram fa-fw" aria-hidden=true></i></a></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw" aria-hidden=true></i>&nbsp;<a href=/tags/pwn/>Pwn</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>返回</a></span>&nbsp;|&nbsp;<span><a href=/>主页</a></span></section></div><div class=post-nav><a href=/langchain_note/ class=prev rel=prev title=LangChain><i class="fas fa-angle-left fa-fw" aria-hidden=true></i>LangChain</a>
<a href=/git/ class=next rel=next title=GIT>GIT<i class="fas fa-angle-right fa-fw" aria-hidden=true></i></a></div></div><div id=comments><div id=valine class=comment></div><noscript>Please enable JavaScript to view the comments powered by <a href=https://valine.js.org/>Valine</a>.</noscript></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line>由 <a href=https://gohugo.io/ target=_blank rel="noopener noreffer" title="Hugo 0.143.1">Hugo</a> 强力驱动 | 主题 - <a href=https://github.com/dillonzq/LoveIt target=_blank rel="noopener noreffer" title="LoveIt 0.3.1-DEV"><i class="far fa-kiss-wink-heart fa-fw" aria-hidden=true></i> LoveIt</a></div><div class=footer-line itemscope itemtype=http://schema.org/CreativeWork><i class="far fa-copyright fa-fw" aria-hidden=true></i><span itemprop=copyrightYear>2019 - 2025</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=/ target=_blank>jshiro</a></span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title=回到顶部><i class="fas fa-arrow-up fa-fw" aria-hidden=true></i></a></div><div id=fixed-buttons-hidden><a href=# id=view-comments class=fixed-button title=查看评论><i class="fas fa-comment fa-fw" aria-hidden=true></i></a></div><link rel=stylesheet href=/lib/valine/valine.min.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.16.21/dist/katex.min.css><script src=https://cdn.jsdelivr.net/npm/valine@1.5.3/dist/Valine.min.js></script><script src=https://cdn.jsdelivr.net/npm/autocomplete.js@0.38.1/dist/autocomplete.min.js></script><script src=https://cdn.jsdelivr.net/npm/algoliasearch@5.20.2/dist/lite/builds/browser.umd.min.js></script><script src=https://cdn.jsdelivr.net/npm/lazysizes@5.3.2/lazysizes.min.js></script><script src=https://cdn.jsdelivr.net/npm/clipboard@2.0.11/dist/clipboard.min.js></script><script src=https://cdn.jsdelivr.net/npm/sharer.js@0.5.2/sharer.min.js></script><script src=https://cdn.jsdelivr.net/npm/katex@0.16.21/dist/katex.min.js></script><script src=https://cdn.jsdelivr.net/npm/katex@0.16.21/dist/contrib/auto-render.min.js></script><script src=https://cdn.jsdelivr.net/npm/katex@0.16.21/dist/contrib/copy-tex.min.js></script><script src=https://cdn.jsdelivr.net/npm/katex@0.16.21/dist/contrib/mhchem.min.js></script><script>window.config={comment:{valine:{appId:"wAgpK3Sa13Vfm247ncxiGVDA-MdYXbMMI",appKey:"p6X9gNaJTGB1sqgG9ZnrEwy4",avatar:"mp",el:"#valine",emojiCDN:"https://cdn.jsdelivr.net/npm/emoji-datasource-google@15.1.2/img/google/64/",emojiMaps:{100:"1f4af.png",alien:"1f47d.png",anger:"1f4a2.png",angry:"1f620.png",anguished:"1f627.png",astonished:"1f632.png",black_heart:"1f5a4.png",blue_heart:"1f499.png",blush:"1f60a.png",bomb:"1f4a3.png",boom:"1f4a5.png",broken_heart:"1f494.png",brown_heart:"1f90e.png",clown_face:"1f921.png",cold_face:"1f976.png",cold_sweat:"1f630.png",confounded:"1f616.png",confused:"1f615.png",cry:"1f622.png",crying_cat_face:"1f63f.png",cupid:"1f498.png",dash:"1f4a8.png",disappointed:"1f61e.png",disappointed_relieved:"1f625.png",dizzy:"1f4ab.png",dizzy_face:"1f635.png",drooling_face:"1f924.png",exploding_head:"1f92f.png",expressionless:"1f611.png",face_vomiting:"1f92e.png",face_with_cowboy_hat:"1f920.png",face_with_hand_over_mouth:"1f92d.png",face_with_head_bandage:"1f915.png",face_with_monocle:"1f9d0.png",face_with_raised_eyebrow:"1f928.png",face_with_rolling_eyes:"1f644.png",face_with_symbols_on_mouth:"1f92c.png",face_with_thermometer:"1f912.png",fearful:"1f628.png",flushed:"1f633.png",frowning:"1f626.png",ghost:"1f47b.png",gift_heart:"1f49d.png",green_heart:"1f49a.png",grimacing:"1f62c.png",grin:"1f601.png",grinning:"1f600.png",hankey:"1f4a9.png",hear_no_evil:"1f649.png",heart:"2764-fe0f.png",heart_decoration:"1f49f.png",heart_eyes:"1f60d.png",heart_eyes_cat:"1f63b.png",heartbeat:"1f493.png",heartpulse:"1f497.png",heavy_heart_exclamation_mark_ornament:"2763-fe0f.png",hole:"1f573-fe0f.png",hot_face:"1f975.png",hugging_face:"1f917.png",hushed:"1f62f.png",imp:"1f47f.png",innocent:"1f607.png",japanese_goblin:"1f47a.png",japanese_ogre:"1f479.png",joy:"1f602.png",joy_cat:"1f639.png",kiss:"1f48b.png",kissing:"1f617.png",kissing_cat:"1f63d.png",kissing_closed_eyes:"1f61a.png",kissing_heart:"1f618.png",kissing_smiling_eyes:"1f619.png",laughing:"1f606.png",left_speech_bubble:"1f5e8-fe0f.png",love_letter:"1f48c.png",lying_face:"1f925.png",mask:"1f637.png",money_mouth_face:"1f911.png",nauseated_face:"1f922.png",nerd_face:"1f913.png",neutral_face:"1f610.png",no_mouth:"1f636.png",open_mouth:"1f62e.png",orange_heart:"1f9e1.png",partying_face:"1f973.png",pensive:"1f614.png",persevere:"1f623.png",pleading_face:"1f97a.png",pouting_cat:"1f63e.png",purple_heart:"1f49c.png",rage:"1f621.png",relaxed:"263a-fe0f.png",relieved:"1f60c.png",revolving_hearts:"1f49e.png",right_anger_bubble:"1f5ef-fe0f.png",robot_face:"1f916.png",rolling_on_the_floor_laughing:"1f923.png",scream:"1f631.png",scream_cat:"1f640.png",see_no_evil:"1f648.png",shushing_face:"1f92b.png",skull:"1f480.png",skull_and_crossbones:"2620-fe0f.png",sleeping:"1f634.png",sleepy:"1f62a.png",slightly_frowning_face:"1f641.png",slightly_smiling_face:"1f642.png",smile:"1f604.png",smile_cat:"1f638.png",smiley:"1f603.png",smiley_cat:"1f63a.png",smiling_face_with_3_hearts:"1f970.png",smiling_imp:"1f608.png",smirk:"1f60f.png",smirk_cat:"1f63c.png",sneezing_face:"1f927.png",sob:"1f62d.png",space_invader:"1f47e.png",sparkling_heart:"1f496.png",speak_no_evil:"1f64a.png",speech_balloon:"1f4ac.png","star-struck":"1f929.png",stuck_out_tongue:"1f61b.png",stuck_out_tongue_closed_eyes:"1f61d.png",stuck_out_tongue_winking_eye:"1f61c.png",sunglasses:"1f60e.png",sweat:"1f613.png",sweat_drops:"1f4a6.png",sweat_smile:"1f605.png",thinking_face:"1f914.png",thought_balloon:"1f4ad.png",tired_face:"1f62b.png",triumph:"1f624.png",two_hearts:"1f495.png",unamused:"1f612.png",upside_down_face:"1f643.png",weary:"1f629.png",white_frowning_face:"2639-fe0f.png",white_heart:"1f90d.png",wink:"1f609.png",woozy_face:"1f974.png",worried:"1f61f.png",yawning_face:"1f971.png",yellow_heart:"1f49b.png",yum:"1f60b.png",zany_face:"1f92a.png",zipper_mouth_face:"1f910.png",zzz:"1f4a4.png"},enableQQ:!1,highlight:!0,lang:"zh-CN",pageSize:10,placeholder:"你的评论 ...",recordIP:!0,serverURLs:"https://wagpk3sa.api.lncldglobal.com",visitor:!0}},math:{delimiters:[{display:!0,left:"$$",right:"$$"},{display:!0,left:"\\[",right:"\\]"},{display:!0,left:"\\begin{equation}",right:"\\end{equation}"},{display:!0,left:"\\begin{equation*}",right:"\\end{equation*}"},{display:!0,left:"\\begin{align}",right:"\\end{align}"},{display:!0,left:"\\begin{align*}",right:"\\end{align*}"},{display:!0,left:"\\begin{alignat}",right:"\\end{alignat}"},{display:!0,left:"\\begin{alignat*}",right:"\\end{alignat*}"},{display:!0,left:"\\begin{gather}",right:"\\end{gather}"},{display:!0,left:"\\begin{CD}",right:"\\end{CD}"},{display:!1,left:"$",right:"$"},{display:!1,left:"\\(",right:"\\)"}],strict:!1},search:{algoliaAppID:"GZT24PWKNT",algoliaIndex:"index",algoliaSearchKey:"634ab679e825b815de2663de38908f9d",highlightTag:"em",maxResultLength:10,noResultsFound:"没有找到结果",snippetLength:50,type:"algolia"}}</script><script src=/js/theme.min.js></script></body></html>